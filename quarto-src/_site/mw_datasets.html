<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.31">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>MW Datasets – Documentation of Roy’s Scripts</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-e1a5c8363afafaef2c763b6775fbf3ca.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-7aaeca69b4e146fcaaa982daeac7f2ee.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="site_libs/quarto-diagram/mermaid.min.js"></script>
<script src="site_libs/quarto-diagram/mermaid-init.js"></script>
<link href="site_libs/quarto-diagram/mermaid.css" rel="stylesheet">


<link rel="stylesheet" href="_quarto/rtd-font.css">
<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar docked quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./modisa_scripts.html">MODISA Scripts</a></li><li class="breadcrumb-item"><a href="./mw_datasets.html">MW Datasets</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-center sidebar-header">
      <a href="./index.html" class="sidebar-logo-link">
      <img src="./images/CW_logo.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./roylib.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Utility Library</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./modisa_scripts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">MODISA Scripts</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./mb_datasets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">MB Datasets</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./mw_datasets.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">MW Datasets</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./api/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">API Reference</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#chlorophyll" id="toc-chlorophyll" class="nav-link active" data-scroll-target="#chlorophyll">Chlorophyll</a>
  <ul class="collapse">
  <li><a href="#makechla1daynewmw" id="toc-makechla1daynewmw" class="nav-link" data-scroll-target="#makechla1daynewmw">makeChla1daynewMW</a></li>
  <li><a href="#compmwchla" id="toc-compmwchla" class="nav-link" data-scroll-target="#compmwchla">CompMWChla</a></li>
  <li><a href="#compmwchlamday" id="toc-compmwchlamday" class="nav-link" data-scroll-target="#compmwchlamday">CompMWChlamday</a></li>
  </ul></li>
  <li><a href="#sst" id="toc-sst" class="nav-link" data-scroll-target="#sst">SST</a>
  <ul class="collapse">
  <li><a href="#makesst1daynewmw" id="toc-makesst1daynewmw" class="nav-link" data-scroll-target="#makesst1daynewmw">makeSST1daynewMW</a></li>
  <li><a href="#compmwsst" id="toc-compmwsst" class="nav-link" data-scroll-target="#compmwsst">CompMWSST</a></li>
  <li><a href="#compmwsstmday" id="toc-compmwsstmday" class="nav-link" data-scroll-target="#compmwsstmday">CompMWSSTmday</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./modisa_scripts.html">MODISA Scripts</a></li><li class="breadcrumb-item"><a href="./mw_datasets.html">MW Datasets</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">MW Datasets</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Here you’ll find the MW (West Coast) processing scripts for both chlorophyll-a and SST.</p>
<p>They ingest raw Level-2 swath files, apply regional spatial and quality filters to isolate the West Coast, and grid valid observations into daily NetCDF products. Those daily files are then averaged over rolling multi-day windows—with composites automatically rebuilt whenever new data arrive.</p>
<p>Below are the individual scripts that form the MW workflow. Use the expandable code blocks to explore each stage of the pipeline.</p>
<section id="chlorophyll" class="level2">
<h2 class="anchored" data-anchor-id="chlorophyll">Chlorophyll</h2>
<section id="makechla1daynewmw" class="level3">
<h3 class="anchored" data-anchor-id="makechla1daynewmw">makeChla1daynewMW</h3>
<p><code>makeChla1daynewMW.py</code> makes a 1-day compiste by reading Level-2 ocean-color swath files for a given day, extracts and filters “Day” pixels for chlorophyll-a, Kd490, PAR(0) and fluorescence line height (cflh) within longitude 205°–255° and latitude 22°–51°, then concatenates their longitude, latitude and value arrays. It uses PyGMT to interpolate each dataset onto a 0.0125° × 0.0125° regular grid, converts the results to CF-compliant NetCDFs, and uploads them to a directory on a remote server. Find the 1-day product on ERDDAP <a href="./modisa_scripts.html#modisa-products-on-swfsc-erddap-server">here</a>.</p>
<p>The following chart summarizes the script’s workflow:</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">%%{init: {"flowchart":{"htmlLabels":true}}}%%
flowchart LR
  I("&lt;b&gt;Inputs&lt;/b&gt;&lt;br/&gt;• Raw L2 Chla NetCDF swaths (dataDir)&lt;br/&gt;• workDir&lt;br/&gt;• Year &amp; DOY")
    --&gt; P("&lt;b&gt;Processing&lt;/b&gt;&lt;br/&gt;• Compute calendar date &amp; directories&lt;br/&gt;• Load static land mask&lt;br/&gt;• Discover swaths for Day N (HOD&gt;10) &amp; N+1 (HOD≤10)&lt;br/&gt;• Stage &amp; filter swaths (Day-only, region overlap)&lt;br/&gt;• Extract, reshape &amp; filter (Chla)&lt;br/&gt;• Interpolate onto 0.0125° grid&lt;br/&gt;• Apply land mask")
    --&gt; O("&lt;b&gt;Output&lt;/b&gt;&lt;br/&gt;• CF-compliant 1-day composite NetCDF&lt;br/&gt;• Deployed to /MW/chla/1day/")
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<div id="0cdb7e8f" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>View makeChla1daynewMW.py</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1"></a><span class="co">"""</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="co">Overview</span></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="co">--------</span></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="co">Generate one-day chlorophyll-a (Chla) and related ocean-color products for the MW (West Coast) region by combining MODIS Level-2 swath files and gridding them with PyGMT. This script produces CF-compliant NetCDF files for Chla, Kd490, PAR(0), and fluorescence line height (cflh), then copies them into the appropriate server directories.</span></span>
<span id="cb1-5"><a href="#cb1-5"></a></span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="co">Usage</span></span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="co">-----</span></span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="co">::</span></span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="co"> </span></span>
<span id="cb1-10"><a href="#cb1-10"></a><span class="co">     python makeChla1daynewMW.py &lt;dataDir&gt; &lt;workDir&gt; &lt;year&gt; &lt;doy&gt;</span></span>
<span id="cb1-11"><a href="#cb1-11"></a></span>
<span id="cb1-12"><a href="#cb1-12"></a><span class="co">Where:</span></span>
<span id="cb1-13"><a href="#cb1-13"></a></span>
<span id="cb1-14"><a href="#cb1-14"></a><span class="co">- ``dataDir``</span></span>
<span id="cb1-15"><a href="#cb1-15"></a></span>
<span id="cb1-16"><a href="#cb1-16"></a><span class="co">  Root folder containing raw Level-2 ocean-color NetCDF swath files, organized as ``&lt;dataDirBase&gt;/&lt;YYYY&gt;&lt;MM&gt;/``. Each swath must match: ``AQUA_MODIS.&lt;YYYY&gt;&lt;MM&gt;&lt;DD&gt;*L2.OC.NRT.nc``.</span></span>
<span id="cb1-17"><a href="#cb1-17"></a></span>
<span id="cb1-18"><a href="#cb1-18"></a><span class="co">- ``workDir``</span></span>
<span id="cb1-19"><a href="#cb1-19"></a></span>
<span id="cb1-20"><a href="#cb1-20"></a><span class="co">  Temporary working directory for staging swath copies and intermediate files.</span></span>
<span id="cb1-21"><a href="#cb1-21"></a></span>
<span id="cb1-22"><a href="#cb1-22"></a><span class="co">- ``year``</span></span>
<span id="cb1-23"><a href="#cb1-23"></a></span>
<span id="cb1-24"><a href="#cb1-24"></a><span class="co">  Four-digit year string (e.g., ``"2025"``).</span></span>
<span id="cb1-25"><a href="#cb1-25"></a></span>
<span id="cb1-26"><a href="#cb1-26"></a><span class="co">- ``doy``</span></span>
<span id="cb1-27"><a href="#cb1-27"></a></span>
<span id="cb1-28"><a href="#cb1-28"></a><span class="co">  Three-digit day-of-year string (zero-padded, e.g., ``"082"`` for March 23).</span></span>
<span id="cb1-29"><a href="#cb1-29"></a></span>
<span id="cb1-30"><a href="#cb1-30"></a><span class="co">Description</span></span>
<span id="cb1-31"><a href="#cb1-31"></a><span class="co">-----------</span></span>
<span id="cb1-32"><a href="#cb1-32"></a><span class="co">1. **Parse command-line arguments**</span></span>
<span id="cb1-33"><a href="#cb1-33"></a></span>
<span id="cb1-34"><a href="#cb1-34"></a><span class="co">     - Read ``dataDir``, ``workDir``, ``year``, and ``doy`` from ``sys.argv``.</span></span>
<span id="cb1-35"><a href="#cb1-35"></a></span>
<span id="cb1-36"><a href="#cb1-36"></a><span class="co">     - Print ``year`` and ``doy`` for logging.</span></span>
<span id="cb1-37"><a href="#cb1-37"></a></span>
<span id="cb1-38"><a href="#cb1-38"></a><span class="co">2. **Convert ``year`` + ``doy`` to calendar date**</span></span>
<span id="cb1-39"><a href="#cb1-39"></a></span>
<span id="cb1-40"><a href="#cb1-40"></a><span class="co">     - Compute a ``datetime`` object for the specified day of year.</span></span>
<span id="cb1-41"><a href="#cb1-41"></a></span>
<span id="cb1-42"><a href="#cb1-42"></a><span class="co">     - Zero-pad month and day to form ``MM`` and ``DD``.</span></span>
<span id="cb1-43"><a href="#cb1-43"></a></span>
<span id="cb1-44"><a href="#cb1-44"></a><span class="co">     - Construct ``datadir = dataDir + year + MM + "/"``, which must contain all raw L2 OC swath files for that date.</span></span>
<span id="cb1-45"><a href="#cb1-45"></a></span>
<span id="cb1-46"><a href="#cb1-46"></a><span class="co">3. **Load static land mask**</span></span>
<span id="cb1-47"><a href="#cb1-47"></a></span>
<span id="cb1-48"><a href="#cb1-48"></a><span class="co">     - Open GRD mask file at: ``/u00/ref/landmasks/LM_205_255_0.0125_22_51_0.0125_gridline.grd``</span></span>
<span id="cb1-49"><a href="#cb1-49"></a></span>
<span id="cb1-50"><a href="#cb1-50"></a><span class="co">     - Read the 2D mask array ``my_mask`` (1 = ocean, other = land).</span></span>
<span id="cb1-51"><a href="#cb1-51"></a></span>
<span id="cb1-52"><a href="#cb1-52"></a><span class="co">     - Close the mask dataset.</span></span>
<span id="cb1-53"><a href="#cb1-53"></a></span>
<span id="cb1-54"><a href="#cb1-54"></a><span class="co">4. **List all swath granules for the given date**</span></span>
<span id="cb1-55"><a href="#cb1-55"></a></span>
<span id="cb1-56"><a href="#cb1-56"></a><span class="co">     - Change into ``datadir``.</span></span>
<span id="cb1-57"><a href="#cb1-57"></a></span>
<span id="cb1-58"><a href="#cb1-58"></a><span class="co">     - Build a glob pattern: ``"AQUA_MODIS.&lt;year&gt;&lt;MM&gt;&lt;DD&gt;*.L2.OC.NRT.nc"``.</span></span>
<span id="cb1-59"><a href="#cb1-59"></a></span>
<span id="cb1-60"><a href="#cb1-60"></a><span class="co">     - Retrieve and sort all matching filenames.</span></span>
<span id="cb1-61"><a href="#cb1-61"></a></span>
<span id="cb1-62"><a href="#cb1-62"></a><span class="co">5. **Prepare working directory**</span></span>
<span id="cb1-63"><a href="#cb1-63"></a></span>
<span id="cb1-64"><a href="#cb1-64"></a><span class="co">     - Change into `workDir`.</span></span>
<span id="cb1-65"><a href="#cb1-65"></a></span>
<span id="cb1-66"><a href="#cb1-66"></a><span class="co">     - Remove any stale files matching:</span></span>
<span id="cb1-67"><a href="#cb1-67"></a></span>
<span id="cb1-68"><a href="#cb1-68"></a><span class="co">         - ``AQUA_MODIS.*L2.OC*``</span></span>
<span id="cb1-69"><a href="#cb1-69"></a></span>
<span id="cb1-70"><a href="#cb1-70"></a><span class="co">         - ``MW20*``</span></span>
<span id="cb1-71"><a href="#cb1-71"></a></span>
<span id="cb1-72"><a href="#cb1-72"></a><span class="co">6. **Initialize data accumulators**</span></span>
<span id="cb1-73"><a href="#cb1-73"></a></span>
<span id="cb1-74"><a href="#cb1-74"></a><span class="co">     - ``filesUsed``: comma-separated string for provenance of processed swaths.</span></span>
<span id="cb1-75"><a href="#cb1-75"></a></span>
<span id="cb1-76"><a href="#cb1-76"></a><span class="co">     - ``temp_data_Chla``, ``temp_data_k490``, ``temp_data_par0``, ``temp_data_flh``: accumulate (lon, lat, value) rows for each parameter.</span></span>
<span id="cb1-77"><a href="#cb1-77"></a></span>
<span id="cb1-78"><a href="#cb1-78"></a><span class="co">7. **Loop over each OC swath granule**</span></span>
<span id="cb1-79"><a href="#cb1-79"></a></span>
<span id="cb1-80"><a href="#cb1-80"></a><span class="co">     For each ``fName`` in the sorted list:</span></span>
<span id="cb1-81"><a href="#cb1-81"></a></span>
<span id="cb1-82"><a href="#cb1-82"></a><span class="co">     a. **Copy swath to work directory &amp; open NetCDF**</span></span>
<span id="cb1-83"><a href="#cb1-83"></a></span>
<span id="cb1-84"><a href="#cb1-84"></a><span class="co">         - Copy from ``datadir`` to ``workDir``.</span></span>
<span id="cb1-85"><a href="#cb1-85"></a></span>
<span id="cb1-86"><a href="#cb1-86"></a><span class="co">         - Attempt ``Dataset(fileName, 'r')``; skip if IOError.</span></span>
<span id="cb1-87"><a href="#cb1-87"></a></span>
<span id="cb1-88"><a href="#cb1-88"></a><span class="co">     b. **Extract navigation data**</span></span>
<span id="cb1-89"><a href="#cb1-89"></a></span>
<span id="cb1-90"><a href="#cb1-90"></a><span class="co">         - Read ``latitude`` and ``longitude`` from ``rootgrp.groups['navigation_data']``.</span></span>
<span id="cb1-91"><a href="#cb1-91"></a></span>
<span id="cb1-92"><a href="#cb1-92"></a><span class="co">         - Convert negative longitudes (&lt; 0) to 0-360°.</span></span>
<span id="cb1-93"><a href="#cb1-93"></a></span>
<span id="cb1-94"><a href="#cb1-94"></a><span class="co">         - Compute ``dataLonMin``, ``dataLonMax``, ``dataLatMin``, ``dataLatMax`` for geographic filtering.</span></span>
<span id="cb1-95"><a href="#cb1-95"></a></span>
<span id="cb1-96"><a href="#cb1-96"></a><span class="co">     c. **Determine if swath overlaps the MW region**</span></span>
<span id="cb1-97"><a href="#cb1-97"></a></span>
<span id="cb1-98"><a href="#cb1-98"></a><span class="co">         - Region bounds: ``lon ∈ [205, 255]`` and ``lat ∈ [22, 51]``.</span></span>
<span id="cb1-99"><a href="#cb1-99"></a></span>
<span id="cb1-100"><a href="#cb1-100"></a><span class="co">         - ``goodLon = True`` if any longitudes fall within [205, 255].</span></span>
<span id="cb1-101"><a href="#cb1-101"></a></span>
<span id="cb1-102"><a href="#cb1-102"></a><span class="co">         - ``goodLat = True`` if any latitudes fall within [22, 51].</span></span>
<span id="cb1-103"><a href="#cb1-103"></a></span>
<span id="cb1-104"><a href="#cb1-104"></a><span class="co">         - Proceed only if ``goodLon and goodLat``.</span></span>
<span id="cb1-105"><a href="#cb1-105"></a></span>
<span id="cb1-106"><a href="#cb1-106"></a><span class="co">     d. **Record filename for provenance**</span></span>
<span id="cb1-107"><a href="#cb1-107"></a></span>
<span id="cb1-108"><a href="#cb1-108"></a><span class="co">         - Append ``fileName`` to ``filesUsed`` (comma-separated).</span></span>
<span id="cb1-109"><a href="#cb1-109"></a></span>
<span id="cb1-110"><a href="#cb1-110"></a><span class="co">     e. **Reshape navigation arrays**</span></span>
<span id="cb1-111"><a href="#cb1-111"></a></span>
<span id="cb1-112"><a href="#cb1-112"></a><span class="co">         - Call ``myReshape(latitude)`` → column vector (Nx1).</span></span>
<span id="cb1-113"><a href="#cb1-113"></a></span>
<span id="cb1-114"><a href="#cb1-114"></a><span class="co">         - Call ``myReshape(longitude)``.</span></span>
<span id="cb1-115"><a href="#cb1-115"></a></span>
<span id="cb1-116"><a href="#cb1-116"></a><span class="co">     f. **Extract and filter each parameter**</span></span>
<span id="cb1-117"><a href="#cb1-117"></a></span>
<span id="cb1-118"><a href="#cb1-118"></a><span class="co">      For each variable in ``geophysical_data``:</span></span>
<span id="cb1-119"><a href="#cb1-119"></a></span>
<span id="cb1-120"><a href="#cb1-120"></a><span class="co">        1. **Chlorophyll-a (chlor_a)**</span></span>
<span id="cb1-121"><a href="#cb1-121"></a></span>
<span id="cb1-122"><a href="#cb1-122"></a><span class="co">             - Read and reshape: ``chlor_a = myReshape(rootgrp.groups['geophysical_data'].variables['chlor_a'][:, :])``</span></span>
<span id="cb1-123"><a href="#cb1-123"></a></span>
<span id="cb1-124"><a href="#cb1-124"></a><span class="co">             - Stack: ``dataOut = np.hstack((longitude, latitude, chlor_a))``</span></span>
<span id="cb1-125"><a href="#cb1-125"></a></span>
<span id="cb1-126"><a href="#cb1-126"></a><span class="co">             - Filter:</span></span>
<span id="cb1-127"><a href="#cb1-127"></a></span>
<span id="cb1-128"><a href="#cb1-128"></a><span class="co">                 - ``dataOut[:, 0] &gt; -400``</span></span>
<span id="cb1-129"><a href="#cb1-129"></a></span>
<span id="cb1-130"><a href="#cb1-130"></a><span class="co">                 - ``lonmin ≤ dataOut[:, 0] ≤ lonmax``</span></span>
<span id="cb1-131"><a href="#cb1-131"></a></span>
<span id="cb1-132"><a href="#cb1-132"></a><span class="co">                 - ``latmin ≤ dataOut[:, 1] ≤ latmax``</span></span>
<span id="cb1-133"><a href="#cb1-133"></a></span>
<span id="cb1-134"><a href="#cb1-134"></a><span class="co">                 - ``chlor_a &gt; 0``</span></span>
<span id="cb1-135"><a href="#cb1-135"></a></span>
<span id="cb1-136"><a href="#cb1-136"></a><span class="co">             - Accumulate into ``temp_data_Chla``.</span></span>
<span id="cb1-137"><a href="#cb1-137"></a></span>
<span id="cb1-138"><a href="#cb1-138"></a><span class="co">         2. **Kd490 (Kd_490)**</span></span>
<span id="cb1-139"><a href="#cb1-139"></a></span>
<span id="cb1-140"><a href="#cb1-140"></a><span class="co">             - Read, optionally scale, reshape, and stack with (lon, lat).</span></span>
<span id="cb1-141"><a href="#cb1-141"></a></span>
<span id="cb1-142"><a href="#cb1-142"></a><span class="co">             - Filter:</span></span>
<span id="cb1-143"><a href="#cb1-143"></a></span>
<span id="cb1-144"><a href="#cb1-144"></a><span class="co">                 - valid lon/lat as above,</span></span>
<span id="cb1-145"><a href="#cb1-145"></a></span>
<span id="cb1-146"><a href="#cb1-146"></a><span class="co">                 - ``0 &lt; Kd490 &lt; 6.3``</span></span>
<span id="cb1-147"><a href="#cb1-147"></a></span>
<span id="cb1-148"><a href="#cb1-148"></a><span class="co">             - Accumulate into ``temp_data_k490``.</span></span>
<span id="cb1-149"><a href="#cb1-149"></a></span>
<span id="cb1-150"><a href="#cb1-150"></a><span class="co">         3. **PAR(0) (par)**</span></span>
<span id="cb1-151"><a href="#cb1-151"></a><span class="co">    </span></span>
<span id="cb1-152"><a href="#cb1-152"></a><span class="co">             - Read, optionally scale, reshape, and stack.</span></span>
<span id="cb1-153"><a href="#cb1-153"></a></span>
<span id="cb1-154"><a href="#cb1-154"></a><span class="co">             - Filter:</span></span>
<span id="cb1-155"><a href="#cb1-155"></a></span>
<span id="cb1-156"><a href="#cb1-156"></a><span class="co">                 - valid lon/lat,</span></span>
<span id="cb1-157"><a href="#cb1-157"></a></span>
<span id="cb1-158"><a href="#cb1-158"></a><span class="co">                 - ``PAR &gt; 0``</span></span>
<span id="cb1-159"><a href="#cb1-159"></a></span>
<span id="cb1-160"><a href="#cb1-160"></a><span class="co">             - Accumulate into ``temp_data_par0``.</span></span>
<span id="cb1-161"><a href="#cb1-161"></a></span>
<span id="cb1-162"><a href="#cb1-162"></a><span class="co">         4. **Fluorescence Line Height (cflh)**</span></span>
<span id="cb1-163"><a href="#cb1-163"></a></span>
<span id="cb1-164"><a href="#cb1-164"></a><span class="co">             - Read, optionally scale, reshape, and stack.</span></span>
<span id="cb1-165"><a href="#cb1-165"></a></span>
<span id="cb1-166"><a href="#cb1-166"></a><span class="co">             - Filter:</span></span>
<span id="cb1-167"><a href="#cb1-167"></a></span>
<span id="cb1-168"><a href="#cb1-168"></a><span class="co">                 - valid lon/lat,</span></span>
<span id="cb1-169"><a href="#cb1-169"></a></span>
<span id="cb1-170"><a href="#cb1-170"></a><span class="co">                 - ``cflh &gt; 0``</span></span>
<span id="cb1-171"><a href="#cb1-171"></a></span>
<span id="cb1-172"><a href="#cb1-172"></a><span class="co">            - Accumulate into ``temp_data_flh``.</span></span>
<span id="cb1-173"><a href="#cb1-173"></a></span>
<span id="cb1-174"><a href="#cb1-174"></a><span class="co">     g. **Cleanup**</span></span>
<span id="cb1-175"><a href="#cb1-175"></a></span>
<span id="cb1-176"><a href="#cb1-176"></a><span class="co">         - ``rootgrp.close()``</span></span>
<span id="cb1-177"><a href="#cb1-177"></a></span>
<span id="cb1-178"><a href="#cb1-178"></a><span class="co">         - ``os.remove(fileName)`` from ``workDir``.</span></span>
<span id="cb1-179"><a href="#cb1-179"></a></span>
<span id="cb1-180"><a href="#cb1-180"></a><span class="co">8. **Grid each parameter's point cloud with PyGMT**</span></span>
<span id="cb1-181"><a href="#cb1-181"></a></span>
<span id="cb1-182"><a href="#cb1-182"></a><span class="co">     For each of ``temp_data_Chla``, ``temp_data_k490``, ``temp_data_par0``, ``temp_data_flh``:</span></span>
<span id="cb1-183"><a href="#cb1-183"></a></span>
<span id="cb1-184"><a href="#cb1-184"></a><span class="co">     - Set:</span></span>
<span id="cb1-185"><a href="#cb1-185"></a><span class="co">         - ``region = "205/255/22/51"``</span></span>
<span id="cb1-186"><a href="#cb1-186"></a></span>
<span id="cb1-187"><a href="#cb1-187"></a><span class="co">         - ``spacing = "0.0125/0.0125"``</span></span>
<span id="cb1-188"><a href="#cb1-188"></a></span>
<span id="cb1-189"><a href="#cb1-189"></a><span class="co">         - ``search_radius = "2k"``</span></span>
<span id="cb1-190"><a href="#cb1-190"></a></span>
<span id="cb1-191"><a href="#cb1-191"></a><span class="co">         - ``sectors = "1"``</span></span>
<span id="cb1-192"><a href="#cb1-192"></a></span>
<span id="cb1-193"><a href="#cb1-193"></a><span class="co">     - Call:</span></span>
<span id="cb1-194"><a href="#cb1-194"></a></span>
<span id="cb1-195"><a href="#cb1-195"></a><span class="co">     ::</span></span>
<span id="cb1-196"><a href="#cb1-196"></a></span>
<span id="cb1-197"><a href="#cb1-197"></a><span class="co">         temp_data1 = pygmt.nearneighbor(</span></span>
<span id="cb1-198"><a href="#cb1-198"></a><span class="co">             data=temp_data_&lt;param&gt;,</span></span>
<span id="cb1-199"><a href="#cb1-199"></a><span class="co">             region=region,</span></span>
<span id="cb1-200"><a href="#cb1-200"></a><span class="co">             spacing=spacing,</span></span>
<span id="cb1-201"><a href="#cb1-201"></a><span class="co">             search_radius=search_radius,</span></span>
<span id="cb1-202"><a href="#cb1-202"></a><span class="co">             sectors="1"</span></span>
<span id="cb1-203"><a href="#cb1-203"></a><span class="co">         )</span></span>
<span id="cb1-204"><a href="#cb1-204"></a></span>
<span id="cb1-205"><a href="#cb1-205"></a><span class="co">     - This returns a PyGMT grid (xarray.DataArray) covering the specified region.</span></span>
<span id="cb1-206"><a href="#cb1-206"></a></span>
<span id="cb1-207"><a href="#cb1-207"></a><span class="co">9. **Convert grid(s) to CF-compliant NetCDF &amp; send to server**</span></span>
<span id="cb1-208"><a href="#cb1-208"></a></span>
<span id="cb1-209"><a href="#cb1-209"></a><span class="co">     - Call:</span></span>
<span id="cb1-210"><a href="#cb1-210"></a></span>
<span id="cb1-211"><a href="#cb1-211"></a><span class="co">     ::</span></span>
<span id="cb1-212"><a href="#cb1-212"></a></span>
<span id="cb1-213"><a href="#cb1-213"></a><span class="co">         ncFile = grd2netcdf1(temp_data1, fileOut, filesUsed, my_mask, "MW")</span></span>
<span id="cb1-214"><a href="#cb1-214"></a></span>
<span id="cb1-215"><a href="#cb1-215"></a><span class="co">     - Masks land, computes coverage, builds CF NetCDF via CDL, and returns the NetCDF path.</span></span>
<span id="cb1-216"><a href="#cb1-216"></a></span>
<span id="cb1-217"><a href="#cb1-217"></a><span class="co">     - Call:</span></span>
<span id="cb1-218"><a href="#cb1-218"></a></span>
<span id="cb1-219"><a href="#cb1-219"></a><span class="co">     ::</span></span>
<span id="cb1-220"><a href="#cb1-220"></a></span>
<span id="cb1-221"><a href="#cb1-221"></a><span class="co">         send_to_servers(ncFile, "/MW/&lt;param&gt;/", "1")</span></span>
<span id="cb1-222"><a href="#cb1-222"></a></span>
<span id="cb1-223"><a href="#cb1-223"></a><span class="co">         - E.g. `send_to_servers(ncFile, "/MW/chla/", "1")`</span></span>
<span id="cb1-224"><a href="#cb1-224"></a></span>
<span id="cb1-225"><a href="#cb1-225"></a><span class="co">     - Delete local NetCDF:</span></span>
<span id="cb1-226"><a href="#cb1-226"></a></span>
<span id="cb1-227"><a href="#cb1-227"></a><span class="co">     ::</span></span>
<span id="cb1-228"><a href="#cb1-228"></a></span>
<span id="cb1-229"><a href="#cb1-229"></a><span class="co">         os.remove(ncFile)</span></span>
<span id="cb1-230"><a href="#cb1-230"></a></span>
<span id="cb1-231"><a href="#cb1-231"></a><span class="co">Dependencies</span></span>
<span id="cb1-232"><a href="#cb1-232"></a><span class="co">------------</span></span>
<span id="cb1-233"><a href="#cb1-233"></a><span class="co">- **Python 3.x**</span></span>
<span id="cb1-234"><a href="#cb1-234"></a></span>
<span id="cb1-235"><a href="#cb1-235"></a><span class="co">- **Standard library:** ``sys``, ``os``, ``glob``, ``shutil``, ``re``, ``itertools.chain``, ``datetime``, ``timedelta``</span></span>
<span id="cb1-236"><a href="#cb1-236"></a></span>
<span id="cb1-237"><a href="#cb1-237"></a><span class="co">- **Third-party packages:** ``netCDF4.Dataset``, ``numpy``, ``pygmt``</span></span>
<span id="cb1-238"><a href="#cb1-238"></a></span>
<span id="cb1-239"><a href="#cb1-239"></a><span class="co">- **Custom roylib functions:**</span></span>
<span id="cb1-240"><a href="#cb1-240"></a></span>
<span id="cb1-241"><a href="#cb1-241"></a><span class="co">  - ``myReshape(array)``</span></span>
<span id="cb1-242"><a href="#cb1-242"></a><span class="co">  </span></span>
<span id="cb1-243"><a href="#cb1-243"></a><span class="co">  - ``grd2netcdf1(grd, outName, filesUsed, mask, fType)``</span></span>
<span id="cb1-244"><a href="#cb1-244"></a><span class="co">  </span></span>
<span id="cb1-245"><a href="#cb1-245"></a><span class="co">  - ``send_to_servers(ncFile, destDir, interval)``</span></span>
<span id="cb1-246"><a href="#cb1-246"></a><span class="co">  </span></span>
<span id="cb1-247"><a href="#cb1-247"></a><span class="co">  - ``isleap(year)``</span></span>
<span id="cb1-248"><a href="#cb1-248"></a><span class="co">  </span></span>
<span id="cb1-249"><a href="#cb1-249"></a><span class="co">  - ``makeNetcdf(mean, nobs, interval, outFile, filesUsed, workDir)``</span></span>
<span id="cb1-250"><a href="#cb1-250"></a><span class="co">  </span></span>
<span id="cb1-251"><a href="#cb1-251"></a><span class="co">  - ``meanVar(mean, num, obs)``</span></span>
<span id="cb1-252"><a href="#cb1-252"></a></span>
<span id="cb1-253"><a href="#cb1-253"></a><span class="co">Land Mask</span></span>
<span id="cb1-254"><a href="#cb1-254"></a><span class="co">---------</span></span>
<span id="cb1-255"><a href="#cb1-255"></a><span class="co">- A static GRD file is required at:</span></span>
<span id="cb1-256"><a href="#cb1-256"></a></span>
<span id="cb1-257"><a href="#cb1-257"></a><span class="co"> ``/u00/ref/landmasks/LM_205_255_0.0125_22_51_0.0125_gridline.grd``</span></span>
<span id="cb1-258"><a href="#cb1-258"></a><span class="co"> </span></span>
<span id="cb1-259"><a href="#cb1-259"></a><span class="co">- This mask is applied to each gridded output to set land pixels to NaN.</span></span>
<span id="cb1-260"><a href="#cb1-260"></a></span>
<span id="cb1-261"><a href="#cb1-261"></a><span class="co">Directory Structure</span></span>
<span id="cb1-262"><a href="#cb1-262"></a><span class="co">-------------------</span></span>
<span id="cb1-263"><a href="#cb1-263"></a><span class="co">- **Input swaths directory** (datadir):</span></span>
<span id="cb1-264"><a href="#cb1-264"></a></span>
<span id="cb1-265"><a href="#cb1-265"></a><span class="co">  Directory for raw Level-2 OC NetCDF swath files for the given date, organized as ``&lt;dataDirBase&gt;/&lt;YYYY&gt;&lt;MM&gt;/``. Each file must be named: ``AQUA_MODIS.&lt;YYYY&gt;&lt;MM&gt;&lt;DD&gt;*L2.OC.NRT.nc``</span></span>
<span id="cb1-266"><a href="#cb1-266"></a></span>
<span id="cb1-267"><a href="#cb1-267"></a><span class="co">- **Working directory** (workDir):</span></span>
<span id="cb1-268"><a href="#cb1-268"></a></span>
<span id="cb1-269"><a href="#cb1-269"></a><span class="co">  Temporary staging area where swaths are copied for processing and then deleted.</span></span>
<span id="cb1-270"><a href="#cb1-270"></a></span>
<span id="cb1-271"><a href="#cb1-271"></a><span class="co">- **Output grid** (fileOut):</span></span>
<span id="cb1-272"><a href="#cb1-272"></a></span>
<span id="cb1-273"><a href="#cb1-273"></a><span class="co">  GMT “.grd” file created by PyGMT nearneighbor, named: ``MW&lt;YYYY&gt;&lt;DDD&gt;_&lt;YYYY&gt;&lt;DDD&gt;_&lt;param&gt;.grd`` (e.g. ``MW2025082_2025082_chla.grd``).</span></span>
<span id="cb1-274"><a href="#cb1-274"></a></span>
<span id="cb1-275"><a href="#cb1-275"></a><span class="co">- **Final NetCDF** (returned by ``grd2netcdf1``):</span></span>
<span id="cb1-276"><a href="#cb1-276"></a></span>
<span id="cb1-277"><a href="#cb1-277"></a><span class="co">  CF-compliant NetCDF file named: ``MW&lt;YYYY&gt;&lt;DDD&gt;_&lt;YYYY&gt;&lt;DDD&gt;_&lt;param&gt;.nc`` Copied into the MW 1-day product directories, for example: ``/path/to/modis_data/modiswc/chla/1day/MW2025082_2025082_chla.nc``</span></span>
<span id="cb1-278"><a href="#cb1-278"></a></span>
<span id="cb1-279"><a href="#cb1-279"></a><span class="co">Usage Example</span></span>
<span id="cb1-280"><a href="#cb1-280"></a><span class="co">-------------</span></span>
<span id="cb1-281"><a href="#cb1-281"></a><span class="co">Assume your raw OC swaths live in:</span></span>
<span id="cb1-282"><a href="#cb1-282"></a></span>
<span id="cb1-283"><a href="#cb1-283"></a><span class="co">::</span></span>
<span id="cb1-284"><a href="#cb1-284"></a></span>
<span id="cb1-285"><a href="#cb1-285"></a><span class="co">     /Users/you/modis_data/netcdf/202503/</span></span>
<span id="cb1-286"><a href="#cb1-286"></a></span>
<span id="cb1-287"><a href="#cb1-287"></a><span class="co">and your working directory is:</span></span>
<span id="cb1-288"><a href="#cb1-288"></a></span>
<span id="cb1-289"><a href="#cb1-289"></a><span class="co">::</span></span>
<span id="cb1-290"><a href="#cb1-290"></a><span class="co"> </span></span>
<span id="cb1-291"><a href="#cb1-291"></a><span class="co">     /Users/you/modis_work/</span></span>
<span id="cb1-292"><a href="#cb1-292"></a></span>
<span id="cb1-293"><a href="#cb1-293"></a><span class="co">Then to produce March 23, 2025 products:</span></span>
<span id="cb1-294"><a href="#cb1-294"></a></span>
<span id="cb1-295"><a href="#cb1-295"></a><span class="co">::</span></span>
<span id="cb1-296"><a href="#cb1-296"></a></span>
<span id="cb1-297"><a href="#cb1-297"></a><span class="co">    python makeChla1daynewMW.py /Users/you/modis_data/netcdf/ </span><span class="op">\</span></span>
<span id="cb1-298"><a href="#cb1-298"></a><span class="co">                                /Users/you/modis_work/ </span><span class="op">\</span></span>
<span id="cb1-299"><a href="#cb1-299"></a><span class="co">                                2025 082</span></span>
<span id="cb1-300"><a href="#cb1-300"></a></span>
<span id="cb1-301"><a href="#cb1-301"></a><span class="co">This will:</span></span>
<span id="cb1-302"><a href="#cb1-302"></a></span>
<span id="cb1-303"><a href="#cb1-303"></a><span class="co">  - Copy all swaths matching ``AQUA_MODIS.20250323*.L2.OC.NRT.nc`` into ``/Users/you/modis_work/``.</span></span>
<span id="cb1-304"><a href="#cb1-304"></a></span>
<span id="cb1-305"><a href="#cb1-305"></a><span class="co">  - Build combined point clouds for Chla, Kd490, PAR(0), and cflh.</span></span>
<span id="cb1-306"><a href="#cb1-306"></a></span>
<span id="cb1-307"><a href="#cb1-307"></a><span class="co">  - Create PyGMT grids over lon 205-255°, lat 22-51° via ``nearneighbor``.</span></span>
<span id="cb1-308"><a href="#cb1-308"></a></span>
<span id="cb1-309"><a href="#cb1-309"></a><span class="co">  - Convert each grid to a CF-compliant NetCDF using ``grd2netcdf1``, masked by the static GRD.</span></span>
<span id="cb1-310"><a href="#cb1-310"></a></span>
<span id="cb1-311"><a href="#cb1-311"></a><span class="co">  - Copy the final NetCDFs to the appropriate MW 1-day product folders.</span></span>
<span id="cb1-312"><a href="#cb1-312"></a><span class="co">"""</span></span>
<span id="cb1-313"><a href="#cb1-313"></a><span class="im">from</span> __future__ <span class="im">import</span> print_function</span>
<span id="cb1-314"><a href="#cb1-314"></a><span class="im">from</span> builtins <span class="im">import</span> <span class="bu">str</span></span>
<span id="cb1-315"><a href="#cb1-315"></a></span>
<span id="cb1-316"><a href="#cb1-316"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb1-317"><a href="#cb1-317"></a>    <span class="im">from</span> datetime <span class="im">import</span> datetime, timedelta</span>
<span id="cb1-318"><a href="#cb1-318"></a>    <span class="im">import</span> glob</span>
<span id="cb1-319"><a href="#cb1-319"></a>    <span class="im">from</span> itertools <span class="im">import</span> chain</span>
<span id="cb1-320"><a href="#cb1-320"></a>    <span class="im">from</span> netCDF4 <span class="im">import</span> Dataset</span>
<span id="cb1-321"><a href="#cb1-321"></a>    <span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-322"><a href="#cb1-322"></a>    <span class="im">import</span> numpy.ma <span class="im">as</span> ma</span>
<span id="cb1-323"><a href="#cb1-323"></a>    <span class="im">import</span> pygmt</span>
<span id="cb1-324"><a href="#cb1-324"></a>    <span class="im">import</span> os</span>
<span id="cb1-325"><a href="#cb1-325"></a>    <span class="im">import</span> re</span>
<span id="cb1-326"><a href="#cb1-326"></a>    <span class="im">import</span> shutil</span>
<span id="cb1-327"><a href="#cb1-327"></a>    <span class="im">import</span> sys</span>
<span id="cb1-328"><a href="#cb1-328"></a></span>
<span id="cb1-329"><a href="#cb1-329"></a>    <span class="co"># Ensure 'roylib' is on the import path</span></span>
<span id="cb1-330"><a href="#cb1-330"></a>    sys.path.append(<span class="st">'/home/cwatch/pythonLibs'</span>)</span>
<span id="cb1-331"><a href="#cb1-331"></a>    <span class="im">from</span> roylib <span class="im">import</span> <span class="op">*</span></span>
<span id="cb1-332"><a href="#cb1-332"></a></span>
<span id="cb1-333"><a href="#cb1-333"></a>    <span class="co"># Geographic bounds for MW region</span></span>
<span id="cb1-334"><a href="#cb1-334"></a>    latmax <span class="op">=</span> <span class="fl">51.</span></span>
<span id="cb1-335"><a href="#cb1-335"></a>    latmin <span class="op">=</span> <span class="fl">22.</span></span>
<span id="cb1-336"><a href="#cb1-336"></a>    lonmax <span class="op">=</span> <span class="fl">255.</span></span>
<span id="cb1-337"><a href="#cb1-337"></a>    lonmin <span class="op">=</span> <span class="fl">205.</span></span>
<span id="cb1-338"><a href="#cb1-338"></a></span>
<span id="cb1-339"><a href="#cb1-339"></a>    <span class="co"># Set data directory</span></span>
<span id="cb1-340"><a href="#cb1-340"></a>    datadirBase <span class="op">=</span> sys.argv[<span class="dv">1</span>]</span>
<span id="cb1-341"><a href="#cb1-341"></a></span>
<span id="cb1-342"><a href="#cb1-342"></a>    <span class="co"># Set work directory</span></span>
<span id="cb1-343"><a href="#cb1-343"></a>    workdir <span class="op">=</span> sys.argv[<span class="dv">2</span>]</span>
<span id="cb1-344"><a href="#cb1-344"></a></span>
<span id="cb1-345"><a href="#cb1-345"></a>    <span class="co"># Get the year and doy from the command line</span></span>
<span id="cb1-346"><a href="#cb1-346"></a>    year <span class="op">=</span> sys.argv[<span class="dv">3</span>]</span>
<span id="cb1-347"><a href="#cb1-347"></a>    doy <span class="op">=</span> sys.argv[<span class="dv">4</span>]</span>
<span id="cb1-348"><a href="#cb1-348"></a>    <span class="bu">print</span>(year)</span>
<span id="cb1-349"><a href="#cb1-349"></a>    <span class="bu">print</span>(doy)</span>
<span id="cb1-350"><a href="#cb1-350"></a></span>
<span id="cb1-351"><a href="#cb1-351"></a>    <span class="co"># Convert year/doy to a calendar date and zero-pad month/day</span></span>
<span id="cb1-352"><a href="#cb1-352"></a>    myDate <span class="op">=</span> datetime(<span class="bu">int</span>(year), <span class="dv">1</span>, <span class="dv">1</span>) <span class="op">+</span> timedelta(<span class="bu">int</span>(doy) <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb1-353"><a href="#cb1-353"></a>    myMon <span class="op">=</span> <span class="bu">str</span>(myDate.month)</span>
<span id="cb1-354"><a href="#cb1-354"></a>    myMon <span class="op">=</span> myMon.rjust(<span class="dv">2</span>, <span class="st">'0'</span>)</span>
<span id="cb1-355"><a href="#cb1-355"></a>    myDay <span class="op">=</span> <span class="bu">str</span>(myDate.day).rjust(<span class="dv">2</span>, <span class="st">'0'</span>)</span>
<span id="cb1-356"><a href="#cb1-356"></a></span>
<span id="cb1-357"><a href="#cb1-357"></a>    <span class="co"># Construct the directory path where raw OC swaths are stored for this date</span></span>
<span id="cb1-358"><a href="#cb1-358"></a>    datadir <span class="op">=</span> datadirBase <span class="op">+</span> year <span class="op">+</span> myMon <span class="op">+</span> <span class="st">'/'</span></span>
<span id="cb1-359"><a href="#cb1-359"></a></span>
<span id="cb1-360"><a href="#cb1-360"></a>    <span class="co"># Load static land mask from GRD</span></span>
<span id="cb1-361"><a href="#cb1-361"></a>    mask_root <span class="op">=</span> Dataset(<span class="st">'/u00/ref/landmasks/LM_205_255_0.0125_22_51_0.0125_gridline.grd'</span>)</span>
<span id="cb1-362"><a href="#cb1-362"></a>    my_mask <span class="op">=</span> mask_root.variables[<span class="st">'z'</span>][:, :]</span>
<span id="cb1-363"><a href="#cb1-363"></a>    mask_root.close()</span>
<span id="cb1-364"><a href="#cb1-364"></a></span>
<span id="cb1-365"><a href="#cb1-365"></a>    <span class="co"># Now move to the data directory</span></span>
<span id="cb1-366"><a href="#cb1-366"></a>    os.chdir(datadir)</span>
<span id="cb1-367"><a href="#cb1-367"></a></span>
<span id="cb1-368"><a href="#cb1-368"></a>    <span class="co"># Set up the string for the file search in the data directory</span></span>
<span id="cb1-369"><a href="#cb1-369"></a>    myString <span class="op">=</span> <span class="st">'AQUA_MODIS.'</span> <span class="op">+</span> year <span class="op">+</span> myMon <span class="op">+</span> myDay  <span class="op">+</span> <span class="st">'*.L2.OC.NRT.nc'</span></span>
<span id="cb1-370"><a href="#cb1-370"></a>    <span class="bu">print</span>(myString)</span>
<span id="cb1-371"><a href="#cb1-371"></a></span>
<span id="cb1-372"><a href="#cb1-372"></a>    <span class="co"># Get list of files in the data directory that match with full path</span></span>
<span id="cb1-373"><a href="#cb1-373"></a>    fileList <span class="op">=</span> glob.glob(myString)</span>
<span id="cb1-374"><a href="#cb1-374"></a>    <span class="co"># print(fileList)</span></span>
<span id="cb1-375"><a href="#cb1-375"></a>    fileList.sort()</span>
<span id="cb1-376"><a href="#cb1-376"></a></span>
<span id="cb1-377"><a href="#cb1-377"></a>    <span class="co"># Now move to the work directory and clear old files</span></span>
<span id="cb1-378"><a href="#cb1-378"></a>    os.chdir(workdir)</span>
<span id="cb1-379"><a href="#cb1-379"></a>    os.system(<span class="st">'rm -f AQUA_MODIS.*L2.OC*'</span>)</span>
<span id="cb1-380"><a href="#cb1-380"></a>    os.system(<span class="st">'rm -f MW20*'</span>)</span>
<span id="cb1-381"><a href="#cb1-381"></a></span>
<span id="cb1-382"><a href="#cb1-382"></a>    <span class="co"># Do the whole thing for chla</span></span>
<span id="cb1-383"><a href="#cb1-383"></a>    outFileChla <span class="op">=</span> <span class="st">'modiswcChlatemp'</span></span>
<span id="cb1-384"><a href="#cb1-384"></a>    outFilek490 <span class="op">=</span> <span class="st">'modiswck490temp'</span></span>
<span id="cb1-385"><a href="#cb1-385"></a>    outFilepar0 <span class="op">=</span> <span class="st">'modiswcpar0temp'</span></span>
<span id="cb1-386"><a href="#cb1-386"></a>    outFilecflh <span class="op">=</span> <span class="st">'modiswccflhtemp'</span></span>
<span id="cb1-387"><a href="#cb1-387"></a>    </span>
<span id="cb1-388"><a href="#cb1-388"></a>    <span class="co"># Initialize variables to accumulate data and track provenance</span></span>
<span id="cb1-389"><a href="#cb1-389"></a>    filesUsed <span class="op">=</span> <span class="st">""</span></span>
<span id="cb1-390"><a href="#cb1-390"></a>    temp_data_Chla <span class="op">=</span> <span class="va">None</span></span>
<span id="cb1-391"><a href="#cb1-391"></a>    temp_data_k490 <span class="op">=</span> <span class="va">None</span></span>
<span id="cb1-392"><a href="#cb1-392"></a>    temp_data_par0 <span class="op">=</span> <span class="va">None</span></span>
<span id="cb1-393"><a href="#cb1-393"></a>    temp_data_flh <span class="op">=</span> <span class="va">None</span></span>
<span id="cb1-394"><a href="#cb1-394"></a></span>
<span id="cb1-395"><a href="#cb1-395"></a>    <span class="co"># Loop over each OC swath granule for the given day</span></span>
<span id="cb1-396"><a href="#cb1-396"></a>    <span class="cf">for</span> fName <span class="kw">in</span> fileList:</span>
<span id="cb1-397"><a href="#cb1-397"></a>        fileName <span class="op">=</span> fName</span>
<span id="cb1-398"><a href="#cb1-398"></a>        <span class="co"># find the datatime group in the filename</span></span>
<span id="cb1-399"><a href="#cb1-399"></a>        <span class="co"># check on what to search for</span></span>
<span id="cb1-400"><a href="#cb1-400"></a>        <span class="co">#datetime = re.search('AQUA_MODIS(.+?).L2.NRT.OC', fileName)</span></span>
<span id="cb1-401"><a href="#cb1-401"></a>        <span class="co"># will want elements 8,9 of datatime.group(1)</span></span>
<span id="cb1-402"><a href="#cb1-402"></a>        <span class="bu">print</span>(fileName)</span>
<span id="cb1-403"><a href="#cb1-403"></a></span>
<span id="cb1-404"><a href="#cb1-404"></a>        <span class="co"># Copy the swath from datadir into the workdir</span></span>
<span id="cb1-405"><a href="#cb1-405"></a>        shutil.copyfile(datadir <span class="op">+</span> fName, workdir <span class="op">+</span> fName)</span>
<span id="cb1-406"><a href="#cb1-406"></a></span>
<span id="cb1-407"><a href="#cb1-407"></a>        <span class="co"># Try to open the NetCDF; skip if the file is unreadable</span></span>
<span id="cb1-408"><a href="#cb1-408"></a>        <span class="cf">try</span>:</span>
<span id="cb1-409"><a href="#cb1-409"></a>            rootgrp <span class="op">=</span> Dataset(fileName, <span class="st">'r'</span>)</span>
<span id="cb1-410"><a href="#cb1-410"></a>        <span class="cf">except</span> <span class="pp">IOError</span>:</span>
<span id="cb1-411"><a href="#cb1-411"></a>            <span class="bu">print</span>(<span class="st">"bad file "</span> <span class="op">+</span> fileName)</span>
<span id="cb1-412"><a href="#cb1-412"></a>            <span class="cf">continue</span></span>
<span id="cb1-413"><a href="#cb1-413"></a></span>
<span id="cb1-414"><a href="#cb1-414"></a>        <span class="co"># Extract navigation-group data</span></span>
<span id="cb1-415"><a href="#cb1-415"></a>        navDataGroup <span class="op">=</span> rootgrp.groups[<span class="st">'navigation_data'</span>]</span>
<span id="cb1-416"><a href="#cb1-416"></a>        latitude <span class="op">=</span> navDataGroup.variables[<span class="st">'latitude'</span>][:, :]</span>
<span id="cb1-417"><a href="#cb1-417"></a>        longitude <span class="op">=</span> navDataGroup.variables[<span class="st">'longitude'</span>][:, :]</span>
<span id="cb1-418"><a href="#cb1-418"></a></span>
<span id="cb1-419"><a href="#cb1-419"></a>        <span class="co"># Convert any negative longitudes to the 0-360° domain</span></span>
<span id="cb1-420"><a href="#cb1-420"></a>        longitude[longitude <span class="op">&lt;</span> <span class="dv">0</span>] <span class="op">=</span> longitude[longitude <span class="op">&lt;</span> <span class="dv">0</span>] <span class="op">+</span> <span class="dv">360</span></span>
<span id="cb1-421"><a href="#cb1-421"></a></span>
<span id="cb1-422"><a href="#cb1-422"></a>        <span class="co"># Compute swath extents (min/max) for geographic filtering</span></span>
<span id="cb1-423"><a href="#cb1-423"></a>        dataLonMin <span class="op">=</span> np.nanmin(longitude[longitude <span class="op">&gt;=</span> <span class="dv">0</span>])</span>
<span id="cb1-424"><a href="#cb1-424"></a>        dataLonMax <span class="op">=</span> np.nanmax(longitude[longitude <span class="op">&lt;=</span> <span class="dv">360</span>])</span>
<span id="cb1-425"><a href="#cb1-425"></a>        dataLatMin <span class="op">=</span> np.nanmin(latitude[latitude <span class="op">&gt;=</span> <span class="op">-</span><span class="dv">90</span>])</span>
<span id="cb1-426"><a href="#cb1-426"></a>        dataLatMax <span class="op">=</span> np.nanmax(latitude[latitude <span class="op">&lt;=</span> <span class="dv">90</span>])</span>
<span id="cb1-427"><a href="#cb1-427"></a></span>
<span id="cb1-428"><a href="#cb1-428"></a>        <span class="co"># Determine if swath overlaps our global MW region</span></span>
<span id="cb1-429"><a href="#cb1-429"></a>        goodLon1 <span class="op">=</span> (dataLonMin <span class="op">&lt;</span> lonmin) <span class="kw">and</span> (dataLonMax <span class="op">&gt;=</span> lonmin)</span>
<span id="cb1-430"><a href="#cb1-430"></a>        goodLon2 <span class="op">=</span> (dataLonMin <span class="op">&gt;=</span> lonmin) <span class="kw">and</span> (dataLonMin <span class="op">&lt;=</span> lonmax)</span>
<span id="cb1-431"><a href="#cb1-431"></a>        goodLon <span class="op">=</span> goodLon1 <span class="kw">or</span> goodLon2</span>
<span id="cb1-432"><a href="#cb1-432"></a></span>
<span id="cb1-433"><a href="#cb1-433"></a>        goodLat1 <span class="op">=</span> (dataLatMin <span class="op">&lt;</span> latmin) <span class="kw">and</span> (dataLatMax <span class="op">&gt;=</span> latmin)</span>
<span id="cb1-434"><a href="#cb1-434"></a>        goodLat2 <span class="op">=</span> (dataLatMin <span class="op">&gt;=</span> latmin) <span class="kw">and</span> (dataLatMin <span class="op">&lt;=</span> latmax)</span>
<span id="cb1-435"><a href="#cb1-435"></a>        goodLat <span class="op">=</span> goodLat1 <span class="kw">or</span> goodLat2</span>
<span id="cb1-436"><a href="#cb1-436"></a></span>
<span id="cb1-437"><a href="#cb1-437"></a>        <span class="co"># Check if swath is daytime (only keep "Day" pixels)</span></span>
<span id="cb1-438"><a href="#cb1-438"></a>        dayNightTest <span class="op">=</span> (rootgrp.day_night_flag <span class="op">==</span> <span class="st">'Day'</span>)</span>
<span id="cb1-439"><a href="#cb1-439"></a></span>
<span id="cb1-440"><a href="#cb1-440"></a>        <span class="co"># Only proceed if geography and day-night tests pass</span></span>
<span id="cb1-441"><a href="#cb1-441"></a>        <span class="cf">if</span> (goodLon <span class="kw">and</span> goodLat):</span>
<span id="cb1-442"><a href="#cb1-442"></a>            <span class="co"># Add filename to provenance list</span></span>
<span id="cb1-443"><a href="#cb1-443"></a>            <span class="cf">if</span> (<span class="bu">len</span>(filesUsed) <span class="op">==</span> <span class="dv">0</span>):</span>
<span id="cb1-444"><a href="#cb1-444"></a>                filesUsed <span class="op">=</span> fileName</span>
<span id="cb1-445"><a href="#cb1-445"></a>            <span class="cf">else</span>:</span>
<span id="cb1-446"><a href="#cb1-446"></a>                filesUsed <span class="op">=</span> filesUsed <span class="op">+</span> <span class="st">', '</span> <span class="op">+</span> fileName</span>
<span id="cb1-447"><a href="#cb1-447"></a></span>
<span id="cb1-448"><a href="#cb1-448"></a>            <span class="co"># Reshape latitude &amp; longitude arrays into column vectors</span></span>
<span id="cb1-449"><a href="#cb1-449"></a>            latitude <span class="op">=</span> myReshape(latitude)</span>
<span id="cb1-450"><a href="#cb1-450"></a>            longitude <span class="op">=</span> myReshape(longitude)</span>
<span id="cb1-451"><a href="#cb1-451"></a></span>
<span id="cb1-452"><a href="#cb1-452"></a>            <span class="co"># Access geophysical data group</span></span>
<span id="cb1-453"><a href="#cb1-453"></a>            geoDataGroup <span class="op">=</span> rootgrp.groups[<span class="st">'geophysical_data'</span>]</span>
<span id="cb1-454"><a href="#cb1-454"></a></span>
<span id="cb1-455"><a href="#cb1-455"></a>            <span class="co"># Extract chlor_a</span></span>
<span id="cb1-456"><a href="#cb1-456"></a>            chlor_a <span class="op">=</span> geoDataGroup.variables[<span class="st">'chlor_a'</span>][:, :]</span>
<span id="cb1-457"><a href="#cb1-457"></a>            chlor_a <span class="op">=</span> myReshape(chlor_a)</span>
<span id="cb1-458"><a href="#cb1-458"></a></span>
<span id="cb1-459"><a href="#cb1-459"></a>            <span class="co"># Stack (lon, lat, chlor_a) into a single 2D array with shape (N, 3)</span></span>
<span id="cb1-460"><a href="#cb1-460"></a>            dataOut <span class="op">=</span> np.hstack((longitude, latitude, chlor_a))</span>
<span id="cb1-461"><a href="#cb1-461"></a></span>
<span id="cb1-462"><a href="#cb1-462"></a>            <span class="co"># Filter out-of-range lon/lat and non-positive chlor_a</span></span>
<span id="cb1-463"><a href="#cb1-463"></a>            dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">0</span>] <span class="op">&gt;</span> <span class="op">-</span><span class="dv">400</span>]</span>
<span id="cb1-464"><a href="#cb1-464"></a>            dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">0</span>] <span class="op">&gt;=</span> lonmin]</span>
<span id="cb1-465"><a href="#cb1-465"></a>            dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">0</span>] <span class="op">&lt;=</span> lonmax]</span>
<span id="cb1-466"><a href="#cb1-466"></a>            dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">1</span>] <span class="op">&gt;=</span> latmin]</span>
<span id="cb1-467"><a href="#cb1-467"></a>            dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">1</span>] <span class="op">&lt;=</span> latmax]</span>
<span id="cb1-468"><a href="#cb1-468"></a>            dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">2</span>] <span class="op">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb1-469"><a href="#cb1-469"></a></span>
<span id="cb1-470"><a href="#cb1-470"></a>            <span class="co"># Accumulate into temp_data_Chla</span></span>
<span id="cb1-471"><a href="#cb1-471"></a>            <span class="cf">if</span> (dataOut.shape[<span class="dv">0</span>] <span class="op">&gt;</span> <span class="dv">0</span>):</span>
<span id="cb1-472"><a href="#cb1-472"></a>                <span class="cf">if</span> (temp_data_Chla <span class="kw">is</span> <span class="va">None</span>):</span>
<span id="cb1-473"><a href="#cb1-473"></a>                    temp_data_Chla <span class="op">=</span> dataOut</span>
<span id="cb1-474"><a href="#cb1-474"></a>                <span class="cf">else</span>:</span>
<span id="cb1-475"><a href="#cb1-475"></a>                    temp_data_Chla <span class="op">=</span> np.concatenate((temp_data_Chla, dataOut), axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb1-476"><a href="#cb1-476"></a></span>
<span id="cb1-477"><a href="#cb1-477"></a>            <span class="co"># Extract Kd490</span></span>
<span id="cb1-478"><a href="#cb1-478"></a>            k490 <span class="op">=</span> geoDataGroup.variables[<span class="st">'Kd_490'</span>][:, :]</span>
<span id="cb1-479"><a href="#cb1-479"></a>            <span class="co"># k490 = k490 * 2.0E-4</span></span>
<span id="cb1-480"><a href="#cb1-480"></a>            k490 <span class="op">=</span> myReshape(k490)</span>
<span id="cb1-481"><a href="#cb1-481"></a></span>
<span id="cb1-482"><a href="#cb1-482"></a>            dataOut <span class="op">=</span> np.hstack((longitude, latitude, k490))</span>
<span id="cb1-483"><a href="#cb1-483"></a>            dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">0</span>] <span class="op">&gt;</span> <span class="op">-</span><span class="dv">400</span>]</span>
<span id="cb1-484"><a href="#cb1-484"></a>            dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">0</span>] <span class="op">&gt;=</span> lonmin]</span>
<span id="cb1-485"><a href="#cb1-485"></a>            dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">0</span>] <span class="op">&lt;=</span> lonmax]</span>
<span id="cb1-486"><a href="#cb1-486"></a>            dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">1</span>] <span class="op">&gt;=</span> latmin]</span>
<span id="cb1-487"><a href="#cb1-487"></a>            dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">1</span>] <span class="op">&lt;=</span> latmax]</span>
<span id="cb1-488"><a href="#cb1-488"></a>            dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">2</span>] <span class="op">&lt;</span> <span class="fl">6.3</span>]</span>
<span id="cb1-489"><a href="#cb1-489"></a>            dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">2</span>] <span class="op">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb1-490"><a href="#cb1-490"></a></span>
<span id="cb1-491"><a href="#cb1-491"></a>            <span class="cf">if</span> (dataOut.shape[<span class="dv">0</span>] <span class="op">&gt;</span> <span class="dv">0</span>):</span>
<span id="cb1-492"><a href="#cb1-492"></a>                <span class="cf">if</span> (temp_data_k490 <span class="kw">is</span> <span class="va">None</span>):</span>
<span id="cb1-493"><a href="#cb1-493"></a>                    temp_data_k490 <span class="op">=</span> dataOut</span>
<span id="cb1-494"><a href="#cb1-494"></a>                <span class="cf">else</span>:</span>
<span id="cb1-495"><a href="#cb1-495"></a>                    temp_data_k490 <span class="op">=</span> np.concatenate((temp_data_k490, dataOut), axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb1-496"><a href="#cb1-496"></a></span>
<span id="cb1-497"><a href="#cb1-497"></a>            <span class="co"># Extract PAR0</span></span>
<span id="cb1-498"><a href="#cb1-498"></a>            par0 <span class="op">=</span> geoDataGroup.variables[<span class="st">'par'</span>][:, :]</span>
<span id="cb1-499"><a href="#cb1-499"></a>            <span class="co"># par0 = (0.002 * par0) + 65.5</span></span>
<span id="cb1-500"><a href="#cb1-500"></a>            par0 <span class="op">=</span> myReshape(par0)</span>
<span id="cb1-501"><a href="#cb1-501"></a></span>
<span id="cb1-502"><a href="#cb1-502"></a>            dataOut <span class="op">=</span> np.hstack((longitude, latitude, par0))</span>
<span id="cb1-503"><a href="#cb1-503"></a>            dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">0</span>] <span class="op">&gt;</span> <span class="op">-</span><span class="dv">400</span>]</span>
<span id="cb1-504"><a href="#cb1-504"></a>            dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">0</span>] <span class="op">&gt;=</span> lonmin]</span>
<span id="cb1-505"><a href="#cb1-505"></a>            dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">0</span>] <span class="op">&lt;=</span> lonmax]</span>
<span id="cb1-506"><a href="#cb1-506"></a>            dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">1</span>] <span class="op">&gt;=</span> latmin]</span>
<span id="cb1-507"><a href="#cb1-507"></a>            dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">1</span>] <span class="op">&lt;=</span> latmax]</span>
<span id="cb1-508"><a href="#cb1-508"></a>            dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">2</span>] <span class="op">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb1-509"><a href="#cb1-509"></a></span>
<span id="cb1-510"><a href="#cb1-510"></a>            <span class="cf">if</span> (dataOut.shape[<span class="dv">0</span>] <span class="op">&gt;</span> <span class="dv">0</span>):</span>
<span id="cb1-511"><a href="#cb1-511"></a>                <span class="cf">if</span> (temp_data_par0 <span class="kw">is</span> <span class="va">None</span>):</span>
<span id="cb1-512"><a href="#cb1-512"></a>                    temp_data_par0 <span class="op">=</span> dataOut</span>
<span id="cb1-513"><a href="#cb1-513"></a>                <span class="cf">else</span>:</span>
<span id="cb1-514"><a href="#cb1-514"></a>                    temp_data_par0 <span class="op">=</span> np.concatenate((temp_data_par0, dataOut), axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb1-515"><a href="#cb1-515"></a></span>
<span id="cb1-516"><a href="#cb1-516"></a>            <span class="co"># Extract Fluorescence Line Height (cflh)</span></span>
<span id="cb1-517"><a href="#cb1-517"></a>            cflh <span class="op">=</span> geoDataGroup.variables[<span class="st">'nflh'</span>][:, :]</span>
<span id="cb1-518"><a href="#cb1-518"></a>            <span class="co"># cflh = 1.0E-5 * cflh</span></span>
<span id="cb1-519"><a href="#cb1-519"></a>            cflh <span class="op">=</span> myReshape(cflh)</span>
<span id="cb1-520"><a href="#cb1-520"></a></span>
<span id="cb1-521"><a href="#cb1-521"></a>            dataOut <span class="op">=</span> np.hstack((longitude, latitude, cflh))</span>
<span id="cb1-522"><a href="#cb1-522"></a>            dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">2</span>] <span class="op">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb1-523"><a href="#cb1-523"></a>            dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">0</span>] <span class="op">&gt;</span> <span class="op">-</span><span class="dv">400</span>]</span>
<span id="cb1-524"><a href="#cb1-524"></a>            dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">0</span>] <span class="op">&gt;=</span> lonmin]</span>
<span id="cb1-525"><a href="#cb1-525"></a>            dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">0</span>] <span class="op">&lt;=</span> lonmax]</span>
<span id="cb1-526"><a href="#cb1-526"></a>            dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">1</span>] <span class="op">&gt;=</span> latmin]</span>
<span id="cb1-527"><a href="#cb1-527"></a>            dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">1</span>] <span class="op">&lt;=</span> latmax]</span>
<span id="cb1-528"><a href="#cb1-528"></a>            dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">2</span>] <span class="op">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb1-529"><a href="#cb1-529"></a></span>
<span id="cb1-530"><a href="#cb1-530"></a>            <span class="cf">if</span> (dataOut.shape[<span class="dv">0</span>] <span class="op">&gt;</span> <span class="dv">0</span>):</span>
<span id="cb1-531"><a href="#cb1-531"></a>                <span class="cf">if</span> (temp_data_flh <span class="kw">is</span> <span class="va">None</span>):</span>
<span id="cb1-532"><a href="#cb1-532"></a>                    temp_data_flh <span class="op">=</span> dataOut</span>
<span id="cb1-533"><a href="#cb1-533"></a>                <span class="cf">else</span>:</span>
<span id="cb1-534"><a href="#cb1-534"></a>                    temp_data_flh <span class="op">=</span> np.concatenate((temp_data_flh, dataOut), axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb1-535"><a href="#cb1-535"></a></span>
<span id="cb1-536"><a href="#cb1-536"></a>        <span class="co"># Close the NetCDF and remove the swath file from workdir</span></span>
<span id="cb1-537"><a href="#cb1-537"></a>        rootgrp.close()</span>
<span id="cb1-538"><a href="#cb1-538"></a>        os.remove(fileName)</span>
<span id="cb1-539"><a href="#cb1-539"></a></span>
<span id="cb1-540"><a href="#cb1-540"></a>    <span class="co"># Grid and write each parameter's point cloud via PyGMT,</span></span>
<span id="cb1-541"><a href="#cb1-541"></a>    <span class="co">#  then convert to NetCDF and send to server</span></span>
<span id="cb1-542"><a href="#cb1-542"></a></span>
<span id="cb1-543"><a href="#cb1-543"></a>    <span class="co"># chlor_a composite</span></span>
<span id="cb1-544"><a href="#cb1-544"></a>    fileOut <span class="op">=</span> <span class="st">'MW'</span> <span class="op">+</span> year <span class="op">+</span> doy <span class="op">+</span> <span class="st">'_'</span> <span class="op">+</span> year <span class="op">+</span> doy <span class="op">+</span> <span class="st">'_chla.grd'</span></span>
<span id="cb1-545"><a href="#cb1-545"></a>    <span class="bu">range</span> <span class="op">=</span> <span class="st">'205/255/22/51'</span></span>
<span id="cb1-546"><a href="#cb1-546"></a>    increment <span class="op">=</span> <span class="st">'0.0125/0.0125'</span></span>
<span id="cb1-547"><a href="#cb1-547"></a>    smooth <span class="op">=</span> <span class="st">'2k'</span></span>
<span id="cb1-548"><a href="#cb1-548"></a></span>
<span id="cb1-549"><a href="#cb1-549"></a>    <span class="co"># Create a gridded dataset from the chlor_a point cloud</span></span>
<span id="cb1-550"><a href="#cb1-550"></a>    temp_data1 <span class="op">=</span> pygmt.nearneighbor(</span>
<span id="cb1-551"><a href="#cb1-551"></a>        data<span class="op">=</span>temp_data_Chla,</span>
<span id="cb1-552"><a href="#cb1-552"></a>        region<span class="op">=</span><span class="bu">range</span>,</span>
<span id="cb1-553"><a href="#cb1-553"></a>        spacing<span class="op">=</span>increment,</span>
<span id="cb1-554"><a href="#cb1-554"></a>        search_radius<span class="op">=</span>smooth,</span>
<span id="cb1-555"><a href="#cb1-555"></a>        sectors<span class="op">=</span><span class="st">'1'</span></span>
<span id="cb1-556"><a href="#cb1-556"></a>    )</span>
<span id="cb1-557"><a href="#cb1-557"></a></span>
<span id="cb1-558"><a href="#cb1-558"></a>    <span class="co"># Convert the GMT grid to CF-compliant NetCDF, masking land</span></span>
<span id="cb1-559"><a href="#cb1-559"></a>    ncFile <span class="op">=</span> grd2netcdf1(temp_data1, fileOut, filesUsed, my_mask, <span class="st">'MW'</span>)</span>
<span id="cb1-560"><a href="#cb1-560"></a></span>
<span id="cb1-561"><a href="#cb1-561"></a>    <span class="co">#myCmd = "mv " + ncFile + " /home/cwatch/pygmt_test/outfiles"</span></span>
<span id="cb1-562"><a href="#cb1-562"></a>    <span class="co">#os.system(myCmd)</span></span>
<span id="cb1-563"><a href="#cb1-563"></a></span>
<span id="cb1-564"><a href="#cb1-564"></a>    <span class="co"># Copy to the MW server folder for chla (1-day product)</span></span>
<span id="cb1-565"><a href="#cb1-565"></a>    send_to_servers(ncFile, <span class="st">'/MW/chla/'</span> , <span class="st">'1'</span>)</span>
<span id="cb1-566"><a href="#cb1-566"></a>    os.remove(ncFile)</span>
<span id="cb1-567"><a href="#cb1-567"></a></span>
<span id="cb1-568"><a href="#cb1-568"></a>    <span class="co"># Kd490 composite</span></span>
<span id="cb1-569"><a href="#cb1-569"></a>    <span class="co">#fileIn = outFilek490</span></span>
<span id="cb1-570"><a href="#cb1-570"></a>    fileOut <span class="op">=</span> <span class="st">'MW'</span> <span class="op">+</span> year <span class="op">+</span> doy <span class="op">+</span> <span class="st">'_'</span> <span class="op">+</span> year <span class="op">+</span> doy <span class="op">+</span> <span class="st">'_k490.grd'</span></span>
<span id="cb1-571"><a href="#cb1-571"></a>    <span class="bu">range</span> <span class="op">=</span> <span class="st">'205/255/22/51'</span></span>
<span id="cb1-572"><a href="#cb1-572"></a>    increment <span class="op">=</span> <span class="st">'0.0125/0.0125'</span></span>
<span id="cb1-573"><a href="#cb1-573"></a>    smooth <span class="op">=</span> <span class="st">'2k'</span></span>
<span id="cb1-574"><a href="#cb1-574"></a></span>
<span id="cb1-575"><a href="#cb1-575"></a>    <span class="co"># Create a gridded dataset from the Kd490 point cloud</span></span>
<span id="cb1-576"><a href="#cb1-576"></a>    temp_data1 <span class="op">=</span> pygmt.nearneighbor(</span>
<span id="cb1-577"><a href="#cb1-577"></a>        data<span class="op">=</span>temp_data_k490,</span>
<span id="cb1-578"><a href="#cb1-578"></a>        region<span class="op">=</span><span class="bu">range</span>,</span>
<span id="cb1-579"><a href="#cb1-579"></a>        spacing<span class="op">=</span>increment,</span>
<span id="cb1-580"><a href="#cb1-580"></a>        search_radius<span class="op">=</span>smooth,</span>
<span id="cb1-581"><a href="#cb1-581"></a>        sectors<span class="op">=</span><span class="st">'1'</span></span>
<span id="cb1-582"><a href="#cb1-582"></a>    )</span>
<span id="cb1-583"><a href="#cb1-583"></a></span>
<span id="cb1-584"><a href="#cb1-584"></a>    <span class="co"># Convert the GMT grid to CF-compliant NetCDF, masking land</span></span>
<span id="cb1-585"><a href="#cb1-585"></a>    ncFile <span class="op">=</span> grd2netcdf1(temp_data1, fileOut, filesUsed, my_mask, <span class="st">'MW'</span>)</span>
<span id="cb1-586"><a href="#cb1-586"></a></span>
<span id="cb1-587"><a href="#cb1-587"></a>    <span class="co">#myCmd = "mv " + ncFile + " /home/cwatch/pygmt_test/outfiles"</span></span>
<span id="cb1-588"><a href="#cb1-588"></a>    <span class="co">#os.system(myCmd)</span></span>
<span id="cb1-589"><a href="#cb1-589"></a></span>
<span id="cb1-590"><a href="#cb1-590"></a>    <span class="co"># Copy to the MW server folder for k490 (1-day product)</span></span>
<span id="cb1-591"><a href="#cb1-591"></a>    send_to_servers(ncFile, <span class="st">'/MW/k490/'</span> , <span class="st">'1'</span>)</span>
<span id="cb1-592"><a href="#cb1-592"></a>    os.remove(ncFile)</span>
<span id="cb1-593"><a href="#cb1-593"></a></span>
<span id="cb1-594"><a href="#cb1-594"></a>    <span class="co"># PAR(0) composite</span></span>
<span id="cb1-595"><a href="#cb1-595"></a>    fileOut <span class="op">=</span> <span class="st">'MW'</span> <span class="op">+</span> year <span class="op">+</span> doy <span class="op">+</span> <span class="st">'_'</span> <span class="op">+</span> year <span class="op">+</span> doy <span class="op">+</span> <span class="st">'_par0.grd'</span></span>
<span id="cb1-596"><a href="#cb1-596"></a>    <span class="bu">range</span> <span class="op">=</span> <span class="st">'205/255/22/51'</span></span>
<span id="cb1-597"><a href="#cb1-597"></a>    increment <span class="op">=</span> <span class="st">'0.0125/0.0125'</span></span>
<span id="cb1-598"><a href="#cb1-598"></a>    smooth <span class="op">=</span> <span class="st">'2k'</span></span>
<span id="cb1-599"><a href="#cb1-599"></a></span>
<span id="cb1-600"><a href="#cb1-600"></a>    <span class="co"># Create a gridded dataset from the PAR(0) point cloud</span></span>
<span id="cb1-601"><a href="#cb1-601"></a>    temp_data1 <span class="op">=</span> pygmt.nearneighbor(</span>
<span id="cb1-602"><a href="#cb1-602"></a>        data<span class="op">=</span>temp_data_par0,</span>
<span id="cb1-603"><a href="#cb1-603"></a>        region<span class="op">=</span><span class="bu">range</span>,</span>
<span id="cb1-604"><a href="#cb1-604"></a>        spacing<span class="op">=</span>increment,</span>
<span id="cb1-605"><a href="#cb1-605"></a>        search_radius<span class="op">=</span>smooth,</span>
<span id="cb1-606"><a href="#cb1-606"></a>        sectors<span class="op">=</span><span class="st">'1'</span></span>
<span id="cb1-607"><a href="#cb1-607"></a>    )</span>
<span id="cb1-608"><a href="#cb1-608"></a></span>
<span id="cb1-609"><a href="#cb1-609"></a>    <span class="co"># Convert the GMT grid to CF-compliant NetCDF, masking land</span></span>
<span id="cb1-610"><a href="#cb1-610"></a>    ncFile <span class="op">=</span> grd2netcdf1(temp_data1, fileOut, filesUsed, my_mask, <span class="st">'MW'</span>)</span>
<span id="cb1-611"><a href="#cb1-611"></a></span>
<span id="cb1-612"><a href="#cb1-612"></a>    <span class="co">#myCmd = "mv " + ncFile + " /home/cwatch/pygmt_test/outfiles"</span></span>
<span id="cb1-613"><a href="#cb1-613"></a>    <span class="co">#os.system(myCmd)</span></span>
<span id="cb1-614"><a href="#cb1-614"></a></span>
<span id="cb1-615"><a href="#cb1-615"></a>    <span class="co"># Copy to the MW server folder for PAR(0) (1-day product)</span></span>
<span id="cb1-616"><a href="#cb1-616"></a>    send_to_servers(ncFile, <span class="st">'/MW/k490/'</span> , <span class="st">'1'</span>)  <span class="co"># Note: likely intended for '/MW/par0/'</span></span>
<span id="cb1-617"><a href="#cb1-617"></a>    os.remove(ncFile)</span>
<span id="cb1-618"><a href="#cb1-618"></a></span>
<span id="cb1-619"><a href="#cb1-619"></a>    <span class="co"># cflh composite</span></span>
<span id="cb1-620"><a href="#cb1-620"></a>    <span class="co">#fileIn = outFilecflh</span></span>
<span id="cb1-621"><a href="#cb1-621"></a>    fileOut <span class="op">=</span> <span class="st">'MW'</span> <span class="op">+</span> year <span class="op">+</span> doy <span class="op">+</span> <span class="st">'_'</span> <span class="op">+</span> year <span class="op">+</span> doy <span class="op">+</span> <span class="st">'_cflh.grd'</span></span>
<span id="cb1-622"><a href="#cb1-622"></a>    <span class="bu">range</span> <span class="op">=</span> <span class="st">'205/255/22/51'</span></span>
<span id="cb1-623"><a href="#cb1-623"></a>    increment <span class="op">=</span> <span class="st">'0.0125/0.0125'</span></span>
<span id="cb1-624"><a href="#cb1-624"></a>    smooth <span class="op">=</span> <span class="st">'2k'</span></span>
<span id="cb1-625"><a href="#cb1-625"></a></span>
<span id="cb1-626"><a href="#cb1-626"></a>    <span class="co"># Create a gridded dataset from the cflh point cloud</span></span>
<span id="cb1-627"><a href="#cb1-627"></a>    temp_data1 <span class="op">=</span> pygmt.nearneighbor(</span>
<span id="cb1-628"><a href="#cb1-628"></a>        data<span class="op">=</span>temp_data_flh,</span>
<span id="cb1-629"><a href="#cb1-629"></a>        region<span class="op">=</span><span class="bu">range</span>,</span>
<span id="cb1-630"><a href="#cb1-630"></a>        spacing<span class="op">=</span>increment,</span>
<span id="cb1-631"><a href="#cb1-631"></a>        search_radius<span class="op">=</span>smooth,</span>
<span id="cb1-632"><a href="#cb1-632"></a>        sectors<span class="op">=</span><span class="st">'1'</span></span>
<span id="cb1-633"><a href="#cb1-633"></a>    )</span>
<span id="cb1-634"><a href="#cb1-634"></a></span>
<span id="cb1-635"><a href="#cb1-635"></a>    <span class="co"># Convert the GMT grid to CF-compliant NetCDF, masking land</span></span>
<span id="cb1-636"><a href="#cb1-636"></a>    ncFile <span class="op">=</span> grd2netcdf1(temp_data1, fileOut, filesUsed, my_mask, <span class="st">'MW'</span>)</span>
<span id="cb1-637"><a href="#cb1-637"></a></span>
<span id="cb1-638"><a href="#cb1-638"></a>    <span class="co">#myCmd = "mv " + ncFile + " /home/cwatch/pygmt_test/outfiles"</span></span>
<span id="cb1-639"><a href="#cb1-639"></a>    <span class="co">#os.system(myCmd)</span></span>
<span id="cb1-640"><a href="#cb1-640"></a></span>
<span id="cb1-641"><a href="#cb1-641"></a>    <span class="co"># Copy to the MW server folder for cflh (1-day product)</span></span>
<span id="cb1-642"><a href="#cb1-642"></a>    send_to_servers(ncFile, <span class="st">'/MW/k490/'</span> , <span class="st">'1'</span>)  <span class="co"># Note: likely intended for '/MW/cflh/'</span></span>
<span id="cb1-643"><a href="#cb1-643"></a>    os.remove(ncFile)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="compmwchla" class="level3">
<h3 class="anchored" data-anchor-id="compmwchla">CompMWChla</h3>
<p><code>CompMWChla.py</code> reads 1-day composite MW NetCDF files for chlorophyll-a, Kd490, PAR(0), CFLH over the specified interval and accumulates running sums and counts on a 0.0125° × 0.0125° regular grid spanning longitude 205°–255° and latitude 22°–51°. It then masks out any grid cells with zero observations, writes each multi-day (3-, 8-, or 14-day) composite as a CF-compliant NetCDF, and uploads them to their respective directories on a remote server. Find the multi-day products on ERDDAP <a href="./modisa_scripts.html#modisa-products-on-swfsc-erddap-server">here</a>.</p>
<p>The following chart summarizes the script’s workflow:</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">%%{init: {"flowchart":{"htmlLabels":true}}}%%
flowchart LR
  I("&lt;b&gt;Inputs&lt;/b&gt;&lt;br/&gt;• 1-day composite NetCDFs (dataDir)&lt;br/&gt;• workDir&lt;br/&gt;• endYear &amp; endDoy&lt;br/&gt;• interval (days)")
    --&gt; P("&lt;b&gt;Processing&lt;/b&gt;&lt;br/&gt;• Parse args &amp; compute start/end DOY&lt;br/&gt;• Clear workDir &amp; initialize mean/num arrays&lt;br/&gt;• Gather files over date range&lt;br/&gt;• Loop: open each file &amp; update mean/num&lt;br/&gt;• Mask zero-observation pixels")
    --&gt; O("&lt;b&gt;Output&lt;/b&gt;&lt;br/&gt;• CF-compliant multi-day (3-, 8-, 14-) composite NetCDF&lt;br/&gt;• Deployed to /MW/chla/interval day/")
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<div id="9c6fa690" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>View CompMWChla.py</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1"></a><span class="co">"""</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="co">Overview</span></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="co">--------</span></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="co">Generate multi-day composites for MODIS MW (West Coast) products:</span></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="co">chlorophyll-a (Chla), Kd490, PAR0, and fluorescence line height (CFLH).</span></span>
<span id="cb2-6"><a href="#cb2-6"></a></span>
<span id="cb2-7"><a href="#cb2-7"></a><span class="co">Usage</span></span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="co">-----</span></span>
<span id="cb2-9"><a href="#cb2-9"></a><span class="co">::</span></span>
<span id="cb2-10"><a href="#cb2-10"></a></span>
<span id="cb2-11"><a href="#cb2-11"></a><span class="co">    python CompMWChla.py &lt;dataDir&gt; &lt;workDir&gt; &lt;endYear&gt; &lt;endDoy&gt; &lt;interval&gt;</span></span>
<span id="cb2-12"><a href="#cb2-12"></a></span>
<span id="cb2-13"><a href="#cb2-13"></a><span class="co">Where:</span></span>
<span id="cb2-14"><a href="#cb2-14"></a></span>
<span id="cb2-15"><a href="#cb2-15"></a><span class="co">- ``dataDir``</span></span>
<span id="cb2-16"><a href="#cb2-16"></a></span>
<span id="cb2-17"><a href="#cb2-17"></a><span class="co">  Directory containing daily 1-day NetCDFs named ``MW&lt;YYYY&gt;&lt;DDD&gt;_&lt;param&gt;.nc``.</span></span>
<span id="cb2-18"><a href="#cb2-18"></a></span>
<span id="cb2-19"><a href="#cb2-19"></a><span class="co">- ``workDir``</span></span>
<span id="cb2-20"><a href="#cb2-20"></a></span>
<span id="cb2-21"><a href="#cb2-21"></a><span class="co">  Temporary working directory for intermediate files.</span></span>
<span id="cb2-22"><a href="#cb2-22"></a></span>
<span id="cb2-23"><a href="#cb2-23"></a><span class="co">- ``endYear`` </span></span>
<span id="cb2-24"><a href="#cb2-24"></a></span>
<span id="cb2-25"><a href="#cb2-25"></a><span class="co">  Four-digit year of the last day in the composite (e.g., ``2025``).</span></span>
<span id="cb2-26"><a href="#cb2-26"></a></span>
<span id="cb2-27"><a href="#cb2-27"></a><span class="co">- ``endDoy``</span></span>
<span id="cb2-28"><a href="#cb2-28"></a></span>
<span id="cb2-29"><a href="#cb2-29"></a><span class="co">  Three-digit day-of-year of the last day (e.g., ``082``).</span></span>
<span id="cb2-30"><a href="#cb2-30"></a></span>
<span id="cb2-31"><a href="#cb2-31"></a><span class="co">- ``interval``</span></span>
<span id="cb2-32"><a href="#cb2-32"></a></span>
<span id="cb2-33"><a href="#cb2-33"></a><span class="co">  Composite length in days (`3`, `5`, `8`, or `14`)</span></span>
<span id="cb2-34"><a href="#cb2-34"></a></span>
<span id="cb2-35"><a href="#cb2-35"></a><span class="co">Description</span></span>
<span id="cb2-36"><a href="#cb2-36"></a><span class="co">-----------</span></span>
<span id="cb2-37"><a href="#cb2-37"></a><span class="co">1. **Parse arguments &amp; compute date range** </span></span>
<span id="cb2-38"><a href="#cb2-38"></a></span>
<span id="cb2-39"><a href="#cb2-39"></a><span class="co">  - Read ``dataDir``, ``workDir``, ``endYear``, ``endDoy``, ``interval``.</span></span>
<span id="cb2-40"><a href="#cb2-40"></a></span>
<span id="cb2-41"><a href="#cb2-41"></a><span class="co">  - Compute start day = end day minus (``interval``-1), zero-pad ``startDoy``.</span></span>
<span id="cb2-42"><a href="#cb2-42"></a></span>
<span id="cb2-43"><a href="#cb2-43"></a><span class="co">2. **Loop over each variable** (``chla``, ``k490``, ``par0``, ``cflh``):  </span></span>
<span id="cb2-44"><a href="#cb2-44"></a></span>
<span id="cb2-45"><a href="#cb2-45"></a><span class="co">  - Clear ``workDir``.</span></span>
<span id="cb2-46"><a href="#cb2-46"></a></span>
<span id="cb2-47"><a href="#cb2-47"></a><span class="co">  - Initialize ``mean`` and ``num`` arrays for sum and count.</span></span>
<span id="cb2-48"><a href="#cb2-48"></a></span>
<span id="cb2-49"><a href="#cb2-49"></a><span class="co">  - Gather daily files over the date range (handles year wrap).</span></span>
<span id="cb2-50"><a href="#cb2-50"></a></span>
<span id="cb2-51"><a href="#cb2-51"></a><span class="co">  - For each file, read 4D ``MW&lt;dtype&gt;``, squeeze to 2D, update ``mean``, ``num``.</span></span>
<span id="cb2-52"><a href="#cb2-52"></a></span>
<span id="cb2-53"><a href="#cb2-53"></a><span class="co">  - Mask out pixels with zero count (fill = -9999999).</span></span>
<span id="cb2-54"><a href="#cb2-54"></a></span>
<span id="cb2-55"><a href="#cb2-55"></a><span class="co">  - Write composite via ``makeNetcdf(...)`` and send via ``send_to_servers(...)``.</span></span>
<span id="cb2-56"><a href="#cb2-56"></a></span>
<span id="cb2-57"><a href="#cb2-57"></a><span class="co">Dependencies</span></span>
<span id="cb2-58"><a href="#cb2-58"></a><span class="co">------------</span></span>
<span id="cb2-59"><a href="#cb2-59"></a><span class="co">- **Python 3.x**</span></span>
<span id="cb2-60"><a href="#cb2-60"></a></span>
<span id="cb2-61"><a href="#cb2-61"></a><span class="co">- **Standard library:** ``os``, ``sys``, ``glob``, ``itertools.chain``, ``datetime``</span></span>
<span id="cb2-62"><a href="#cb2-62"></a></span>
<span id="cb2-63"><a href="#cb2-63"></a><span class="co">- **Third-party:** ``numpy``, ``numpy.ma``, ``netCDF4``</span></span>
<span id="cb2-64"><a href="#cb2-64"></a></span>
<span id="cb2-65"><a href="#cb2-65"></a><span class="co">- **Custom roylib functions:**</span></span>
<span id="cb2-66"><a href="#cb2-66"></a></span>
<span id="cb2-67"><a href="#cb2-67"></a><span class="co">  - ``isleap(year)``</span></span>
<span id="cb2-68"><a href="#cb2-68"></a></span>
<span id="cb2-69"><a href="#cb2-69"></a><span class="co">  - ``meanVar(mean, num, obs)``</span></span>
<span id="cb2-70"><a href="#cb2-70"></a></span>
<span id="cb2-71"><a href="#cb2-71"></a><span class="co">  - ``makeNetcdf(mean, nobs, interval, outFile, filesUsed, workDir)``</span></span>
<span id="cb2-72"><a href="#cb2-72"></a></span>
<span id="cb2-73"><a href="#cb2-73"></a><span class="co">  - ``send_to_servers(ncFile, destDir, interval)``</span></span>
<span id="cb2-74"><a href="#cb2-74"></a></span>
<span id="cb2-75"><a href="#cb2-75"></a><span class="co">Directory Structure</span></span>
<span id="cb2-76"><a href="#cb2-76"></a><span class="co">-------------------</span></span>
<span id="cb2-77"><a href="#cb2-77"></a><span class="co">- **Input Directory** (``dataDir``):</span></span>
<span id="cb2-78"><a href="#cb2-78"></a></span>
<span id="cb2-79"><a href="#cb2-79"></a><span class="co">  ``MW&lt;YYYY&gt;&lt;DDD&gt;*&lt;dtype&gt;.nc``</span></span>
<span id="cb2-80"><a href="#cb2-80"></a></span>
<span id="cb2-81"><a href="#cb2-81"></a><span class="co">- **Working Directory** (``workDir``):</span></span>
<span id="cb2-82"><a href="#cb2-82"></a></span>
<span id="cb2-83"><a href="#cb2-83"></a><span class="co">  Temporary staging for intermediate files</span></span>
<span id="cb2-84"><a href="#cb2-84"></a></span>
<span id="cb2-85"><a href="#cb2-85"></a><span class="co">- **Output Location** (remote):</span></span>
<span id="cb2-86"><a href="#cb2-86"></a></span>
<span id="cb2-87"><a href="#cb2-87"></a><span class="co">  ``/MW/&lt;dtype&gt;/`` on the server</span></span>
<span id="cb2-88"><a href="#cb2-88"></a></span>
<span id="cb2-89"><a href="#cb2-89"></a><span class="co">Usage Example</span></span>
<span id="cb2-90"><a href="#cb2-90"></a><span class="co">-------------</span></span>
<span id="cb2-91"><a href="#cb2-91"></a><span class="co">5-day composite (DOY 100-104 of 2025):</span></span>
<span id="cb2-92"><a href="#cb2-92"></a></span>
<span id="cb2-93"><a href="#cb2-93"></a><span class="co">::</span></span>
<span id="cb2-94"><a href="#cb2-94"></a><span class="co">  </span></span>
<span id="cb2-95"><a href="#cb2-95"></a><span class="co">   python CompMWChla.py /data/MW/1day /tmp/mw_work 2025 104 5</span></span>
<span id="cb2-96"><a href="#cb2-96"></a></span>
<span id="cb2-97"><a href="#cb2-97"></a><span class="co">This command will:</span></span>
<span id="cb2-98"><a href="#cb2-98"></a></span>
<span id="cb2-99"><a href="#cb2-99"></a><span class="co">  - Read all daily files ``MW2025100*...MW2025104*`` from ``/data/MW/1day``.</span></span>
<span id="cb2-100"><a href="#cb2-100"></a></span>
<span id="cb2-101"><a href="#cb2-101"></a><span class="co">  - Compute the 5-day composite for Chla, Kd490, PAR0, and CFLH.</span></span>
<span id="cb2-102"><a href="#cb2-102"></a></span>
<span id="cb2-103"><a href="#cb2-103"></a><span class="co">  - Write the output files to ``/tmp/mw_work/`` and upload them to ``/MW/&lt;dtype&gt;/`` on the server.</span></span>
<span id="cb2-104"><a href="#cb2-104"></a><span class="co">"""</span></span>
<span id="cb2-105"><a href="#cb2-105"></a><span class="im">from</span> __future__ <span class="im">import</span> print_function</span>
<span id="cb2-106"><a href="#cb2-106"></a><span class="im">from</span> builtins <span class="im">import</span> <span class="bu">str</span></span>
<span id="cb2-107"><a href="#cb2-107"></a><span class="im">from</span> builtins <span class="im">import</span> <span class="bu">range</span></span>
<span id="cb2-108"><a href="#cb2-108"></a></span>
<span id="cb2-109"><a href="#cb2-109"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb2-110"><a href="#cb2-110"></a>    <span class="im">from</span> datetime <span class="im">import</span> datetime, timedelta</span>
<span id="cb2-111"><a href="#cb2-111"></a>    <span class="im">import</span> glob</span>
<span id="cb2-112"><a href="#cb2-112"></a>    <span class="im">from</span> itertools <span class="im">import</span> chain</span>
<span id="cb2-113"><a href="#cb2-113"></a>    <span class="im">from</span> netCDF4 <span class="im">import</span> Dataset</span>
<span id="cb2-114"><a href="#cb2-114"></a>    <span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb2-115"><a href="#cb2-115"></a>    <span class="im">import</span> numpy.ma <span class="im">as</span> ma</span>
<span id="cb2-116"><a href="#cb2-116"></a>    <span class="im">import</span> os</span>
<span id="cb2-117"><a href="#cb2-117"></a>    <span class="im">import</span> sys</span>
<span id="cb2-118"><a href="#cb2-118"></a></span>
<span id="cb2-119"><a href="#cb2-119"></a>    <span class="co"># Ensure 'roylib' is on the import path</span></span>
<span id="cb2-120"><a href="#cb2-120"></a>    sys.path.append(<span class="st">'/home/cwatch/pythonLibs'</span>)</span>
<span id="cb2-121"><a href="#cb2-121"></a>    <span class="im">from</span> roylib <span class="im">import</span> <span class="op">*</span></span>
<span id="cb2-122"><a href="#cb2-122"></a></span>
<span id="cb2-123"><a href="#cb2-123"></a>    <span class="co"># Directory with 1-day MW NetCDFs</span></span>
<span id="cb2-124"><a href="#cb2-124"></a>    dataDir <span class="op">=</span> sys.argv[<span class="dv">1</span>]</span>
<span id="cb2-125"><a href="#cb2-125"></a></span>
<span id="cb2-126"><a href="#cb2-126"></a>    <span class="co"># Temporary working directory</span></span>
<span id="cb2-127"><a href="#cb2-127"></a>    workDir <span class="op">=</span> sys.argv[<span class="dv">2</span>]</span>
<span id="cb2-128"><a href="#cb2-128"></a></span>
<span id="cb2-129"><a href="#cb2-129"></a>    <span class="co"># Composite end year (YYYY)</span></span>
<span id="cb2-130"><a href="#cb2-130"></a>    endyearC <span class="op">=</span> sys.argv[<span class="dv">3</span>]</span>
<span id="cb2-131"><a href="#cb2-131"></a></span>
<span id="cb2-132"><a href="#cb2-132"></a>    <span class="co"># Composite end day-of-year (DDD)</span></span>
<span id="cb2-133"><a href="#cb2-133"></a>    endDoyC <span class="op">=</span> sys.argv[<span class="dv">4</span>]</span>
<span id="cb2-134"><a href="#cb2-134"></a>    endDoyC <span class="op">=</span> endDoyC.rjust(<span class="dv">3</span>, <span class="st">'0'</span>)</span>
<span id="cb2-135"><a href="#cb2-135"></a></span>
<span id="cb2-136"><a href="#cb2-136"></a>    <span class="co"># Integer form of end day-of-year</span></span>
<span id="cb2-137"><a href="#cb2-137"></a>    endDoy <span class="op">=</span> <span class="bu">int</span>(endDoyC)</span>
<span id="cb2-138"><a href="#cb2-138"></a></span>
<span id="cb2-139"><a href="#cb2-139"></a>    <span class="co"># Composite length</span></span>
<span id="cb2-140"><a href="#cb2-140"></a>    intervalC <span class="op">=</span> sys.argv[<span class="dv">5</span>]</span>
<span id="cb2-141"><a href="#cb2-141"></a>    interval <span class="op">=</span> <span class="bu">int</span>(intervalC)</span>
<span id="cb2-142"><a href="#cb2-142"></a></span>
<span id="cb2-143"><a href="#cb2-143"></a>    <span class="co"># Convert end Doy to calendar date</span></span>
<span id="cb2-144"><a href="#cb2-144"></a>    myDateEnd <span class="op">=</span> datetime(<span class="bu">int</span>(endyearC), <span class="dv">1</span>, <span class="dv">1</span>) <span class="op">+</span> timedelta(<span class="bu">int</span>(endDoyC) <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb2-145"><a href="#cb2-145"></a></span>
<span id="cb2-146"><a href="#cb2-146"></a>    <span class="co"># Start date = end date minus (interval-1) days</span></span>
<span id="cb2-147"><a href="#cb2-147"></a>    myDateStart <span class="op">=</span> myDateEnd <span class="op">+</span> timedelta(days<span class="op">=-</span>(interval <span class="op">-</span> <span class="dv">1</span>))</span>
<span id="cb2-148"><a href="#cb2-148"></a></span>
<span id="cb2-149"><a href="#cb2-149"></a>    <span class="co"># Zero-padded start Doy and year</span></span>
<span id="cb2-150"><a href="#cb2-150"></a>    startDoyC <span class="op">=</span> myDateStart.strftime(<span class="st">"%j"</span>).zfill(<span class="dv">3</span>)</span>
<span id="cb2-151"><a href="#cb2-151"></a>    startDoy <span class="op">=</span> <span class="bu">int</span>(startDoyC)</span>
<span id="cb2-152"><a href="#cb2-152"></a>    startYearC <span class="op">=</span> <span class="bu">str</span>(myDateStart.year)</span>
<span id="cb2-153"><a href="#cb2-153"></a></span>
<span id="cb2-154"><a href="#cb2-154"></a>    <span class="co"># Prepare output directory </span></span>
<span id="cb2-155"><a href="#cb2-155"></a>    outDir <span class="op">=</span> <span class="st">'/ERDData1/modisa/data/modsiwc/'</span> <span class="op">+</span> endyearC <span class="op">+</span> <span class="st">'/'</span> <span class="op">+</span> intervalC <span class="op">+</span> <span class="st">'day'</span></span>
<span id="cb2-156"><a href="#cb2-156"></a></span>
<span id="cb2-157"><a href="#cb2-157"></a>    <span class="bu">print</span>(dataDir)</span>
<span id="cb2-158"><a href="#cb2-158"></a>    <span class="bu">print</span>(workDir)</span>
<span id="cb2-159"><a href="#cb2-159"></a>    <span class="bu">print</span>(endyearC)</span>
<span id="cb2-160"><a href="#cb2-160"></a>    <span class="bu">print</span>(endDoyC)</span>
<span id="cb2-161"><a href="#cb2-161"></a>    <span class="bu">print</span>(intervalC)</span>
<span id="cb2-162"><a href="#cb2-162"></a></span>
<span id="cb2-163"><a href="#cb2-163"></a>    <span class="co"># List of parameters to composite</span></span>
<span id="cb2-164"><a href="#cb2-164"></a>    dtypeList <span class="op">=</span> [<span class="st">'chla'</span>, <span class="st">'k490'</span>, <span class="st">'par0'</span>, <span class="st">'cflh'</span>]</span>
<span id="cb2-165"><a href="#cb2-165"></a></span>
<span id="cb2-166"><a href="#cb2-166"></a>    <span class="co"># Loop over each variable type</span></span>
<span id="cb2-167"><a href="#cb2-167"></a>    <span class="cf">for</span> dtype <span class="kw">in</span> dtypeList:</span>
<span id="cb2-168"><a href="#cb2-168"></a>        <span class="co"># Clear working directory</span></span>
<span id="cb2-169"><a href="#cb2-169"></a>        os.chdir(workDir)</span>
<span id="cb2-170"><a href="#cb2-170"></a>        os.system(<span class="st">'rm -f *'</span>)</span>
<span id="cb2-171"><a href="#cb2-171"></a></span>
<span id="cb2-172"><a href="#cb2-172"></a>        <span class="co"># Move to data directory</span></span>
<span id="cb2-173"><a href="#cb2-173"></a>        os.chdir(dataDir)</span>
<span id="cb2-174"><a href="#cb2-174"></a></span>
<span id="cb2-175"><a href="#cb2-175"></a>        <span class="co"># Preallocate sum (mean) and count arrays matching grid dims</span></span>
<span id="cb2-176"><a href="#cb2-176"></a>        mean <span class="op">=</span> np.zeros((<span class="dv">2321</span>, <span class="dv">4001</span>), np.single)</span>
<span id="cb2-177"><a href="#cb2-177"></a>        num <span class="op">=</span> np.zeros((<span class="dv">2321</span>, <span class="dv">4001</span>), dtype<span class="op">=</span>np.int32)</span>
<span id="cb2-178"><a href="#cb2-178"></a></span>
<span id="cb2-179"><a href="#cb2-179"></a>        <span class="co"># If composite does not cross year boundary</span></span>
<span id="cb2-180"><a href="#cb2-180"></a>        <span class="cf">if</span> (endDoy <span class="op">&gt;</span> startDoy):</span>
<span id="cb2-181"><a href="#cb2-181"></a>            doyRange <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(startDoy, endDoy<span class="op">+</span><span class="dv">1</span>))</span>
<span id="cb2-182"><a href="#cb2-182"></a>            fileList <span class="op">=</span> []</span>
<span id="cb2-183"><a href="#cb2-183"></a>            <span class="co"># Gather matching files for each day in range</span></span>
<span id="cb2-184"><a href="#cb2-184"></a>            <span class="cf">for</span> doy <span class="kw">in</span> doyRange:</span>
<span id="cb2-185"><a href="#cb2-185"></a>                doyC <span class="op">=</span> <span class="bu">str</span>(doy)</span>
<span id="cb2-186"><a href="#cb2-186"></a>                doyC <span class="op">=</span> doyC.rjust(<span class="dv">3</span>, <span class="st">'0'</span>)</span>
<span id="cb2-187"><a href="#cb2-187"></a>                myString <span class="op">=</span> <span class="st">'MW'</span> <span class="op">+</span> endyearC <span class="op">+</span> doyC <span class="op">+</span> <span class="st">'*'</span> <span class="op">+</span> dtype <span class="op">+</span> <span class="st">'.nc'</span></span>
<span id="cb2-188"><a href="#cb2-188"></a>                fileList.append(glob.glob(myString))</span>
<span id="cb2-189"><a href="#cb2-189"></a>            </span>
<span id="cb2-190"><a href="#cb2-190"></a>            <span class="co"># Flatten and sort list of lists</span></span>
<span id="cb2-191"><a href="#cb2-191"></a>            fileList<span class="op">=</span><span class="bu">list</span>(chain.from_iterable(fileList))</span>
<span id="cb2-192"><a href="#cb2-192"></a>            fileList.sort()</span>
<span id="cb2-193"><a href="#cb2-193"></a></span>
<span id="cb2-194"><a href="#cb2-194"></a>            filesUsed <span class="op">=</span> <span class="st">""</span></span>
<span id="cb2-195"><a href="#cb2-195"></a>            <span class="bu">print</span>(fileList)</span>
<span id="cb2-196"><a href="#cb2-196"></a>            <span class="cf">for</span> fName <span class="kw">in</span> fileList:</span>
<span id="cb2-197"><a href="#cb2-197"></a>                <span class="co"># Build comma-separated provenance string</span></span>
<span id="cb2-198"><a href="#cb2-198"></a>                <span class="cf">if</span> (<span class="bu">len</span>(filesUsed) <span class="op">==</span> <span class="dv">0</span>):</span>
<span id="cb2-199"><a href="#cb2-199"></a>                    filesUsed <span class="op">=</span> fName</span>
<span id="cb2-200"><a href="#cb2-200"></a>                <span class="cf">else</span>:</span>
<span id="cb2-201"><a href="#cb2-201"></a>                    filesUsed <span class="op">=</span> filesUsed <span class="op">+</span> <span class="st">', '</span> <span class="op">+</span> fName</span>
<span id="cb2-202"><a href="#cb2-202"></a></span>
<span id="cb2-203"><a href="#cb2-203"></a>                <span class="co"># Read the variable from NetCDF and accumulate</span></span>
<span id="cb2-204"><a href="#cb2-204"></a>                chlaFile <span class="op">=</span> Dataset(fName)</span>
<span id="cb2-205"><a href="#cb2-205"></a>                param <span class="op">=</span> <span class="st">'MW'</span> <span class="op">+</span> dtype</span>
<span id="cb2-206"><a href="#cb2-206"></a>                chla <span class="op">=</span> chlaFile.variables[param][:, :, :, :]</span>
<span id="cb2-207"><a href="#cb2-207"></a>                chlaFile.close()</span>
<span id="cb2-208"><a href="#cb2-208"></a>                chla <span class="op">=</span> np.squeeze(chla)</span>
<span id="cb2-209"><a href="#cb2-209"></a></span>
<span id="cb2-210"><a href="#cb2-210"></a>                <span class="co"># Update running mean and count arrays</span></span>
<span id="cb2-211"><a href="#cb2-211"></a>                mean, num <span class="op">=</span> meanVar(mean, num, chla)</span>
<span id="cb2-212"><a href="#cb2-212"></a></span>
<span id="cb2-213"><a href="#cb2-213"></a>        <span class="cf">else</span>:</span>
<span id="cb2-214"><a href="#cb2-214"></a>            <span class="co"># Composite spans year boundary: first part in startYearC</span></span>
<span id="cb2-215"><a href="#cb2-215"></a>            dataDir1 <span class="op">=</span> dataDir</span>
<span id="cb2-216"><a href="#cb2-216"></a>            dataDir1 <span class="op">=</span> dataDir1.replace(endyearC, startYearC)</span>
<span id="cb2-217"><a href="#cb2-217"></a>            <span class="cf">if</span> (isleap):</span>
<span id="cb2-218"><a href="#cb2-218"></a>                endday <span class="op">=</span> <span class="dv">366</span></span>
<span id="cb2-219"><a href="#cb2-219"></a>            <span class="cf">else</span>:</span>
<span id="cb2-220"><a href="#cb2-220"></a>                endday <span class="op">=</span> <span class="dv">365</span></span>
<span id="cb2-221"><a href="#cb2-221"></a></span>
<span id="cb2-222"><a href="#cb2-222"></a>            fileList <span class="op">=</span> []</span>
<span id="cb2-223"><a href="#cb2-223"></a>            os.chdir(dataDir1)</span>
<span id="cb2-224"><a href="#cb2-224"></a>            <span class="co"># Days from startDoy to end of start year</span></span>
<span id="cb2-225"><a href="#cb2-225"></a>            doyRange <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(startDoy, endday <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb2-226"><a href="#cb2-226"></a>            <span class="cf">for</span> doy <span class="kw">in</span> doyRange:</span>
<span id="cb2-227"><a href="#cb2-227"></a>                doyC <span class="op">=</span> <span class="bu">str</span>(doy)</span>
<span id="cb2-228"><a href="#cb2-228"></a>                doyC <span class="op">=</span> doyC.rjust(<span class="dv">3</span>, <span class="st">'0'</span>)</span>
<span id="cb2-229"><a href="#cb2-229"></a>                myString <span class="op">=</span> <span class="st">'MW'</span> <span class="op">+</span> startYearC <span class="op">+</span> doyC <span class="op">+</span> <span class="st">'*'</span> <span class="op">+</span> dtype <span class="op">+</span> <span class="st">'.nc'</span></span>
<span id="cb2-230"><a href="#cb2-230"></a>                fileList.append(glob.glob(myString))</span>
<span id="cb2-231"><a href="#cb2-231"></a></span>
<span id="cb2-232"><a href="#cb2-232"></a>            fileList <span class="op">=</span> <span class="bu">list</span>(chain.from_iterable(fileList))</span>
<span id="cb2-233"><a href="#cb2-233"></a>            fileList.sort()</span>
<span id="cb2-234"><a href="#cb2-234"></a>            filesUsed <span class="op">=</span> <span class="st">""</span></span>
<span id="cb2-235"><a href="#cb2-235"></a>            <span class="bu">print</span>(fileList)</span>
<span id="cb2-236"><a href="#cb2-236"></a>            <span class="cf">for</span> fName <span class="kw">in</span> fileList:</span>
<span id="cb2-237"><a href="#cb2-237"></a>                <span class="cf">if</span> (<span class="bu">len</span>(filesUsed) <span class="op">==</span> <span class="dv">0</span>):</span>
<span id="cb2-238"><a href="#cb2-238"></a>                    filesUsed <span class="op">=</span> fName</span>
<span id="cb2-239"><a href="#cb2-239"></a>                <span class="cf">else</span>:</span>
<span id="cb2-240"><a href="#cb2-240"></a>                    filesUsed <span class="op">=</span> filesUsed <span class="op">+</span> <span class="st">', '</span> <span class="op">+</span> fName</span>
<span id="cb2-241"><a href="#cb2-241"></a></span>
<span id="cb2-242"><a href="#cb2-242"></a>                chlaFile <span class="op">=</span> Dataset(fName)</span>
<span id="cb2-243"><a href="#cb2-243"></a>                param <span class="op">=</span> <span class="st">'MW'</span> <span class="op">+</span> dtype</span>
<span id="cb2-244"><a href="#cb2-244"></a>                chla <span class="op">=</span> chlaFile.variables[param][:, :, :, :]</span>
<span id="cb2-245"><a href="#cb2-245"></a>                chlaFile.close()</span>
<span id="cb2-246"><a href="#cb2-246"></a>                chla <span class="op">=</span> np.squeeze(chla)</span>
<span id="cb2-247"><a href="#cb2-247"></a>                mean, num <span class="op">=</span> meanVar(mean, num, chla)</span>
<span id="cb2-248"><a href="#cb2-248"></a></span>
<span id="cb2-249"><a href="#cb2-249"></a>            <span class="co"># Days from DOY=1 of end year to endDoy</span></span>
<span id="cb2-250"><a href="#cb2-250"></a>            os.chdir(dataDir)</span>
<span id="cb2-251"><a href="#cb2-251"></a>            fileList <span class="op">=</span> []</span>
<span id="cb2-252"><a href="#cb2-252"></a>            doyRange <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="dv">1</span>, endDoy <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb2-253"><a href="#cb2-253"></a>            <span class="cf">for</span> doy <span class="kw">in</span> doyRange:</span>
<span id="cb2-254"><a href="#cb2-254"></a>                doyC <span class="op">=</span> <span class="bu">str</span>(doy)</span>
<span id="cb2-255"><a href="#cb2-255"></a>                doyC <span class="op">=</span> doyC.rjust(<span class="dv">3</span>, <span class="st">'0'</span>)</span>
<span id="cb2-256"><a href="#cb2-256"></a>                myString <span class="op">=</span> <span class="st">'MW'</span> <span class="op">+</span> endyearC <span class="op">+</span> doyC <span class="op">+</span> <span class="st">'*'</span> <span class="op">+</span> dtype <span class="op">+</span> <span class="st">'.nc'</span></span>
<span id="cb2-257"><a href="#cb2-257"></a>                fileList.append(glob.glob(myString))</span>
<span id="cb2-258"><a href="#cb2-258"></a></span>
<span id="cb2-259"><a href="#cb2-259"></a>            fileList <span class="op">=</span> <span class="bu">list</span>(chain.from_iterable(fileList))</span>
<span id="cb2-260"><a href="#cb2-260"></a>            fileList.sort()</span>
<span id="cb2-261"><a href="#cb2-261"></a>            <span class="bu">print</span>(fileList)</span>
<span id="cb2-262"><a href="#cb2-262"></a>            <span class="cf">for</span> fName <span class="kw">in</span> fileList:</span>
<span id="cb2-263"><a href="#cb2-263"></a>                <span class="cf">if</span> (<span class="bu">len</span>(filesUsed) <span class="op">==</span> <span class="dv">0</span>):</span>
<span id="cb2-264"><a href="#cb2-264"></a>                    filesUsed <span class="op">=</span> fName</span>
<span id="cb2-265"><a href="#cb2-265"></a>                <span class="cf">else</span>:</span>
<span id="cb2-266"><a href="#cb2-266"></a>                    filesUsed <span class="op">=</span> filesUsed <span class="op">+</span> <span class="st">', '</span> <span class="op">+</span> fName</span>
<span id="cb2-267"><a href="#cb2-267"></a></span>
<span id="cb2-268"><a href="#cb2-268"></a>                chlaFile <span class="op">=</span> Dataset(fName)</span>
<span id="cb2-269"><a href="#cb2-269"></a>                param <span class="op">=</span> <span class="st">'MW'</span> <span class="op">+</span> dtype</span>
<span id="cb2-270"><a href="#cb2-270"></a>                chla <span class="op">=</span> chlaFile.variables[param][:, :, :, :]</span>
<span id="cb2-271"><a href="#cb2-271"></a>                chlaFile.close()</span>
<span id="cb2-272"><a href="#cb2-272"></a>                chla <span class="op">=</span> np.squeeze(chla)</span>
<span id="cb2-273"><a href="#cb2-273"></a>                mean, num <span class="op">=</span> meanVar(mean, num, chla)</span>
<span id="cb2-274"><a href="#cb2-274"></a></span>
<span id="cb2-275"><a href="#cb2-275"></a>        <span class="co"># Mask out any grid cells with zero observations, setting them to the fill value</span></span>
<span id="cb2-276"><a href="#cb2-276"></a>        mean <span class="op">=</span> ma.array(mean, mask<span class="op">=</span>(num <span class="op">==</span> <span class="dv">0</span>), fill_value<span class="op">=-</span><span class="fl">9999999.</span>)</span>
<span id="cb2-277"><a href="#cb2-277"></a></span>
<span id="cb2-278"><a href="#cb2-278"></a>        <span class="co"># Switch to the working directory for output operations</span></span>
<span id="cb2-279"><a href="#cb2-279"></a>        os.chdir(workDir)</span>
<span id="cb2-280"><a href="#cb2-280"></a></span>
<span id="cb2-281"><a href="#cb2-281"></a>        <span class="co"># Construct the output filename with start and end dates plus data types</span></span>
<span id="cb2-282"><a href="#cb2-282"></a>        outFile <span class="op">=</span> <span class="st">'MW'</span> <span class="op">+</span> startYearC <span class="op">+</span> startDoyC <span class="op">+</span> <span class="st">'_'</span> <span class="op">+</span> endyearC <span class="op">+</span> endDoyC <span class="op">+</span> <span class="st">'_'</span> <span class="op">+</span> dtype <span class="op">+</span> <span class="st">'.nc'</span></span>
<span id="cb2-283"><a href="#cb2-283"></a></span>
<span id="cb2-284"><a href="#cb2-284"></a>        <span class="co"># Create multi-day NetCDF file using the mean and count arrays</span></span>
<span id="cb2-285"><a href="#cb2-285"></a>        ncFile <span class="op">=</span> makeNetcdf(mean, num, interval, outFile, filesUsed, workDir)</span>
<span id="cb2-286"><a href="#cb2-286"></a></span>
<span id="cb2-287"><a href="#cb2-287"></a>        <span class="co"># Directory on the remote server for storing the multi-day data product</span></span>
<span id="cb2-288"><a href="#cb2-288"></a>        remote_dir <span class="op">=</span> <span class="st">'/MW/'</span> <span class="op">+</span> dtype <span class="op">+</span> <span class="st">'/'</span></span>
<span id="cb2-289"><a href="#cb2-289"></a></span>
<span id="cb2-290"><a href="#cb2-290"></a>        <span class="co"># Transfer the generated NetCDF file to the remote server directory</span></span>
<span id="cb2-291"><a href="#cb2-291"></a>        send_to_servers(ncFile, remote_dir , <span class="bu">str</span>(interval))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="compmwchlamday" class="level3">
<h3 class="anchored" data-anchor-id="compmwchlamday">CompMWChlamday</h3>
<p><code>CompMWChlamday.py</code> reads 1-day composite MW NetCDFs for chlorophyll-a, Kd490, PAR(0), and CFLH and accumulates them over a user-defined interval on a regular 0.0125° x 0.0125° grid spanning longitude 205°–255° and latitude 22°–51°. It computes the monthly mean by summing and counting valid observations, masks out grid cells with no data, writes CF-compliant NetCDF composites, and upload to a directory on a remote server Find the monthly product on ERDDAP <a href="./modisa_scripts.html#modisa-products-on-swfsc-erddap-server">here</a>.</p>
<p>The following chart summarizes the script’s workflow:</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">%%{init: {"flowchart":{"htmlLabels":true}}}%%
flowchart LR
  I("&lt;b&gt;Inputs&lt;/b&gt;&lt;br/&gt;• 1-day composite NetCDFs (dataDir)&lt;br/&gt;• workDir&lt;br/&gt;• endYear &amp; endDoy&lt;br/&gt;• startDoy")
    --&gt; P("&lt;b&gt;Processing&lt;/b&gt;&lt;br/&gt;• Parse args &amp; compute interval&lt;br/&gt;• Compute start/end dates&lt;br/&gt;• Clear workDir &amp; initialize mean/num arrays&lt;br/&gt;• Gather files spanning startDoy…endDoy&lt;br/&gt;• Loop: open each file &amp; update mean/num&lt;br/&gt;• Mask zero‐observation pixels")
    --&gt; O("&lt;b&gt;Output&lt;/b&gt;&lt;br/&gt;• CF-compliant monthly composite NetCDF&lt;br/&gt;• Deployed to /MW/chla/mday/")
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<div id="1095b71e" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>View CompMWChlamday.py</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1"></a><span class="co">"""</span></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="co">Overview</span></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="co">--------</span></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="co">Generate monthly composites of chlorophyll-a, Kd_490, PAR0, and CFLH</span></span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="co">for the MODIS MW (West Coast) region by accumulating 1-day NetCDF products.</span></span>
<span id="cb3-6"><a href="#cb3-6"></a></span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="co">Usage</span></span>
<span id="cb3-8"><a href="#cb3-8"></a><span class="co">-----</span></span>
<span id="cb3-9"><a href="#cb3-9"></a><span class="co">::</span></span>
<span id="cb3-10"><a href="#cb3-10"></a><span class="co"> </span></span>
<span id="cb3-11"><a href="#cb3-11"></a><span class="co">     python CompMWChlamday.py &lt;dataDir&gt; &lt;workDir&gt; &lt;endYear&gt; &lt;endDoy&gt; &lt;startDoy&gt;</span></span>
<span id="cb3-12"><a href="#cb3-12"></a></span>
<span id="cb3-13"><a href="#cb3-13"></a><span class="co">Description</span></span>
<span id="cb3-14"><a href="#cb3-14"></a><span class="co">-----------</span></span>
<span id="cb3-15"><a href="#cb3-15"></a><span class="co">1. **Parse arguments &amp; compute interval** </span></span>
<span id="cb3-16"><a href="#cb3-16"></a></span>
<span id="cb3-17"><a href="#cb3-17"></a><span class="co">  - Read ``dataDir``, ``workDir``, ``endYear``, ``endDoy``, and ``startDoy``.  </span></span>
<span id="cb3-18"><a href="#cb3-18"></a><span class="co">  </span></span>
<span id="cb3-19"><a href="#cb3-19"></a><span class="co">  - Compute the number of days ``interval = endDoy - startDoy + 1``.</span></span>
<span id="cb3-20"><a href="#cb3-20"></a></span>
<span id="cb3-21"><a href="#cb3-21"></a><span class="co">2. **Compute calendar dates**</span></span>
<span id="cb3-22"><a href="#cb3-22"></a></span>
<span id="cb3-23"><a href="#cb3-23"></a><span class="co">  - Convert ``startDoy``/``endDoy`` to ``datetime`` for logging/output paths.</span></span>
<span id="cb3-24"><a href="#cb3-24"></a></span>
<span id="cb3-25"><a href="#cb3-25"></a><span class="co">3. **Loop over each parameter**</span></span>
<span id="cb3-26"><a href="#cb3-26"></a></span>
<span id="cb3-27"><a href="#cb3-27"></a><span class="co">  For each in ``['chla','k490','par0','cflh']``:</span></span>
<span id="cb3-28"><a href="#cb3-28"></a></span>
<span id="cb3-29"><a href="#cb3-29"></a><span class="co">     - **Initialize sum &amp; count arrays** of shape 2321x4001.</span></span>
<span id="cb3-30"><a href="#cb3-30"></a></span>
<span id="cb3-31"><a href="#cb3-31"></a><span class="co">     - **Gather all matching 1-day NetCDF files** between ``startDoy``…``endDoy``, handling both same-year and wrap-around cases.</span></span>
<span id="cb3-32"><a href="#cb3-32"></a></span>
<span id="cb3-33"><a href="#cb3-33"></a><span class="co">     - **For each file**:</span></span>
<span id="cb3-34"><a href="#cb3-34"></a></span>
<span id="cb3-35"><a href="#cb3-35"></a><span class="co">         - Open with ``netCDF4.Dataset``, read 4D variable ``MW&lt;param&gt;``, squeeze to 2D.</span></span>
<span id="cb3-36"><a href="#cb3-36"></a></span>
<span id="cb3-37"><a href="#cb3-37"></a><span class="co">         - Update running totals (``mean``) and counts (``num``) via ``meanVar()``.</span></span>
<span id="cb3-38"><a href="#cb3-38"></a></span>
<span id="cb3-39"><a href="#cb3-39"></a><span class="co">     - **Mask out** grid cells with zero observations (``num==0``), fill with -9999999.0.</span></span>
<span id="cb3-40"><a href="#cb3-40"></a></span>
<span id="cb3-41"><a href="#cb3-41"></a><span class="co">     - **Write** composite via ``makeNetcdfmDay()``.</span></span>
<span id="cb3-42"><a href="#cb3-42"></a></span>
<span id="cb3-43"><a href="#cb3-43"></a><span class="co">     - **Send** result to ``/MW/&lt;param&gt;/mday/`` on the server.</span></span>
<span id="cb3-44"><a href="#cb3-44"></a></span>
<span id="cb3-45"><a href="#cb3-45"></a><span class="co">Dependencies</span></span>
<span id="cb3-46"><a href="#cb3-46"></a><span class="co">------------</span></span>
<span id="cb3-47"><a href="#cb3-47"></a><span class="co">- **Python 3.x**</span></span>
<span id="cb3-48"><a href="#cb3-48"></a></span>
<span id="cb3-49"><a href="#cb3-49"></a><span class="co">- **Standard library:** ``os``, ``sys``, ``glob``, ``itertools.chain``, ``datetime``, ``timedelta``</span></span>
<span id="cb3-50"><a href="#cb3-50"></a></span>
<span id="cb3-51"><a href="#cb3-51"></a><span class="co">- **Third-party:** ``numpy``, ``numpy.ma``, ``netCDF4``</span></span>
<span id="cb3-52"><a href="#cb3-52"></a></span>
<span id="cb3-53"><a href="#cb3-53"></a><span class="co">- **Custom roylib functions:**</span></span>
<span id="cb3-54"><a href="#cb3-54"></a></span>
<span id="cb3-55"><a href="#cb3-55"></a><span class="co">  - ``isleap(year)``</span></span>
<span id="cb3-56"><a href="#cb3-56"></a></span>
<span id="cb3-57"><a href="#cb3-57"></a><span class="co">  - ``meanVar(sum_array, count_array, data_slice)``</span></span>
<span id="cb3-58"><a href="#cb3-58"></a></span>
<span id="cb3-59"><a href="#cb3-59"></a><span class="co">  - ``makeNetcdfmDay(mean, num, interval, outFile, filesUsed, workDir)``</span></span>
<span id="cb3-60"><a href="#cb3-60"></a></span>
<span id="cb3-61"><a href="#cb3-61"></a><span class="co">  - ``send_to_servers(ncFile, remote_dir, 'm')``</span></span>
<span id="cb3-62"><a href="#cb3-62"></a></span>
<span id="cb3-63"><a href="#cb3-63"></a><span class="co">Directory Structure</span></span>
<span id="cb3-64"><a href="#cb3-64"></a><span class="co">-------------------</span></span>
<span id="cb3-65"><a href="#cb3-65"></a><span class="co">- **Input Directory (dataDir):**</span></span>
<span id="cb3-66"><a href="#cb3-66"></a></span>
<span id="cb3-67"><a href="#cb3-67"></a><span class="co">  Contains 1-day NetCDFs named ``MW&lt;YYYY&gt;&lt;DDD&gt;_&lt;param&gt;.nc``.</span></span>
<span id="cb3-68"><a href="#cb3-68"></a></span>
<span id="cb3-69"><a href="#cb3-69"></a><span class="co">- **Working Directory (workDir):**</span></span>
<span id="cb3-70"><a href="#cb3-70"></a></span>
<span id="cb3-71"><a href="#cb3-71"></a><span class="co">  Scratch space; cleared each loop.</span></span>
<span id="cb3-72"><a href="#cb3-72"></a></span>
<span id="cb3-73"><a href="#cb3-73"></a><span class="co">- **Output location (remote):**</span></span>
<span id="cb3-74"><a href="#cb3-74"></a></span>
<span id="cb3-75"><a href="#cb3-75"></a><span class="co">  ``/MW/chla/mday/``, ``/MW/k490/mday/``, etc.</span></span>
<span id="cb3-76"><a href="#cb3-76"></a></span>
<span id="cb3-77"><a href="#cb3-77"></a><span class="co">Usage Example</span></span>
<span id="cb3-78"><a href="#cb3-78"></a><span class="co">-------------</span></span>
<span id="cb3-79"><a href="#cb3-79"></a><span class="co">Generate a composite for the month of January 2025 (DOY 001-031):</span></span>
<span id="cb3-80"><a href="#cb3-80"></a></span>
<span id="cb3-81"><a href="#cb3-81"></a><span class="co">::</span></span>
<span id="cb3-82"><a href="#cb3-82"></a><span class="co"> </span></span>
<span id="cb3-83"><a href="#cb3-83"></a><span class="co">     python CompMWChlamday.py /data/mw/1day/ /tmp/mwwork/ 2025 031 001</span></span>
<span id="cb3-84"><a href="#cb3-84"></a></span>
<span id="cb3-85"><a href="#cb3-85"></a><span class="co">This command will:</span></span>
<span id="cb3-86"><a href="#cb3-86"></a></span>
<span id="cb3-87"><a href="#cb3-87"></a><span class="co">  - Read daily files ``MB2025001..Mb2025031``, computes the January composite.</span></span>
<span id="cb3-88"><a href="#cb3-88"></a></span>
<span id="cb3-89"><a href="#cb3-89"></a><span class="co">  - Writes MB2025001_2025031_chla.nc in ``/tmp/mw_work/``.</span></span>
<span id="cb3-90"><a href="#cb3-90"></a></span>
<span id="cb3-91"><a href="#cb3-91"></a><span class="co">  - Uploads it to ``/MB/chla/`` on the server.</span></span>
<span id="cb3-92"><a href="#cb3-92"></a></span>
<span id="cb3-93"><a href="#cb3-93"></a><span class="co">"""</span></span>
<span id="cb3-94"><a href="#cb3-94"></a><span class="im">from</span> __future__ <span class="im">import</span> print_function</span>
<span id="cb3-95"><a href="#cb3-95"></a><span class="im">from</span> builtins <span class="im">import</span> <span class="bu">str</span></span>
<span id="cb3-96"><a href="#cb3-96"></a><span class="im">from</span> builtins <span class="im">import</span> <span class="bu">range</span></span>
<span id="cb3-97"><a href="#cb3-97"></a></span>
<span id="cb3-98"><a href="#cb3-98"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb3-99"><a href="#cb3-99"></a>    <span class="im">from</span> datetime <span class="im">import</span> datetime, timedelta</span>
<span id="cb3-100"><a href="#cb3-100"></a>    <span class="im">import</span> glob</span>
<span id="cb3-101"><a href="#cb3-101"></a>    <span class="im">from</span> itertools <span class="im">import</span> chain</span>
<span id="cb3-102"><a href="#cb3-102"></a>    <span class="im">from</span> netCDF4 <span class="im">import</span> Dataset</span>
<span id="cb3-103"><a href="#cb3-103"></a>    <span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb3-104"><a href="#cb3-104"></a>    <span class="im">import</span> numpy.ma <span class="im">as</span> ma</span>
<span id="cb3-105"><a href="#cb3-105"></a>    <span class="im">import</span> os</span>
<span id="cb3-106"><a href="#cb3-106"></a>    <span class="im">import</span> sys</span>
<span id="cb3-107"><a href="#cb3-107"></a></span>
<span id="cb3-108"><a href="#cb3-108"></a>    <span class="co"># Ensure 'roylib' is on the import path</span></span>
<span id="cb3-109"><a href="#cb3-109"></a>    sys.path.append(<span class="st">'/home/cwatch/pythonLibs'</span>)</span>
<span id="cb3-110"><a href="#cb3-110"></a>    <span class="im">from</span> roylib <span class="im">import</span> <span class="op">*</span></span>
<span id="cb3-111"><a href="#cb3-111"></a></span>
<span id="cb3-112"><a href="#cb3-112"></a>    <span class="co"># Directory with 1-day MW NetCDFs</span></span>
<span id="cb3-113"><a href="#cb3-113"></a>    dataDir <span class="op">=</span> sys.argv[<span class="dv">1</span>]</span>
<span id="cb3-114"><a href="#cb3-114"></a></span>
<span id="cb3-115"><a href="#cb3-115"></a>    <span class="co"># Temporary working directory</span></span>
<span id="cb3-116"><a href="#cb3-116"></a>    workDir <span class="op">=</span> sys.argv[<span class="dv">2</span>]</span>
<span id="cb3-117"><a href="#cb3-117"></a></span>
<span id="cb3-118"><a href="#cb3-118"></a>    <span class="co"># Composite end year</span></span>
<span id="cb3-119"><a href="#cb3-119"></a>    endyearC <span class="op">=</span> sys.argv[<span class="dv">3</span>]</span>
<span id="cb3-120"><a href="#cb3-120"></a>    endyear <span class="op">=</span> <span class="bu">int</span>(endyearC)</span>
<span id="cb3-121"><a href="#cb3-121"></a></span>
<span id="cb3-122"><a href="#cb3-122"></a>    <span class="co"># Start year </span></span>
<span id="cb3-123"><a href="#cb3-123"></a>    startYearC <span class="op">=</span> endyearC</span>
<span id="cb3-124"><a href="#cb3-124"></a>    startyear <span class="op">=</span> <span class="bu">int</span>(startYearC)</span>
<span id="cb3-125"><a href="#cb3-125"></a></span>
<span id="cb3-126"><a href="#cb3-126"></a>    <span class="co"># Composite end day-of-year</span></span>
<span id="cb3-127"><a href="#cb3-127"></a>    endDoyC <span class="op">=</span> sys.argv[<span class="dv">4</span>]</span>
<span id="cb3-128"><a href="#cb3-128"></a>    endDoyC <span class="op">=</span> endDoyC.rjust(<span class="dv">3</span>, <span class="st">'0'</span>)</span>
<span id="cb3-129"><a href="#cb3-129"></a>    endDoy <span class="op">=</span> <span class="bu">int</span>(endDoyC)</span>
<span id="cb3-130"><a href="#cb3-130"></a></span>
<span id="cb3-131"><a href="#cb3-131"></a>    <span class="co"># Composite start day-of-year</span></span>
<span id="cb3-132"><a href="#cb3-132"></a>    startDoyC <span class="op">=</span> sys.argv[<span class="dv">5</span>]</span>
<span id="cb3-133"><a href="#cb3-133"></a>    startDoyC <span class="op">=</span> startDoyC.rjust(<span class="dv">3</span>, <span class="st">'0'</span>)</span>
<span id="cb3-134"><a href="#cb3-134"></a>    startDoy <span class="op">=</span> <span class="bu">int</span>(startDoyC)</span>
<span id="cb3-135"><a href="#cb3-135"></a></span>
<span id="cb3-136"><a href="#cb3-136"></a>    <span class="co"># Number of days in the composite</span></span>
<span id="cb3-137"><a href="#cb3-137"></a>    interval <span class="op">=</span> endDoy <span class="op">-</span> startDoy <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb3-138"><a href="#cb3-138"></a></span>
<span id="cb3-139"><a href="#cb3-139"></a>    <span class="co"># Compute calendar dats for logging or directory creation</span></span>
<span id="cb3-140"><a href="#cb3-140"></a>    myDateEnd <span class="op">=</span> datetime(endyear, <span class="dv">1</span>, <span class="dv">1</span>) <span class="op">+</span> timedelta(endDoy <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb3-141"><a href="#cb3-141"></a>    myDateStart <span class="op">=</span> datetime(startyear, <span class="dv">1</span>, <span class="dv">1</span>) <span class="op">+</span> timedelta(startDoy <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb3-142"><a href="#cb3-142"></a></span>
<span id="cb3-143"><a href="#cb3-143"></a>    <span class="co"># Output directory on server</span></span>
<span id="cb3-144"><a href="#cb3-144"></a>    outDir <span class="op">=</span> <span class="st">'/ERDData1/modisa/data/modsiwc/'</span> <span class="op">+</span> endyearC <span class="op">+</span> <span class="st">'/mday'</span></span>
<span id="cb3-145"><a href="#cb3-145"></a></span>
<span id="cb3-146"><a href="#cb3-146"></a>    <span class="bu">print</span>(dataDir)</span>
<span id="cb3-147"><a href="#cb3-147"></a>    <span class="bu">print</span>(workDir)</span>
<span id="cb3-148"><a href="#cb3-148"></a>    <span class="bu">print</span>(endyearC)</span>
<span id="cb3-149"><a href="#cb3-149"></a>    <span class="bu">print</span>(endDoyC)</span>
<span id="cb3-150"><a href="#cb3-150"></a>    <span class="bu">print</span>(interval)</span>
<span id="cb3-151"><a href="#cb3-151"></a></span>
<span id="cb3-152"><a href="#cb3-152"></a>    <span class="co"># List of variables to composite</span></span>
<span id="cb3-153"><a href="#cb3-153"></a>    dtypeList <span class="op">=</span> [<span class="st">'chla'</span>, <span class="st">'k490'</span>, <span class="st">'par0'</span>, <span class="st">'cflh'</span>]</span>
<span id="cb3-154"><a href="#cb3-154"></a>    <span class="cf">for</span> dtype <span class="kw">in</span> dtypeList:</span>
<span id="cb3-155"><a href="#cb3-155"></a>        <span class="co"># Clear working directory</span></span>
<span id="cb3-156"><a href="#cb3-156"></a>        os.chdir(workDir)</span>
<span id="cb3-157"><a href="#cb3-157"></a>        os.system(<span class="st">'rm -f *'</span>)</span>
<span id="cb3-158"><a href="#cb3-158"></a></span>
<span id="cb3-159"><a href="#cb3-159"></a>        <span class="co"># Move to input directory</span></span>
<span id="cb3-160"><a href="#cb3-160"></a>        os.chdir(dataDir)</span>
<span id="cb3-161"><a href="#cb3-161"></a></span>
<span id="cb3-162"><a href="#cb3-162"></a>        <span class="co"># Initialize sum and count arrays</span></span>
<span id="cb3-163"><a href="#cb3-163"></a>        mean <span class="op">=</span> np.zeros((<span class="dv">2321</span>, <span class="dv">4001</span>), np.single)</span>
<span id="cb3-164"><a href="#cb3-164"></a>        num <span class="op">=</span> np.zeros((<span class="dv">2321</span>, <span class="dv">4001</span>), dtype<span class="op">=</span>np.int32)</span>
<span id="cb3-165"><a href="#cb3-165"></a></span>
<span id="cb3-166"><a href="#cb3-166"></a>        <span class="co"># Composite within same calendar year</span></span>
<span id="cb3-167"><a href="#cb3-167"></a>        <span class="cf">if</span> (endDoy <span class="op">&gt;</span> startDoy):</span>
<span id="cb3-168"><a href="#cb3-168"></a>            doyRange <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(startDoy, endDoy <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb3-169"><a href="#cb3-169"></a>            fileList <span class="op">=</span> []</span>
<span id="cb3-170"><a href="#cb3-170"></a>            <span class="co"># Gather all matching NetCDF filenames for each DOY</span></span>
<span id="cb3-171"><a href="#cb3-171"></a>            <span class="cf">for</span> doy <span class="kw">in</span> doyRange:</span>
<span id="cb3-172"><a href="#cb3-172"></a>                doyC <span class="op">=</span> <span class="bu">str</span>(doy)</span>
<span id="cb3-173"><a href="#cb3-173"></a>                doyC <span class="op">=</span> doyC.rjust(<span class="dv">3</span>, <span class="st">'0'</span>)</span>
<span id="cb3-174"><a href="#cb3-174"></a>                myString <span class="op">=</span> <span class="st">'MW'</span> <span class="op">+</span> endyearC <span class="op">+</span> doyC <span class="op">+</span> <span class="st">'*'</span> <span class="op">+</span> dtype <span class="op">+</span> <span class="st">'.nc'</span></span>
<span id="cb3-175"><a href="#cb3-175"></a>                fileList.append(glob.glob(myString))</span>
<span id="cb3-176"><a href="#cb3-176"></a></span>
<span id="cb3-177"><a href="#cb3-177"></a>            <span class="co"># Flatten and sort the list</span></span>
<span id="cb3-178"><a href="#cb3-178"></a>            fileList <span class="op">=</span> <span class="bu">list</span>(chain.from_iterable(fileList))</span>
<span id="cb3-179"><a href="#cb3-179"></a>            fileList.sort()</span>
<span id="cb3-180"><a href="#cb3-180"></a></span>
<span id="cb3-181"><a href="#cb3-181"></a>            filesUsed <span class="op">=</span> <span class="st">""</span></span>
<span id="cb3-182"><a href="#cb3-182"></a>            <span class="bu">print</span>(fileList)</span>
<span id="cb3-183"><a href="#cb3-183"></a></span>
<span id="cb3-184"><a href="#cb3-184"></a>            <span class="co"># Loop over each file, accumulate the variable</span></span>
<span id="cb3-185"><a href="#cb3-185"></a>            <span class="cf">for</span> fName <span class="kw">in</span> fileList:</span>
<span id="cb3-186"><a href="#cb3-186"></a>                <span class="cf">if</span> (<span class="bu">len</span>(filesUsed) <span class="op">==</span> <span class="dv">0</span>):</span>
<span id="cb3-187"><a href="#cb3-187"></a>                    filesUsed <span class="op">=</span> fName</span>
<span id="cb3-188"><a href="#cb3-188"></a>                <span class="cf">else</span>:</span>
<span id="cb3-189"><a href="#cb3-189"></a>                    filesUsed <span class="op">=</span> filesUsed <span class="op">+</span> <span class="st">', '</span> <span class="op">+</span> fName</span>
<span id="cb3-190"><a href="#cb3-190"></a></span>
<span id="cb3-191"><a href="#cb3-191"></a>                chlaFile <span class="op">=</span> Dataset(fName)</span>
<span id="cb3-192"><a href="#cb3-192"></a>                param <span class="op">=</span> <span class="st">'MW'</span> <span class="op">+</span> dtype</span>
<span id="cb3-193"><a href="#cb3-193"></a>                chla <span class="op">=</span> chlaFile.variables[param][:, :, :, :]</span>
<span id="cb3-194"><a href="#cb3-194"></a>                chlaFile.close()</span>
<span id="cb3-195"><a href="#cb3-195"></a></span>
<span id="cb3-196"><a href="#cb3-196"></a>                <span class="co"># Remove singleton dimensions -&gt; 2D (lat x lon)</span></span>
<span id="cb3-197"><a href="#cb3-197"></a>                chla <span class="op">=</span> np.squeeze(chla)</span>
<span id="cb3-198"><a href="#cb3-198"></a></span>
<span id="cb3-199"><a href="#cb3-199"></a>                <span class="co"># Update running mean and count</span></span>
<span id="cb3-200"><a href="#cb3-200"></a>                mean, num <span class="op">=</span> meanVar(mean, num, chla)</span>
<span id="cb3-201"><a href="#cb3-201"></a></span>
<span id="cb3-202"><a href="#cb3-202"></a>        <span class="cf">else</span>:</span>
<span id="cb3-203"><a href="#cb3-203"></a>            <span class="co"># Composite spans year boundary</span></span>
<span id="cb3-204"><a href="#cb3-204"></a>            dataDir1 <span class="op">=</span> dataDir</span>
<span id="cb3-205"><a href="#cb3-205"></a>            dataDir1 <span class="op">=</span> dataDir1.replace(endyearC, startYearC)</span>
<span id="cb3-206"><a href="#cb3-206"></a>            <span class="co"># Determine days in start year</span></span>
<span id="cb3-207"><a href="#cb3-207"></a>            <span class="cf">if</span> (isleap):</span>
<span id="cb3-208"><a href="#cb3-208"></a>                endday <span class="op">=</span> <span class="dv">366</span></span>
<span id="cb3-209"><a href="#cb3-209"></a>            <span class="cf">else</span>:</span>
<span id="cb3-210"><a href="#cb3-210"></a>                endday <span class="op">=</span> <span class="dv">365</span></span>
<span id="cb3-211"><a href="#cb3-211"></a></span>
<span id="cb3-212"><a href="#cb3-212"></a>            <span class="co"># DOY startDoy -&gt; end of startYearC</span></span>
<span id="cb3-213"><a href="#cb3-213"></a>            fileList <span class="op">=</span> []</span>
<span id="cb3-214"><a href="#cb3-214"></a>            os.chdir(dataDir1)</span>
<span id="cb3-215"><a href="#cb3-215"></a>            doyRange <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(startDoy, endday <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb3-216"><a href="#cb3-216"></a>            <span class="cf">for</span> doy <span class="kw">in</span> doyRange:</span>
<span id="cb3-217"><a href="#cb3-217"></a>                doyC <span class="op">=</span> <span class="bu">str</span>(doy)</span>
<span id="cb3-218"><a href="#cb3-218"></a>                doyC <span class="op">=</span> doyC.rjust(<span class="dv">3</span>, <span class="st">'0'</span>)</span>
<span id="cb3-219"><a href="#cb3-219"></a>                myString <span class="op">=</span> <span class="st">'MW'</span> <span class="op">+</span> startYearC <span class="op">+</span> doyC <span class="op">+</span> <span class="st">'*'</span> <span class="op">+</span> dtype <span class="op">+</span> <span class="st">'.nc'</span></span>
<span id="cb3-220"><a href="#cb3-220"></a>                fileList.append(glob.glob(myString))</span>
<span id="cb3-221"><a href="#cb3-221"></a>            fileList <span class="op">=</span> <span class="bu">list</span>(chain.from_iterable(fileList))</span>
<span id="cb3-222"><a href="#cb3-222"></a>            fileList.sort()</span>
<span id="cb3-223"><a href="#cb3-223"></a></span>
<span id="cb3-224"><a href="#cb3-224"></a>            filesUsed <span class="op">=</span> <span class="st">""</span></span>
<span id="cb3-225"><a href="#cb3-225"></a>            <span class="bu">print</span>(fileList)</span>
<span id="cb3-226"><a href="#cb3-226"></a>            <span class="cf">for</span> fName <span class="kw">in</span> fileList:</span>
<span id="cb3-227"><a href="#cb3-227"></a>                <span class="cf">if</span> (<span class="bu">len</span>(filesUsed) <span class="op">==</span> <span class="dv">0</span>):</span>
<span id="cb3-228"><a href="#cb3-228"></a>                    filesUsed <span class="op">=</span> fName</span>
<span id="cb3-229"><a href="#cb3-229"></a>                <span class="cf">else</span>:</span>
<span id="cb3-230"><a href="#cb3-230"></a>                    filesUsed <span class="op">=</span> filesUsed <span class="op">+</span> <span class="st">', '</span> <span class="op">+</span> fName</span>
<span id="cb3-231"><a href="#cb3-231"></a></span>
<span id="cb3-232"><a href="#cb3-232"></a>                chlaFile <span class="op">=</span> Dataset(fName)</span>
<span id="cb3-233"><a href="#cb3-233"></a>                param <span class="op">=</span> <span class="st">'MW'</span> <span class="op">+</span> dtype</span>
<span id="cb3-234"><a href="#cb3-234"></a>                chla <span class="op">=</span> chlaFile.variables[param][:, :, :, :]</span>
<span id="cb3-235"><a href="#cb3-235"></a>                chlaFile.close()</span>
<span id="cb3-236"><a href="#cb3-236"></a>                chla <span class="op">=</span> np.squeeze(chla)</span>
<span id="cb3-237"><a href="#cb3-237"></a>                mean, num <span class="op">=</span> meanVar(mean, num, chla)</span>
<span id="cb3-238"><a href="#cb3-238"></a></span>
<span id="cb3-239"><a href="#cb3-239"></a>            <span class="co"># DOY 1 -&gt; endDoy in endYearC</span></span>
<span id="cb3-240"><a href="#cb3-240"></a>            os.chdir(dataDir)</span>
<span id="cb3-241"><a href="#cb3-241"></a>            fileList <span class="op">=</span> []</span>
<span id="cb3-242"><a href="#cb3-242"></a>            doyRange <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="dv">1</span>, endDoy <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb3-243"><a href="#cb3-243"></a>            <span class="cf">for</span> doy <span class="kw">in</span> doyRange:</span>
<span id="cb3-244"><a href="#cb3-244"></a>                doyC <span class="op">=</span> <span class="bu">str</span>(doy)</span>
<span id="cb3-245"><a href="#cb3-245"></a>                doyC <span class="op">=</span> doyC.rjust(<span class="dv">3</span>, <span class="st">'0'</span>)</span>
<span id="cb3-246"><a href="#cb3-246"></a>                myString <span class="op">=</span> <span class="st">'MW'</span> <span class="op">+</span> endyearC <span class="op">+</span> doyC <span class="op">+</span> <span class="st">'*'</span> <span class="op">+</span> dtype <span class="op">+</span> <span class="st">'.nc'</span></span>
<span id="cb3-247"><a href="#cb3-247"></a>                fileList.append(glob.glob(myString))</span>
<span id="cb3-248"><a href="#cb3-248"></a></span>
<span id="cb3-249"><a href="#cb3-249"></a>            fileList <span class="op">=</span> <span class="bu">list</span>(chain.from_iterable(fileList))</span>
<span id="cb3-250"><a href="#cb3-250"></a>            fileList.sort()</span>
<span id="cb3-251"><a href="#cb3-251"></a>            <span class="bu">print</span>(fileList)</span>
<span id="cb3-252"><a href="#cb3-252"></a>            <span class="cf">for</span> fName <span class="kw">in</span> fileList:</span>
<span id="cb3-253"><a href="#cb3-253"></a>                <span class="cf">if</span> (<span class="bu">len</span>(filesUsed) <span class="op">==</span> <span class="dv">0</span>):</span>
<span id="cb3-254"><a href="#cb3-254"></a>                    filesUsed <span class="op">=</span> fName</span>
<span id="cb3-255"><a href="#cb3-255"></a>                <span class="cf">else</span>:</span>
<span id="cb3-256"><a href="#cb3-256"></a>                    filesUsed <span class="op">=</span> filesUsed <span class="op">+</span> <span class="st">', '</span> <span class="op">+</span> fName</span>
<span id="cb3-257"><a href="#cb3-257"></a></span>
<span id="cb3-258"><a href="#cb3-258"></a>                chlaFile <span class="op">=</span> Dataset(fName)</span>
<span id="cb3-259"><a href="#cb3-259"></a>                param <span class="op">=</span> <span class="st">'MW'</span> <span class="op">+</span> dtype</span>
<span id="cb3-260"><a href="#cb3-260"></a>                chla <span class="op">=</span> chlaFile.variables[param][:, :, :, :]</span>
<span id="cb3-261"><a href="#cb3-261"></a>                chlaFile.close()</span>
<span id="cb3-262"><a href="#cb3-262"></a>                chla <span class="op">=</span> np.squeeze(chla)</span>
<span id="cb3-263"><a href="#cb3-263"></a>                mean, num <span class="op">=</span> meanVar(mean, num, chla)</span>
<span id="cb3-264"><a href="#cb3-264"></a></span>
<span id="cb3-265"><a href="#cb3-265"></a>        <span class="co"># Mask out pixels with zero observations and set fill value for missing data </span></span>
<span id="cb3-266"><a href="#cb3-266"></a>        mean <span class="op">=</span> ma.array(mean, mask<span class="op">=</span>(num <span class="op">==</span> <span class="dv">0</span>), fill_value<span class="op">=-</span><span class="fl">9999999.</span>)</span>
<span id="cb3-267"><a href="#cb3-267"></a></span>
<span id="cb3-268"><a href="#cb3-268"></a>        <span class="co"># Return to working directory for output</span></span>
<span id="cb3-269"><a href="#cb3-269"></a>        os.chdir(workDir)</span>
<span id="cb3-270"><a href="#cb3-270"></a></span>
<span id="cb3-271"><a href="#cb3-271"></a>        <span class="co"># Construct output filename</span></span>
<span id="cb3-272"><a href="#cb3-272"></a>        outFile <span class="op">=</span> <span class="st">'MW'</span> <span class="op">+</span> startYearC <span class="op">+</span> startDoyC <span class="op">+</span> <span class="st">'_'</span> <span class="op">+</span> endyearC <span class="op">+</span> endDoyC <span class="op">+</span> <span class="st">'_'</span> <span class="op">+</span> dtype <span class="op">+</span> <span class="st">'.nc'</span></span>
<span id="cb3-273"><a href="#cb3-273"></a></span>
<span id="cb3-274"><a href="#cb3-274"></a>        <span class="co"># Create multi-day NetCDF</span></span>
<span id="cb3-275"><a href="#cb3-275"></a>        ncFile <span class="op">=</span> makeNetcdfmDay(mean, num, interval, outFile, filesUsed, workDir)</span>
<span id="cb3-276"><a href="#cb3-276"></a></span>
<span id="cb3-277"><a href="#cb3-277"></a>        <span class="co"># Send to server folder for this parameter</span></span>
<span id="cb3-278"><a href="#cb3-278"></a>        remote_dir <span class="op">=</span> <span class="st">'/MW/'</span> <span class="op">+</span> dtype <span class="op">+</span> <span class="st">'/'</span></span>
<span id="cb3-279"><a href="#cb3-279"></a>        send_to_servers(ncFile, remote_dir , <span class="st">'m'</span>)</span>
<span id="cb3-280"><a href="#cb3-280"></a></span>
<span id="cb3-281"><a href="#cb3-281"></a>        <span class="co">#intervalDay = str(interval) + 'day'</span></span>
<span id="cb3-282"><a href="#cb3-282"></a>        <span class="co"># myCmd = 'scp ' + ncFile  + ' cwatch@192.168.31.15:/u00/satellite/MW/' + dtype + '/mday'</span></span>
<span id="cb3-283"><a href="#cb3-283"></a>        <span class="co">#myCmd = 'rsync -tvh ' + ncFile  + ' cwatch@192.168.31.15:/u00/satellite/MW/' + dtype + '/mday/' + ncFile</span></span>
<span id="cb3-284"><a href="#cb3-284"></a>        <span class="co">#os.system(myCmd)</span></span>
<span id="cb3-285"><a href="#cb3-285"></a>        <span class="co"># myCmd = 'scp ' + ncFile  + ' cwatch@192.168.31.15:/u00/satelliteNAS/MW/' + dtype + '/mday'</span></span>
<span id="cb3-286"><a href="#cb3-286"></a>        <span class="co">#myCmd = 'rsync -tvh ' + ncFile  + ' cwatch@192.168.31.15:/u00/satelliteNAS/MW/' + dtype + '/mday/' + ncFile</span></span>
<span id="cb3-287"><a href="#cb3-287"></a>        <span class="co">#os.system(myCmd)</span></span>
<span id="cb3-288"><a href="#cb3-288"></a>        <span class="co"># myCmd = 'scp ' + ncFile  + ' cwatch@161.55.17.28:/u00/satellite/MW/' + dtype +  '/mday'</span></span>
<span id="cb3-289"><a href="#cb3-289"></a>        <span class="co"># myCmd = 'rsync -tvh ' + ncFile  + ' /u00/satellite/MW/' + dtype +  '/mday/' + ncFile</span></span>
<span id="cb3-290"><a href="#cb3-290"></a>        <span class="co">#myCmd = 'rsync -tvh ' + ncFile  + ' cwatch@161.55.17.28:/u00/satellite/MW/' + dtype +  '/mday/' + ncFile</span></span>
<span id="cb3-291"><a href="#cb3-291"></a>        <span class="co">#os.system(myCmd)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="sst" class="level2">
<h2 class="anchored" data-anchor-id="sst">SST</h2>
<section id="makesst1daynewmw" class="level3">
<h3 class="anchored" data-anchor-id="makesst1daynewmw">makeSST1daynewMW</h3>
<p><code>makeSST1daynewMW.py</code> creates a 1-day composite by reading Level-2 SST swath NetCDFs for the given date, filters “Day” pixels with quality flag &lt;2 that fall within longitude 205°–255° and latitude 22°–51°, and collates their longitude, latitude, and SST values. It then interpolates these observations onto a 0.0125° x 0.0125° regular grid using PyGMT, writes the result as a CF-compliant NetCDF, and uploads it to a directory on a remote server. Find the 1-day composite product on ERDDAP <a href="./modisa_scripts.html#modisa-products-on-swfsc-erddap-server">here</a>.</p>
<p>The following chart summarizes the script’s workflow:</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">%%{init: {"flowchart":{"htmlLabels":true}}}%%
flowchart LR
  I("&lt;b&gt;Inputs&lt;/b&gt;&lt;br/&gt;• Raw L2 SST NetCDF swaths (dataDir)&lt;br/&gt;• workDir&lt;br/&gt;• Year &amp; DOY")
    --&gt; P("&lt;b&gt;Processing&lt;/b&gt;&lt;br/&gt;• Compute calendar date &amp; directories&lt;br/&gt;• Load static land mask&lt;br/&gt;• Discover swaths for Day N (HOD&gt;10) &amp; N+1 (HOD≤10)&lt;br/&gt;• Stage &amp; filter swaths (Day-only, region overlap)&lt;br/&gt;• Extract, reshape &amp; filter (SST + quality)&lt;br/&gt;• Interpolate onto 0.0125° grid&lt;br/&gt;• Apply land mask")
    --&gt; O("&lt;b&gt;Output&lt;/b&gt;&lt;br/&gt;• CF-compliant 1-day composite NetCDF&lt;br/&gt;• Deployed to /MW/sstd/1day/")
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<div id="b95dd8af" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>View makeSST1daynewMW.py</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1"></a><span class="co">"""</span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="co">Overview</span></span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="co">--------</span></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="co">Generate a one-day SST grid for the MODIS MW (West Coast) region by combining swaths</span></span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="co">from Level-2 SST NetCDF files and gridding them with PyGMT. The final product is a CF-compliant</span></span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="co">NetCDF file containing daily SST for the MW region (lon 205-255°, lat 22-51°).</span></span>
<span id="cb4-7"><a href="#cb4-7"></a></span>
<span id="cb4-8"><a href="#cb4-8"></a><span class="co">Usage</span></span>
<span id="cb4-9"><a href="#cb4-9"></a><span class="co">-----</span></span>
<span id="cb4-10"><a href="#cb4-10"></a><span class="co">::</span></span>
<span id="cb4-11"><a href="#cb4-11"></a></span>
<span id="cb4-12"><a href="#cb4-12"></a><span class="co">    python makeSST1daynewMW.py &lt;dataDir&gt; &lt;workDir&gt; &lt;year&gt; &lt;doy&gt;</span></span>
<span id="cb4-13"><a href="#cb4-13"></a></span>
<span id="cb4-14"><a href="#cb4-14"></a><span class="co">Where:</span></span>
<span id="cb4-15"><a href="#cb4-15"></a></span>
<span id="cb4-16"><a href="#cb4-16"></a><span class="co">- ``dataDir``</span></span>
<span id="cb4-17"><a href="#cb4-17"></a></span>
<span id="cb4-18"><a href="#cb4-18"></a><span class="co">  Directory containing raw Level-2 SST NetCDF swaths for the target date, organized as ``&lt;dataDirBase&gt;/&lt;YYYY&gt;&lt;MM&gt;/``. Each file must follow the pattern: ``AQUA_MODIS.&lt;YYYY&gt;&lt;MM&gt;&lt;DD&gt;T*.L2.SST.NRT.nc``.</span></span>
<span id="cb4-19"><a href="#cb4-19"></a></span>
<span id="cb4-20"><a href="#cb4-20"></a><span class="co">- ``workDir`` </span></span>
<span id="cb4-21"><a href="#cb4-21"></a></span>
<span id="cb4-22"><a href="#cb4-22"></a><span class="co">  Temporary working directory. Swath files are copied here, intermediate products are created, and then cleaned up.</span></span>
<span id="cb4-23"><a href="#cb4-23"></a></span>
<span id="cb4-24"><a href="#cb4-24"></a><span class="co">- ``year``</span></span>
<span id="cb4-25"><a href="#cb4-25"></a></span>
<span id="cb4-26"><a href="#cb4-26"></a><span class="co">  Four-digit year string (e.g., ``"2025"``).</span></span>
<span id="cb4-27"><a href="#cb4-27"></a></span>
<span id="cb4-28"><a href="#cb4-28"></a><span class="co">- ``doy``</span></span>
<span id="cb4-29"><a href="#cb4-29"></a></span>
<span id="cb4-30"><a href="#cb4-30"></a><span class="co">  Three-digit day-of-year string (zero-padded, e.g., ``"082"`` for March 23).</span></span>
<span id="cb4-31"><a href="#cb4-31"></a></span>
<span id="cb4-32"><a href="#cb4-32"></a><span class="co">Description</span></span>
<span id="cb4-33"><a href="#cb4-33"></a><span class="co">-----------</span></span>
<span id="cb4-34"><a href="#cb4-34"></a><span class="co">1. **Date and Directory Setup**  </span></span>
<span id="cb4-35"><a href="#cb4-35"></a></span>
<span id="cb4-36"><a href="#cb4-36"></a><span class="co">   - Convert ``year`` + ``doy`` to a calendar date (``myDate``), then extract zero-padded month (``myMon``) and day (``myDay``).</span></span>
<span id="cb4-37"><a href="#cb4-37"></a></span>
<span id="cb4-38"><a href="#cb4-38"></a><span class="co">   - Define ``datadir = dataDirBase + year + myMon + "/"``. This folder must contain all SST swath NetCDF files for the date.</span></span>
<span id="cb4-39"><a href="#cb4-39"></a></span>
<span id="cb4-40"><a href="#cb4-40"></a><span class="co">   - Load a static land-mask grid from ``/u00/ref/landmasks/LM_205_255_0.0125_22_51_0.0125_gridline.grd`` into ``my_mask``.</span></span>
<span id="cb4-41"><a href="#cb4-41"></a></span>
<span id="cb4-42"><a href="#cb4-42"></a><span class="co">2. **Swath Discovery**  </span></span>
<span id="cb4-43"><a href="#cb4-43"></a></span>
<span id="cb4-44"><a href="#cb4-44"></a><span class="co">   - Change directory to ``datadir``.</span></span>
<span id="cb4-45"><a href="#cb4-45"></a></span>
<span id="cb4-46"><a href="#cb4-46"></a><span class="co">   - Build a glob pattern: ``AQUA_MODIS.&lt;year&gt;&lt;myMon&gt;&lt;myDay&gt;*.L2.SST.NRT.nc``.</span></span>
<span id="cb4-47"><a href="#cb4-47"></a></span>
<span id="cb4-48"><a href="#cb4-48"></a><span class="co">   - Sort the resulting list of swath filenames (``fileList``).</span></span>
<span id="cb4-49"><a href="#cb4-49"></a></span>
<span id="cb4-50"><a href="#cb4-50"></a><span class="co">3. **Data Staging and Cleanup**  </span></span>
<span id="cb4-51"><a href="#cb4-51"></a></span>
<span id="cb4-52"><a href="#cb4-52"></a><span class="co">   - Change directory to ``workDir``.</span></span>
<span id="cb4-53"><a href="#cb4-53"></a></span>
<span id="cb4-54"><a href="#cb4-54"></a><span class="co">   - Remove any existing temporary files matching ``AQUA_MODIS.*L2.SST*`` or ``MW20*`` to start fresh.</span></span>
<span id="cb4-55"><a href="#cb4-55"></a></span>
<span id="cb4-56"><a href="#cb4-56"></a><span class="co">4. **Loop Over Each Swath**  </span></span>
<span id="cb4-57"><a href="#cb4-57"></a></span>
<span id="cb4-58"><a href="#cb4-58"></a><span class="co">   For each file ``fName`` in ``fileList``:</span></span>
<span id="cb4-59"><a href="#cb4-59"></a></span>
<span id="cb4-60"><a href="#cb4-60"></a><span class="co">   a. **Copy and Open**  </span></span>
<span id="cb4-61"><a href="#cb4-61"></a></span>
<span id="cb4-62"><a href="#cb4-62"></a><span class="co">      - Copy the swath from ``datadir`` to ``workDir``.</span></span>
<span id="cb4-63"><a href="#cb4-63"></a></span>
<span id="cb4-64"><a href="#cb4-64"></a><span class="co">      - Open with ``netCDF4.Dataset``. If unreadable, skip the swath.</span></span>
<span id="cb4-65"><a href="#cb4-65"></a></span>
<span id="cb4-66"><a href="#cb4-66"></a><span class="co">   b. **Extract Navigation (Swath Geometry)**  </span></span>
<span id="cb4-67"><a href="#cb4-67"></a></span>
<span id="cb4-68"><a href="#cb4-68"></a><span class="co">      - Read ``latitude`` and ``longitude`` from the ``navigation_data`` group.</span></span>
<span id="cb4-69"><a href="#cb4-69"></a></span>
<span id="cb4-70"><a href="#cb4-70"></a><span class="co">      - Convert any negative longitudes to the 0-360° range.</span></span>
<span id="cb4-71"><a href="#cb4-71"></a></span>
<span id="cb4-72"><a href="#cb4-72"></a><span class="co">      - Compute swath extents: ``dataLonMin``, ``dataLonMax``, ``dataLatMin``, ``dataLatMax``.</span></span>
<span id="cb4-73"><a href="#cb4-73"></a></span>
<span id="cb4-74"><a href="#cb4-74"></a><span class="co">      - Define tests for geographic overlap:</span></span>
<span id="cb4-75"><a href="#cb4-75"></a></span>
<span id="cb4-76"><a href="#cb4-76"></a><span class="co">       - Longitude overlaps 205°-255°. </span></span>
<span id="cb4-77"><a href="#cb4-77"></a></span>
<span id="cb4-78"><a href="#cb4-78"></a><span class="co">       - Latitude overlaps 22°-51°.  </span></span>
<span id="cb4-79"><a href="#cb4-79"></a></span>
<span id="cb4-80"><a href="#cb4-80"></a><span class="co">      - Check ``day_night_flag == "Day"``.</span></span>
<span id="cb4-81"><a href="#cb4-81"></a></span>
<span id="cb4-82"><a href="#cb4-82"></a><span class="co">      - Only if all tests pass, append the swath to ``filesUsed``.</span></span>
<span id="cb4-83"><a href="#cb4-83"></a></span>
<span id="cb4-84"><a href="#cb4-84"></a><span class="co">   c. **Extract SST and Quality**  </span></span>
<span id="cb4-85"><a href="#cb4-85"></a></span>
<span id="cb4-86"><a href="#cb4-86"></a><span class="co">      - In the ``geophysical_data`` group, read:</span></span>
<span id="cb4-87"><a href="#cb4-87"></a></span>
<span id="cb4-88"><a href="#cb4-88"></a><span class="co">        - ``sst`` (sea surface temperature)</span></span>
<span id="cb4-89"><a href="#cb4-89"></a></span>
<span id="cb4-90"><a href="#cb4-90"></a><span class="co">        - ``qual_sst`` (quality flag)  </span></span>
<span id="cb4-91"><a href="#cb4-91"></a></span>
<span id="cb4-92"><a href="#cb4-92"></a><span class="co">      - Reshape ``sst``, ``latitude``, and ``longitude`` into column vectors using ``myReshape``.</span></span>
<span id="cb4-93"><a href="#cb4-93"></a></span>
<span id="cb4-94"><a href="#cb4-94"></a><span class="co">      - Flatten ``qual_sst`` into a 1D mask array (``qual_sst1``).</span></span>
<span id="cb4-95"><a href="#cb4-95"></a></span>
<span id="cb4-96"><a href="#cb4-96"></a><span class="co">      - Stack ``longitude``, ``latitude``, and ``sst`` into a 2D ``dataOut`` array.</span></span>
<span id="cb4-97"><a href="#cb4-97"></a></span>
<span id="cb4-98"><a href="#cb4-98"></a><span class="co">      - Apply filters to ``dataOut``:</span></span>
<span id="cb4-99"><a href="#cb4-99"></a></span>
<span id="cb4-100"><a href="#cb4-100"></a><span class="co">        - Quality flag &lt; 2.  </span></span>
<span id="cb4-101"><a href="#cb4-101"></a></span>
<span id="cb4-102"><a href="#cb4-102"></a><span class="co">        - Longitude between 205° and 255°. </span></span>
<span id="cb4-103"><a href="#cb4-103"></a></span>
<span id="cb4-104"><a href="#cb4-104"></a><span class="co">        - Latitude between 22° and 51°.  </span></span>
<span id="cb4-105"><a href="#cb4-105"></a></span>
<span id="cb4-106"><a href="#cb4-106"></a><span class="co">        - SST &gt; -2 °C.  </span></span>
<span id="cb4-107"><a href="#cb4-107"></a></span>
<span id="cb4-108"><a href="#cb4-108"></a><span class="co">      - Concatenate valid points into a master array ``temp_data``.</span></span>
<span id="cb4-109"><a href="#cb4-109"></a></span>
<span id="cb4-110"><a href="#cb4-110"></a><span class="co">   d. **Cleanup Swath File**  </span></span>
<span id="cb4-111"><a href="#cb4-111"></a></span>
<span id="cb4-112"><a href="#cb4-112"></a><span class="co">      - Close the NetCDF dataset.</span></span>
<span id="cb4-113"><a href="#cb4-113"></a></span>
<span id="cb4-114"><a href="#cb4-114"></a><span class="co">      - Delete the swath file from ``workDir``.</span></span>
<span id="cb4-115"><a href="#cb4-115"></a></span>
<span id="cb4-116"><a href="#cb4-116"></a><span class="co">5. **Gridding Swath Point Cloud**  </span></span>
<span id="cb4-117"><a href="#cb4-117"></a></span>
<span id="cb4-118"><a href="#cb4-118"></a><span class="co">   - After processing all swaths, define output grid filename: ``MW&lt;year&gt;&lt;doy&gt;_&lt;year&gt;&lt;doy&gt;_sstd.grd``.</span></span>
<span id="cb4-119"><a href="#cb4-119"></a></span>
<span id="cb4-120"><a href="#cb4-120"></a><span class="co">   - Set PyGMT region and spacing:</span></span>
<span id="cb4-121"><a href="#cb4-121"></a></span>
<span id="cb4-122"><a href="#cb4-122"></a><span class="co">      - ``region = "205/255/22/51"``  </span></span>
<span id="cb4-123"><a href="#cb4-123"></a></span>
<span id="cb4-124"><a href="#cb4-124"></a><span class="co">     - ``spacing = "0.0125/0.0125"``  </span></span>
<span id="cb4-125"><a href="#cb4-125"></a></span>
<span id="cb4-126"><a href="#cb4-126"></a><span class="co">     - ``search_radius = "2k"``  </span></span>
<span id="cb4-127"><a href="#cb4-127"></a></span>
<span id="cb4-128"><a href="#cb4-128"></a><span class="co">     - ``sectors = "1"``  </span></span>
<span id="cb4-129"><a href="#cb4-129"></a></span>
<span id="cb4-130"><a href="#cb4-130"></a><span class="co">   - Then run the following to produce a gridded ``xarray.DataArray`` (``temp_grid``):</span></span>
<span id="cb4-131"><a href="#cb4-131"></a></span>
<span id="cb4-132"><a href="#cb4-132"></a><span class="co">   ::</span></span>
<span id="cb4-133"><a href="#cb4-133"></a></span>
<span id="cb4-134"><a href="#cb4-134"></a><span class="co">       pygmt.nearneighbor(</span></span>
<span id="cb4-135"><a href="#cb4-135"></a><span class="co">           data=temp_data,</span></span>
<span id="cb4-136"><a href="#cb4-136"></a><span class="co">           region=region,</span></span>
<span id="cb4-137"><a href="#cb4-137"></a><span class="co">           spacing=spacing,</span></span>
<span id="cb4-138"><a href="#cb4-138"></a><span class="co">           search_radius=search_radius,</span></span>
<span id="cb4-139"><a href="#cb4-139"></a><span class="co">           sectors=sectors</span></span>
<span id="cb4-140"><a href="#cb4-140"></a><span class="co">       )</span></span>
<span id="cb4-141"><a href="#cb4-141"></a></span>
<span id="cb4-142"><a href="#cb4-142"></a><span class="co">6. **Convert to NetCDF and Send to Server**  </span></span>
<span id="cb4-143"><a href="#cb4-143"></a></span>
<span id="cb4-144"><a href="#cb4-144"></a><span class="co">   Invoke:</span></span>
<span id="cb4-145"><a href="#cb4-145"></a></span>
<span id="cb4-146"><a href="#cb4-146"></a><span class="co">   ``grd2netcdf1(temp_grid, fileOut, filesUsed, my_mask, "MW")``</span></span>
<span id="cb4-147"><a href="#cb4-147"></a></span>
<span id="cb4-148"><a href="#cb4-148"></a><span class="co">   from ``roylib``:</span></span>
<span id="cb4-149"><a href="#cb4-149"></a></span>
<span id="cb4-150"><a href="#cb4-150"></a><span class="co">   - Applies ``my_mask`` to zero out land pixels.</span></span>
<span id="cb4-151"><a href="#cb4-151"></a></span>
<span id="cb4-152"><a href="#cb4-152"></a><span class="co">   - Computes coverage statistics (# observations, % coverage).</span></span>
<span id="cb4-153"><a href="#cb4-153"></a></span>
<span id="cb4-154"><a href="#cb4-154"></a><span class="co">   - Generates a CF-compliant NetCDF skeleton via ``ncgen`` + a CDL template.</span></span>
<span id="cb4-155"><a href="#cb4-155"></a></span>
<span id="cb4-156"><a href="#cb4-156"></a><span class="co">   - Populates coordinates, SST data, metadata, and a center-time stamp.</span></span>
<span id="cb4-157"><a href="#cb4-157"></a></span>
<span id="cb4-158"><a href="#cb4-158"></a><span class="co">   - Returns the new NetCDF filename (``MW&lt;year&gt;&lt;doy&gt;_&lt;year&gt;&lt;doy&gt;_sstd.nc``).</span></span>
<span id="cb4-159"><a href="#cb4-159"></a></span>
<span id="cb4-160"><a href="#cb4-160"></a><span class="co">   Then run:</span></span>
<span id="cb4-161"><a href="#cb4-161"></a></span>
<span id="cb4-162"><a href="#cb4-162"></a><span class="co">   ::</span></span>
<span id="cb4-163"><a href="#cb4-163"></a></span>
<span id="cb4-164"><a href="#cb4-164"></a><span class="co">       send_to_servers(ncFile, "/MW/sstd/", "1")</span></span>
<span id="cb4-165"><a href="#cb4-165"></a></span>
<span id="cb4-166"><a href="#cb4-166"></a><span class="co">   to copy the NetCDF into ``/MW/sstd/1day/``.</span></span>
<span id="cb4-167"><a href="#cb4-167"></a></span>
<span id="cb4-168"><a href="#cb4-168"></a><span class="co">   Finally, remove the local NetCDF copy.</span></span>
<span id="cb4-169"><a href="#cb4-169"></a></span>
<span id="cb4-170"><a href="#cb4-170"></a><span class="co">Dependencies</span></span>
<span id="cb4-171"><a href="#cb4-171"></a><span class="co">------------</span></span>
<span id="cb4-172"><a href="#cb4-172"></a><span class="co">- **Python 3.x**</span></span>
<span id="cb4-173"><a href="#cb4-173"></a></span>
<span id="cb4-174"><a href="#cb4-174"></a><span class="co">- **Standard library:**  ``os``, ``glob``, ``re``, ``shutil``, ``sys``, ``datetime``, ``timedelta``</span></span>
<span id="cb4-175"><a href="#cb4-175"></a></span>
<span id="cb4-176"><a href="#cb4-176"></a><span class="co">- **Third-party packages:** ``netCDF4.Dataset``, ``numpy``, ``pygmt`` </span></span>
<span id="cb4-177"><a href="#cb4-177"></a></span>
<span id="cb4-178"><a href="#cb4-178"></a><span class="co">- **Custom roylib functions:**</span></span>
<span id="cb4-179"><a href="#cb4-179"></a></span>
<span id="cb4-180"><a href="#cb4-180"></a><span class="co">   - ``myReshape(array)``</span></span>
<span id="cb4-181"><a href="#cb4-181"></a><span class="co">  </span></span>
<span id="cb4-182"><a href="#cb4-182"></a><span class="co">   - ``grd2netcdf1(grd, outName, filesUsed, mask, fType)``</span></span>
<span id="cb4-183"><a href="#cb4-183"></a></span>
<span id="cb4-184"><a href="#cb4-184"></a><span class="co">   - ``safe_remove(filePath)``  </span></span>
<span id="cb4-185"><a href="#cb4-185"></a></span>
<span id="cb4-186"><a href="#cb4-186"></a><span class="co">   - ``send_to_servers(ncFile, destDir, interval)``</span></span>
<span id="cb4-187"><a href="#cb4-187"></a></span>
<span id="cb4-188"><a href="#cb4-188"></a><span class="co">   - ``isleap(year)``</span></span>
<span id="cb4-189"><a href="#cb4-189"></a></span>
<span id="cb4-190"><a href="#cb4-190"></a><span class="co">   - ``makeNetcdf(mean, nobs, interval, outFile, filesUsed, workDir)``</span></span>
<span id="cb4-191"><a href="#cb4-191"></a></span>
<span id="cb4-192"><a href="#cb4-192"></a><span class="co">   - ``meanVar(mean, num, obs)``</span></span>
<span id="cb4-193"><a href="#cb4-193"></a></span>
<span id="cb4-194"><a href="#cb4-194"></a><span class="co">Land Mask</span></span>
<span id="cb4-195"><a href="#cb4-195"></a><span class="co">---------</span></span>
<span id="cb4-196"><a href="#cb4-196"></a><span class="co">- A static GRD file is required at:</span></span>
<span id="cb4-197"><a href="#cb4-197"></a></span>
<span id="cb4-198"><a href="#cb4-198"></a><span class="co">  ``/u00/ref/landmasks/LM_205_255_0.0125_22_51_0.0125_gridline.grd``</span></span>
<span id="cb4-199"><a href="#cb4-199"></a></span>
<span id="cb4-200"><a href="#cb4-200"></a><span class="co">- This mask is applied to the gridded SST to set land pixels to NaN.</span></span>
<span id="cb4-201"><a href="#cb4-201"></a></span>
<span id="cb4-202"><a href="#cb4-202"></a><span class="co">Directory Structure</span></span>
<span id="cb4-203"><a href="#cb4-203"></a><span class="co">-------------------</span></span>
<span id="cb4-204"><a href="#cb4-204"></a><span class="co">- **Input swaths directory** (datadir):</span></span>
<span id="cb4-205"><a href="#cb4-205"></a></span>
<span id="cb4-206"><a href="#cb4-206"></a><span class="co">  Must contain all Level-2 NetCDF swath files for the date, named: ``AQUA_MODIS.&lt;YYYY&gt;&lt;MM&gt;&lt;DD&gt;T*.L2.SST.NRT.nc``</span></span>
<span id="cb4-207"><a href="#cb4-207"></a></span>
<span id="cb4-208"><a href="#cb4-208"></a><span class="co">- **Working directory** (workDir):  </span></span>
<span id="cb4-209"><a href="#cb4-209"></a></span>
<span id="cb4-210"><a href="#cb4-210"></a><span class="co">  Temporary location where swaths are staged, processed, and removed.</span></span>
<span id="cb4-211"><a href="#cb4-211"></a></span>
<span id="cb4-212"><a href="#cb4-212"></a><span class="co">- **Output grid** (fileOut):  </span></span>
<span id="cb4-213"><a href="#cb4-213"></a></span>
<span id="cb4-214"><a href="#cb4-214"></a><span class="co">  A GMT “.grd” file named ``MW&lt;year&gt;&lt;doy&gt;_&lt;year&gt;&lt;doy&gt;_sstd.grd``.</span></span>
<span id="cb4-215"><a href="#cb4-215"></a></span>
<span id="cb4-216"><a href="#cb4-216"></a><span class="co">- **Final NetCDF** (returned by grd2netcdf1):  </span></span>
<span id="cb4-217"><a href="#cb4-217"></a></span>
<span id="cb4-218"><a href="#cb4-218"></a><span class="co">  Named ``MW&lt;year&gt;&lt;doy&gt;_&lt;year&gt;&lt;doy&gt;_sstd.nc``, then copied to ``/MW/sstd/1day/``.</span></span>
<span id="cb4-219"><a href="#cb4-219"></a></span>
<span id="cb4-220"><a href="#cb4-220"></a><span class="co">Usage Example</span></span>
<span id="cb4-221"><a href="#cb4-221"></a><span class="co">-------------</span></span>
<span id="cb4-222"><a href="#cb4-222"></a><span class="co">Assume your raw SST swaths are in  ``/Users/you/modis_data/netcdf/202503/`` and your  working directory is ``/Users/you/modis_work/``:</span></span>
<span id="cb4-223"><a href="#cb4-223"></a></span>
<span id="cb4-224"><a href="#cb4-224"></a><span class="co">::</span></span>
<span id="cb4-225"><a href="#cb4-225"></a></span>
<span id="cb4-226"><a href="#cb4-226"></a><span class="co">    python makeSST1daynewMW.py /Users/you/modis_data/netcdf/202503/  /Users/you/modis_work/  2025 082</span></span>
<span id="cb4-227"><a href="#cb4-227"></a></span>
<span id="cb4-228"><a href="#cb4-228"></a><span class="co">This will:</span></span>
<span id="cb4-229"><a href="#cb4-229"></a></span>
<span id="cb4-230"><a href="#cb4-230"></a><span class="co">  - Copy all swaths matching ``AQUA_MODIS.20250323*.L2.SST.NRT.nc`` into ``/Users/you/modis_work/``.</span></span>
<span id="cb4-231"><a href="#cb4-231"></a></span>
<span id="cb4-232"><a href="#cb4-232"></a><span class="co">  - Build a combined point cloud from valid “Day” pixels within the MW region.</span></span>
<span id="cb4-233"><a href="#cb4-233"></a></span>
<span id="cb4-234"><a href="#cb4-234"></a><span class="co">  - Create ``MW2025082_2025082_sstd.grd`` via PyGMT nearneighbor.</span></span>
<span id="cb4-235"><a href="#cb4-235"></a></span>
<span id="cb4-236"><a href="#cb4-236"></a><span class="co">  - Convert the grid to ``MW2025082_2025082_sstd.nc`` using ``grd2netcdf1``.</span></span>
<span id="cb4-237"><a href="#cb4-237"></a></span>
<span id="cb4-238"><a href="#cb4-238"></a><span class="co">  - Copy the NetCDF to ``/MW/sstd/1day/`` and remove local copies.</span></span>
<span id="cb4-239"><a href="#cb4-239"></a><span class="co">"""</span></span>
<span id="cb4-240"><a href="#cb4-240"></a><span class="im">from</span> __future__ <span class="im">import</span> print_function</span>
<span id="cb4-241"><a href="#cb4-241"></a><span class="im">from</span> builtins <span class="im">import</span> <span class="bu">str</span></span>
<span id="cb4-242"><a href="#cb4-242"></a></span>
<span id="cb4-243"><a href="#cb4-243"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb4-244"><a href="#cb4-244"></a>    <span class="im">from</span> datetime <span class="im">import</span> datetime, timedelta</span>
<span id="cb4-245"><a href="#cb4-245"></a>    <span class="im">import</span> glob</span>
<span id="cb4-246"><a href="#cb4-246"></a>    <span class="im">from</span> itertools <span class="im">import</span> chain</span>
<span id="cb4-247"><a href="#cb4-247"></a>    <span class="im">from</span> netCDF4 <span class="im">import</span> Dataset</span>
<span id="cb4-248"><a href="#cb4-248"></a>    <span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb4-249"><a href="#cb4-249"></a>    <span class="im">import</span> numpy.ma <span class="im">as</span> ma</span>
<span id="cb4-250"><a href="#cb4-250"></a>    <span class="im">import</span> pygmt</span>
<span id="cb4-251"><a href="#cb4-251"></a>    <span class="im">import</span> os</span>
<span id="cb4-252"><a href="#cb4-252"></a>    <span class="im">import</span> re</span>
<span id="cb4-253"><a href="#cb4-253"></a>    <span class="im">import</span> shutil</span>
<span id="cb4-254"><a href="#cb4-254"></a>    <span class="im">import</span> sys</span>
<span id="cb4-255"><a href="#cb4-255"></a></span>
<span id="cb4-256"><a href="#cb4-256"></a>    <span class="co"># Ensure 'roylib' is on the import path</span></span>
<span id="cb4-257"><a href="#cb4-257"></a>    sys.path.append(<span class="st">'/home/cwatch/pythonLibs'</span>)</span>
<span id="cb4-258"><a href="#cb4-258"></a>    <span class="im">from</span> roylib <span class="im">import</span> <span class="op">*</span></span>
<span id="cb4-259"><a href="#cb4-259"></a></span>
<span id="cb4-260"><a href="#cb4-260"></a>    <span class="co"># Geographic bounds for MW region</span></span>
<span id="cb4-261"><a href="#cb4-261"></a>    latmax <span class="op">=</span> <span class="fl">51.</span></span>
<span id="cb4-262"><a href="#cb4-262"></a>    latmin <span class="op">=</span> <span class="fl">22.</span></span>
<span id="cb4-263"><a href="#cb4-263"></a>    lonmax <span class="op">=</span> <span class="fl">255.</span></span>
<span id="cb4-264"><a href="#cb4-264"></a>    lonmin <span class="op">=</span> <span class="fl">205.</span></span>
<span id="cb4-265"><a href="#cb4-265"></a></span>
<span id="cb4-266"><a href="#cb4-266"></a>    outFile <span class="op">=</span> <span class="st">'modiswcSSTtemp'</span></span>
<span id="cb4-267"><a href="#cb4-267"></a></span>
<span id="cb4-268"><a href="#cb4-268"></a>    <span class="co"># Set data directory</span></span>
<span id="cb4-269"><a href="#cb4-269"></a>    datadirBase <span class="op">=</span> sys.argv[<span class="dv">1</span>]</span>
<span id="cb4-270"><a href="#cb4-270"></a></span>
<span id="cb4-271"><a href="#cb4-271"></a>    <span class="co"># Set work directory</span></span>
<span id="cb4-272"><a href="#cb4-272"></a>    workdir <span class="op">=</span> sys.argv[<span class="dv">2</span>]</span>
<span id="cb4-273"><a href="#cb4-273"></a></span>
<span id="cb4-274"><a href="#cb4-274"></a>    <span class="co"># Get the year and doy from the command line</span></span>
<span id="cb4-275"><a href="#cb4-275"></a>    year <span class="op">=</span> sys.argv[<span class="dv">3</span>]</span>
<span id="cb4-276"><a href="#cb4-276"></a>    doy <span class="op">=</span> sys.argv[<span class="dv">4</span>]</span>
<span id="cb4-277"><a href="#cb4-277"></a>    <span class="bu">print</span>(year)</span>
<span id="cb4-278"><a href="#cb4-278"></a>    <span class="bu">print</span>(doy)</span>
<span id="cb4-279"><a href="#cb4-279"></a></span>
<span id="cb4-280"><a href="#cb4-280"></a>    <span class="co"># Convert year/doy to a calendar date and zero-pad month/day</span></span>
<span id="cb4-281"><a href="#cb4-281"></a>    myDate <span class="op">=</span> datetime(<span class="bu">int</span>(year), <span class="dv">1</span>, <span class="dv">1</span>) <span class="op">+</span> timedelta(<span class="bu">int</span>(doy) <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb4-282"><a href="#cb4-282"></a>    myMon <span class="op">=</span> <span class="bu">str</span>(myDate.month)</span>
<span id="cb4-283"><a href="#cb4-283"></a>    myMon <span class="op">=</span> myMon.rjust(<span class="dv">2</span>, <span class="st">'0'</span>)</span>
<span id="cb4-284"><a href="#cb4-284"></a>    myDay <span class="op">=</span> <span class="bu">str</span>(myDate.day).rjust(<span class="dv">2</span>, <span class="st">'0'</span>)</span>
<span id="cb4-285"><a href="#cb4-285"></a></span>
<span id="cb4-286"><a href="#cb4-286"></a>    <span class="co"># Construct the directory path</span></span>
<span id="cb4-287"><a href="#cb4-287"></a>    datadir <span class="op">=</span> datadirBase <span class="op">+</span> year <span class="op">+</span> myMon <span class="op">+</span> <span class="st">'/'</span></span>
<span id="cb4-288"><a href="#cb4-288"></a></span>
<span id="cb4-289"><a href="#cb4-289"></a>    <span class="co"># Load static land mask from GRD</span></span>
<span id="cb4-290"><a href="#cb4-290"></a>    mask_root <span class="op">=</span> Dataset(<span class="st">'/u00/ref/landmasks/LM_205_255_0.0125_22_51_0.0125_gridline.grd'</span>)</span>
<span id="cb4-291"><a href="#cb4-291"></a>    my_mask <span class="op">=</span> mask_root.variables[<span class="st">'z'</span>][:, :]</span>
<span id="cb4-292"><a href="#cb4-292"></a>    mask_root.close()</span>
<span id="cb4-293"><a href="#cb4-293"></a></span>
<span id="cb4-294"><a href="#cb4-294"></a>    <span class="co"># Now move to the data directory</span></span>
<span id="cb4-295"><a href="#cb4-295"></a>    os.chdir(datadir)</span>
<span id="cb4-296"><a href="#cb4-296"></a></span>
<span id="cb4-297"><a href="#cb4-297"></a>    <span class="co"># Set up the string for the file search in the data directory</span></span>
<span id="cb4-298"><a href="#cb4-298"></a>    myString <span class="op">=</span> <span class="st">'AQUA_MODIS.'</span> <span class="op">+</span> year <span class="op">+</span> myMon <span class="op">+</span> myDay  <span class="op">+</span> <span class="st">'*.L2.SST.NRT.nc'</span></span>
<span id="cb4-299"><a href="#cb4-299"></a></span>
<span id="cb4-300"><a href="#cb4-300"></a>    <span class="co"># Get list of files in the data directory that match with full path</span></span>
<span id="cb4-301"><a href="#cb4-301"></a>    fileList <span class="op">=</span> glob.glob(myString)</span>
<span id="cb4-302"><a href="#cb4-302"></a>    <span class="co"># print(fileList)</span></span>
<span id="cb4-303"><a href="#cb4-303"></a>    fileList.sort()</span>
<span id="cb4-304"><a href="#cb4-304"></a></span>
<span id="cb4-305"><a href="#cb4-305"></a>    <span class="co"># Now move to the work directory and clear old files</span></span>
<span id="cb4-306"><a href="#cb4-306"></a>    os.chdir(workdir)</span>
<span id="cb4-307"><a href="#cb4-307"></a>    os.system(<span class="st">'rm -f AQUA_MODIS.*L2.SST*'</span>)</span>
<span id="cb4-308"><a href="#cb4-308"></a>    os.system(<span class="st">'rm -f MW20*'</span>)</span>
<span id="cb4-309"><a href="#cb4-309"></a></span>
<span id="cb4-310"><a href="#cb4-310"></a>    <span class="co"># Prepare variables to accumulate point-cloud data and track provenance</span></span>
<span id="cb4-311"><a href="#cb4-311"></a>    filesUsed <span class="op">=</span> <span class="st">""</span></span>
<span id="cb4-312"><a href="#cb4-312"></a>    temp_data <span class="op">=</span> <span class="va">None</span></span>
<span id="cb4-313"><a href="#cb4-313"></a></span>
<span id="cb4-314"><a href="#cb4-314"></a>    <span class="co"># Loop through each swath filename for Day N</span></span>
<span id="cb4-315"><a href="#cb4-315"></a>    <span class="cf">for</span> fName <span class="kw">in</span> fileList:</span>
<span id="cb4-316"><a href="#cb4-316"></a>        fileName <span class="op">=</span> fName</span>
<span id="cb4-317"><a href="#cb4-317"></a>        <span class="bu">print</span>(fileName)</span>
<span id="cb4-318"><a href="#cb4-318"></a>        shutil.copyfile(datadir <span class="op">+</span> fName, workdir <span class="op">+</span> fName)</span>
<span id="cb4-319"><a href="#cb4-319"></a>        <span class="cf">try</span>:</span>
<span id="cb4-320"><a href="#cb4-320"></a>            rootgrp <span class="op">=</span> Dataset(fileName, <span class="st">'r'</span>)</span>
<span id="cb4-321"><a href="#cb4-321"></a>        <span class="cf">except</span> <span class="pp">IOError</span>:</span>
<span id="cb4-322"><a href="#cb4-322"></a>            <span class="bu">print</span>(<span class="st">"bad file "</span> <span class="op">+</span> fileName)</span>
<span id="cb4-323"><a href="#cb4-323"></a>            <span class="cf">continue</span></span>
<span id="cb4-324"><a href="#cb4-324"></a></span>
<span id="cb4-325"><a href="#cb4-325"></a>        <span class="co"># Extract navigation-group data</span></span>
<span id="cb4-326"><a href="#cb4-326"></a>        navDataGroup <span class="op">=</span> rootgrp.groups[<span class="st">'navigation_data'</span>]</span>
<span id="cb4-327"><a href="#cb4-327"></a>        latitude <span class="op">=</span> navDataGroup.variables[<span class="st">'latitude'</span>][:, :]</span>
<span id="cb4-328"><a href="#cb4-328"></a>        longitude <span class="op">=</span> navDataGroup.variables[<span class="st">'longitude'</span>][:, :]</span>
<span id="cb4-329"><a href="#cb4-329"></a></span>
<span id="cb4-330"><a href="#cb4-330"></a>        <span class="co"># Convert any negative longitudes to the 0-360° domain</span></span>
<span id="cb4-331"><a href="#cb4-331"></a>        longitude[longitude <span class="op">&lt;</span> <span class="dv">0</span>] <span class="op">=</span> longitude[longitude <span class="op">&lt;</span> <span class="dv">0</span>] <span class="op">+</span> <span class="dv">360</span></span>
<span id="cb4-332"><a href="#cb4-332"></a></span>
<span id="cb4-333"><a href="#cb4-333"></a>        <span class="co"># Compute swath extents (min/max) for geographic filtering</span></span>
<span id="cb4-334"><a href="#cb4-334"></a>        dataLonMin <span class="op">=</span> np.nanmin(longitude[longitude <span class="op">&gt;=</span> <span class="dv">0</span>])</span>
<span id="cb4-335"><a href="#cb4-335"></a>        dataLonMax <span class="op">=</span> np.nanmax(longitude[longitude <span class="op">&lt;=</span> <span class="dv">360</span>])</span>
<span id="cb4-336"><a href="#cb4-336"></a>        dataLatMin <span class="op">=</span> np.nanmin(latitude[latitude <span class="op">&gt;=</span> <span class="op">-</span><span class="dv">90</span>])</span>
<span id="cb4-337"><a href="#cb4-337"></a>        dataLatMax <span class="op">=</span> np.nanmax(latitude[latitude <span class="op">&lt;=</span> <span class="dv">90</span>])</span>
<span id="cb4-338"><a href="#cb4-338"></a></span>
<span id="cb4-339"><a href="#cb4-339"></a>        <span class="co"># Determine if swath overlaps our global MW region</span></span>
<span id="cb4-340"><a href="#cb4-340"></a>        goodLon1 <span class="op">=</span> (dataLonMin <span class="op">&lt;</span> lonmin) <span class="kw">and</span> (dataLonMax <span class="op">&gt;=</span> lonmin)</span>
<span id="cb4-341"><a href="#cb4-341"></a>        goodLon2 <span class="op">=</span> (dataLonMin <span class="op">&gt;=</span> lonmin) <span class="kw">and</span> (dataLonMin <span class="op">&lt;=</span> lonmax)</span>
<span id="cb4-342"><a href="#cb4-342"></a>        goodLon <span class="op">=</span> goodLon1 <span class="kw">or</span> goodLon2</span>
<span id="cb4-343"><a href="#cb4-343"></a></span>
<span id="cb4-344"><a href="#cb4-344"></a>        goodLat1 <span class="op">=</span> (dataLatMin <span class="op">&lt;</span> latmin) <span class="kw">and</span> (dataLatMax <span class="op">&gt;=</span> latmin)</span>
<span id="cb4-345"><a href="#cb4-345"></a>        goodLat2 <span class="op">=</span> (dataLatMin <span class="op">&gt;=</span> latmin) <span class="kw">and</span> (dataLatMin <span class="op">&lt;=</span> latmax)</span>
<span id="cb4-346"><a href="#cb4-346"></a>        goodLat <span class="op">=</span> goodLat1 <span class="kw">or</span> goodLat2</span>
<span id="cb4-347"><a href="#cb4-347"></a></span>
<span id="cb4-348"><a href="#cb4-348"></a>        <span class="co"># Check if swath is daytime (only keep "Day" pixels)</span></span>
<span id="cb4-349"><a href="#cb4-349"></a>        dayNightTest <span class="op">=</span> (rootgrp.day_night_flag <span class="op">==</span> <span class="st">'Day'</span>)</span>
<span id="cb4-350"><a href="#cb4-350"></a></span>
<span id="cb4-351"><a href="#cb4-351"></a>        <span class="co"># Only proceed if geography and day-night tests pass</span></span>
<span id="cb4-352"><a href="#cb4-352"></a>        <span class="cf">if</span> (goodLon <span class="kw">and</span> goodLat <span class="kw">and</span> dayNightTest):</span>
<span id="cb4-353"><a href="#cb4-353"></a>            <span class="co"># Add filename to provenance list</span></span>
<span id="cb4-354"><a href="#cb4-354"></a>            <span class="cf">if</span> (<span class="bu">len</span>(filesUsed) <span class="op">==</span> <span class="dv">0</span>):</span>
<span id="cb4-355"><a href="#cb4-355"></a>                filesUsed <span class="op">=</span> fileName</span>
<span id="cb4-356"><a href="#cb4-356"></a>            <span class="cf">else</span>:</span>
<span id="cb4-357"><a href="#cb4-357"></a>                filesUsed <span class="op">=</span> filesUsed <span class="op">+</span> <span class="st">', '</span> <span class="op">+</span> fileName</span>
<span id="cb4-358"><a href="#cb4-358"></a></span>
<span id="cb4-359"><a href="#cb4-359"></a>            <span class="co"># Extract geophysical data and reshape</span></span>
<span id="cb4-360"><a href="#cb4-360"></a>            geoDataGroup <span class="op">=</span> rootgrp.groups[<span class="st">'geophysical_data'</span>]</span>
<span id="cb4-361"><a href="#cb4-361"></a>            sst <span class="op">=</span> geoDataGroup.variables[<span class="st">'sst'</span>][:, :]</span>
<span id="cb4-362"><a href="#cb4-362"></a>            sst <span class="op">=</span> myReshape(sst)</span>
<span id="cb4-363"><a href="#cb4-363"></a>            qual_sst <span class="op">=</span> geoDataGroup.variables[<span class="st">'qual_sst'</span>][:, :]</span>
<span id="cb4-364"><a href="#cb4-364"></a>            qual_sst1 <span class="op">=</span> qual_sst.flatten()</span>
<span id="cb4-365"><a href="#cb4-365"></a>            latitude <span class="op">=</span> myReshape(latitude)</span>
<span id="cb4-366"><a href="#cb4-366"></a>            longitude <span class="op">=</span> myReshape(longitude)</span>
<span id="cb4-367"><a href="#cb4-367"></a></span>
<span id="cb4-368"><a href="#cb4-368"></a>            <span class="co"># Stack (lon, lat, sst) into a single 2D array with shape (N, 3)</span></span>
<span id="cb4-369"><a href="#cb4-369"></a>            dataOut <span class="op">=</span> np.hstack((longitude, latitude, sst))</span>
<span id="cb4-370"><a href="#cb4-370"></a></span>
<span id="cb4-371"><a href="#cb4-371"></a>            <span class="co"># Keep only quality &lt; 2, valid SST &gt; -2°C, and within MW region</span></span>
<span id="cb4-372"><a href="#cb4-372"></a>            qualTest <span class="op">=</span> qual_sst1 <span class="op">&lt;</span> <span class="dv">2</span></span>
<span id="cb4-373"><a href="#cb4-373"></a>            dataOut <span class="op">=</span> dataOut[qualTest]</span>
<span id="cb4-374"><a href="#cb4-374"></a>            dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">0</span>] <span class="op">&gt;</span> <span class="op">-</span><span class="dv">400</span>]</span>
<span id="cb4-375"><a href="#cb4-375"></a>            dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">0</span>] <span class="op">&gt;=</span> lonmin]</span>
<span id="cb4-376"><a href="#cb4-376"></a>            dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">0</span>] <span class="op">&lt;=</span> lonmax]</span>
<span id="cb4-377"><a href="#cb4-377"></a>            dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">1</span>] <span class="op">&gt;=</span> latmin]</span>
<span id="cb4-378"><a href="#cb4-378"></a>            dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">1</span>] <span class="op">&lt;=</span> latmax]</span>
<span id="cb4-379"><a href="#cb4-379"></a>            dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">2</span>] <span class="op">&gt;</span> <span class="op">-</span><span class="dv">2</span>]</span>
<span id="cb4-380"><a href="#cb4-380"></a></span>
<span id="cb4-381"><a href="#cb4-381"></a>            <span class="co"># Accumulate into temp_data array</span></span>
<span id="cb4-382"><a href="#cb4-382"></a>            <span class="cf">if</span> (dataOut.shape[<span class="dv">0</span>] <span class="op">&gt;</span> <span class="dv">0</span>):</span>
<span id="cb4-383"><a href="#cb4-383"></a>                <span class="cf">if</span> (temp_data <span class="kw">is</span> <span class="va">None</span>):</span>
<span id="cb4-384"><a href="#cb4-384"></a>                    temp_data <span class="op">=</span> dataOut</span>
<span id="cb4-385"><a href="#cb4-385"></a>                <span class="cf">else</span>:</span>
<span id="cb4-386"><a href="#cb4-386"></a>                    temp_data <span class="op">=</span> np.concatenate((temp_data, dataOut), axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb4-387"><a href="#cb4-387"></a></span>
<span id="cb4-388"><a href="#cb4-388"></a>        <span class="co"># Close the NetCDF and remove swath copy from workdir</span></span>
<span id="cb4-389"><a href="#cb4-389"></a>        rootgrp.close()</span>
<span id="cb4-390"><a href="#cb4-390"></a>        os.remove(fileName)</span>
<span id="cb4-391"><a href="#cb4-391"></a></span>
<span id="cb4-392"><a href="#cb4-392"></a>    <span class="co"># Build and write the GMT grid from the accumulated point cloud</span></span>
<span id="cb4-393"><a href="#cb4-393"></a>    <span class="co"># Define output grid filename</span></span>
<span id="cb4-394"><a href="#cb4-394"></a>    fileOut <span class="op">=</span> <span class="st">'MW'</span> <span class="op">+</span> year <span class="op">+</span> doy <span class="op">+</span> <span class="st">'_'</span> <span class="op">+</span> year <span class="op">+</span> doy <span class="op">+</span> <span class="st">'_sstd.grd'</span></span>
<span id="cb4-395"><a href="#cb4-395"></a>    <span class="bu">range</span> <span class="op">=</span> <span class="st">'205/255/22/51'</span></span>
<span id="cb4-396"><a href="#cb4-396"></a>    increment <span class="op">=</span> <span class="st">'0.0125/0.0125'</span></span>
<span id="cb4-397"><a href="#cb4-397"></a>    smooth <span class="op">=</span> <span class="st">'2k'</span></span>
<span id="cb4-398"><a href="#cb4-398"></a></span>
<span id="cb4-399"><a href="#cb4-399"></a>    <span class="co"># Use PyGMT nearneighbor to interpolate scattered (lon, lat, sst) points onto a grid</span></span>
<span id="cb4-400"><a href="#cb4-400"></a>    temp_data1 <span class="op">=</span> pygmt.nearneighbor(</span>
<span id="cb4-401"><a href="#cb4-401"></a>        data<span class="op">=</span>temp_data,</span>
<span id="cb4-402"><a href="#cb4-402"></a>        region<span class="op">=</span><span class="bu">range</span>,</span>
<span id="cb4-403"><a href="#cb4-403"></a>        spacing<span class="op">=</span>increment,</span>
<span id="cb4-404"><a href="#cb4-404"></a>        search_radius<span class="op">=</span>smooth,</span>
<span id="cb4-405"><a href="#cb4-405"></a>        sectors<span class="op">=</span><span class="st">'1'</span></span>
<span id="cb4-406"><a href="#cb4-406"></a>    )</span>
<span id="cb4-407"><a href="#cb4-407"></a></span>
<span id="cb4-408"><a href="#cb4-408"></a>    <span class="co"># Convert the GMT grid to a CF-compliant NetCDF and send to server</span></span>
<span id="cb4-409"><a href="#cb4-409"></a>    <span class="co"># Apply the land mask, create a NetCDF via a CDL template, and add metadata</span></span>
<span id="cb4-410"><a href="#cb4-410"></a>    ncFile <span class="op">=</span> grd2netcdf1(temp_data1, fileOut, filesUsed, my_mask, <span class="st">'MW'</span>)</span>
<span id="cb4-411"><a href="#cb4-411"></a></span>
<span id="cb4-412"><a href="#cb4-412"></a>    <span class="co">#myCmd = "mv " + ncFile + " /home/cwatch/pygmt_test/outfiles"</span></span>
<span id="cb4-413"><a href="#cb4-413"></a>    <span class="co">#os.system(myCmd)</span></span>
<span id="cb4-414"><a href="#cb4-414"></a></span>
<span id="cb4-415"><a href="#cb4-415"></a>    <span class="co"># Copy the final NetCDF to the "MW" server folder for 1-day products</span></span>
<span id="cb4-416"><a href="#cb4-416"></a>    send_to_servers(ncFile, <span class="st">'/MW/sstd/'</span>, <span class="st">'1'</span>)</span>
<span id="cb4-417"><a href="#cb4-417"></a></span>
<span id="cb4-418"><a href="#cb4-418"></a>    <span class="co"># Remove the local NetCDF to copy from workdir</span></span>
<span id="cb4-419"><a href="#cb4-419"></a>    os.remove(ncFile)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="compmwsst" class="level3">
<h3 class="anchored" data-anchor-id="compmwsst">CompMWSST</h3>
<p><code>CompMWSST.py</code> computes a multi-day (3-, 8-, &amp; 14-) SST composite by reading daily 1-day SST NetCDFs over the specified interval and averaging them on a regular 0.0125° x 0.0125° grid covering longitude 205°–255° and latitude 22°–51°. It masks out pixels with no observations, writes the result as a CF-compliant NetCDF, and uploads it to a directory on a remote server. Find the multi-day composite products on ERDDAP <a href="./modisa_scripts.html#modisa-products-on-swfsc-erddap-server">here</a>.</p>
<p>The following chart summarizes the script’s workflow:</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">%%{init: {"flowchart":{"htmlLabels":true}}}%%
flowchart LR
  I("&lt;b&gt;Inputs&lt;/b&gt;&lt;br/&gt;• 1-day composite NetCDFs (dataDir)&lt;br/&gt;• workDir&lt;br/&gt;• endYear &amp; endDoy&lt;br/&gt;• interval (days)")
    --&gt; P("&lt;b&gt;Processing&lt;/b&gt;&lt;br/&gt;• Parse args &amp; compute start/end DOY&lt;br/&gt;• Clear workDir &amp; initialize mean/num arrays&lt;br/&gt;• Gather files over date range&lt;br/&gt;• Loop: open each file &amp; update mean/num&lt;br/&gt;• Mask zero-observation pixels")
    --&gt; O("&lt;b&gt;Output&lt;/b&gt;&lt;br/&gt;• CF-compliant multi-day composite NetCDF&lt;br/&gt;• Deployed to /MW/sstd/interval day/")
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<div id="247c9786" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>View CompMWSST.py</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1"></a><span class="co">"""</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="co">Overview</span></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="co">--------</span></span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="co">Generate multi-day SST composites for the MODIS MW (West Coast) dataset by averaging</span></span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="co">1-day NetCDF files over a specified interval (e.g., 3, 5, 8, or 14 days).</span></span>
<span id="cb5-6"><a href="#cb5-6"></a></span>
<span id="cb5-7"><a href="#cb5-7"></a><span class="co">Usage</span></span>
<span id="cb5-8"><a href="#cb5-8"></a><span class="co">-----</span></span>
<span id="cb5-9"><a href="#cb5-9"></a><span class="co">::</span></span>
<span id="cb5-10"><a href="#cb5-10"></a><span class="co">  </span></span>
<span id="cb5-11"><a href="#cb5-11"></a><span class="co">    python CompMWSST.py &lt;dataDir&gt; &lt;workDir&gt; &lt;endYear&gt; &lt;endDoy&gt; &lt;interval&gt;</span></span>
<span id="cb5-12"><a href="#cb5-12"></a></span>
<span id="cb5-13"><a href="#cb5-13"></a><span class="co">Where:</span></span>
<span id="cb5-14"><a href="#cb5-14"></a></span>
<span id="cb5-15"><a href="#cb5-15"></a><span class="co">- ``dataDir``</span></span>
<span id="cb5-16"><a href="#cb5-16"></a></span>
<span id="cb5-17"><a href="#cb5-17"></a><span class="co">  Directory containing the daily MW SST NetCDF files named ``MW&lt;YYYY&gt;&lt;DDD&gt;*sstd.nc``.</span></span>
<span id="cb5-18"><a href="#cb5-18"></a></span>
<span id="cb5-19"><a href="#cb5-19"></a><span class="co">- ``workDir``</span></span>
<span id="cb5-20"><a href="#cb5-20"></a></span>
<span id="cb5-21"><a href="#cb5-21"></a><span class="co">  Temporary working directory for intermediate files.</span></span>
<span id="cb5-22"><a href="#cb5-22"></a></span>
<span id="cb5-23"><a href="#cb5-23"></a><span class="co">- ``endYear`` </span></span>
<span id="cb5-24"><a href="#cb5-24"></a></span>
<span id="cb5-25"><a href="#cb5-25"></a><span class="co">  Four-digit year of the last day in the composite (e.g., ``2025``).</span></span>
<span id="cb5-26"><a href="#cb5-26"></a></span>
<span id="cb5-27"><a href="#cb5-27"></a><span class="co">- ``endDoy``</span></span>
<span id="cb5-28"><a href="#cb5-28"></a></span>
<span id="cb5-29"><a href="#cb5-29"></a><span class="co">  Three-digit day-of-year of the last day (e.g., ``082``).</span></span>
<span id="cb5-30"><a href="#cb5-30"></a></span>
<span id="cb5-31"><a href="#cb5-31"></a><span class="co">- ``interval``</span></span>
<span id="cb5-32"><a href="#cb5-32"></a></span>
<span id="cb5-33"><a href="#cb5-33"></a><span class="co">  Number of days to include (e.g., `3`, `5`, `8`, `14`).</span></span>
<span id="cb5-34"><a href="#cb5-34"></a></span>
<span id="cb5-35"><a href="#cb5-35"></a><span class="co">Description</span></span>
<span id="cb5-36"><a href="#cb5-36"></a><span class="co">-----------</span></span>
<span id="cb5-37"><a href="#cb5-37"></a><span class="co">1. **Parse arguments &amp; compute dates**  </span></span>
<span id="cb5-38"><a href="#cb5-38"></a></span>
<span id="cb5-39"><a href="#cb5-39"></a><span class="co">  - Read paths and parameters from ``sys.argv``.</span></span>
<span id="cb5-40"><a href="#cb5-40"></a><span class="co">  </span></span>
<span id="cb5-41"><a href="#cb5-41"></a><span class="co">  - Convert ``endYear``+``endDoy`` to a calendar date ``myDateEnd``.</span></span>
<span id="cb5-42"><a href="#cb5-42"></a><span class="co">  </span></span>
<span id="cb5-43"><a href="#cb5-43"></a><span class="co">  - Compute ``myDateStart = myDateEnd - (interval-1) days``.</span></span>
<span id="cb5-44"><a href="#cb5-44"></a><span class="co">  </span></span>
<span id="cb5-45"><a href="#cb5-45"></a><span class="co">  - Zero-pad start and end DOY strings.</span></span>
<span id="cb5-46"><a href="#cb5-46"></a></span>
<span id="cb5-47"><a href="#cb5-47"></a><span class="co">2. **Initialize**</span></span>
<span id="cb5-48"><a href="#cb5-48"></a></span>
<span id="cb5-49"><a href="#cb5-49"></a><span class="co">  - Change into ``workDir`` and clear old files.</span></span>
<span id="cb5-50"><a href="#cb5-50"></a></span>
<span id="cb5-51"><a href="#cb5-51"></a><span class="co">  - Change into ``dataDir``.</span></span>
<span id="cb5-52"><a href="#cb5-52"></a></span>
<span id="cb5-53"><a href="#cb5-53"></a><span class="co">  - Preallocate two 2321x4001 arrays:</span></span>
<span id="cb5-54"><a href="#cb5-54"></a></span>
<span id="cb5-55"><a href="#cb5-55"></a><span class="co">      - ``mean`` (running sum of SST)</span></span>
<span id="cb5-56"><a href="#cb5-56"></a></span>
<span id="cb5-57"><a href="#cb5-57"></a><span class="co">      - ``num``  (count of observations)</span></span>
<span id="cb5-58"><a href="#cb5-58"></a></span>
<span id="cb5-59"><a href="#cb5-59"></a><span class="co">3. **Collect 1-day files**</span></span>
<span id="cb5-60"><a href="#cb5-60"></a></span>
<span id="cb5-61"><a href="#cb5-61"></a><span class="co">  - If ``startDoy ≤ endDoy`` (same year), gather DOYs ``startDoy…endDoy``.</span></span>
<span id="cb5-62"><a href="#cb5-62"></a></span>
<span id="cb5-63"><a href="#cb5-63"></a><span class="co">  - Else, handle year-boundary wrap: DOYs ``startDoy…endOfYear`` and ``1…endDoy``.</span></span>
<span id="cb5-64"><a href="#cb5-64"></a></span>
<span id="cb5-65"><a href="#cb5-65"></a><span class="co">4. **Accumulate SST**</span></span>
<span id="cb5-66"><a href="#cb5-66"></a></span>
<span id="cb5-67"><a href="#cb5-67"></a><span class="co">  For each matching file:</span></span>
<span id="cb5-68"><a href="#cb5-68"></a></span>
<span id="cb5-69"><a href="#cb5-69"></a><span class="co">     - Read and squeeze the 4D SST variable ``"MWsstd"``.</span></span>
<span id="cb5-70"><a href="#cb5-70"></a><span class="co">     </span></span>
<span id="cb5-71"><a href="#cb5-71"></a><span class="co">     - Update ``mean, num`` via ``meanVar(mean, num, sst)``.</span></span>
<span id="cb5-72"><a href="#cb5-72"></a></span>
<span id="cb5-73"><a href="#cb5-73"></a><span class="co">5. **Finalize composite**</span></span>
<span id="cb5-74"><a href="#cb5-74"></a></span>
<span id="cb5-75"><a href="#cb5-75"></a><span class="co">  - Mask out cells with zero observations (``num==0``), setting fill value ``-9999999.``.</span></span>
<span id="cb5-76"><a href="#cb5-76"></a></span>
<span id="cb5-77"><a href="#cb5-77"></a><span class="co">6. **Write &amp; deploy**</span></span>
<span id="cb5-78"><a href="#cb5-78"></a></span>
<span id="cb5-79"><a href="#cb5-79"></a><span class="co">  - Change back to ``workDir``.</span></span>
<span id="cb5-80"><a href="#cb5-80"></a></span>
<span id="cb5-81"><a href="#cb5-81"></a><span class="co">  - Call ``makeNetcdf(mean, num, interval, outFile, filesUsed, workDir)`` to create CF-compliant NetCDF.</span></span>
<span id="cb5-82"><a href="#cb5-82"></a></span>
<span id="cb5-83"><a href="#cb5-83"></a><span class="co">  - Transfer result via ``send_to_servers(ncFile, "/MW/sstd/", str(interval))``.</span></span>
<span id="cb5-84"><a href="#cb5-84"></a></span>
<span id="cb5-85"><a href="#cb5-85"></a><span class="co">Dependencies</span></span>
<span id="cb5-86"><a href="#cb5-86"></a><span class="co">------------</span></span>
<span id="cb5-87"><a href="#cb5-87"></a><span class="co">- **Python 3.x**</span></span>
<span id="cb5-88"><a href="#cb5-88"></a></span>
<span id="cb5-89"><a href="#cb5-89"></a><span class="co">- **Standard library:** ``os``, ``sys``, ``glob``, ``itertools.chain``, ``datetime``, ``timedelta``  </span></span>
<span id="cb5-90"><a href="#cb5-90"></a></span>
<span id="cb5-91"><a href="#cb5-91"></a><span class="co">- **Third-party:** ``netCDF4.Dataset``, ``numpy``, ``numpy.ma``  </span></span>
<span id="cb5-92"><a href="#cb5-92"></a></span>
<span id="cb5-93"><a href="#cb5-93"></a><span class="co">- **Custom roylib functions:**</span></span>
<span id="cb5-94"><a href="#cb5-94"></a></span>
<span id="cb5-95"><a href="#cb5-95"></a><span class="co">  - ``isleap(year)``</span></span>
<span id="cb5-96"><a href="#cb5-96"></a></span>
<span id="cb5-97"><a href="#cb5-97"></a><span class="co">  - ``meanVar(sum_array, count_array, data_slice)``</span></span>
<span id="cb5-98"><a href="#cb5-98"></a></span>
<span id="cb5-99"><a href="#cb5-99"></a><span class="co">  - ``makeNetcdfmDay(mean, num, interval, outFile, filesUsed, workDir)``</span></span>
<span id="cb5-100"><a href="#cb5-100"></a></span>
<span id="cb5-101"><a href="#cb5-101"></a><span class="co">  - ``send_to_servers(ncFile, remote_dir, 'm')``</span></span>
<span id="cb5-102"><a href="#cb5-102"></a></span>
<span id="cb5-103"><a href="#cb5-103"></a><span class="co">Directory Structure</span></span>
<span id="cb5-104"><a href="#cb5-104"></a><span class="co">-------------------</span></span>
<span id="cb5-105"><a href="#cb5-105"></a><span class="co">- **Input Directory** (dataDir):</span></span>
<span id="cb5-106"><a href="#cb5-106"></a></span>
<span id="cb5-107"><a href="#cb5-107"></a><span class="co">  ``MW&lt;YYYY&gt;&lt;DDD&gt;*sstd.nc`` (1-day SST files)</span></span>
<span id="cb5-108"><a href="#cb5-108"></a></span>
<span id="cb5-109"><a href="#cb5-109"></a><span class="co">- **Working directory** (workDir):  </span></span>
<span id="cb5-110"><a href="#cb5-110"></a></span>
<span id="cb5-111"><a href="#cb5-111"></a><span class="co">  Temporary staging for intermediate files  </span></span>
<span id="cb5-112"><a href="#cb5-112"></a></span>
<span id="cb5-113"><a href="#cb5-113"></a><span class="co">- **Output location** (remote):  </span></span>
<span id="cb5-114"><a href="#cb5-114"></a></span>
<span id="cb5-115"><a href="#cb5-115"></a><span class="co">  ``/MW/sstd/&lt;interval&gt;day/`` on the server  </span></span>
<span id="cb5-116"><a href="#cb5-116"></a></span>
<span id="cb5-117"><a href="#cb5-117"></a><span class="co">Usage Example</span></span>
<span id="cb5-118"><a href="#cb5-118"></a><span class="co">-------------</span></span>
<span id="cb5-119"><a href="#cb5-119"></a><span class="co">Generate a 5-day composite ending on 2025 day-of-year 082</span></span>
<span id="cb5-120"><a href="#cb5-120"></a></span>
<span id="cb5-121"><a href="#cb5-121"></a><span class="co">::</span></span>
<span id="cb5-122"><a href="#cb5-122"></a><span class="co"> </span></span>
<span id="cb5-123"><a href="#cb5-123"></a><span class="co">   python CompMWSST.py /Users/you/modis_data/mw/1day/ /Users/you/modis_work/ 2025 082 5</span></span>
<span id="cb5-124"><a href="#cb5-124"></a></span>
<span id="cb5-125"><a href="#cb5-125"></a><span class="co">This command will:</span></span>
<span id="cb5-126"><a href="#cb5-126"></a></span>
<span id="cb5-127"><a href="#cb5-127"></a><span class="co">  - Read the five daily files MW202508?*sstd.nc for DOY 078-082 </span></span>
<span id="cb5-128"><a href="#cb5-128"></a></span>
<span id="cb5-129"><a href="#cb5-129"></a><span class="co">  - Compute the 5-day running average for each grid cell  </span></span>
<span id="cb5-130"><a href="#cb5-130"></a></span>
<span id="cb5-131"><a href="#cb5-131"></a><span class="co">  - Write ``MW2025078_2025082_sstd.nc`` in ``/Users/you/modis_work/`` </span></span>
<span id="cb5-132"><a href="#cb5-132"></a><span class="co">   </span></span>
<span id="cb5-133"><a href="#cb5-133"></a><span class="co">  - Upload it to ``/MW/sstd/5day/`` on the server </span></span>
<span id="cb5-134"><a href="#cb5-134"></a><span class="co">"""</span></span>
<span id="cb5-135"><a href="#cb5-135"></a><span class="im">from</span> __future__ <span class="im">import</span> print_function</span>
<span id="cb5-136"><a href="#cb5-136"></a><span class="im">from</span> builtins <span class="im">import</span> <span class="bu">str</span></span>
<span id="cb5-137"><a href="#cb5-137"></a><span class="im">from</span> builtins <span class="im">import</span> <span class="bu">range</span></span>
<span id="cb5-138"><a href="#cb5-138"></a></span>
<span id="cb5-139"><a href="#cb5-139"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb5-140"><a href="#cb5-140"></a>    <span class="im">from</span> datetime <span class="im">import</span> datetime, timedelta</span>
<span id="cb5-141"><a href="#cb5-141"></a>    <span class="im">import</span> glob</span>
<span id="cb5-142"><a href="#cb5-142"></a>    <span class="im">from</span> itertools <span class="im">import</span> chain</span>
<span id="cb5-143"><a href="#cb5-143"></a>    <span class="im">from</span> netCDF4 <span class="im">import</span> Dataset</span>
<span id="cb5-144"><a href="#cb5-144"></a>    <span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb5-145"><a href="#cb5-145"></a>    <span class="im">import</span> numpy.ma <span class="im">as</span> ma</span>
<span id="cb5-146"><a href="#cb5-146"></a>    <span class="im">import</span> os</span>
<span id="cb5-147"><a href="#cb5-147"></a>    <span class="im">import</span> sys</span>
<span id="cb5-148"><a href="#cb5-148"></a></span>
<span id="cb5-149"><a href="#cb5-149"></a>    <span class="co"># Ensure 'roylib' is on the import path</span></span>
<span id="cb5-150"><a href="#cb5-150"></a>    sys.path.append(<span class="st">'/home/cwatch/pythonLibs'</span>)</span>
<span id="cb5-151"><a href="#cb5-151"></a>    <span class="im">from</span> roylib <span class="im">import</span> <span class="op">*</span></span>
<span id="cb5-152"><a href="#cb5-152"></a></span>
<span id="cb5-153"><a href="#cb5-153"></a>    <span class="co"># Directory with 1-day MW SST NetCDFs</span></span>
<span id="cb5-154"><a href="#cb5-154"></a>    dataDir <span class="op">=</span> sys.argv[<span class="dv">1</span>]</span>
<span id="cb5-155"><a href="#cb5-155"></a></span>
<span id="cb5-156"><a href="#cb5-156"></a>    <span class="co"># Temporary working directory</span></span>
<span id="cb5-157"><a href="#cb5-157"></a>    workDir <span class="op">=</span> sys.argv[<span class="dv">2</span>]</span>
<span id="cb5-158"><a href="#cb5-158"></a></span>
<span id="cb5-159"><a href="#cb5-159"></a>    <span class="co"># Composite end year (YYYY)</span></span>
<span id="cb5-160"><a href="#cb5-160"></a>    endyearC <span class="op">=</span> sys.argv[<span class="dv">3</span>]</span>
<span id="cb5-161"><a href="#cb5-161"></a></span>
<span id="cb5-162"><a href="#cb5-162"></a>    <span class="co"># Composite end day-of-year (DDD)</span></span>
<span id="cb5-163"><a href="#cb5-163"></a>    endDoyC <span class="op">=</span> sys.argv[<span class="dv">4</span>]</span>
<span id="cb5-164"><a href="#cb5-164"></a>    endDoyC <span class="op">=</span> endDoyC.rjust(<span class="dv">3</span>, <span class="st">'0'</span>)</span>
<span id="cb5-165"><a href="#cb5-165"></a></span>
<span id="cb5-166"><a href="#cb5-166"></a>    <span class="co"># Integer form of end day-of-year</span></span>
<span id="cb5-167"><a href="#cb5-167"></a>    endDoy <span class="op">=</span> <span class="bu">int</span>(endDoyC)</span>
<span id="cb5-168"><a href="#cb5-168"></a></span>
<span id="cb5-169"><a href="#cb5-169"></a>    <span class="co"># Composite length as string</span></span>
<span id="cb5-170"><a href="#cb5-170"></a>    intervalC <span class="op">=</span> sys.argv[<span class="dv">5</span>]</span>
<span id="cb5-171"><a href="#cb5-171"></a></span>
<span id="cb5-172"><a href="#cb5-172"></a>    <span class="bu">print</span>(dataDir)</span>
<span id="cb5-173"><a href="#cb5-173"></a>    <span class="bu">print</span>(intervalC)</span>
<span id="cb5-174"><a href="#cb5-174"></a></span>
<span id="cb5-175"><a href="#cb5-175"></a>    <span class="co"># Composite length as integer</span></span>
<span id="cb5-176"><a href="#cb5-176"></a>    interval <span class="op">=</span> <span class="bu">int</span>(intervalC)</span>
<span id="cb5-177"><a href="#cb5-177"></a></span>
<span id="cb5-178"><a href="#cb5-178"></a>    <span class="co"># Convert end Doy to calendar date</span></span>
<span id="cb5-179"><a href="#cb5-179"></a>    myDateEnd <span class="op">=</span> datetime(<span class="bu">int</span>(endyearC), <span class="dv">1</span>, <span class="dv">1</span>) <span class="op">+</span> timedelta(<span class="bu">int</span>(endDoyC) <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb5-180"><a href="#cb5-180"></a></span>
<span id="cb5-181"><a href="#cb5-181"></a>    <span class="co"># Start date = end date minus (interval-1) days</span></span>
<span id="cb5-182"><a href="#cb5-182"></a>    myDateStart <span class="op">=</span> myDateEnd <span class="op">+</span> timedelta(days<span class="op">=-</span>(interval <span class="op">-</span> <span class="dv">1</span>))</span>
<span id="cb5-183"><a href="#cb5-183"></a></span>
<span id="cb5-184"><a href="#cb5-184"></a>    <span class="co"># Zero-padded start Doy and year</span></span>
<span id="cb5-185"><a href="#cb5-185"></a>    startDoyC <span class="op">=</span> myDateStart.strftime(<span class="st">"%j"</span>).zfill(<span class="dv">3</span>)</span>
<span id="cb5-186"><a href="#cb5-186"></a>    startDoy <span class="op">=</span> <span class="bu">int</span>(startDoyC)</span>
<span id="cb5-187"><a href="#cb5-187"></a>    startYearC <span class="op">=</span> <span class="bu">str</span>(myDateStart.year)</span>
<span id="cb5-188"><a href="#cb5-188"></a></span>
<span id="cb5-189"><a href="#cb5-189"></a>    <span class="co"># Prepare output directory </span></span>
<span id="cb5-190"><a href="#cb5-190"></a>    outDir <span class="op">=</span> <span class="st">'/ERDData1/modisa/data/modiswc/'</span> <span class="op">+</span> endyearC <span class="op">+</span> <span class="st">'/'</span> <span class="op">+</span> intervalC <span class="op">+</span> <span class="st">'day'</span></span>
<span id="cb5-191"><a href="#cb5-191"></a></span>
<span id="cb5-192"><a href="#cb5-192"></a>    <span class="bu">print</span>(dataDir)</span>
<span id="cb5-193"><a href="#cb5-193"></a>    <span class="bu">print</span>(workDir)</span>
<span id="cb5-194"><a href="#cb5-194"></a>    <span class="bu">print</span>(endyearC)</span>
<span id="cb5-195"><a href="#cb5-195"></a>    <span class="bu">print</span>(endDoyC)</span>
<span id="cb5-196"><a href="#cb5-196"></a>    <span class="bu">print</span>(intervalC)</span>
<span id="cb5-197"><a href="#cb5-197"></a></span>
<span id="cb5-198"><a href="#cb5-198"></a>    <span class="co">###</span></span>
<span id="cb5-199"><a href="#cb5-199"></a>    <span class="co"># dtypeList = ['sstd']</span></span>
<span id="cb5-200"><a href="#cb5-200"></a>    <span class="co"># for dtype in dtypeList:</span></span>
<span id="cb5-201"><a href="#cb5-201"></a></span>
<span id="cb5-202"><a href="#cb5-202"></a>    <span class="co"># Data type for SST composites</span></span>
<span id="cb5-203"><a href="#cb5-203"></a>    dtype <span class="op">=</span> <span class="st">'sstd'</span></span>
<span id="cb5-204"><a href="#cb5-204"></a></span>
<span id="cb5-205"><a href="#cb5-205"></a>    <span class="co"># Clear working directory</span></span>
<span id="cb5-206"><a href="#cb5-206"></a>    os.chdir(workDir)</span>
<span id="cb5-207"><a href="#cb5-207"></a>    os.system(<span class="st">'rm -f *'</span>)</span>
<span id="cb5-208"><a href="#cb5-208"></a></span>
<span id="cb5-209"><a href="#cb5-209"></a>    <span class="co"># Move to data directory</span></span>
<span id="cb5-210"><a href="#cb5-210"></a>    os.chdir(dataDir)</span>
<span id="cb5-211"><a href="#cb5-211"></a></span>
<span id="cb5-212"><a href="#cb5-212"></a>    <span class="co"># Preallocate sum (mean) and count arrays matching grid dims</span></span>
<span id="cb5-213"><a href="#cb5-213"></a>    mean <span class="op">=</span> np.zeros((<span class="dv">2321</span>, <span class="dv">4001</span>), np.single)</span>
<span id="cb5-214"><a href="#cb5-214"></a>    num <span class="op">=</span> np.zeros((<span class="dv">2321</span>, <span class="dv">4001</span>), dtype<span class="op">=</span>np.int32)</span>
<span id="cb5-215"><a href="#cb5-215"></a></span>
<span id="cb5-216"><a href="#cb5-216"></a>    <span class="co"># Collect all NetCDF files spanning startDoy..endDoy</span></span>
<span id="cb5-217"><a href="#cb5-217"></a>    <span class="cf">if</span> (endDoy <span class="op">&gt;</span> startDoy):</span>
<span id="cb5-218"><a href="#cb5-218"></a>        <span class="co"># Same-year composite</span></span>
<span id="cb5-219"><a href="#cb5-219"></a>        doyRange <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(startDoy, endDoy <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb5-220"><a href="#cb5-220"></a>        fileList <span class="op">=</span> []</span>
<span id="cb5-221"><a href="#cb5-221"></a>        <span class="cf">for</span> doy <span class="kw">in</span> doyRange:</span>
<span id="cb5-222"><a href="#cb5-222"></a>            doyC <span class="op">=</span> <span class="bu">str</span>(doy)</span>
<span id="cb5-223"><a href="#cb5-223"></a>            doyC <span class="op">=</span> doyC.rjust(<span class="dv">3</span>, <span class="st">'0'</span>)</span>
<span id="cb5-224"><a href="#cb5-224"></a>            myString <span class="op">=</span> <span class="st">'MW'</span> <span class="op">+</span> endyearC <span class="op">+</span> doyC <span class="op">+</span> <span class="st">'*'</span> <span class="op">+</span> dtype <span class="op">+</span> <span class="st">'.nc'</span></span>
<span id="cb5-225"><a href="#cb5-225"></a>            fileList.append(glob.glob(myString))</span>
<span id="cb5-226"><a href="#cb5-226"></a></span>
<span id="cb5-227"><a href="#cb5-227"></a>        <span class="co"># Flatten nested lists and sort</span></span>
<span id="cb5-228"><a href="#cb5-228"></a>        fileList <span class="op">=</span> <span class="bu">list</span>(chain.from_iterable(fileList))</span>
<span id="cb5-229"><a href="#cb5-229"></a>        fileList.sort()</span>
<span id="cb5-230"><a href="#cb5-230"></a>        <span class="bu">print</span>(fileList)</span>
<span id="cb5-231"><a href="#cb5-231"></a></span>
<span id="cb5-232"><a href="#cb5-232"></a>        filesUsed <span class="op">=</span> <span class="st">""</span></span>
<span id="cb5-233"><a href="#cb5-233"></a>        <span class="cf">for</span> fName <span class="kw">in</span> fileList:</span>
<span id="cb5-234"><a href="#cb5-234"></a>            <span class="co"># Build comma-separated list of files used</span></span>
<span id="cb5-235"><a href="#cb5-235"></a>            <span class="cf">if</span> (<span class="bu">len</span>(filesUsed) <span class="op">==</span> <span class="dv">0</span>):</span>
<span id="cb5-236"><a href="#cb5-236"></a>                filesUsed <span class="op">=</span> fName</span>
<span id="cb5-237"><a href="#cb5-237"></a>            <span class="cf">else</span>:</span>
<span id="cb5-238"><a href="#cb5-238"></a>                filesUsed <span class="op">=</span> filesUsed <span class="op">+</span> <span class="st">', '</span> <span class="op">+</span> fName</span>
<span id="cb5-239"><a href="#cb5-239"></a></span>
<span id="cb5-240"><a href="#cb5-240"></a>            <span class="co"># Open NetCDF file and extract 4D SST variable</span></span>
<span id="cb5-241"><a href="#cb5-241"></a>            sstFile <span class="op">=</span> Dataset(fName)</span>
<span id="cb5-242"><a href="#cb5-242"></a>            sst <span class="op">=</span> sstFile.variables[<span class="st">"MWsstd"</span>][:, :, :, :]</span>
<span id="cb5-243"><a href="#cb5-243"></a>            sstFile.close()</span>
<span id="cb5-244"><a href="#cb5-244"></a></span>
<span id="cb5-245"><a href="#cb5-245"></a>            <span class="co"># Squeeze to remove singleton dimensions -&gt; 2D array</span></span>
<span id="cb5-246"><a href="#cb5-246"></a>            sst <span class="op">=</span> np.squeeze(sst)</span>
<span id="cb5-247"><a href="#cb5-247"></a></span>
<span id="cb5-248"><a href="#cb5-248"></a>            <span class="co"># Update running mean and count arrays</span></span>
<span id="cb5-249"><a href="#cb5-249"></a>            mean, num <span class="op">=</span> meanVar(mean, num, sst)</span>
<span id="cb5-250"><a href="#cb5-250"></a></span>
<span id="cb5-251"><a href="#cb5-251"></a>    <span class="cf">else</span>:</span>
<span id="cb5-252"><a href="#cb5-252"></a>        <span class="co"># Compute directory for start of year by replacing year in path</span></span>
<span id="cb5-253"><a href="#cb5-253"></a>        dataDir1 <span class="op">=</span> dataDir</span>
<span id="cb5-254"><a href="#cb5-254"></a>        dataDir1 <span class="op">=</span> dataDir1.replace(endyearC, startYearC)</span>
<span id="cb5-255"><a href="#cb5-255"></a></span>
<span id="cb5-256"><a href="#cb5-256"></a>        <span class="co"># Determine end-of-year DOY based on leap year</span></span>
<span id="cb5-257"><a href="#cb5-257"></a>        <span class="cf">if</span>(isleap):</span>
<span id="cb5-258"><a href="#cb5-258"></a>            endday <span class="op">=</span> <span class="dv">366</span></span>
<span id="cb5-259"><a href="#cb5-259"></a>        <span class="cf">else</span>:</span>
<span id="cb5-260"><a href="#cb5-260"></a>            endday <span class="op">=</span> <span class="dv">365</span></span>
<span id="cb5-261"><a href="#cb5-261"></a></span>
<span id="cb5-262"><a href="#cb5-262"></a>        <span class="co"># From startDoy through end of startYearC</span></span>
<span id="cb5-263"><a href="#cb5-263"></a>        fileList <span class="op">=</span> []</span>
<span id="cb5-264"><a href="#cb5-264"></a>        os.chdir(dataDir1)</span>
<span id="cb5-265"><a href="#cb5-265"></a>        doyRange <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(startDoy, endday <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb5-266"><a href="#cb5-266"></a>        <span class="cf">for</span> doy <span class="kw">in</span> doyRange:</span>
<span id="cb5-267"><a href="#cb5-267"></a>            doyC <span class="op">=</span> <span class="bu">str</span>(doy)</span>
<span id="cb5-268"><a href="#cb5-268"></a>            doyC <span class="op">=</span> doyC.rjust(<span class="dv">3</span>, <span class="st">'0'</span>)</span>
<span id="cb5-269"><a href="#cb5-269"></a>            myString <span class="op">=</span> <span class="st">'MW'</span> <span class="op">+</span> startYearC <span class="op">+</span> doyC <span class="op">+</span> <span class="st">'*'</span> <span class="op">+</span> dtype <span class="op">+</span> <span class="st">'.nc'</span></span>
<span id="cb5-270"><a href="#cb5-270"></a>            fileList.append(glob.glob(myString))</span>
<span id="cb5-271"><a href="#cb5-271"></a></span>
<span id="cb5-272"><a href="#cb5-272"></a>        fileList <span class="op">=</span> <span class="bu">list</span>(chain.from_iterable(fileList))</span>
<span id="cb5-273"><a href="#cb5-273"></a>        fileList.sort()</span>
<span id="cb5-274"><a href="#cb5-274"></a>        <span class="bu">print</span>(fileList)</span>
<span id="cb5-275"><a href="#cb5-275"></a></span>
<span id="cb5-276"><a href="#cb5-276"></a>        filesUsed <span class="op">=</span> <span class="st">''</span></span>
<span id="cb5-277"><a href="#cb5-277"></a>        <span class="cf">for</span> fName <span class="kw">in</span> fileList:</span>
<span id="cb5-278"><a href="#cb5-278"></a>            <span class="cf">if</span> (<span class="bu">len</span>(filesUsed) <span class="op">==</span> <span class="dv">0</span>):</span>
<span id="cb5-279"><a href="#cb5-279"></a>                filesUsed <span class="op">=</span> fName</span>
<span id="cb5-280"><a href="#cb5-280"></a>            <span class="cf">else</span>:</span>
<span id="cb5-281"><a href="#cb5-281"></a>                filesUsed <span class="op">=</span> filesUsed <span class="op">+</span> <span class="st">', '</span> <span class="op">+</span> fName</span>
<span id="cb5-282"><a href="#cb5-282"></a></span>
<span id="cb5-283"><a href="#cb5-283"></a>            sstFile <span class="op">=</span> Dataset(fName)</span>
<span id="cb5-284"><a href="#cb5-284"></a>            sst <span class="op">=</span> sstFile.variables[<span class="st">"MWsstd"</span>][:, :, :, :]</span>
<span id="cb5-285"><a href="#cb5-285"></a>            sstFile.close()</span>
<span id="cb5-286"><a href="#cb5-286"></a>            sst <span class="op">=</span> np.squeeze(sst)</span>
<span id="cb5-287"><a href="#cb5-287"></a>            mean, num <span class="op">=</span> meanVar(mean, num, sst)</span>
<span id="cb5-288"><a href="#cb5-288"></a></span>
<span id="cb5-289"><a href="#cb5-289"></a>        <span class="co"># From DOY=1 of endyearC through endDoy</span></span>
<span id="cb5-290"><a href="#cb5-290"></a>        os.chdir(dataDir)</span>
<span id="cb5-291"><a href="#cb5-291"></a>        fileList <span class="op">=</span> []</span>
<span id="cb5-292"><a href="#cb5-292"></a>        doyRange<span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="dv">1</span>, endDoy <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb5-293"><a href="#cb5-293"></a>        <span class="cf">for</span> doy <span class="kw">in</span> doyRange:</span>
<span id="cb5-294"><a href="#cb5-294"></a>            doyC <span class="op">=</span> <span class="bu">str</span>(doy)</span>
<span id="cb5-295"><a href="#cb5-295"></a>            doyC <span class="op">=</span> doyC.rjust(<span class="dv">3</span>, <span class="st">'0'</span>)</span>
<span id="cb5-296"><a href="#cb5-296"></a>            myString <span class="op">=</span> <span class="st">'MW'</span> <span class="op">+</span> endyearC <span class="op">+</span> doyC <span class="op">+</span> <span class="st">'*'</span> <span class="op">+</span> dtype <span class="op">+</span> <span class="st">'.nc'</span></span>
<span id="cb5-297"><a href="#cb5-297"></a>            fileList.append(glob.glob(myString))</span>
<span id="cb5-298"><a href="#cb5-298"></a></span>
<span id="cb5-299"><a href="#cb5-299"></a>        fileList <span class="op">=</span> <span class="bu">list</span>(chain.from_iterable(fileList))</span>
<span id="cb5-300"><a href="#cb5-300"></a>        fileList.sort()</span>
<span id="cb5-301"><a href="#cb5-301"></a>        <span class="bu">print</span>(fileList)</span>
<span id="cb5-302"><a href="#cb5-302"></a></span>
<span id="cb5-303"><a href="#cb5-303"></a>        <span class="cf">for</span> fName <span class="kw">in</span> fileList:</span>
<span id="cb5-304"><a href="#cb5-304"></a>            <span class="cf">if</span> (<span class="bu">len</span>(filesUsed) <span class="op">==</span> <span class="dv">0</span>):</span>
<span id="cb5-305"><a href="#cb5-305"></a>                filesUsed <span class="op">=</span> fName</span>
<span id="cb5-306"><a href="#cb5-306"></a>            <span class="cf">else</span>:</span>
<span id="cb5-307"><a href="#cb5-307"></a>                filesUsed <span class="op">=</span> filesUsed <span class="op">+</span> <span class="st">', '</span> <span class="op">+</span> fName</span>
<span id="cb5-308"><a href="#cb5-308"></a></span>
<span id="cb5-309"><a href="#cb5-309"></a>            sstFile <span class="op">=</span> Dataset(fName)</span>
<span id="cb5-310"><a href="#cb5-310"></a>            sst <span class="op">=</span> sstFile.variables[<span class="st">"MWsstd"</span>][:, :, :, :]</span>
<span id="cb5-311"><a href="#cb5-311"></a>            sstFile.close()</span>
<span id="cb5-312"><a href="#cb5-312"></a>            sst <span class="op">=</span> np.squeeze(sst)</span>
<span id="cb5-313"><a href="#cb5-313"></a>            mean, num <span class="op">=</span> meanVar(mean, num, sst)</span>
<span id="cb5-314"><a href="#cb5-314"></a></span>
<span id="cb5-315"><a href="#cb5-315"></a>    <span class="co"># Mask out any grid cells with zero observations, setting them to the fill value</span></span>
<span id="cb5-316"><a href="#cb5-316"></a>    mean <span class="op">=</span> ma.array(mean, mask<span class="op">=</span>(num <span class="op">==</span> <span class="dv">0</span>), fill_value<span class="op">=-</span><span class="fl">9999999.</span>)</span>
<span id="cb5-317"><a href="#cb5-317"></a>    <span class="bu">print</span>(<span class="st">'COmpMWSST finished mean'</span>)</span>
<span id="cb5-318"><a href="#cb5-318"></a></span>
<span id="cb5-319"><a href="#cb5-319"></a>    <span class="co"># Switch to the working directory for output operations</span></span>
<span id="cb5-320"><a href="#cb5-320"></a>    os.chdir(workDir)</span>
<span id="cb5-321"><a href="#cb5-321"></a></span>
<span id="cb5-322"><a href="#cb5-322"></a>    <span class="co"># Construct the output filename with start and end dates plus data types</span></span>
<span id="cb5-323"><a href="#cb5-323"></a>    outFile <span class="op">=</span> <span class="st">'MW'</span> <span class="op">+</span> startYearC <span class="op">+</span> startDoyC <span class="op">+</span> <span class="st">'_'</span> <span class="op">+</span> endyearC <span class="op">+</span> endDoyC <span class="op">+</span> <span class="st">'_'</span> <span class="op">+</span> dtype <span class="op">+</span> <span class="st">'.nc'</span></span>
<span id="cb5-324"><a href="#cb5-324"></a></span>
<span id="cb5-325"><a href="#cb5-325"></a>    <span class="co"># Create multi-day NetCDF file using the mean and count arrays</span></span>
<span id="cb5-326"><a href="#cb5-326"></a>    ncFile <span class="op">=</span> makeNetcdf(mean, num, interval, outFile, filesUsed, workDir)</span>
<span id="cb5-327"><a href="#cb5-327"></a></span>
<span id="cb5-328"><a href="#cb5-328"></a>    <span class="co"># Directory on the remote server for storing the multi-day SST product</span></span>
<span id="cb5-329"><a href="#cb5-329"></a>    remote_dir <span class="op">=</span> <span class="st">'/MW/sstd/'</span></span>
<span id="cb5-330"><a href="#cb5-330"></a></span>
<span id="cb5-331"><a href="#cb5-331"></a>    <span class="co"># Transfer the generated NetCDF file to the remote server directory, labeling it with the interval</span></span>
<span id="cb5-332"><a href="#cb5-332"></a>    send_to_servers(ncFile, remote_dir , <span class="bu">str</span>(interval))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="compmwsstmday" class="level3">
<h3 class="anchored" data-anchor-id="compmwsstmday">CompMWSSTmday</h3>
<p><code>CompMWSSTmday.py</code> computes a monthly composite SST by reading 1-day composite MW SST NetCDFs over the specified date range and averaging them on a 0.0125° x 0.0125° regular grid covering longitude 205°–255° and latitude 22°–51°. It then masks out any pixels with no valid observations, writes the result as a CF-compliant NetCDF, and uploads it to a directory on a remote server. Find the monthly composite product on ERDDAP <a href="./modisa_scripts.html#modisa-products-on-swfsc-erddap-server">here</a>.</p>
<p>The following chart summarizes the script’s workflow:</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">%%{init: {"flowchart":{"htmlLabels":true}}}%%
flowchart LR
  I("&lt;b&gt;Inputs&lt;/b&gt;&lt;br/&gt;• 1-day composite NetCDFs (dataDir)&lt;br/&gt;• workDir&lt;br/&gt;• endYear &amp; endDoy&lt;br/&gt;• startDoy")
    --&gt; P("&lt;b&gt;Processing&lt;/b&gt;&lt;br/&gt;• Parse args &amp; compute interval&lt;br/&gt;• Compute start/end dates&lt;br/&gt;• Clear workDir &amp; initialize mean/num arrays&lt;br/&gt;• Gather files spanning startDoy…endDoy&lt;br/&gt;• Loop: open each file &amp; update mean/num&lt;br/&gt;• Mask zero‐observation pixels")
    --&gt; O("&lt;b&gt;Output&lt;/b&gt;&lt;br/&gt;• CF-compliant monthly composite NetCDF&lt;br/&gt;• Deployed to /MW/sstd/mday/")
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<div id="dff143e8" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>View CompMWSSTmday.py</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1"></a><span class="co">"""</span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="co">Overview</span></span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="co">--------</span></span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="co">Compute monthly SST composites for the MODIS MW (West Coast) region by averaging</span></span>
<span id="cb6-5"><a href="#cb6-5"></a><span class="co">daily 1-day SST NetCDF products over a specified interval.</span></span>
<span id="cb6-6"><a href="#cb6-6"></a></span>
<span id="cb6-7"><a href="#cb6-7"></a><span class="co">Usage</span></span>
<span id="cb6-8"><a href="#cb6-8"></a><span class="co">-----</span></span>
<span id="cb6-9"><a href="#cb6-9"></a><span class="co">::</span></span>
<span id="cb6-10"><a href="#cb6-10"></a><span class="co">  </span></span>
<span id="cb6-11"><a href="#cb6-11"></a><span class="co">    python CompMWSSTmday.py &lt;dataDir&gt; &lt;workDir&gt; &lt;endYear&gt; &lt;endDoy&gt; &lt;startDoy&gt;</span></span>
<span id="cb6-12"><a href="#cb6-12"></a></span>
<span id="cb6-13"><a href="#cb6-13"></a><span class="co">Where:</span></span>
<span id="cb6-14"><a href="#cb6-14"></a></span>
<span id="cb6-15"><a href="#cb6-15"></a><span class="co">- ``dataDir``</span></span>
<span id="cb6-16"><a href="#cb6-16"></a></span>
<span id="cb6-17"><a href="#cb6-17"></a><span class="co">  Directory containing 1-day NetCDF files named ``MW&lt;YYYY&gt;&lt;DDD&gt;*sstd.nc``</span></span>
<span id="cb6-18"><a href="#cb6-18"></a></span>
<span id="cb6-19"><a href="#cb6-19"></a><span class="co">- ``workDir``</span></span>
<span id="cb6-20"><a href="#cb6-20"></a></span>
<span id="cb6-21"><a href="#cb6-21"></a><span class="co">  Temporary working directory for intermediate files</span></span>
<span id="cb6-22"><a href="#cb6-22"></a></span>
<span id="cb6-23"><a href="#cb6-23"></a><span class="co">- ``endYear``   </span></span>
<span id="cb6-24"><a href="#cb6-24"></a></span>
<span id="cb6-25"><a href="#cb6-25"></a><span class="co">  Four-digit year of the last day in the composite (e.g., ``2025``)</span></span>
<span id="cb6-26"><a href="#cb6-26"></a></span>
<span id="cb6-27"><a href="#cb6-27"></a><span class="co">- ``endDoy``</span></span>
<span id="cb6-28"><a href="#cb6-28"></a></span>
<span id="cb6-29"><a href="#cb6-29"></a><span class="co">  Three-digit day-of-year of the last day (e.g., ``082``)</span></span>
<span id="cb6-30"><a href="#cb6-30"></a></span>
<span id="cb6-31"><a href="#cb6-31"></a><span class="co">- ``startDoy``</span></span>
<span id="cb6-32"><a href="#cb6-32"></a></span>
<span id="cb6-33"><a href="#cb6-33"></a><span class="co">  Three-digit day-of-year of the first day (e.g., ``075``)</span></span>
<span id="cb6-34"><a href="#cb6-34"></a></span>
<span id="cb6-35"><a href="#cb6-35"></a><span class="co">Description</span></span>
<span id="cb6-36"><a href="#cb6-36"></a><span class="co">-----------</span></span>
<span id="cb6-37"><a href="#cb6-37"></a><span class="co">1. **Parse command-line arguments** and compute the composite length:</span></span>
<span id="cb6-38"><a href="#cb6-38"></a></span>
<span id="cb6-39"><a href="#cb6-39"></a><span class="co">  - Read ``dataDir``, ``workDir``, ``endYear``, ``endDoy``, ``startDoy``.</span></span>
<span id="cb6-40"><a href="#cb6-40"></a></span>
<span id="cb6-41"><a href="#cb6-41"></a><span class="co">  - Zero-pad ``endDoy`` and ``startDoy``, compute ``interval = endDoy - startDoy + 1``.</span></span>
<span id="cb6-42"><a href="#cb6-42"></a></span>
<span id="cb6-43"><a href="#cb6-43"></a><span class="co">2. **Convert endDoy to a calendar date** (``myDateEnd``) for logging or output paths.</span></span>
<span id="cb6-44"><a href="#cb6-44"></a></span>
<span id="cb6-45"><a href="#cb6-45"></a><span class="co">3. **Gather all 1-day SST files** spanning ``startDoy..endDoy``:</span></span>
<span id="cb6-46"><a href="#cb6-46"></a></span>
<span id="cb6-47"><a href="#cb6-47"></a><span class="co">  - Build glob patterns ``MW&lt;year&gt;&lt;DDD&gt;*sstd.nc``</span></span>
<span id="cb6-48"><a href="#cb6-48"></a></span>
<span id="cb6-49"><a href="#cb6-49"></a><span class="co">  - Handles same-year and year-boundary wrap-around cases.</span></span>
<span id="cb6-50"><a href="#cb6-50"></a></span>
<span id="cb6-51"><a href="#cb6-51"></a><span class="co">4. **Initialize accumulators**:</span></span>
<span id="cb6-52"><a href="#cb6-52"></a></span>
<span id="cb6-53"><a href="#cb6-53"></a><span class="co">  - ``mean`` (float32) and ``num`` (int32) arrays of shape 2321x4001.</span></span>
<span id="cb6-54"><a href="#cb6-54"></a></span>
<span id="cb6-55"><a href="#cb6-55"></a><span class="co">5. **Loop over each NetCDF**:</span></span>
<span id="cb6-56"><a href="#cb6-56"></a></span>
<span id="cb6-57"><a href="#cb6-57"></a><span class="co">  - Open with ``Dataset()``.</span></span>
<span id="cb6-58"><a href="#cb6-58"></a></span>
<span id="cb6-59"><a href="#cb6-59"></a><span class="co">  - Read the 4D variable ``MWsstd``, squeeze to 2D.</span></span>
<span id="cb6-60"><a href="#cb6-60"></a></span>
<span id="cb6-61"><a href="#cb6-61"></a><span class="co">  - Update running ``mean`` and ``num`` via ``meanVar(mean, num, sst)``.</span></span>
<span id="cb6-62"><a href="#cb6-62"></a></span>
<span id="cb6-63"><a href="#cb6-63"></a><span class="co">6. **Mask unobserved cells** (``num ==0``) and set fill value ``-9999999``.</span></span>
<span id="cb6-64"><a href="#cb6-64"></a></span>
<span id="cb6-65"><a href="#cb6-65"></a><span class="co">7. **Write composite**:</span></span>
<span id="cb6-66"><a href="#cb6-66"></a></span>
<span id="cb6-67"><a href="#cb6-67"></a><span class="co">  - Call ``makeNetcdfmDay(mean, num, interval, outFile, filesUsed, workDir)`` to produce a CF-compliant NetCDF.</span></span>
<span id="cb6-68"><a href="#cb6-68"></a></span>
<span id="cb6-69"><a href="#cb6-69"></a><span class="co">8. **Transfer result**:</span></span>
<span id="cb6-70"><a href="#cb6-70"></a></span>
<span id="cb6-71"><a href="#cb6-71"></a><span class="co">  - Use ``send_to_servers(ncFile, '/MW/sstd/', 'm')`` to copy the composite to the remote directory.</span></span>
<span id="cb6-72"><a href="#cb6-72"></a></span>
<span id="cb6-73"><a href="#cb6-73"></a><span class="co">Dependencies</span></span>
<span id="cb6-74"><a href="#cb6-74"></a><span class="co">------------</span></span>
<span id="cb6-75"><a href="#cb6-75"></a><span class="co">- **Python 3.x**</span></span>
<span id="cb6-76"><a href="#cb6-76"></a></span>
<span id="cb6-77"><a href="#cb6-77"></a><span class="co">- **Standard library:** ``os``, ``sys``, ``glob``, ``itertools.chain``, ``datetime``, ``timedelta``</span></span>
<span id="cb6-78"><a href="#cb6-78"></a></span>
<span id="cb6-79"><a href="#cb6-79"></a><span class="co">- **Third-party:** ``numpy``, ``numpy.ma``, ``netCDF4.Dataset``</span></span>
<span id="cb6-80"><a href="#cb6-80"></a></span>
<span id="cb6-81"><a href="#cb6-81"></a><span class="co">- **Custom roylib functions:**</span></span>
<span id="cb6-82"><a href="#cb6-82"></a></span>
<span id="cb6-83"><a href="#cb6-83"></a><span class="co">  - ``isleap(year)``</span></span>
<span id="cb6-84"><a href="#cb6-84"></a></span>
<span id="cb6-85"><a href="#cb6-85"></a><span class="co">  - ``meanVar(sum_array, count_array, data_slice)``</span></span>
<span id="cb6-86"><a href="#cb6-86"></a></span>
<span id="cb6-87"><a href="#cb6-87"></a><span class="co">  - ``makeNetcdfmDay(mean, num, interval, outFile, filesUsed, workDir)``</span></span>
<span id="cb6-88"><a href="#cb6-88"></a></span>
<span id="cb6-89"><a href="#cb6-89"></a><span class="co">  - ``send_to_servers(ncFile, remote_dir, 'm')``</span></span>
<span id="cb6-90"><a href="#cb6-90"></a></span>
<span id="cb6-91"><a href="#cb6-91"></a><span class="co">Directory Structure</span></span>
<span id="cb6-92"><a href="#cb6-92"></a><span class="co">-------------------</span></span>
<span id="cb6-93"><a href="#cb6-93"></a><span class="co">- **Input directory** (dataDir):</span></span>
<span id="cb6-94"><a href="#cb6-94"></a></span>
<span id="cb6-95"><a href="#cb6-95"></a><span class="co">  Contains files like ``MWYYYYDDD*sstd.nc``, one per day.</span></span>
<span id="cb6-96"><a href="#cb6-96"></a></span>
<span id="cb6-97"><a href="#cb6-97"></a><span class="co">- **Working directory** (workDir):</span></span>
<span id="cb6-98"><a href="#cb6-98"></a></span>
<span id="cb6-99"><a href="#cb6-99"></a><span class="co">  Cleared and used for any temporary artifacts (none persisted).</span></span>
<span id="cb6-100"><a href="#cb6-100"></a></span>
<span id="cb6-101"><a href="#cb6-101"></a><span class="co">- **Output Location** (via ``makeNetcdfmDay``):</span></span>
<span id="cb6-102"><a href="#cb6-102"></a></span>
<span id="cb6-103"><a href="#cb6-103"></a><span class="co">  Writes ``MW&lt;startYYYY&gt;&lt;startDDD&gt;_&lt;endYYYY&gt;&lt;endDDD&gt;_sstd.nc`` in ``&lt;workDir&gt;`` and then copies it to ``/MW/sstd/``.</span></span>
<span id="cb6-104"><a href="#cb6-104"></a></span>
<span id="cb6-105"><a href="#cb6-105"></a><span class="co">Usage Example</span></span>
<span id="cb6-106"><a href="#cb6-106"></a><span class="co">-------------</span></span>
<span id="cb6-107"><a href="#cb6-107"></a><span class="co">Create a January 2025 composite (DOY 001-031):</span></span>
<span id="cb6-108"><a href="#cb6-108"></a></span>
<span id="cb6-109"><a href="#cb6-109"></a><span class="co">::</span></span>
<span id="cb6-110"><a href="#cb6-110"></a><span class="co"> </span></span>
<span id="cb6-111"><a href="#cb6-111"></a><span class="co">   python CompMWSSTmday.py /path/to/MW/1day/ /path/to/tmp/ 2025 031 001</span></span>
<span id="cb6-112"><a href="#cb6-112"></a></span>
<span id="cb6-113"><a href="#cb6-113"></a><span class="co">This command will:</span></span>
<span id="cb6-114"><a href="#cb6-114"></a></span>
<span id="cb6-115"><a href="#cb6-115"></a><span class="co">  - Read daily SST files ``MW2025001*…MW2025031*`` from ``/path/to/MW/1day/``.</span></span>
<span id="cb6-116"><a href="#cb6-116"></a></span>
<span id="cb6-117"><a href="#cb6-117"></a><span class="co">  - Compute the 31-day average for each grid cell.</span></span>
<span id="cb6-118"><a href="#cb6-118"></a></span>
<span id="cb6-119"><a href="#cb6-119"></a><span class="co">  - Write ``MW2025001_2025031_sstd.nc`` in ``/path/to/tmp/``. </span></span>
<span id="cb6-120"><a href="#cb6-120"></a></span>
<span id="cb6-121"><a href="#cb6-121"></a><span class="co">  - Upload the composite to ``/MW/sstd/`` on the server.</span></span>
<span id="cb6-122"><a href="#cb6-122"></a><span class="co">"""</span></span>
<span id="cb6-123"><a href="#cb6-123"></a><span class="im">from</span> __future__ <span class="im">import</span> print_function</span>
<span id="cb6-124"><a href="#cb6-124"></a><span class="im">from</span> builtins <span class="im">import</span> <span class="bu">str</span></span>
<span id="cb6-125"><a href="#cb6-125"></a><span class="im">from</span> builtins <span class="im">import</span> <span class="bu">range</span></span>
<span id="cb6-126"><a href="#cb6-126"></a></span>
<span id="cb6-127"><a href="#cb6-127"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb6-128"><a href="#cb6-128"></a>    <span class="im">from</span> datetime <span class="im">import</span> datetime, timedelta</span>
<span id="cb6-129"><a href="#cb6-129"></a>    <span class="im">import</span> glob</span>
<span id="cb6-130"><a href="#cb6-130"></a>    <span class="im">from</span> itertools <span class="im">import</span> chain</span>
<span id="cb6-131"><a href="#cb6-131"></a>    <span class="im">from</span> netCDF4 <span class="im">import</span> Dataset</span>
<span id="cb6-132"><a href="#cb6-132"></a>    <span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb6-133"><a href="#cb6-133"></a>    <span class="im">import</span> numpy.ma <span class="im">as</span> ma</span>
<span id="cb6-134"><a href="#cb6-134"></a>    <span class="im">import</span> os</span>
<span id="cb6-135"><a href="#cb6-135"></a>    <span class="im">import</span> sys</span>
<span id="cb6-136"><a href="#cb6-136"></a></span>
<span id="cb6-137"><a href="#cb6-137"></a>    <span class="co"># Ensure 'roylib' is on the import path</span></span>
<span id="cb6-138"><a href="#cb6-138"></a>    sys.path.append(<span class="st">'/home/cwatch/pythonLibs'</span>)</span>
<span id="cb6-139"><a href="#cb6-139"></a>    <span class="im">from</span> roylib <span class="im">import</span> <span class="op">*</span></span>
<span id="cb6-140"><a href="#cb6-140"></a></span>
<span id="cb6-141"><a href="#cb6-141"></a>    <span class="co"># Directory containing daily MW NetCDF files</span></span>
<span id="cb6-142"><a href="#cb6-142"></a>    dataDir <span class="op">=</span> sys.argv[<span class="dv">1</span>]</span>
<span id="cb6-143"><a href="#cb6-143"></a></span>
<span id="cb6-144"><a href="#cb6-144"></a>    <span class="co"># Temporary working directory</span></span>
<span id="cb6-145"><a href="#cb6-145"></a>    workDir <span class="op">=</span> sys.argv[<span class="dv">2</span>]</span>
<span id="cb6-146"><a href="#cb6-146"></a></span>
<span id="cb6-147"><a href="#cb6-147"></a>    <span class="co"># End date (year, day-of-year)</span></span>
<span id="cb6-148"><a href="#cb6-148"></a>    endyearC <span class="op">=</span> sys.argv[<span class="dv">3</span>]</span>
<span id="cb6-149"><a href="#cb6-149"></a>    endDoyC <span class="op">=</span> sys.argv[<span class="dv">4</span>]</span>
<span id="cb6-150"><a href="#cb6-150"></a>    endDoyC <span class="op">=</span> endDoyC.rjust(<span class="dv">3</span>, <span class="st">'0'</span>)</span>
<span id="cb6-151"><a href="#cb6-151"></a></span>
<span id="cb6-152"><a href="#cb6-152"></a>    <span class="co"># Start day-of-year (same year)</span></span>
<span id="cb6-153"><a href="#cb6-153"></a>    startYearC <span class="op">=</span> endyearC</span>
<span id="cb6-154"><a href="#cb6-154"></a>    endDoy <span class="op">=</span> <span class="bu">int</span>(endDoyC)</span>
<span id="cb6-155"><a href="#cb6-155"></a>    startDoyC <span class="op">=</span> sys.argv[<span class="dv">5</span>]</span>
<span id="cb6-156"><a href="#cb6-156"></a>    startDoyC <span class="op">=</span> startDoyC.rjust(<span class="dv">3</span>, <span class="st">'0'</span>)</span>
<span id="cb6-157"><a href="#cb6-157"></a>    startDoy <span class="op">=</span> <span class="bu">int</span>(startDoyC)</span>
<span id="cb6-158"><a href="#cb6-158"></a></span>
<span id="cb6-159"><a href="#cb6-159"></a>    <span class="co"># Number of days in the composite</span></span>
<span id="cb6-160"><a href="#cb6-160"></a>    interval <span class="op">=</span> endDoy <span class="op">-</span> startDoy <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb6-161"><a href="#cb6-161"></a></span>
<span id="cb6-162"><a href="#cb6-162"></a>    <span class="co"># Convert end date to calendar dates</span></span>
<span id="cb6-163"><a href="#cb6-163"></a>    myDateEnd <span class="op">=</span> datetime(<span class="bu">int</span>(endyearC), <span class="dv">1</span>, <span class="dv">1</span>) <span class="op">+</span> timedelta(endDoy <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb6-164"><a href="#cb6-164"></a>    myDateStart <span class="op">=</span> myDateEnd <span class="op">+</span> timedelta(startDoy <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb6-165"><a href="#cb6-165"></a></span>
<span id="cb6-166"><a href="#cb6-166"></a>    <span class="co"># Prepare output directory</span></span>
<span id="cb6-167"><a href="#cb6-167"></a>    outDir <span class="op">=</span> <span class="st">'/ERDData1/modisa/data/modiswc/'</span> <span class="op">+</span> endyearC <span class="op">+</span> <span class="st">'/mday'</span></span>
<span id="cb6-168"><a href="#cb6-168"></a>    <span class="bu">print</span>(dataDir)</span>
<span id="cb6-169"><a href="#cb6-169"></a>    <span class="bu">print</span>(workDir)</span>
<span id="cb6-170"><a href="#cb6-170"></a>    <span class="bu">print</span>(endyearC)</span>
<span id="cb6-171"><a href="#cb6-171"></a>    <span class="bu">print</span>(endDoyC)</span>
<span id="cb6-172"><a href="#cb6-172"></a>    <span class="bu">print</span>(interval)</span>
<span id="cb6-173"><a href="#cb6-173"></a></span>
<span id="cb6-174"><a href="#cb6-174"></a>    <span class="co">###</span></span>
<span id="cb6-175"><a href="#cb6-175"></a>    <span class="co"># dtypeList = ['sstd']</span></span>
<span id="cb6-176"><a href="#cb6-176"></a>    <span class="co"># for dtype in dtypeList:</span></span>
<span id="cb6-177"><a href="#cb6-177"></a></span>
<span id="cb6-178"><a href="#cb6-178"></a>    <span class="co"># Set up for reading MB SST variable ("MWsstd") across multiple days</span></span>
<span id="cb6-179"><a href="#cb6-179"></a>    dtype <span class="op">=</span> <span class="st">'sstd'</span></span>
<span id="cb6-180"><a href="#cb6-180"></a></span>
<span id="cb6-181"><a href="#cb6-181"></a>    <span class="co"># Clear working directory</span></span>
<span id="cb6-182"><a href="#cb6-182"></a>    os.chdir(workDir)</span>
<span id="cb6-183"><a href="#cb6-183"></a>    os.system(<span class="st">'rm -f *'</span>)</span>
<span id="cb6-184"><a href="#cb6-184"></a></span>
<span id="cb6-185"><a href="#cb6-185"></a>    <span class="co"># Move to data directory</span></span>
<span id="cb6-186"><a href="#cb6-186"></a>    os.chdir(dataDir)</span>
<span id="cb6-187"><a href="#cb6-187"></a></span>
<span id="cb6-188"><a href="#cb6-188"></a>    <span class="co"># Preallocate sum (mean) and count arrays matching grid dims</span></span>
<span id="cb6-189"><a href="#cb6-189"></a>    mean <span class="op">=</span> np.zeros((<span class="dv">2321</span>, <span class="dv">4001</span>), np.single)</span>
<span id="cb6-190"><a href="#cb6-190"></a>    num <span class="op">=</span> np.zeros((<span class="dv">2321</span>, <span class="dv">4001</span>), dtype<span class="op">=</span>np.int32)</span>
<span id="cb6-191"><a href="#cb6-191"></a></span>
<span id="cb6-192"><a href="#cb6-192"></a>    <span class="co"># Build list of NetCDF files spanning startDoy..endDoy</span></span>
<span id="cb6-193"><a href="#cb6-193"></a>    <span class="cf">if</span> (endDoy <span class="op">&gt;</span> startDoy):</span>
<span id="cb6-194"><a href="#cb6-194"></a>        <span class="co"># Composite within the same calendar year</span></span>
<span id="cb6-195"><a href="#cb6-195"></a>        doyRange <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(startDoy, endDoy <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb6-196"><a href="#cb6-196"></a>        fileList <span class="op">=</span> []</span>
<span id="cb6-197"><a href="#cb6-197"></a>        <span class="cf">for</span> doy <span class="kw">in</span> doyRange:</span>
<span id="cb6-198"><a href="#cb6-198"></a>            doyC <span class="op">=</span> <span class="bu">str</span>(doy)</span>
<span id="cb6-199"><a href="#cb6-199"></a>            doyC <span class="op">=</span> doyC.rjust(<span class="dv">3</span>, <span class="st">'0'</span>)</span>
<span id="cb6-200"><a href="#cb6-200"></a>            myString <span class="op">=</span> <span class="st">'MW'</span> <span class="op">+</span> endyearC <span class="op">+</span> doyC <span class="op">+</span> <span class="st">'*'</span> <span class="op">+</span> dtype <span class="op">+</span> <span class="st">'.nc'</span></span>
<span id="cb6-201"><a href="#cb6-201"></a>            <span class="co"># find all files matching MWYYYYDD*&lt;dtype&gt;.nc</span></span>
<span id="cb6-202"><a href="#cb6-202"></a>            fileList.append(glob.glob(myString))</span>
<span id="cb6-203"><a href="#cb6-203"></a></span>
<span id="cb6-204"><a href="#cb6-204"></a>        <span class="co"># Flatten list of lists and sort alphabetically</span></span>
<span id="cb6-205"><a href="#cb6-205"></a>        fileList <span class="op">=</span> <span class="bu">list</span>(chain.from_iterable(fileList))</span>
<span id="cb6-206"><a href="#cb6-206"></a>        fileList.sort()</span>
<span id="cb6-207"><a href="#cb6-207"></a>        <span class="bu">print</span>(fileList)</span>
<span id="cb6-208"><a href="#cb6-208"></a></span>
<span id="cb6-209"><a href="#cb6-209"></a>        <span class="co"># Track which files were used</span></span>
<span id="cb6-210"><a href="#cb6-210"></a>        filesUsed <span class="op">=</span> <span class="st">""</span></span>
<span id="cb6-211"><a href="#cb6-211"></a>        <span class="cf">for</span> fName <span class="kw">in</span> fileList:</span>
<span id="cb6-212"><a href="#cb6-212"></a>            <span class="cf">if</span> (<span class="bu">len</span>(filesUsed) <span class="op">==</span> <span class="dv">0</span>):</span>
<span id="cb6-213"><a href="#cb6-213"></a>                filesUsed <span class="op">=</span> fName</span>
<span id="cb6-214"><a href="#cb6-214"></a>            <span class="cf">else</span>:</span>
<span id="cb6-215"><a href="#cb6-215"></a>                filesUsed <span class="op">=</span> filesUsed <span class="op">+</span> <span class="st">', '</span> <span class="op">+</span> fName</span>
<span id="cb6-216"><a href="#cb6-216"></a></span>
<span id="cb6-217"><a href="#cb6-217"></a>            <span class="co"># Open NetCDF, extract the 4D SST array, then squeeze to 2D</span></span>
<span id="cb6-218"><a href="#cb6-218"></a>            sstFile <span class="op">=</span> Dataset(fName)</span>
<span id="cb6-219"><a href="#cb6-219"></a>            sst <span class="op">=</span> sstFile.variables[<span class="st">"MWsstd"</span>][:, :, :, :]</span>
<span id="cb6-220"><a href="#cb6-220"></a>            sstFile.close()</span>
<span id="cb6-221"><a href="#cb6-221"></a>            sst <span class="op">=</span> np.squeeze(sst)</span>
<span id="cb6-222"><a href="#cb6-222"></a></span>
<span id="cb6-223"><a href="#cb6-223"></a>            <span class="co"># Update running mean and count arrays</span></span>
<span id="cb6-224"><a href="#cb6-224"></a>            mean, num <span class="op">=</span> meanVar(mean, num, sst)</span>
<span id="cb6-225"><a href="#cb6-225"></a></span>
<span id="cb6-226"><a href="#cb6-226"></a>    <span class="cf">else</span>:</span>
<span id="cb6-227"><a href="#cb6-227"></a>        <span class="co"># Compute directory for start of year by replacing year in path</span></span>
<span id="cb6-228"><a href="#cb6-228"></a>        dataDir1 <span class="op">=</span> dataDir</span>
<span id="cb6-229"><a href="#cb6-229"></a>        dataDir1 <span class="op">=</span> dataDir1.replace(endyearC, startYearC)</span>
<span id="cb6-230"><a href="#cb6-230"></a></span>
<span id="cb6-231"><a href="#cb6-231"></a>        <span class="co"># Determine end-of-year DOY based on leap year</span></span>
<span id="cb6-232"><a href="#cb6-232"></a>        <span class="cf">if</span> (isleap):</span>
<span id="cb6-233"><a href="#cb6-233"></a>            endday <span class="op">=</span> <span class="dv">366</span></span>
<span id="cb6-234"><a href="#cb6-234"></a>        <span class="cf">else</span>:</span>
<span id="cb6-235"><a href="#cb6-235"></a>            endday <span class="op">=</span> <span class="dv">365</span></span>
<span id="cb6-236"><a href="#cb6-236"></a></span>
<span id="cb6-237"><a href="#cb6-237"></a>        <span class="co"># From startDoy through end of start year  </span></span>
<span id="cb6-238"><a href="#cb6-238"></a>        fileList <span class="op">=</span> []</span>
<span id="cb6-239"><a href="#cb6-239"></a>        os.chdir(dataDir1)</span>
<span id="cb6-240"><a href="#cb6-240"></a>        doyRange <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(startDoy, endday <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb6-241"><a href="#cb6-241"></a>        <span class="cf">for</span> doy <span class="kw">in</span> doyRange:</span>
<span id="cb6-242"><a href="#cb6-242"></a>            doyC <span class="op">=</span> <span class="bu">str</span>(doy)</span>
<span id="cb6-243"><a href="#cb6-243"></a>            doyC <span class="op">=</span> doyC.rjust(<span class="dv">3</span>, <span class="st">'0'</span>)</span>
<span id="cb6-244"><a href="#cb6-244"></a>            myString <span class="op">=</span> <span class="st">'MW'</span> <span class="op">+</span> startYearC <span class="op">+</span> doyC <span class="op">+</span> <span class="st">'*'</span> <span class="op">+</span> dtype <span class="op">+</span> <span class="st">'.nc'</span></span>
<span id="cb6-245"><a href="#cb6-245"></a>            fileList.append(glob.glob(myString))</span>
<span id="cb6-246"><a href="#cb6-246"></a></span>
<span id="cb6-247"><a href="#cb6-247"></a>        fileList <span class="op">=</span> <span class="bu">list</span>(chain.from_iterable(fileList))</span>
<span id="cb6-248"><a href="#cb6-248"></a>        fileList.sort()</span>
<span id="cb6-249"><a href="#cb6-249"></a>        <span class="bu">print</span>(fileList)</span>
<span id="cb6-250"><a href="#cb6-250"></a>        filesUsed <span class="op">=</span> <span class="st">''</span></span>
<span id="cb6-251"><a href="#cb6-251"></a>        <span class="cf">for</span> fName <span class="kw">in</span> fileList:</span>
<span id="cb6-252"><a href="#cb6-252"></a>            <span class="cf">if</span> (<span class="bu">len</span>(filesUsed) <span class="op">==</span> <span class="dv">0</span>):</span>
<span id="cb6-253"><a href="#cb6-253"></a>                filesUsed <span class="op">=</span> fName</span>
<span id="cb6-254"><a href="#cb6-254"></a>            <span class="cf">else</span>:</span>
<span id="cb6-255"><a href="#cb6-255"></a>                filesUsed <span class="op">=</span> filesUsed <span class="op">+</span> <span class="st">', '</span> <span class="op">+</span> fName</span>
<span id="cb6-256"><a href="#cb6-256"></a></span>
<span id="cb6-257"><a href="#cb6-257"></a>            sstFile <span class="op">=</span> Dataset(fName)</span>
<span id="cb6-258"><a href="#cb6-258"></a>            sst <span class="op">=</span> sstFile.variables[<span class="st">"MWsstd"</span>][:, :, :, :]</span>
<span id="cb6-259"><a href="#cb6-259"></a>            sstFile.close()</span>
<span id="cb6-260"><a href="#cb6-260"></a>            sst <span class="op">=</span> np.squeeze(sst)</span>
<span id="cb6-261"><a href="#cb6-261"></a>            mean, num <span class="op">=</span> meanVar(mean, num, sst)</span>
<span id="cb6-262"><a href="#cb6-262"></a></span>
<span id="cb6-263"><a href="#cb6-263"></a>        <span class="co"># From DOY 1 of end year through endDoy</span></span>
<span id="cb6-264"><a href="#cb6-264"></a>        os.chdir(dataDir)</span>
<span id="cb6-265"><a href="#cb6-265"></a>        fileList <span class="op">=</span> []</span>
<span id="cb6-266"><a href="#cb6-266"></a>        doyRange <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="dv">1</span>, endDoy <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb6-267"><a href="#cb6-267"></a>        <span class="cf">for</span> doy <span class="kw">in</span> doyRange:</span>
<span id="cb6-268"><a href="#cb6-268"></a>            doyC <span class="op">=</span> <span class="bu">str</span>(doy)</span>
<span id="cb6-269"><a href="#cb6-269"></a>            doyC <span class="op">=</span> doyC.rjust(<span class="dv">3</span>, <span class="st">'0'</span>)</span>
<span id="cb6-270"><a href="#cb6-270"></a>            myString <span class="op">=</span> <span class="st">'MW'</span> <span class="op">+</span> endyearC <span class="op">+</span> doyC <span class="op">+</span> <span class="st">'*'</span> <span class="op">+</span> dtype <span class="op">+</span> <span class="st">'.nc'</span></span>
<span id="cb6-271"><a href="#cb6-271"></a>            fileList.append(glob.glob(myString))</span>
<span id="cb6-272"><a href="#cb6-272"></a></span>
<span id="cb6-273"><a href="#cb6-273"></a>        fileList <span class="op">=</span> <span class="bu">list</span>(chain.from_iterable(fileList))</span>
<span id="cb6-274"><a href="#cb6-274"></a>        fileList.sort()</span>
<span id="cb6-275"><a href="#cb6-275"></a>        <span class="bu">print</span>(fileList)</span>
<span id="cb6-276"><a href="#cb6-276"></a></span>
<span id="cb6-277"><a href="#cb6-277"></a>        <span class="cf">for</span> fName <span class="kw">in</span> fileList:</span>
<span id="cb6-278"><a href="#cb6-278"></a>            <span class="cf">if</span> (<span class="bu">len</span>(filesUsed) <span class="op">==</span> <span class="dv">0</span>):</span>
<span id="cb6-279"><a href="#cb6-279"></a>                filesUsed <span class="op">=</span> fName</span>
<span id="cb6-280"><a href="#cb6-280"></a>            <span class="cf">else</span>:</span>
<span id="cb6-281"><a href="#cb6-281"></a>                filesUsed <span class="op">=</span> filesUsed <span class="op">+</span> <span class="st">', '</span> <span class="op">+</span> fName</span>
<span id="cb6-282"><a href="#cb6-282"></a></span>
<span id="cb6-283"><a href="#cb6-283"></a>            sstFile <span class="op">=</span> Dataset(fName)</span>
<span id="cb6-284"><a href="#cb6-284"></a>            sst <span class="op">=</span> sstFile.variables[<span class="st">"MWsstd"</span>][:, :, :, :]</span>
<span id="cb6-285"><a href="#cb6-285"></a>            sstFile.close()</span>
<span id="cb6-286"><a href="#cb6-286"></a>            sst <span class="op">=</span> np.squeeze(sst)</span>
<span id="cb6-287"><a href="#cb6-287"></a>            mean, num <span class="op">=</span> meanVar(mean, num, sst)</span>
<span id="cb6-288"><a href="#cb6-288"></a></span>
<span id="cb6-289"><a href="#cb6-289"></a>    <span class="co"># Mask out pixels with zero observations and set fill value for missing data</span></span>
<span id="cb6-290"><a href="#cb6-290"></a>    mean <span class="op">=</span> ma.array(mean, mask<span class="op">=</span>(num <span class="op">==</span> <span class="dv">0</span>), fill_value<span class="op">=-</span><span class="fl">9999999.</span>)</span>
<span id="cb6-291"><a href="#cb6-291"></a></span>
<span id="cb6-292"><a href="#cb6-292"></a>    <span class="co"># Switch to the working directory</span></span>
<span id="cb6-293"><a href="#cb6-293"></a>    os.chdir(workDir)</span>
<span id="cb6-294"><a href="#cb6-294"></a></span>
<span id="cb6-295"><a href="#cb6-295"></a>    <span class="co"># Construct output filename</span></span>
<span id="cb6-296"><a href="#cb6-296"></a>    outFile <span class="op">=</span> <span class="st">'MW'</span> <span class="op">+</span> startYearC <span class="op">+</span> startDoyC <span class="op">+</span> <span class="st">'_'</span> <span class="op">+</span> endyearC <span class="op">+</span> endDoyC <span class="op">+</span> <span class="st">'_'</span> <span class="op">+</span> dtype <span class="op">+</span> <span class="st">'.nc'</span></span>
<span id="cb6-297"><a href="#cb6-297"></a></span>
<span id="cb6-298"><a href="#cb6-298"></a>    <span class="co"># Generate the multi-day NetCDF file</span></span>
<span id="cb6-299"><a href="#cb6-299"></a>    ncFile <span class="op">=</span> makeNetcdfmDay(mean, num, interval, outFile, filesUsed, workDir)</span>
<span id="cb6-300"><a href="#cb6-300"></a></span>
<span id="cb6-301"><a href="#cb6-301"></a>    <span class="co"># Directory on the remote server where multi-day SST files are stored</span></span>
<span id="cb6-302"><a href="#cb6-302"></a>    remote_dir <span class="op">=</span> <span class="st">'/MW/sstd/'</span></span>
<span id="cb6-303"><a href="#cb6-303"></a></span>
<span id="cb6-304"><a href="#cb6-304"></a>    <span class="co"># Send the NetCDF to the remote server directory</span></span>
<span id="cb6-305"><a href="#cb6-305"></a>    send_to_servers(ncFile, remote_dir , <span class="st">'m'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>