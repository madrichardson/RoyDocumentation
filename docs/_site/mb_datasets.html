<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.31">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>MB Datasets – Documentation of Roy’s Scripts</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-e1a5c8363afafaef2c763b6775fbf3ca.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-7aaeca69b4e146fcaaa982daeac7f2ee.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="site_libs/quarto-diagram/mermaid.min.js"></script>
<script src="site_libs/quarto-diagram/mermaid-init.js"></script>
<link href="site_libs/quarto-diagram/mermaid.css" rel="stylesheet">


<link rel="stylesheet" href="_quarto/rtd-font.css">
<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar docked quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./modisa_scripts.html">MODISA Scripts</a></li><li class="breadcrumb-item"><a href="./mb_datasets.html">MB Datasets</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-center sidebar-header">
      <a href="./index.html" class="sidebar-logo-link">
      <img src="./images/CW_logo.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./roylib.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Utility Library</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./modisa_scripts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">MODISA Scripts</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./mb_datasets.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">MB Datasets</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./mw_datasets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">MW Datasets</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./api/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">API Reference</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#chlorophyll" id="toc-chlorophyll" class="nav-link active" data-scroll-target="#chlorophyll">Chlorophyll</a>
  <ul class="collapse">
  <li><a href="#makechla1daynewmb" id="toc-makechla1daynewmb" class="nav-link" data-scroll-target="#makechla1daynewmb">makeChla1daynewMB</a></li>
  <li><a href="#compmbchla" id="toc-compmbchla" class="nav-link" data-scroll-target="#compmbchla">CompMBChla</a></li>
  <li><a href="#compmbchlamday" id="toc-compmbchlamday" class="nav-link" data-scroll-target="#compmbchlamday">CompMBChlamday</a></li>
  </ul></li>
  <li><a href="#sst" id="toc-sst" class="nav-link" data-scroll-target="#sst">SST</a>
  <ul class="collapse">
  <li><a href="#makesst1daynewmb" id="toc-makesst1daynewmb" class="nav-link" data-scroll-target="#makesst1daynewmb">makeSST1daynewMB</a></li>
  <li><a href="#compmbsst" id="toc-compmbsst" class="nav-link" data-scroll-target="#compmbsst">CompMBSST</a></li>
  <li><a href="#compmbsstmday" id="toc-compmbsstmday" class="nav-link" data-scroll-target="#compmbsstmday">CompMBSSTmday</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./modisa_scripts.html">MODISA Scripts</a></li><li class="breadcrumb-item"><a href="./mb_datasets.html">MB Datasets</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">MB Datasets</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Here you’ll find the MB (Pacific Ocean) processing scripts for both chlorophyll-a and SST.</p>
<p>They ingest raw Level-2 swath files, apply global coverage and quality filters, and grid valid observations into daily NetCDF products. These daily outputs are then averaged over rolling multi-day windows—automatically rebuilding composites whenever new data arrive.</p>
<p>Below are the individual scripts that form the MB workflow. Use the expandable code blocks to explore each stage of the pipeline.</p>
<section id="chlorophyll" class="level2">
<h2 class="anchored" data-anchor-id="chlorophyll">Chlorophyll</h2>
<section id="makechla1daynewmb" class="level3">
<h3 class="anchored" data-anchor-id="makechla1daynewmb">makeChla1daynewMB</h3>
<p><code>makeChla1daynewMB.py</code> ingests Level-2 chlorophyll-a swath NetCDFs for the target day (HOD &gt; 10) and early hours of the next day (HOD ≤ 10), filters to “Day” pixels within longitude 120–320° and latitude –45–65°, and interpolates onto a 0.025° × 0.025°regular grid. The resulting 1-day composite is land-masked, written as a CF-compliant NetCDF, and deployed automatically to a remote server directory. Find the 1-day product on ERDDAP <a href="./modisa_scripts.html#modisa-products-on-swfsc-erddap-server">here</a>.</p>
<p>The following chart summarizes the script’s workflow:</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">%%{init: {"flowchart":{"htmlLabels":true}}}%%
flowchart LR
  I("&lt;b&gt;Inputs&lt;/b&gt;&lt;br/&gt;• Raw L2 Chla NetCDF swaths (dataDir)&lt;br/&gt;• workDir&lt;br/&gt;• Year &amp; DOY")
    --&gt; P("&lt;b&gt;Processing&lt;/b&gt;&lt;br/&gt;• Compute dates &amp; directories&lt;br/&gt;• Load land mask&lt;br/&gt;• Discover swaths for day &amp; next-day&lt;br/&gt;• Stage &amp; filter swaths (day-only, region overlap)&lt;br/&gt;• Extract, reshape &amp; filter variables&lt;br/&gt;• Interpolate onto regular grid&lt;br/&gt;• Apply mask")
    --&gt; O("&lt;b&gt;Output&lt;/b&gt;&lt;br/&gt;• CF-compliant 1-day composite Chla NetCDF&lt;br/&gt;• Deployed to /MB/chla/1day/")
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<div id="12fd3faa" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>View makeChla1daynewMB.py</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1"></a><span class="co">"""</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="co">Overview</span></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="co">--------</span></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="co">Generate a one-day ocean-color (Chla) grid for the MODIS “MB” (Pacific Ocean) product by</span></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="co">combining swaths from Level-2 chlorophyll-a NetCDF files and gridding them with PyGMT. The</span></span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="co">script produces a CF-compliant NetCDF file of daily Chla for the region (lon 120-320°, lat -45-65°).</span></span>
<span id="cb1-7"><a href="#cb1-7"></a></span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="co">Usage</span></span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="co">-----</span></span>
<span id="cb1-10"><a href="#cb1-10"></a><span class="co">::</span></span>
<span id="cb1-11"><a href="#cb1-11"></a><span class="co">  </span></span>
<span id="cb1-12"><a href="#cb1-12"></a><span class="co">     python makeChla1daynewMB.py &lt;dataDirBase&gt; &lt;workDir&gt; &lt;year&gt; &lt;doy&gt;</span></span>
<span id="cb1-13"><a href="#cb1-13"></a></span>
<span id="cb1-14"><a href="#cb1-14"></a><span class="co">Where:</span></span>
<span id="cb1-15"><a href="#cb1-15"></a></span>
<span id="cb1-16"><a href="#cb1-16"></a><span class="co">- ``dataDir``</span></span>
<span id="cb1-17"><a href="#cb1-17"></a></span>
<span id="cb1-18"><a href="#cb1-18"></a><span class="co">  Root folder containing raw Level-2 ocean-color NetCDF swath files, organized as ``&lt;dataDirBase&gt;/&lt;YYYY&gt;&lt;MM&gt;/``. Each swath must match: ``AQUA_MODIS.&lt;YYYY&gt;&lt;MM&gt;&lt;DD&gt;*L2.OC.NRT.nc``.</span></span>
<span id="cb1-19"><a href="#cb1-19"></a></span>
<span id="cb1-20"><a href="#cb1-20"></a><span class="co">- ``workDir``</span></span>
<span id="cb1-21"><a href="#cb1-21"></a></span>
<span id="cb1-22"><a href="#cb1-22"></a><span class="co">  Temporary working directory for staging swath copies and intermediate files.</span></span>
<span id="cb1-23"><a href="#cb1-23"></a></span>
<span id="cb1-24"><a href="#cb1-24"></a><span class="co">- ``year``</span></span>
<span id="cb1-25"><a href="#cb1-25"></a></span>
<span id="cb1-26"><a href="#cb1-26"></a><span class="co">  Four-digit year string (e.g., ``"2025"``).</span></span>
<span id="cb1-27"><a href="#cb1-27"></a></span>
<span id="cb1-28"><a href="#cb1-28"></a><span class="co">- ``doy``</span></span>
<span id="cb1-29"><a href="#cb1-29"></a></span>
<span id="cb1-30"><a href="#cb1-30"></a><span class="co">  Three-digit day-of-year string (zero-padded, e.g., ``"082"`` for March 23).</span></span>
<span id="cb1-31"><a href="#cb1-31"></a></span>
<span id="cb1-32"><a href="#cb1-32"></a><span class="co">Description</span></span>
<span id="cb1-33"><a href="#cb1-33"></a><span class="co">-----------</span></span>
<span id="cb1-34"><a href="#cb1-34"></a><span class="co">1. **Date and Directory Setup**  </span></span>
<span id="cb1-35"><a href="#cb1-35"></a></span>
<span id="cb1-36"><a href="#cb1-36"></a><span class="co">     - Computes calendar date from ``year`` + ``doy``, zero-pads month/day, and sets ``datadir = dataDirBase + YYYY + MM + "/"``.  </span></span>
<span id="cb1-37"><a href="#cb1-37"></a><span class="co">     </span></span>
<span id="cb1-38"><a href="#cb1-38"></a><span class="co">     - Also computes the next day's directory for early-morning swaths (``HOD ≤ 10``).</span></span>
<span id="cb1-39"><a href="#cb1-39"></a></span>
<span id="cb1-40"><a href="#cb1-40"></a><span class="co">2. **Load Land Mask**  </span></span>
<span id="cb1-41"><a href="#cb1-41"></a></span>
<span id="cb1-42"><a href="#cb1-42"></a><span class="co">     - Reads a static GRD land-mask from ``/u00/ref/landmasks/LM_120_320_0.025_-45_65_0.025_gridline.grd`` into ``my_mask``.</span></span>
<span id="cb1-43"><a href="#cb1-43"></a></span>
<span id="cb1-44"><a href="#cb1-44"></a><span class="co">3. **Swath Discovery &amp; Staging**</span></span>
<span id="cb1-45"><a href="#cb1-45"></a></span>
<span id="cb1-46"><a href="#cb1-46"></a><span class="co">     - Globs ``AQUA_MODIS.&lt;YYYY&gt;&lt;MM&gt;&lt;DD&gt;*.L2.OC.NRT.nc`` in both current and next-day folders.</span></span>
<span id="cb1-47"><a href="#cb1-47"></a></span>
<span id="cb1-48"><a href="#cb1-48"></a><span class="co">     - Copies swaths into ``workDir``, removing any old ``AQUA_MODIS.*L2.OC*`` or ``MB20*`` files.</span></span>
<span id="cb1-49"><a href="#cb1-49"></a></span>
<span id="cb1-50"><a href="#cb1-50"></a><span class="co">4. **Swath Processing**</span></span>
<span id="cb1-51"><a href="#cb1-51"></a></span>
<span id="cb1-52"><a href="#cb1-52"></a><span class="co">     For each swath:</span></span>
<span id="cb1-53"><a href="#cb1-53"></a></span>
<span id="cb1-54"><a href="#cb1-54"></a><span class="co">         - Extracts navigation (``lon``, ``lat``), converts negative longitudes to 0-360°, and tests overlap with the region (lon 120-320°, lat -45-65°).</span></span>
<span id="cb1-55"><a href="#cb1-55"></a></span>
<span id="cb1-56"><a href="#cb1-56"></a><span class="co">     - Filters only daytime pixels (``day_night_flag == "Day"``).</span></span>
<span id="cb1-57"><a href="#cb1-57"></a></span>
<span id="cb1-58"><a href="#cb1-58"></a><span class="co">     - Reads chlorophyll-a (``chlor_a``), reshapes into column vectors, and stacks into ``(lon, lat, Chla)``.</span></span>
<span id="cb1-59"><a href="#cb1-59"></a></span>
<span id="cb1-60"><a href="#cb1-60"></a><span class="co">     - Applies sequential filters:  </span></span>
<span id="cb1-61"><a href="#cb1-61"></a></span>
<span id="cb1-62"><a href="#cb1-62"></a><span class="co">         • ``Chla &gt; 0``</span></span>
<span id="cb1-63"><a href="#cb1-63"></a></span>
<span id="cb1-64"><a href="#cb1-64"></a><span class="co">         • ``lonmin ≤ lon ≤ lonmax``</span></span>
<span id="cb1-65"><a href="#cb1-65"></a></span>
<span id="cb1-66"><a href="#cb1-66"></a><span class="co">         • ``latmin ≤ lat ≤ latmax``</span></span>
<span id="cb1-67"><a href="#cb1-67"></a></span>
<span id="cb1-68"><a href="#cb1-68"></a><span class="co">         • Discards any obviously invalid longitudes (``&gt; -400``).</span></span>
<span id="cb1-69"><a href="#cb1-69"></a></span>
<span id="cb1-70"><a href="#cb1-70"></a><span class="co">     - Accumulates valid points into ``temp_data`` and tracks provenance in ``filesUsed``.</span></span>
<span id="cb1-71"><a href="#cb1-71"></a></span>
<span id="cb1-72"><a href="#cb1-72"></a><span class="co">5. **Gridding &amp; NetCDF Generation**  </span></span>
<span id="cb1-73"><a href="#cb1-73"></a></span>
<span id="cb1-74"><a href="#cb1-74"></a><span class="co">     - Uses ``pygmt.xyz2grd`` on ``temp_data`` with region ``120/320/-45/65`` and spacing ``0.025/0.025`` to produce a GMT ``.grd`` file named ``MB&lt;YYYY&gt;&lt;DDD&gt;_&lt;YYYY&gt;&lt;DDD&gt;_chla.grd``.</span></span>
<span id="cb1-75"><a href="#cb1-75"></a><span class="co">     </span></span>
<span id="cb1-76"><a href="#cb1-76"></a><span class="co">     - Converts the grid to a CF-compliant NetCDF via ``roylib.grd2netcdf1``, applying ``my_mask``.</span></span>
<span id="cb1-77"><a href="#cb1-77"></a><span class="co">     </span></span>
<span id="cb1-78"><a href="#cb1-78"></a><span class="co">     - Sends the final NetCDF into ``/MB/chla/1day/`` via ``roylib.send_to_servers``.</span></span>
<span id="cb1-79"><a href="#cb1-79"></a></span>
<span id="cb1-80"><a href="#cb1-80"></a><span class="co">Dependencies</span></span>
<span id="cb1-81"><a href="#cb1-81"></a><span class="co">------------</span></span>
<span id="cb1-82"><a href="#cb1-82"></a><span class="co">- **Python 3.x**</span></span>
<span id="cb1-83"><a href="#cb1-83"></a></span>
<span id="cb1-84"><a href="#cb1-84"></a><span class="co">- **Standard library**: ``os``, ``sys``, ``datetime``, ``timedelta``, ``glob``, ``re``, ``shutil``</span></span>
<span id="cb1-85"><a href="#cb1-85"></a></span>
<span id="cb1-86"><a href="#cb1-86"></a><span class="co">- **Third-party**: ``netCDF4.Dataset``, ``numpy``, ``numpy.ma``, ``pygmt``  </span></span>
<span id="cb1-87"><a href="#cb1-87"></a></span>
<span id="cb1-88"><a href="#cb1-88"></a><span class="co">- **Custom roylib functions**:  </span></span>
<span id="cb1-89"><a href="#cb1-89"></a></span>
<span id="cb1-90"><a href="#cb1-90"></a><span class="co">     - ``myReshape(array)``</span></span>
<span id="cb1-91"><a href="#cb1-91"></a></span>
<span id="cb1-92"><a href="#cb1-92"></a><span class="co">     - ``grd2netcdf1(grd, outName, filesUsed, mask, fType)``</span></span>
<span id="cb1-93"><a href="#cb1-93"></a></span>
<span id="cb1-94"><a href="#cb1-94"></a><span class="co">     - ``safe_remove(filePath)``  </span></span>
<span id="cb1-95"><a href="#cb1-95"></a></span>
<span id="cb1-96"><a href="#cb1-96"></a><span class="co">     - ``send_to_servers(ncFile, destDir, interval)``</span></span>
<span id="cb1-97"><a href="#cb1-97"></a></span>
<span id="cb1-98"><a href="#cb1-98"></a><span class="co">     - ``isleap(year)``</span></span>
<span id="cb1-99"><a href="#cb1-99"></a></span>
<span id="cb1-100"><a href="#cb1-100"></a><span class="co">     - ``makeNetcdf(mean, nobs, interval, outFile, filesUsed, workDir)``</span></span>
<span id="cb1-101"><a href="#cb1-101"></a></span>
<span id="cb1-102"><a href="#cb1-102"></a><span class="co">     - ``meanVar(mean, num, obs)``</span></span>
<span id="cb1-103"><a href="#cb1-103"></a></span>
<span id="cb1-104"><a href="#cb1-104"></a><span class="co">Land Mask</span></span>
<span id="cb1-105"><a href="#cb1-105"></a><span class="co">---------</span></span>
<span id="cb1-106"><a href="#cb1-106"></a><span class="co">A static GRD mask is required at:</span></span>
<span id="cb1-107"><a href="#cb1-107"></a></span>
<span id="cb1-108"><a href="#cb1-108"></a><span class="co"> ``/u00/ref/landmasks/LM_120_320_0.025_-45_65_0.025_gridline.grd``  </span></span>
<span id="cb1-109"><a href="#cb1-109"></a></span>
<span id="cb1-110"><a href="#cb1-110"></a><span class="co">to zero-out land pixels in the daily Chla grid.</span></span>
<span id="cb1-111"><a href="#cb1-111"></a></span>
<span id="cb1-112"><a href="#cb1-112"></a><span class="co">Directory Structure</span></span>
<span id="cb1-113"><a href="#cb1-113"></a><span class="co">-------------------</span></span>
<span id="cb1-114"><a href="#cb1-114"></a><span class="co">- **Input directory** (datadir):</span></span>
<span id="cb1-115"><a href="#cb1-115"></a></span>
<span id="cb1-116"><a href="#cb1-116"></a><span class="co">  ``&lt;dataDirBase&gt;/&lt;YYYY&gt;&lt;MM&gt;/`` containing raw L2 OC files: ``AQUA_MODIS.&lt;YYYY&gt;&lt;MM&gt;&lt;DD&gt;*.L2.OC.NRT.nc``</span></span>
<span id="cb1-117"><a href="#cb1-117"></a></span>
<span id="cb1-118"><a href="#cb1-118"></a><span class="co">- **Working directory** (workDir):</span></span>
<span id="cb1-119"><a href="#cb1-119"></a></span>
<span id="cb1-120"><a href="#cb1-120"></a><span class="co">  Temporary staging area; cleared of ``AQUA_MODIS.*L2.OC*`` and ``MB20*`` at start.</span></span>
<span id="cb1-121"><a href="#cb1-121"></a></span>
<span id="cb1-122"><a href="#cb1-122"></a><span class="co">- **Output grid** (fileOut):</span></span>
<span id="cb1-123"><a href="#cb1-123"></a></span>
<span id="cb1-124"><a href="#cb1-124"></a><span class="co">  GMT “.grd” file named ``MB&lt;YYYY&gt;&lt;DDD&gt;_&lt;YYYY&gt;&lt;DDD&gt;_chla.grd``</span></span>
<span id="cb1-125"><a href="#cb1-125"></a></span>
<span id="cb1-126"><a href="#cb1-126"></a><span class="co">- **Final NetCDF**:</span></span>
<span id="cb1-127"><a href="#cb1-127"></a></span>
<span id="cb1-128"><a href="#cb1-128"></a><span class="co">  ``MB&lt;YYYY&gt;&lt;DDD&gt;_&lt;YYYY&gt;&lt;DDD&gt;_chla.nc``, copied to: ``/path/to/modis_data/modisgf/chla/1day/``</span></span>
<span id="cb1-129"><a href="#cb1-129"></a></span>
<span id="cb1-130"><a href="#cb1-130"></a><span class="co">Usage Example</span></span>
<span id="cb1-131"><a href="#cb1-131"></a><span class="co">-------------</span></span>
<span id="cb1-132"><a href="#cb1-132"></a><span class="co">::  </span></span>
<span id="cb1-133"><a href="#cb1-133"></a><span class="co">  </span></span>
<span id="cb1-134"><a href="#cb1-134"></a><span class="co">     python makeChla1daynewMB.py /Users/you/modis_data/netcdf/ /Users/you/modis_work/ 2025 082</span></span>
<span id="cb1-135"><a href="#cb1-135"></a></span>
<span id="cb1-136"><a href="#cb1-136"></a><span class="co">This will:</span></span>
<span id="cb1-137"><a href="#cb1-137"></a></span>
<span id="cb1-138"><a href="#cb1-138"></a><span class="co">  - Download and stage all Level-2 OC swaths for March 23, 2025 (``HOD &gt; 10`` and next day ``HOD ≤ 10``).</span></span>
<span id="cb1-139"><a href="#cb1-139"></a></span>
<span id="cb1-140"><a href="#cb1-140"></a><span class="co">  - Build and grid the daily chlorophyll-a point cloud for the region.</span></span>
<span id="cb1-141"><a href="#cb1-141"></a></span>
<span id="cb1-142"><a href="#cb1-142"></a><span class="co">  - Generate CF-compliant NetCDF and deploy to ``/modisgf/chla/1day/``.</span></span>
<span id="cb1-143"><a href="#cb1-143"></a><span class="co">"""</span></span>
<span id="cb1-144"><a href="#cb1-144"></a><span class="im">from</span> __future__ <span class="im">import</span> print_function</span>
<span id="cb1-145"><a href="#cb1-145"></a><span class="im">from</span> builtins <span class="im">import</span> <span class="bu">str</span></span>
<span id="cb1-146"><a href="#cb1-146"></a></span>
<span id="cb1-147"><a href="#cb1-147"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb1-148"><a href="#cb1-148"></a>    <span class="im">from</span> datetime <span class="im">import</span> datetime, timedelta</span>
<span id="cb1-149"><a href="#cb1-149"></a>    <span class="im">import</span> glob</span>
<span id="cb1-150"><a href="#cb1-150"></a>    <span class="im">from</span> itertools <span class="im">import</span> chain</span>
<span id="cb1-151"><a href="#cb1-151"></a>    <span class="im">from</span> netCDF4 <span class="im">import</span> Dataset</span>
<span id="cb1-152"><a href="#cb1-152"></a>    <span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-153"><a href="#cb1-153"></a>    <span class="im">import</span> numpy.ma <span class="im">as</span> ma</span>
<span id="cb1-154"><a href="#cb1-154"></a>    <span class="im">import</span> pygmt</span>
<span id="cb1-155"><a href="#cb1-155"></a>    <span class="im">import</span> os</span>
<span id="cb1-156"><a href="#cb1-156"></a>    <span class="im">import</span> re</span>
<span id="cb1-157"><a href="#cb1-157"></a>    <span class="im">import</span> shutil</span>
<span id="cb1-158"><a href="#cb1-158"></a>    <span class="im">import</span> sys</span>
<span id="cb1-159"><a href="#cb1-159"></a></span>
<span id="cb1-160"><a href="#cb1-160"></a>    <span class="co"># Ensure 'roylib' is on the import path</span></span>
<span id="cb1-161"><a href="#cb1-161"></a>    sys.path.append(<span class="st">'/home/cwatch/pythonLibs'</span>)</span>
<span id="cb1-162"><a href="#cb1-162"></a>    <span class="im">from</span> roylib <span class="im">import</span> <span class="op">*</span></span>
<span id="cb1-163"><a href="#cb1-163"></a></span>
<span id="cb1-164"><a href="#cb1-164"></a>    <span class="co"># Geographic bounds for MB region</span></span>
<span id="cb1-165"><a href="#cb1-165"></a>    latmax <span class="op">=</span> <span class="fl">65.</span></span>
<span id="cb1-166"><a href="#cb1-166"></a>    latmin <span class="op">=</span> <span class="op">-</span><span class="fl">45.</span></span>
<span id="cb1-167"><a href="#cb1-167"></a>    lonmax <span class="op">=</span> <span class="fl">320.</span></span>
<span id="cb1-168"><a href="#cb1-168"></a>    lonmin <span class="op">=</span> <span class="fl">120.</span></span>
<span id="cb1-169"><a href="#cb1-169"></a></span>
<span id="cb1-170"><a href="#cb1-170"></a>    outFile <span class="op">=</span> <span class="st">'modisgfChlatemp'</span></span>
<span id="cb1-171"><a href="#cb1-171"></a></span>
<span id="cb1-172"><a href="#cb1-172"></a>    <span class="co"># Set data directory</span></span>
<span id="cb1-173"><a href="#cb1-173"></a>    datadirBase <span class="op">=</span> sys.argv[<span class="dv">1</span>]</span>
<span id="cb1-174"><a href="#cb1-174"></a></span>
<span id="cb1-175"><a href="#cb1-175"></a>    <span class="co"># Set work directory</span></span>
<span id="cb1-176"><a href="#cb1-176"></a>    workdir <span class="op">=</span> sys.argv[<span class="dv">2</span>]</span>
<span id="cb1-177"><a href="#cb1-177"></a></span>
<span id="cb1-178"><a href="#cb1-178"></a>    <span class="co"># Get the year and doy from the command line</span></span>
<span id="cb1-179"><a href="#cb1-179"></a>    year <span class="op">=</span> sys.argv[<span class="dv">3</span>]</span>
<span id="cb1-180"><a href="#cb1-180"></a>    doy <span class="op">=</span> sys.argv[<span class="dv">4</span>]</span>
<span id="cb1-181"><a href="#cb1-181"></a>    <span class="bu">print</span>(year)</span>
<span id="cb1-182"><a href="#cb1-182"></a>    <span class="bu">print</span>(doy)</span>
<span id="cb1-183"><a href="#cb1-183"></a></span>
<span id="cb1-184"><a href="#cb1-184"></a>    <span class="co"># Convert year/doy to a calendar date and zero-pad month/day</span></span>
<span id="cb1-185"><a href="#cb1-185"></a>    myDate <span class="op">=</span> datetime(<span class="bu">int</span>(year), <span class="dv">1</span>, <span class="dv">1</span>) <span class="op">+</span> timedelta(<span class="bu">int</span>(doy) <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb1-186"><a href="#cb1-186"></a>    myMon <span class="op">=</span> <span class="bu">str</span>(myDate.month)</span>
<span id="cb1-187"><a href="#cb1-187"></a>    myMon <span class="op">=</span> myMon.rjust(<span class="dv">2</span>, <span class="st">'0'</span>)</span>
<span id="cb1-188"><a href="#cb1-188"></a>    myDay <span class="op">=</span> <span class="bu">str</span>(myDate.day).rjust(<span class="dv">2</span>, <span class="st">'0'</span>)</span>
<span id="cb1-189"><a href="#cb1-189"></a></span>
<span id="cb1-190"><a href="#cb1-190"></a>    <span class="co"># Construct the directory path where raw swaths are stored for this date</span></span>
<span id="cb1-191"><a href="#cb1-191"></a>    datadir <span class="op">=</span> datadirBase <span class="op">+</span> year <span class="op">+</span> myMon <span class="op">+</span> <span class="st">'/'</span></span>
<span id="cb1-192"><a href="#cb1-192"></a></span>
<span id="cb1-193"><a href="#cb1-193"></a>    <span class="co"># Next calendar day (for hours ≤ 10)</span></span>
<span id="cb1-194"><a href="#cb1-194"></a>    myDate1 <span class="op">=</span> myDate <span class="op">+</span> timedelta(days<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb1-195"><a href="#cb1-195"></a>    year1 <span class="op">=</span> <span class="bu">str</span>(myDate1.year)</span>
<span id="cb1-196"><a href="#cb1-196"></a>    doy1 <span class="op">=</span> myDate1.strftime(<span class="st">"%j"</span>).zfill(<span class="dv">3</span>)</span>
<span id="cb1-197"><a href="#cb1-197"></a>    myMon1 <span class="op">=</span> <span class="bu">str</span>(myDate1.month)</span>
<span id="cb1-198"><a href="#cb1-198"></a>    myMon1 <span class="op">=</span> myMon1.rjust(<span class="dv">2</span>, <span class="st">'0'</span>)</span>
<span id="cb1-199"><a href="#cb1-199"></a>    myDay1 <span class="op">=</span> <span class="bu">str</span>(myDate1.day).rjust(<span class="dv">2</span>, <span class="st">'0'</span>)</span>
<span id="cb1-200"><a href="#cb1-200"></a>    datadir1 <span class="op">=</span> datadirBase <span class="op">+</span> year1 <span class="op">+</span> myMon1 <span class="op">+</span> <span class="st">'/'</span></span>
<span id="cb1-201"><a href="#cb1-201"></a></span>
<span id="cb1-202"><a href="#cb1-202"></a>    <span class="co"># Load static land mask from GRD</span></span>
<span id="cb1-203"><a href="#cb1-203"></a>    mask_root <span class="op">=</span> Dataset(<span class="st">'/u00/ref/landmasks/LM_120_320_0.025_-45_65_0.025_gridline.grd'</span>)</span>
<span id="cb1-204"><a href="#cb1-204"></a>    my_mask <span class="op">=</span> mask_root.variables[<span class="st">'z'</span>][:, :]</span>
<span id="cb1-205"><a href="#cb1-205"></a>    mask_root.close()</span>
<span id="cb1-206"><a href="#cb1-206"></a></span>
<span id="cb1-207"><a href="#cb1-207"></a>    <span class="co"># Now move to the data directory</span></span>
<span id="cb1-208"><a href="#cb1-208"></a>    os.chdir(datadir)</span>
<span id="cb1-209"><a href="#cb1-209"></a></span>
<span id="cb1-210"><a href="#cb1-210"></a>    <span class="co"># Set up the string for the file search in the data directory</span></span>
<span id="cb1-211"><a href="#cb1-211"></a>    <span class="co">#myString = 'A' + year + doy + '*.L2_LAC_OC.nc'</span></span>
<span id="cb1-212"><a href="#cb1-212"></a>    myString <span class="op">=</span> <span class="st">'AQUA_MODIS.'</span> <span class="op">+</span> year <span class="op">+</span> myMon <span class="op">+</span> myDay <span class="op">+</span> <span class="st">'*.L2.OC.NRT.nc'</span></span>
<span id="cb1-213"><a href="#cb1-213"></a>    <span class="bu">print</span>(myString)</span>
<span id="cb1-214"><a href="#cb1-214"></a></span>
<span id="cb1-215"><a href="#cb1-215"></a>    <span class="co"># Get list of files in the data directory that match with full path</span></span>
<span id="cb1-216"><a href="#cb1-216"></a>    fileList <span class="op">=</span> glob.glob(myString)</span>
<span id="cb1-217"><a href="#cb1-217"></a>    fileList.sort()</span>
<span id="cb1-218"><a href="#cb1-218"></a></span>
<span id="cb1-219"><a href="#cb1-219"></a>    <span class="co"># Now move to the work directory and clear old files</span></span>
<span id="cb1-220"><a href="#cb1-220"></a>    os.chdir(workdir)</span>
<span id="cb1-221"><a href="#cb1-221"></a>    os.system(<span class="st">'rm -f AQUA_MODIS.*L2.OC*'</span>)</span>
<span id="cb1-222"><a href="#cb1-222"></a>    os.system(<span class="st">'rm -f MB20*'</span>)</span>
<span id="cb1-223"><a href="#cb1-223"></a></span>
<span id="cb1-224"><a href="#cb1-224"></a>    <span class="co"># Initialize variables to accumulate data and track provenance</span></span>
<span id="cb1-225"><a href="#cb1-225"></a>    filesUsed <span class="op">=</span> <span class="st">""</span></span>
<span id="cb1-226"><a href="#cb1-226"></a>    temp_data <span class="op">=</span> <span class="va">None</span></span>
<span id="cb1-227"><a href="#cb1-227"></a></span>
<span id="cb1-228"><a href="#cb1-228"></a>    <span class="co"># Loop over swaths for hod &gt; 10 </span></span>
<span id="cb1-229"><a href="#cb1-229"></a>    <span class="cf">for</span> fName <span class="kw">in</span> fileList:</span>
<span id="cb1-230"><a href="#cb1-230"></a>        fileName <span class="op">=</span> fName</span>
<span id="cb1-231"><a href="#cb1-231"></a>        <span class="co"># Extract hour of day from filename</span></span>
<span id="cb1-232"><a href="#cb1-232"></a>        datetime <span class="op">=</span> re.search(<span class="st">'AQUA_MODIS.(.+?).L2.OC.NRT.nc'</span>, fileName)</span>
<span id="cb1-233"><a href="#cb1-233"></a>        hodstr <span class="op">=</span> datetime.group(<span class="dv">1</span>)[<span class="dv">9</span>:<span class="dv">11</span>]</span>
<span id="cb1-234"><a href="#cb1-234"></a>        hod <span class="op">=</span> <span class="bu">int</span>(hodstr)</span>
<span id="cb1-235"><a href="#cb1-235"></a></span>
<span id="cb1-236"><a href="#cb1-236"></a>        <span class="cf">if</span> (hod <span class="op">&gt;</span> <span class="dv">10</span>):</span>
<span id="cb1-237"><a href="#cb1-237"></a>            <span class="bu">print</span>(hod)</span>
<span id="cb1-238"><a href="#cb1-238"></a>            <span class="bu">print</span>(fileName)</span>
<span id="cb1-239"><a href="#cb1-239"></a></span>
<span id="cb1-240"><a href="#cb1-240"></a>            <span class="co"># Stage the swath in the working directory</span></span>
<span id="cb1-241"><a href="#cb1-241"></a>            shutil.copyfile(datadir <span class="op">+</span> fName, workdir <span class="op">+</span> fName)</span>
<span id="cb1-242"><a href="#cb1-242"></a></span>
<span id="cb1-243"><a href="#cb1-243"></a>            <span class="co"># Try to open the NetCDF; skip if the file is unreadable</span></span>
<span id="cb1-244"><a href="#cb1-244"></a>            <span class="cf">try</span>:</span>
<span id="cb1-245"><a href="#cb1-245"></a>                rootgrp <span class="op">=</span> Dataset(fileName, <span class="st">'r'</span>)</span>
<span id="cb1-246"><a href="#cb1-246"></a>            <span class="cf">except</span> <span class="pp">IOError</span>:</span>
<span id="cb1-247"><a href="#cb1-247"></a>                <span class="bu">print</span>(<span class="st">"bad file "</span> <span class="op">+</span> fileName)</span>
<span id="cb1-248"><a href="#cb1-248"></a>                <span class="cf">continue</span></span>
<span id="cb1-249"><a href="#cb1-249"></a></span>
<span id="cb1-250"><a href="#cb1-250"></a>            <span class="co"># Extract navigation-group data</span></span>
<span id="cb1-251"><a href="#cb1-251"></a>            navDataGroup <span class="op">=</span> rootgrp.groups[<span class="st">'navigation_data'</span>]</span>
<span id="cb1-252"><a href="#cb1-252"></a>            latitude <span class="op">=</span> navDataGroup.variables[<span class="st">'latitude'</span>][:, :]</span>
<span id="cb1-253"><a href="#cb1-253"></a>            longitude <span class="op">=</span> navDataGroup.variables[<span class="st">'longitude'</span>][:, :]</span>
<span id="cb1-254"><a href="#cb1-254"></a></span>
<span id="cb1-255"><a href="#cb1-255"></a>            <span class="co"># Convert any negative longitudes to the 0-360° domain</span></span>
<span id="cb1-256"><a href="#cb1-256"></a>            longitude[longitude <span class="op">&lt;</span> <span class="dv">0</span>] <span class="op">=</span> longitude[longitude <span class="op">&lt;</span> <span class="dv">0</span>] <span class="op">+</span> <span class="dv">360</span></span>
<span id="cb1-257"><a href="#cb1-257"></a></span>
<span id="cb1-258"><a href="#cb1-258"></a>            <span class="co"># Compute swath extents (min/max) for geographic filtering</span></span>
<span id="cb1-259"><a href="#cb1-259"></a>            dataLonMin <span class="op">=</span> np.nanmin(longitude[longitude <span class="op">&gt;=</span> <span class="dv">0</span>])</span>
<span id="cb1-260"><a href="#cb1-260"></a>            dataLonMax <span class="op">=</span> np.nanmax(longitude[longitude <span class="op">&lt;=</span> <span class="dv">360</span>])</span>
<span id="cb1-261"><a href="#cb1-261"></a>            dataLatMin <span class="op">=</span> np.nanmin(latitude[latitude <span class="op">&gt;=</span> <span class="op">-</span><span class="dv">90</span>])</span>
<span id="cb1-262"><a href="#cb1-262"></a>            dataLatMax <span class="op">=</span> np.nanmax(latitude[latitude <span class="op">&lt;=</span> <span class="dv">90</span>])</span>
<span id="cb1-263"><a href="#cb1-263"></a></span>
<span id="cb1-264"><a href="#cb1-264"></a>            <span class="co"># Determine if swath overlaps our the MW region</span></span>
<span id="cb1-265"><a href="#cb1-265"></a>            goodLon1 <span class="op">=</span> (dataLonMin <span class="op">&lt;</span> lonmin) <span class="kw">and</span> (dataLonMax <span class="op">&gt;=</span> lonmin)</span>
<span id="cb1-266"><a href="#cb1-266"></a>            goodLon2 <span class="op">=</span> (dataLonMin <span class="op">&gt;=</span> lonmin) <span class="kw">and</span> (dataLonMin <span class="op">&lt;=</span> lonmax)</span>
<span id="cb1-267"><a href="#cb1-267"></a>            goodLon <span class="op">=</span> goodLon1 <span class="kw">or</span> goodLon2</span>
<span id="cb1-268"><a href="#cb1-268"></a></span>
<span id="cb1-269"><a href="#cb1-269"></a>            goodLat1 <span class="op">=</span> (dataLatMin <span class="op">&lt;</span> latmin) <span class="kw">and</span> (dataLatMax <span class="op">&gt;=</span> latmin)</span>
<span id="cb1-270"><a href="#cb1-270"></a>            goodLat2 <span class="op">=</span> (dataLatMin <span class="op">&gt;=</span> latmin) <span class="kw">and</span> (dataLatMin <span class="op">&lt;=</span> latmax)</span>
<span id="cb1-271"><a href="#cb1-271"></a>            goodLat <span class="op">=</span> goodLat1 <span class="kw">or</span> goodLat2</span>
<span id="cb1-272"><a href="#cb1-272"></a></span>
<span id="cb1-273"><a href="#cb1-273"></a>            <span class="co"># Check if swath is daytime (only keep "Day" pixels)</span></span>
<span id="cb1-274"><a href="#cb1-274"></a>            dayNightTest <span class="op">=</span> (rootgrp.day_night_flag <span class="op">==</span> <span class="st">'Day'</span>)</span>
<span id="cb1-275"><a href="#cb1-275"></a></span>
<span id="cb1-276"><a href="#cb1-276"></a>            <span class="co"># Only proceed if geography and day-night tests pass</span></span>
<span id="cb1-277"><a href="#cb1-277"></a>            <span class="cf">if</span> (goodLon <span class="kw">and</span> goodLat <span class="kw">and</span> dayNightTest):</span>
<span id="cb1-278"><a href="#cb1-278"></a>            <span class="co"># if(goodLon and goodLat):</span></span>
<span id="cb1-279"><a href="#cb1-279"></a>                <span class="cf">if</span> (<span class="bu">len</span>(filesUsed) <span class="op">==</span> <span class="dv">0</span>):</span>
<span id="cb1-280"><a href="#cb1-280"></a>                    filesUsed <span class="op">=</span> fileName</span>
<span id="cb1-281"><a href="#cb1-281"></a>                <span class="cf">else</span>:</span>
<span id="cb1-282"><a href="#cb1-282"></a>                    filesUsed <span class="op">=</span> filesUsed <span class="op">+</span> <span class="st">', '</span> <span class="op">+</span> fileName</span>
<span id="cb1-283"><a href="#cb1-283"></a></span>
<span id="cb1-284"><a href="#cb1-284"></a>                <span class="co"># Reshape latitude &amp; longitude arrays into column vectors</span></span>
<span id="cb1-285"><a href="#cb1-285"></a>                latitude <span class="op">=</span> myReshape(latitude)</span>
<span id="cb1-286"><a href="#cb1-286"></a>                longitude <span class="op">=</span> myReshape(longitude)</span>
<span id="cb1-287"><a href="#cb1-287"></a></span>
<span id="cb1-288"><a href="#cb1-288"></a>                <span class="co"># Access geophysical data group</span></span>
<span id="cb1-289"><a href="#cb1-289"></a>                geoDataGroup <span class="op">=</span> rootgrp.groups[<span class="st">'geophysical_data'</span>]</span>
<span id="cb1-290"><a href="#cb1-290"></a></span>
<span id="cb1-291"><a href="#cb1-291"></a>                <span class="co"># Extract chlor_a</span></span>
<span id="cb1-292"><a href="#cb1-292"></a>                chlor_a <span class="op">=</span> geoDataGroup.variables[<span class="st">'chlor_a'</span>][:, :]</span>
<span id="cb1-293"><a href="#cb1-293"></a>                chlor_a <span class="op">=</span> myReshape(chlor_a)</span>
<span id="cb1-294"><a href="#cb1-294"></a></span>
<span id="cb1-295"><a href="#cb1-295"></a>                <span class="co"># Stack (lon, lat, chlor_a) into a single 2D array with shape (N, 3)</span></span>
<span id="cb1-296"><a href="#cb1-296"></a>                dataOut <span class="op">=</span> np.hstack((longitude, latitude, chlor_a))</span>
<span id="cb1-297"><a href="#cb1-297"></a></span>
<span id="cb1-298"><a href="#cb1-298"></a>                <span class="co"># Filter rows to keep only valid chlor_a (&gt;0)</span></span>
<span id="cb1-299"><a href="#cb1-299"></a>                dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">2</span>] <span class="op">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb1-300"><a href="#cb1-300"></a>                dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">0</span>] <span class="op">&gt;</span> <span class="op">-</span><span class="dv">400</span>]</span>
<span id="cb1-301"><a href="#cb1-301"></a>                dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">0</span>] <span class="op">&gt;=</span> lonmin]</span>
<span id="cb1-302"><a href="#cb1-302"></a>                dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">0</span>] <span class="op">&lt;=</span> lonmax]</span>
<span id="cb1-303"><a href="#cb1-303"></a>                dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">1</span>] <span class="op">&gt;=</span> latmin]</span>
<span id="cb1-304"><a href="#cb1-304"></a>                dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">1</span>] <span class="op">&lt;=</span> latmax]</span>
<span id="cb1-305"><a href="#cb1-305"></a></span>
<span id="cb1-306"><a href="#cb1-306"></a>                <span class="co"># Accumulate into temp_data</span></span>
<span id="cb1-307"><a href="#cb1-307"></a>                <span class="cf">if</span>(dataOut.shape[<span class="dv">0</span>] <span class="op">&gt;</span> <span class="dv">0</span>):</span>
<span id="cb1-308"><a href="#cb1-308"></a>                    <span class="cf">if</span>(temp_data <span class="kw">is</span> <span class="va">None</span>):</span>
<span id="cb1-309"><a href="#cb1-309"></a>                        temp_data <span class="op">=</span> dataOut</span>
<span id="cb1-310"><a href="#cb1-310"></a>                    <span class="cf">else</span>:</span>
<span id="cb1-311"><a href="#cb1-311"></a>                        temp_data <span class="op">=</span> np.concatenate((temp_data, dataOut), axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb1-312"><a href="#cb1-312"></a></span>
<span id="cb1-313"><a href="#cb1-313"></a>            <span class="co"># Clean up this swath</span></span>
<span id="cb1-314"><a href="#cb1-314"></a>            rootgrp.close()</span>
<span id="cb1-315"><a href="#cb1-315"></a>            safe_remove(fileName)</span>
<span id="cb1-316"><a href="#cb1-316"></a></span>
<span id="cb1-317"><a href="#cb1-317"></a>    <span class="co"># Repeat for hod ≤ 10 on the next day</span></span>
<span id="cb1-318"><a href="#cb1-318"></a></span>
<span id="cb1-319"><a href="#cb1-319"></a>    <span class="co"># Move back to data dir</span></span>
<span id="cb1-320"><a href="#cb1-320"></a>    os.chdir(datadir1)</span>
<span id="cb1-321"><a href="#cb1-321"></a></span>
<span id="cb1-322"><a href="#cb1-322"></a>    <span class="co"># Set up the string for file matching of doy+1</span></span>
<span id="cb1-323"><a href="#cb1-323"></a>    myString <span class="op">=</span> <span class="st">'AQUA_MODIS.'</span> <span class="op">+</span> year1 <span class="op">+</span> myMon1 <span class="op">+</span> myDay1 <span class="op">+</span> <span class="st">'*.L2.OC.NRT.nc'</span></span>
<span id="cb1-324"><a href="#cb1-324"></a>    fileList <span class="op">=</span> glob.glob(myString)</span>
<span id="cb1-325"><a href="#cb1-325"></a>    fileList.sort()</span>
<span id="cb1-326"><a href="#cb1-326"></a></span>
<span id="cb1-327"><a href="#cb1-327"></a>    <span class="co"># Change back to work directory</span></span>
<span id="cb1-328"><a href="#cb1-328"></a>    os.chdir(workdir)</span>
<span id="cb1-329"><a href="#cb1-329"></a></span>
<span id="cb1-330"><a href="#cb1-330"></a>    <span class="cf">for</span> fName <span class="kw">in</span> fileList:</span>
<span id="cb1-331"><a href="#cb1-331"></a>        fileName <span class="op">=</span> fName</span>
<span id="cb1-332"><a href="#cb1-332"></a></span>
<span id="cb1-333"><a href="#cb1-333"></a>        <span class="co"># Find the datatime group in the filename</span></span>
<span id="cb1-334"><a href="#cb1-334"></a>        datetime <span class="op">=</span> re.search(<span class="st">'AQUA_MODIS.(.+?).L2.OC.NRT.nc'</span>, fileName)</span>
<span id="cb1-335"><a href="#cb1-335"></a>        hodstr <span class="op">=</span> datetime.group(<span class="dv">1</span>)[<span class="dv">9</span>:<span class="dv">11</span>]</span>
<span id="cb1-336"><a href="#cb1-336"></a>        hod <span class="op">=</span> <span class="bu">int</span>(hodstr)</span>
<span id="cb1-337"><a href="#cb1-337"></a>        <span class="cf">if</span> (hod <span class="op">&lt;=</span> <span class="dv">10</span>):</span>
<span id="cb1-338"><a href="#cb1-338"></a>            <span class="bu">print</span>(hod)</span>
<span id="cb1-339"><a href="#cb1-339"></a>            <span class="bu">print</span>(fileName)</span>
<span id="cb1-340"><a href="#cb1-340"></a></span>
<span id="cb1-341"><a href="#cb1-341"></a>            <span class="co"># cp file from work directory to</span></span>
<span id="cb1-342"><a href="#cb1-342"></a>            shutil.copyfile(datadir1 <span class="op">+</span> fName, workdir <span class="op">+</span> fName)</span>
<span id="cb1-343"><a href="#cb1-343"></a>            <span class="cf">try</span>:</span>
<span id="cb1-344"><a href="#cb1-344"></a>                rootgrp <span class="op">=</span> Dataset(fileName, <span class="st">'r'</span>)</span>
<span id="cb1-345"><a href="#cb1-345"></a>            <span class="cf">except</span> <span class="pp">IOError</span>:</span>
<span id="cb1-346"><a href="#cb1-346"></a>                <span class="bu">print</span>(<span class="st">"bad file "</span> <span class="op">+</span> fileName)</span>
<span id="cb1-347"><a href="#cb1-347"></a>                <span class="cf">continue</span></span>
<span id="cb1-348"><a href="#cb1-348"></a></span>
<span id="cb1-349"><a href="#cb1-349"></a>            <span class="co">#rootgrp = Dataset(fileName, 'r')</span></span>
<span id="cb1-350"><a href="#cb1-350"></a></span>
<span id="cb1-351"><a href="#cb1-351"></a>            navDataGroup <span class="op">=</span> rootgrp.groups[<span class="st">'navigation_data'</span>]</span>
<span id="cb1-352"><a href="#cb1-352"></a>            latitude <span class="op">=</span> navDataGroup.variables[<span class="st">'latitude'</span>][:, :]</span>
<span id="cb1-353"><a href="#cb1-353"></a>            longitude <span class="op">=</span> navDataGroup.variables[<span class="st">'longitude'</span>][:, :]</span>
<span id="cb1-354"><a href="#cb1-354"></a></span>
<span id="cb1-355"><a href="#cb1-355"></a>            longitude[longitude <span class="op">&lt;</span> <span class="dv">0</span>] <span class="op">=</span> longitude[longitude <span class="op">&lt;</span> <span class="dv">0</span>] <span class="op">+</span> <span class="dv">360</span></span>
<span id="cb1-356"><a href="#cb1-356"></a></span>
<span id="cb1-357"><a href="#cb1-357"></a>            dataLonMin <span class="op">=</span> np.nanmin(longitude[longitude <span class="op">&gt;=</span> <span class="dv">0</span>])</span>
<span id="cb1-358"><a href="#cb1-358"></a>            dataLonMax <span class="op">=</span> np.nanmax(longitude[longitude <span class="op">&lt;=</span> <span class="dv">360</span>])</span>
<span id="cb1-359"><a href="#cb1-359"></a>            dataLatMin <span class="op">=</span> np.nanmin(latitude[latitude <span class="op">&gt;=</span> <span class="op">-</span><span class="dv">90</span>] )</span>
<span id="cb1-360"><a href="#cb1-360"></a>            dataLatMax <span class="op">=</span> np.nanmax(latitude[latitude <span class="op">&lt;=</span> <span class="dv">90</span>] )</span>
<span id="cb1-361"><a href="#cb1-361"></a></span>
<span id="cb1-362"><a href="#cb1-362"></a>            goodLon1 <span class="op">=</span> (dataLonMin <span class="op">&lt;</span> lonmin) <span class="kw">and</span> ( dataLonMax <span class="op">&gt;=</span> lonmin)</span>
<span id="cb1-363"><a href="#cb1-363"></a>            goodLon2 <span class="op">=</span> (dataLonMin <span class="op">&gt;=</span> lonmin) <span class="kw">and</span> (dataLonMin <span class="op">&lt;=</span> lonmax)</span>
<span id="cb1-364"><a href="#cb1-364"></a>            goodLon <span class="op">=</span> goodLon1 <span class="kw">or</span> goodLon2</span>
<span id="cb1-365"><a href="#cb1-365"></a></span>
<span id="cb1-366"><a href="#cb1-366"></a>            goodLat1 <span class="op">=</span> (dataLatMin <span class="op">&lt;</span> latmin) <span class="kw">and</span> (dataLatMax <span class="op">&gt;=</span> latmin)</span>
<span id="cb1-367"><a href="#cb1-367"></a>            goodLat2 <span class="op">=</span> (dataLatMin <span class="op">&gt;=</span> latmin) <span class="kw">and</span> (dataLatMin <span class="op">&lt;=</span> latmax)</span>
<span id="cb1-368"><a href="#cb1-368"></a>            goodLat <span class="op">=</span> goodLat1 <span class="kw">or</span> goodLat2</span>
<span id="cb1-369"><a href="#cb1-369"></a></span>
<span id="cb1-370"><a href="#cb1-370"></a>            dayNightTest <span class="op">=</span> (rootgrp.day_night_flag <span class="op">==</span> <span class="st">'Day'</span>)</span>
<span id="cb1-371"><a href="#cb1-371"></a></span>
<span id="cb1-372"><a href="#cb1-372"></a>            <span class="cf">if</span> (goodLon <span class="kw">and</span> goodLat <span class="kw">and</span> dayNightTest):</span>
<span id="cb1-373"><a href="#cb1-373"></a>                <span class="cf">if</span> (<span class="bu">len</span>(filesUsed) <span class="op">==</span> <span class="dv">0</span>):</span>
<span id="cb1-374"><a href="#cb1-374"></a>                    filesUsed <span class="op">=</span> fileName</span>
<span id="cb1-375"><a href="#cb1-375"></a>                <span class="cf">else</span>:</span>
<span id="cb1-376"><a href="#cb1-376"></a>                    filesUsed <span class="op">=</span> filesUsed <span class="op">+</span> <span class="st">', '</span> <span class="op">+</span> fileName</span>
<span id="cb1-377"><a href="#cb1-377"></a></span>
<span id="cb1-378"><a href="#cb1-378"></a>                latitude <span class="op">=</span> myReshape(latitude)</span>
<span id="cb1-379"><a href="#cb1-379"></a>                longitude <span class="op">=</span> myReshape(longitude)</span>
<span id="cb1-380"><a href="#cb1-380"></a></span>
<span id="cb1-381"><a href="#cb1-381"></a>                geoDataGroup <span class="op">=</span> rootgrp.groups[<span class="st">'geophysical_data'</span>]</span>
<span id="cb1-382"><a href="#cb1-382"></a></span>
<span id="cb1-383"><a href="#cb1-383"></a>                chlor_a <span class="op">=</span> geoDataGroup.variables[<span class="st">'chlor_a'</span>][:, :]</span>
<span id="cb1-384"><a href="#cb1-384"></a>                chlor_a <span class="op">=</span> myReshape(chlor_a)</span>
<span id="cb1-385"><a href="#cb1-385"></a></span>
<span id="cb1-386"><a href="#cb1-386"></a>                dataOut <span class="op">=</span> np.hstack((longitude, latitude, chlor_a))</span>
<span id="cb1-387"><a href="#cb1-387"></a></span>
<span id="cb1-388"><a href="#cb1-388"></a>                dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">2</span>] <span class="op">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb1-389"><a href="#cb1-389"></a>                dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">0</span>] <span class="op">&gt;</span> <span class="op">-</span><span class="dv">400</span>]</span>
<span id="cb1-390"><a href="#cb1-390"></a>                dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">0</span>] <span class="op">&gt;=</span> lonmin]</span>
<span id="cb1-391"><a href="#cb1-391"></a>                dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">0</span>] <span class="op">&lt;=</span> lonmax]</span>
<span id="cb1-392"><a href="#cb1-392"></a>                dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">1</span>] <span class="op">&gt;=</span> latmin]</span>
<span id="cb1-393"><a href="#cb1-393"></a>                dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">1</span>] <span class="op">&lt;=</span> latmax]</span>
<span id="cb1-394"><a href="#cb1-394"></a></span>
<span id="cb1-395"><a href="#cb1-395"></a>                <span class="cf">if</span>(dataOut.shape[<span class="dv">0</span>] <span class="op">&gt;</span> <span class="dv">0</span>):</span>
<span id="cb1-396"><a href="#cb1-396"></a>                    <span class="cf">if</span>(temp_data <span class="kw">is</span> <span class="va">None</span>):</span>
<span id="cb1-397"><a href="#cb1-397"></a>                        temp_data <span class="op">=</span> dataOut</span>
<span id="cb1-398"><a href="#cb1-398"></a>                    <span class="cf">else</span>:</span>
<span id="cb1-399"><a href="#cb1-399"></a>                        temp_data <span class="op">=</span> np.concatenate((temp_data, dataOut), axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb1-400"><a href="#cb1-400"></a></span>
<span id="cb1-401"><a href="#cb1-401"></a>            rootgrp.close()</span>
<span id="cb1-402"><a href="#cb1-402"></a>            safe_remove(fileName)</span>
<span id="cb1-403"><a href="#cb1-403"></a></span>
<span id="cb1-404"><a href="#cb1-404"></a>    <span class="co"># Grid the combined Chla point cloud and write outputs</span></span>
<span id="cb1-405"><a href="#cb1-405"></a>    fileOut <span class="op">=</span> <span class="st">'MB'</span> <span class="op">+</span> year <span class="op">+</span> doy <span class="op">+</span> <span class="st">'_'</span> <span class="op">+</span> year <span class="op">+</span> doy <span class="op">+</span> <span class="st">'_chla.grd'</span></span>
<span id="cb1-406"><a href="#cb1-406"></a>    <span class="bu">range</span> <span class="op">=</span> <span class="st">'120/320/-45/65'</span></span>
<span id="cb1-407"><a href="#cb1-407"></a>    increment <span class="op">=</span> <span class="st">'0.025/0.025'</span></span>
<span id="cb1-408"><a href="#cb1-408"></a>    temp_data1 <span class="op">=</span> pygmt.xyz2grd(</span>
<span id="cb1-409"><a href="#cb1-409"></a>        data<span class="op">=</span>temp_data,</span>
<span id="cb1-410"><a href="#cb1-410"></a>        region<span class="op">=</span><span class="bu">range</span>,</span>
<span id="cb1-411"><a href="#cb1-411"></a>        spacing<span class="op">=</span>increment,</span>
<span id="cb1-412"><a href="#cb1-412"></a>    )</span>
<span id="cb1-413"><a href="#cb1-413"></a></span>
<span id="cb1-414"><a href="#cb1-414"></a>    <span class="co"># Convert the GMT grid to CF-compliant NetCDF, masking land</span></span>
<span id="cb1-415"><a href="#cb1-415"></a>    ncFile <span class="op">=</span> grd2netcdf1(temp_data1, fileOut, filesUsed, my_mask, <span class="st">'MB'</span>)</span>
<span id="cb1-416"><a href="#cb1-416"></a></span>
<span id="cb1-417"><a href="#cb1-417"></a>    <span class="co">#myCmd = "mv " + ncFile + " /home/cwatch/pygmt_test/outfiles"</span></span>
<span id="cb1-418"><a href="#cb1-418"></a>    <span class="co">#os.system(myCmd)</span></span>
<span id="cb1-419"><a href="#cb1-419"></a></span>
<span id="cb1-420"><a href="#cb1-420"></a>    <span class="co"># Copy to the MB server folder for chla (1-day product)</span></span>
<span id="cb1-421"><a href="#cb1-421"></a>    send_to_servers(ncFile, <span class="st">'/MB/chla/'</span> , <span class="st">'1'</span>)</span>
<span id="cb1-422"><a href="#cb1-422"></a>    os.remove(ncFile)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="compmbchla" class="level3">
<h3 class="anchored" data-anchor-id="compmbchla">CompMBChla</h3>
<p><code>CompMBChla.py</code> reads the daily 1-day chlorophyll-a NetCDF files over a user-defined interval, accumulates running sum and count arrays on a 0.025° × 0.025° regular grid spanning longitude 120°–320° and latitude –45°–65°, then masks out cells with no observations and writes the averaged multi-day (3-, 5-, 8-, or 14-day) composite as a CF-compliant NetCDF. It finishes by uploading the final composite to a directory on a remote server. Find the multi-day products on ERDDAP <a href="./modisa_scripts.html#modisa-products-on-swfsc-erddap-server">here</a>.</p>
<p>The following chart summarizes the script’s workflow:</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">%%{init: {"flowchart":{"htmlLabels":true}}}%%
flowchart LR
  I("&lt;b&gt;Inputs&lt;/b&gt;&lt;br/&gt;• Daily 1-day Chla NetCDFs (dataDir)&lt;br/&gt;• workDir&lt;br/&gt;• endYear &amp; endDoy&lt;br/&gt;• interval (days)")
    --&gt; P("&lt;b&gt;Processing&lt;/b&gt;&lt;br/&gt;• Compute start &amp; end dates&lt;br/&gt;• Initialize mean/num arrays&lt;br/&gt;• Gather daily files over interval&lt;br/&gt;• Loop: open each file, extract &amp; squeeze variable&lt;br/&gt;• Update running mean &amp; count&lt;br/&gt;• Mask pixels with zero observations")
    --&gt; O("&lt;b&gt;Output&lt;/b&gt;&lt;br/&gt;• CF-compliant multi-day composite Chla NetCDF&lt;br/&gt;• Deployed to /MB/chla/")
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<div id="905feac3" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>View CompMBChla.py</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1"></a><span class="co">"""</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="co">Overview</span></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="co">--------</span></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="co">Compute multi-day (m-day) chlorophyll-a composites for the MODIS “MB” (Pacific Ocean)</span></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="co">dataset by averaging 1-day NetCDF files over a specified range of days.</span></span>
<span id="cb2-6"><a href="#cb2-6"></a></span>
<span id="cb2-7"><a href="#cb2-7"></a><span class="co">Usage</span></span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="co">-----</span></span>
<span id="cb2-9"><a href="#cb2-9"></a><span class="co">::</span></span>
<span id="cb2-10"><a href="#cb2-10"></a><span class="co">  </span></span>
<span id="cb2-11"><a href="#cb2-11"></a><span class="co">      python CompMBChla.py &lt;dataDir&gt; &lt;workDir&gt; &lt;endYear&gt; &lt;endDoy&gt; &lt;interval&gt;</span></span>
<span id="cb2-12"><a href="#cb2-12"></a></span>
<span id="cb2-13"><a href="#cb2-13"></a><span class="co">Where:</span></span>
<span id="cb2-14"><a href="#cb2-14"></a></span>
<span id="cb2-15"><a href="#cb2-15"></a><span class="co">- ``dataDir``</span></span>
<span id="cb2-16"><a href="#cb2-16"></a></span>
<span id="cb2-17"><a href="#cb2-17"></a><span class="co">  Directory containing daily 1-day NetCDFs named ``MB&lt;YYYY&gt;&lt;DDD&gt;*chla.nc``.</span></span>
<span id="cb2-18"><a href="#cb2-18"></a></span>
<span id="cb2-19"><a href="#cb2-19"></a><span class="co">- ``workDir``</span></span>
<span id="cb2-20"><a href="#cb2-20"></a></span>
<span id="cb2-21"><a href="#cb2-21"></a><span class="co">  Temporary working directory for intermediate files.</span></span>
<span id="cb2-22"><a href="#cb2-22"></a></span>
<span id="cb2-23"><a href="#cb2-23"></a><span class="co">- ``endYear``</span></span>
<span id="cb2-24"><a href="#cb2-24"></a></span>
<span id="cb2-25"><a href="#cb2-25"></a><span class="co">  Four-digit year of the last day in the composite (e.g., ``2025``).</span></span>
<span id="cb2-26"><a href="#cb2-26"></a></span>
<span id="cb2-27"><a href="#cb2-27"></a><span class="co">- ``endDoy``</span></span>
<span id="cb2-28"><a href="#cb2-28"></a></span>
<span id="cb2-29"><a href="#cb2-29"></a><span class="co">  Three-digit day-of-year of the last day (e.g., ``082``).</span></span>
<span id="cb2-30"><a href="#cb2-30"></a></span>
<span id="cb2-31"><a href="#cb2-31"></a><span class="co">- ``interval``</span></span>
<span id="cb2-32"><a href="#cb2-32"></a></span>
<span id="cb2-33"><a href="#cb2-33"></a><span class="co">  Number of days to include (e.g., `3`, `5`, `8`, `14`).</span></span>
<span id="cb2-34"><a href="#cb2-34"></a></span>
<span id="cb2-35"><a href="#cb2-35"></a></span>
<span id="cb2-36"><a href="#cb2-36"></a><span class="co">Description</span></span>
<span id="cb2-37"><a href="#cb2-37"></a><span class="co">-----------</span></span>
<span id="cb2-38"><a href="#cb2-38"></a><span class="co">1. **Parse arguments &amp; compute interval**</span></span>
<span id="cb2-39"><a href="#cb2-39"></a></span>
<span id="cb2-40"><a href="#cb2-40"></a><span class="co">  - Read ``dataDir``, ``workDir``, ``endYear``, ``endDoy``, and ``interval`` from ``sys.argv``.</span></span>
<span id="cb2-41"><a href="#cb2-41"></a></span>
<span id="cb2-42"><a href="#cb2-42"></a><span class="co">  - Compute ``startDoy = endDoy - interval + 1``.</span></span>
<span id="cb2-43"><a href="#cb2-43"></a></span>
<span id="cb2-44"><a href="#cb2-44"></a><span class="co">2. **Compute start/end dates**</span></span>
<span id="cb2-45"><a href="#cb2-45"></a></span>
<span id="cb2-46"><a href="#cb2-46"></a><span class="co">  - Convert ``endYear`` + ``endDoy`` to a ``datetime``.</span></span>
<span id="cb2-47"><a href="#cb2-47"></a></span>
<span id="cb2-48"><a href="#cb2-48"></a><span class="co">  - Derive ``startDoy`` date by subtracting ``interval - 1`` days.</span></span>
<span id="cb2-49"><a href="#cb2-49"></a></span>
<span id="cb2-50"><a href="#cb2-50"></a><span class="co">3. **Initialize accumulators**</span></span>
<span id="cb2-51"><a href="#cb2-51"></a></span>
<span id="cb2-52"><a href="#cb2-52"></a><span class="co">  - Change to ``workDir`` and clear any old files.</span></span>
<span id="cb2-53"><a href="#cb2-53"></a></span>
<span id="cb2-54"><a href="#cb2-54"></a><span class="co">  - Preallocate two arrays of shape (4401x8001):</span></span>
<span id="cb2-55"><a href="#cb2-55"></a></span>
<span id="cb2-56"><a href="#cb2-56"></a><span class="co">     - ``mean`` (float32) for the running sum of chlorophyll-a.</span></span>
<span id="cb2-57"><a href="#cb2-57"></a></span>
<span id="cb2-58"><a href="#cb2-58"></a><span class="co">     - ``num``  (int32) for the count of valid observations.</span></span>
<span id="cb2-59"><a href="#cb2-59"></a></span>
<span id="cb2-60"><a href="#cb2-60"></a><span class="co">4. **Gather daily files**</span></span>
<span id="cb2-61"><a href="#cb2-61"></a></span>
<span id="cb2-62"><a href="#cb2-62"></a><span class="co">  - Build a list of all ``MB&lt;YYYY&gt;&lt;DDD&gt;*chla.nc`` files from ``startDoy`` to ``endDoy``.</span></span>
<span id="cb2-63"><a href="#cb2-63"></a></span>
<span id="cb2-64"><a href="#cb2-64"></a><span class="co">  - Handle wrap-around year boundaries by splitting into two ranges if needed.</span></span>
<span id="cb2-65"><a href="#cb2-65"></a></span>
<span id="cb2-66"><a href="#cb2-66"></a><span class="co">5. **Accumulate daily Chla**</span></span>
<span id="cb2-67"><a href="#cb2-67"></a><span class="co">  </span></span>
<span id="cb2-68"><a href="#cb2-68"></a><span class="co">  - For each file:</span></span>
<span id="cb2-69"><a href="#cb2-69"></a></span>
<span id="cb2-70"><a href="#cb2-70"></a><span class="co">     - Open with ``Dataset()``, read the 4-D variable ``MBchla``, squeeze to 2-D.</span></span>
<span id="cb2-71"><a href="#cb2-71"></a></span>
<span id="cb2-72"><a href="#cb2-72"></a><span class="co">     - Update ``mean`` and ``num`` via ``meanVar(mean, num, data2d)``.</span></span>
<span id="cb2-73"><a href="#cb2-73"></a></span>
<span id="cb2-74"><a href="#cb2-74"></a><span class="co">6. **Mask &amp; finalize**</span></span>
<span id="cb2-75"><a href="#cb2-75"></a></span>
<span id="cb2-76"><a href="#cb2-76"></a><span class="co">  - Create a masked array where ``num == 0`` (no observations), fill value ``-9999999.``.</span></span>
<span id="cb2-77"><a href="#cb2-77"></a></span>
<span id="cb2-78"><a href="#cb2-78"></a><span class="co">7. **Write &amp; deploy** </span></span>
<span id="cb2-79"><a href="#cb2-79"></a></span>
<span id="cb2-80"><a href="#cb2-80"></a><span class="co">  - Change to ``workDir``.</span></span>
<span id="cb2-81"><a href="#cb2-81"></a><span class="co">  </span></span>
<span id="cb2-82"><a href="#cb2-82"></a><span class="co">  - Construct output filename ``MB&lt;startYear&gt;&lt;startDDD&gt;_&lt;endYear&gt;&lt;endDDD&gt;_chla.nc``.</span></span>
<span id="cb2-83"><a href="#cb2-83"></a><span class="co">  </span></span>
<span id="cb2-84"><a href="#cb2-84"></a><span class="co">  - Call ``makeNetcdf(mean, num, interval, outFile, filesUsed, workDir)`` to write the CF-compliant NetCDF.</span></span>
<span id="cb2-85"><a href="#cb2-85"></a><span class="co">  </span></span>
<span id="cb2-86"><a href="#cb2-86"></a><span class="co">  - Transfer it to ``/MB/chla/`` on the server via ``send_to_servers()``.</span></span>
<span id="cb2-87"><a href="#cb2-87"></a></span>
<span id="cb2-88"><a href="#cb2-88"></a><span class="co">Dependencies</span></span>
<span id="cb2-89"><a href="#cb2-89"></a><span class="co">------------</span></span>
<span id="cb2-90"><a href="#cb2-90"></a><span class="co">- Python 3.x</span></span>
<span id="cb2-91"><a href="#cb2-91"></a></span>
<span id="cb2-92"><a href="#cb2-92"></a><span class="co">- Standard library: ``os``, ``sys``, ``glob``, ``itertools.chain``, ``datetime``, ``timedelta``</span></span>
<span id="cb2-93"><a href="#cb2-93"></a></span>
<span id="cb2-94"><a href="#cb2-94"></a><span class="co">- Third-party: ``numpy``, ``numpy.ma``, ``netCDF4``</span></span>
<span id="cb2-95"><a href="#cb2-95"></a></span>
<span id="cb2-96"><a href="#cb2-96"></a><span class="co">- Custom roylib functions:</span></span>
<span id="cb2-97"><a href="#cb2-97"></a></span>
<span id="cb2-98"><a href="#cb2-98"></a><span class="co">  - ``isleap(year)``</span></span>
<span id="cb2-99"><a href="#cb2-99"></a></span>
<span id="cb2-100"><a href="#cb2-100"></a><span class="co">  - ``meanVar(mean, num, array)``</span></span>
<span id="cb2-101"><a href="#cb2-101"></a></span>
<span id="cb2-102"><a href="#cb2-102"></a><span class="co">  - ``makeNetcdf(mean, num, interval, outFile, filesUsed, workDir)``</span></span>
<span id="cb2-103"><a href="#cb2-103"></a></span>
<span id="cb2-104"><a href="#cb2-104"></a><span class="co">  - ``send_to_servers(ncFile, remote_dir, interval_flag)``</span></span>
<span id="cb2-105"><a href="#cb2-105"></a></span>
<span id="cb2-106"><a href="#cb2-106"></a><span class="co">Directory Structure</span></span>
<span id="cb2-107"><a href="#cb2-107"></a><span class="co">-------------------</span></span>
<span id="cb2-108"><a href="#cb2-108"></a><span class="co">- **Input Directory** (``dataDir``):</span></span>
<span id="cb2-109"><a href="#cb2-109"></a></span>
<span id="cb2-110"><a href="#cb2-110"></a><span class="co">  ``MB&lt;YYYY&gt;&lt;DDD&gt;*chla.nc`` daily files.</span></span>
<span id="cb2-111"><a href="#cb2-111"></a></span>
<span id="cb2-112"><a href="#cb2-112"></a><span class="co">- **Working Directory** (``workDir``):</span></span>
<span id="cb2-113"><a href="#cb2-113"></a></span>
<span id="cb2-114"><a href="#cb2-114"></a><span class="co">  Temporary staging and output location.</span></span>
<span id="cb2-115"><a href="#cb2-115"></a></span>
<span id="cb2-116"><a href="#cb2-116"></a><span class="co">- **Output location**:</span></span>
<span id="cb2-117"><a href="#cb2-117"></a></span>
<span id="cb2-118"><a href="#cb2-118"></a><span class="co">  Copied to ``/MB/chla/`` with the interval flag.</span></span>
<span id="cb2-119"><a href="#cb2-119"></a></span>
<span id="cb2-120"><a href="#cb2-120"></a><span class="co">Usage Example</span></span>
<span id="cb2-121"><a href="#cb2-121"></a><span class="co">-------------</span></span>
<span id="cb2-122"><a href="#cb2-122"></a><span class="co">Create a 5-day chlorophyll composite DOY 001-005 of 2025</span></span>
<span id="cb2-123"><a href="#cb2-123"></a><span class="co">::</span></span>
<span id="cb2-124"><a href="#cb2-124"></a><span class="co"> </span></span>
<span id="cb2-125"><a href="#cb2-125"></a><span class="co">   python CompMBChla.py /data/modisgf/1day/ /tmp/mw_work/ 2025 005 5</span></span>
<span id="cb2-126"><a href="#cb2-126"></a></span>
<span id="cb2-127"><a href="#cb2-127"></a><span class="co">This averages files for DOY 001…005, writes ``MB2025001_2025005_chla.nc`` in /tmp/mw_work/, and uploads to /MB/chla/.</span></span>
<span id="cb2-128"><a href="#cb2-128"></a><span class="co">"""</span></span>
<span id="cb2-129"><a href="#cb2-129"></a><span class="im">from</span> __future__ <span class="im">import</span> print_function</span>
<span id="cb2-130"><a href="#cb2-130"></a><span class="im">from</span> builtins <span class="im">import</span> <span class="bu">str</span></span>
<span id="cb2-131"><a href="#cb2-131"></a><span class="im">from</span> builtins <span class="im">import</span> <span class="bu">range</span></span>
<span id="cb2-132"><a href="#cb2-132"></a></span>
<span id="cb2-133"><a href="#cb2-133"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb2-134"><a href="#cb2-134"></a>    <span class="im">from</span> datetime <span class="im">import</span> datetime, timedelta</span>
<span id="cb2-135"><a href="#cb2-135"></a>    <span class="im">import</span> glob</span>
<span id="cb2-136"><a href="#cb2-136"></a>    <span class="im">from</span> itertools <span class="im">import</span> chain</span>
<span id="cb2-137"><a href="#cb2-137"></a>    <span class="im">from</span> netCDF4 <span class="im">import</span> Dataset</span>
<span id="cb2-138"><a href="#cb2-138"></a>    <span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb2-139"><a href="#cb2-139"></a>    <span class="im">import</span> numpy.ma <span class="im">as</span> ma</span>
<span id="cb2-140"><a href="#cb2-140"></a>    <span class="im">import</span> os</span>
<span id="cb2-141"><a href="#cb2-141"></a>    <span class="im">import</span> sys</span>
<span id="cb2-142"><a href="#cb2-142"></a></span>
<span id="cb2-143"><a href="#cb2-143"></a>    <span class="co"># Ensure 'roylib' is on the import path</span></span>
<span id="cb2-144"><a href="#cb2-144"></a>    sys.path.append(<span class="st">'/home/cwatch/pythonLibs'</span>)</span>
<span id="cb2-145"><a href="#cb2-145"></a>    <span class="im">from</span> roylib <span class="im">import</span> <span class="op">*</span></span>
<span id="cb2-146"><a href="#cb2-146"></a></span>
<span id="cb2-147"><a href="#cb2-147"></a>    dataDir <span class="op">=</span> sys.argv[<span class="dv">1</span>]</span>
<span id="cb2-148"><a href="#cb2-148"></a></span>
<span id="cb2-149"><a href="#cb2-149"></a>    <span class="co"># Temporary working directory</span></span>
<span id="cb2-150"><a href="#cb2-150"></a>    workDir <span class="op">=</span> sys.argv[<span class="dv">2</span>]</span>
<span id="cb2-151"><a href="#cb2-151"></a></span>
<span id="cb2-152"><a href="#cb2-152"></a>    <span class="co"># Composite end year (YYYY)</span></span>
<span id="cb2-153"><a href="#cb2-153"></a>    endyearC <span class="op">=</span> sys.argv[<span class="dv">3</span>]</span>
<span id="cb2-154"><a href="#cb2-154"></a></span>
<span id="cb2-155"><a href="#cb2-155"></a>    <span class="co"># Composite end day-of-year (DDD)</span></span>
<span id="cb2-156"><a href="#cb2-156"></a>    endDoyC <span class="op">=</span> sys.argv[<span class="dv">4</span>]</span>
<span id="cb2-157"><a href="#cb2-157"></a>    endDoyC <span class="op">=</span> endDoyC.rjust(<span class="dv">3</span>, <span class="st">'0'</span>)</span>
<span id="cb2-158"><a href="#cb2-158"></a>    endDoy <span class="op">=</span> <span class="bu">int</span>(endDoyC)</span>
<span id="cb2-159"><a href="#cb2-159"></a></span>
<span id="cb2-160"><a href="#cb2-160"></a>    <span class="co"># Composite length</span></span>
<span id="cb2-161"><a href="#cb2-161"></a>    intervalC <span class="op">=</span> sys.argv[<span class="dv">5</span>]</span>
<span id="cb2-162"><a href="#cb2-162"></a>    interval <span class="op">=</span> <span class="bu">int</span>(intervalC)</span>
<span id="cb2-163"><a href="#cb2-163"></a></span>
<span id="cb2-164"><a href="#cb2-164"></a>    <span class="co"># Convert end Doy to calendar date</span></span>
<span id="cb2-165"><a href="#cb2-165"></a>    myDateEnd <span class="op">=</span> datetime(<span class="bu">int</span>(endyearC), <span class="dv">1</span>, <span class="dv">1</span>) <span class="op">+</span> timedelta(<span class="bu">int</span>(endDoyC)<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb2-166"><a href="#cb2-166"></a></span>
<span id="cb2-167"><a href="#cb2-167"></a>    <span class="co"># Start date = end date minus (interval-1) days</span></span>
<span id="cb2-168"><a href="#cb2-168"></a>    myDateStart <span class="op">=</span> myDateEnd <span class="op">+</span> timedelta(days<span class="op">=-</span>(interval <span class="op">-</span> <span class="dv">1</span>))</span>
<span id="cb2-169"><a href="#cb2-169"></a></span>
<span id="cb2-170"><a href="#cb2-170"></a>    <span class="co"># Zero-padded start Doy and year</span></span>
<span id="cb2-171"><a href="#cb2-171"></a>    startDoyC <span class="op">=</span> myDateStart.strftime(<span class="st">"%j"</span>).zfill(<span class="dv">3</span>)</span>
<span id="cb2-172"><a href="#cb2-172"></a>    startDoy <span class="op">=</span> <span class="bu">int</span>(startDoyC)</span>
<span id="cb2-173"><a href="#cb2-173"></a>    startYearC <span class="op">=</span> <span class="bu">str</span>(myDateStart.year)</span>
<span id="cb2-174"><a href="#cb2-174"></a></span>
<span id="cb2-175"><a href="#cb2-175"></a>    <span class="co"># Prepare output directory</span></span>
<span id="cb2-176"><a href="#cb2-176"></a>    outDir <span class="op">=</span> <span class="st">'/ERDData1/modisa/data/modisgf/'</span> <span class="op">+</span> endyearC <span class="op">+</span> <span class="st">'/'</span><span class="op">+</span> intervalC <span class="op">+</span> <span class="st">'day'</span></span>
<span id="cb2-177"><a href="#cb2-177"></a></span>
<span id="cb2-178"><a href="#cb2-178"></a>    <span class="bu">print</span>(dataDir)</span>
<span id="cb2-179"><a href="#cb2-179"></a>    <span class="bu">print</span>(workDir)</span>
<span id="cb2-180"><a href="#cb2-180"></a>    <span class="bu">print</span>(endyearC)</span>
<span id="cb2-181"><a href="#cb2-181"></a>    <span class="bu">print</span>(endDoyC)</span>
<span id="cb2-182"><a href="#cb2-182"></a>    <span class="bu">print</span>(intervalC)</span>
<span id="cb2-183"><a href="#cb2-183"></a></span>
<span id="cb2-184"><a href="#cb2-184"></a>    <span class="co">###</span></span>
<span id="cb2-185"><a href="#cb2-185"></a>    <span class="co"># dtypeList = ['chla']</span></span>
<span id="cb2-186"><a href="#cb2-186"></a>    <span class="co"># for dtype in dtypeList:</span></span>
<span id="cb2-187"><a href="#cb2-187"></a></span>
<span id="cb2-188"><a href="#cb2-188"></a>    <span class="co"># Data type for composites</span></span>
<span id="cb2-189"><a href="#cb2-189"></a>    dtype <span class="op">=</span> <span class="st">'chla'</span></span>
<span id="cb2-190"><a href="#cb2-190"></a></span>
<span id="cb2-191"><a href="#cb2-191"></a>    <span class="co"># Clean working directory</span></span>
<span id="cb2-192"><a href="#cb2-192"></a>    os.chdir(workDir)</span>
<span id="cb2-193"><a href="#cb2-193"></a>    os.system(<span class="st">'rm -f *'</span>)</span>
<span id="cb2-194"><a href="#cb2-194"></a></span>
<span id="cb2-195"><a href="#cb2-195"></a>    <span class="co"># Change to data directory</span></span>
<span id="cb2-196"><a href="#cb2-196"></a>    os.chdir(dataDir)</span>
<span id="cb2-197"><a href="#cb2-197"></a></span>
<span id="cb2-198"><a href="#cb2-198"></a>    <span class="co"># Preallocate sum (mean) and count arrays matching grid dims</span></span>
<span id="cb2-199"><a href="#cb2-199"></a>    mean <span class="op">=</span> np.zeros((<span class="dv">4401</span>, <span class="dv">8001</span>), np.single)</span>
<span id="cb2-200"><a href="#cb2-200"></a>    num <span class="op">=</span> np.zeros((<span class="dv">4401</span>, <span class="dv">8001</span>), dtype<span class="op">=</span>np.int32)</span>
<span id="cb2-201"><a href="#cb2-201"></a></span>
<span id="cb2-202"><a href="#cb2-202"></a>    <span class="co"># Composite within the same calendar year</span></span>
<span id="cb2-203"><a href="#cb2-203"></a>    <span class="cf">if</span> (endDoy <span class="op">&gt;</span> startDoy):</span>
<span id="cb2-204"><a href="#cb2-204"></a>        <span class="co"># Build range of Doys</span></span>
<span id="cb2-205"><a href="#cb2-205"></a>        doyRange <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(startDoy, endDoy <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb2-206"><a href="#cb2-206"></a>        fileList <span class="op">=</span> []</span>
<span id="cb2-207"><a href="#cb2-207"></a>        <span class="co"># Gather filenames for each DOY</span></span>
<span id="cb2-208"><a href="#cb2-208"></a>        <span class="cf">for</span> doy <span class="kw">in</span> doyRange:</span>
<span id="cb2-209"><a href="#cb2-209"></a>            doyC <span class="op">=</span> <span class="bu">str</span>(doy)</span>
<span id="cb2-210"><a href="#cb2-210"></a>            doyC <span class="op">=</span> doyC.rjust(<span class="dv">3</span>, <span class="st">'0'</span>)</span>
<span id="cb2-211"><a href="#cb2-211"></a>            myString <span class="op">=</span> <span class="st">'MB'</span> <span class="op">+</span> endyearC <span class="op">+</span> doyC <span class="op">+</span> <span class="st">'*'</span> <span class="op">+</span> dtype <span class="op">+</span> <span class="st">'.nc'</span></span>
<span id="cb2-212"><a href="#cb2-212"></a>            fileList.append(glob.glob(myString))</span>
<span id="cb2-213"><a href="#cb2-213"></a></span>
<span id="cb2-214"><a href="#cb2-214"></a>        <span class="co"># Flatten and sort file list</span></span>
<span id="cb2-215"><a href="#cb2-215"></a>        fileList <span class="op">=</span> <span class="bu">list</span>(chain.from_iterable(fileList))</span>
<span id="cb2-216"><a href="#cb2-216"></a>        fileList.sort()</span>
<span id="cb2-217"><a href="#cb2-217"></a>        filesUsed <span class="op">=</span> <span class="st">""</span></span>
<span id="cb2-218"><a href="#cb2-218"></a>        <span class="bu">print</span>(fileList)</span>
<span id="cb2-219"><a href="#cb2-219"></a></span>
<span id="cb2-220"><a href="#cb2-220"></a>        <span class="co"># Loop through files and accumulate data</span></span>
<span id="cb2-221"><a href="#cb2-221"></a>        <span class="cf">for</span> fName <span class="kw">in</span> fileList:</span>
<span id="cb2-222"><a href="#cb2-222"></a>            <span class="cf">if</span> (<span class="bu">len</span>(filesUsed) <span class="op">==</span> <span class="dv">0</span>):</span>
<span id="cb2-223"><a href="#cb2-223"></a>                filesUsed <span class="op">=</span> fName</span>
<span id="cb2-224"><a href="#cb2-224"></a>            <span class="cf">else</span>:</span>
<span id="cb2-225"><a href="#cb2-225"></a>                filesUsed <span class="op">=</span> filesUsed <span class="op">+</span> <span class="st">', '</span> <span class="op">+</span> fName</span>
<span id="cb2-226"><a href="#cb2-226"></a></span>
<span id="cb2-227"><a href="#cb2-227"></a>            chlaFile <span class="op">=</span> Dataset(fName)</span>
<span id="cb2-228"><a href="#cb2-228"></a>            chla <span class="op">=</span> chlaFile.variables[<span class="st">"MBchla"</span>][:, :, :, :]</span>
<span id="cb2-229"><a href="#cb2-229"></a>            chlaFile.close()</span>
<span id="cb2-230"><a href="#cb2-230"></a>            chla <span class="op">=</span> np.squeeze(chla)</span>
<span id="cb2-231"><a href="#cb2-231"></a>            mean, num <span class="op">=</span> meanVar(mean, num, chla)</span>
<span id="cb2-232"><a href="#cb2-232"></a>    <span class="cf">else</span>:</span>
<span id="cb2-233"><a href="#cb2-233"></a>        <span class="co"># Composite spans year boundary</span></span>
<span id="cb2-234"><a href="#cb2-234"></a>        <span class="co"># Determine directory for the start year</span></span>
<span id="cb2-235"><a href="#cb2-235"></a>        dataDir1 <span class="op">=</span> dataDir</span>
<span id="cb2-236"><a href="#cb2-236"></a>        dataDir1 <span class="op">=</span> dataDir1.replace(endyearC, startYearC)</span>
<span id="cb2-237"><a href="#cb2-237"></a>        <span class="co"># Determine end of start year based on start year</span></span>
<span id="cb2-238"><a href="#cb2-238"></a>        <span class="cf">if</span> (isleap):</span>
<span id="cb2-239"><a href="#cb2-239"></a>            endday <span class="op">=</span> <span class="dv">366</span></span>
<span id="cb2-240"><a href="#cb2-240"></a>        <span class="cf">else</span>:</span>
<span id="cb2-241"><a href="#cb2-241"></a>            endday <span class="op">=</span> <span class="dv">365</span></span>
<span id="cb2-242"><a href="#cb2-242"></a></span>
<span id="cb2-243"><a href="#cb2-243"></a>        fileList <span class="op">=</span> []</span>
<span id="cb2-244"><a href="#cb2-244"></a>        os.chdir(dataDir1)</span>
<span id="cb2-245"><a href="#cb2-245"></a>        doyRange <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(startDoy, endday <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb2-246"><a href="#cb2-246"></a>        <span class="cf">for</span> doy <span class="kw">in</span> doyRange:</span>
<span id="cb2-247"><a href="#cb2-247"></a>            doyC <span class="op">=</span> <span class="bu">str</span>(doy)</span>
<span id="cb2-248"><a href="#cb2-248"></a>            doyC <span class="op">=</span> doyC.rjust(<span class="dv">3</span>, <span class="st">'0'</span>)</span>
<span id="cb2-249"><a href="#cb2-249"></a>            myString <span class="op">=</span> <span class="st">'MB'</span> <span class="op">+</span> startYearC <span class="op">+</span> doyC <span class="op">+</span> <span class="st">'*'</span> <span class="op">+</span> dtype <span class="op">+</span> <span class="st">'.nc'</span></span>
<span id="cb2-250"><a href="#cb2-250"></a>            fileList.append(glob.glob(myString))</span>
<span id="cb2-251"><a href="#cb2-251"></a></span>
<span id="cb2-252"><a href="#cb2-252"></a>        fileList <span class="op">=</span> <span class="bu">list</span>(chain.from_iterable(fileList))</span>
<span id="cb2-253"><a href="#cb2-253"></a>        fileList.sort()</span>
<span id="cb2-254"><a href="#cb2-254"></a>        filesUsed <span class="op">=</span> <span class="st">""</span></span>
<span id="cb2-255"><a href="#cb2-255"></a>        <span class="bu">print</span>(fileList)</span>
<span id="cb2-256"><a href="#cb2-256"></a>        <span class="cf">for</span> fName <span class="kw">in</span> fileList:</span>
<span id="cb2-257"><a href="#cb2-257"></a>            <span class="cf">if</span> (<span class="bu">len</span>(filesUsed) <span class="op">==</span> <span class="dv">0</span>):</span>
<span id="cb2-258"><a href="#cb2-258"></a>                filesUsed <span class="op">=</span> fName</span>
<span id="cb2-259"><a href="#cb2-259"></a>            <span class="cf">else</span>:</span>
<span id="cb2-260"><a href="#cb2-260"></a>                filesUsed <span class="op">=</span> filesUsed <span class="op">+</span> <span class="st">', '</span> <span class="op">+</span> fName</span>
<span id="cb2-261"><a href="#cb2-261"></a></span>
<span id="cb2-262"><a href="#cb2-262"></a>            chlaFile <span class="op">=</span> Dataset(fName)</span>
<span id="cb2-263"><a href="#cb2-263"></a>            chla <span class="op">=</span> chlaFile.variables[<span class="st">"MBchla"</span>][:, :, :, :]</span>
<span id="cb2-264"><a href="#cb2-264"></a>            chlaFile.close()</span>
<span id="cb2-265"><a href="#cb2-265"></a>            chla <span class="op">=</span> np.squeeze(chla)</span>
<span id="cb2-266"><a href="#cb2-266"></a>            mean, num <span class="op">=</span> meanVar(mean, num, chla)</span>
<span id="cb2-267"><a href="#cb2-267"></a></span>
<span id="cb2-268"><a href="#cb2-268"></a>        <span class="co"># DOY from 1 to endDoy of end year</span></span>
<span id="cb2-269"><a href="#cb2-269"></a>        os.chdir(dataDir)</span>
<span id="cb2-270"><a href="#cb2-270"></a>        fileList <span class="op">=</span> []</span>
<span id="cb2-271"><a href="#cb2-271"></a>        doyRange <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="dv">1</span>, endDoy <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb2-272"><a href="#cb2-272"></a>        <span class="cf">for</span> doy <span class="kw">in</span> doyRange:</span>
<span id="cb2-273"><a href="#cb2-273"></a>            doyC <span class="op">=</span> <span class="bu">str</span>(doy)</span>
<span id="cb2-274"><a href="#cb2-274"></a>            doyC <span class="op">=</span> doyC.rjust(<span class="dv">3</span>, <span class="st">'0'</span>)</span>
<span id="cb2-275"><a href="#cb2-275"></a>            myString <span class="op">=</span> <span class="st">'MB'</span> <span class="op">+</span> endyearC <span class="op">+</span> doyC <span class="op">+</span> <span class="st">'*'</span> <span class="op">+</span> dtype <span class="op">+</span> <span class="st">'.nc'</span></span>
<span id="cb2-276"><a href="#cb2-276"></a>            fileList.append(glob.glob(myString))</span>
<span id="cb2-277"><a href="#cb2-277"></a></span>
<span id="cb2-278"><a href="#cb2-278"></a>        fileList <span class="op">=</span> <span class="bu">list</span>(chain.from_iterable(fileList))</span>
<span id="cb2-279"><a href="#cb2-279"></a>        fileList.sort()</span>
<span id="cb2-280"><a href="#cb2-280"></a>        <span class="bu">print</span>(fileList)</span>
<span id="cb2-281"><a href="#cb2-281"></a>        <span class="cf">for</span> fName <span class="kw">in</span> fileList:</span>
<span id="cb2-282"><a href="#cb2-282"></a>            <span class="cf">if</span> (<span class="bu">len</span>(filesUsed) <span class="op">==</span> <span class="dv">0</span>):</span>
<span id="cb2-283"><a href="#cb2-283"></a>                filesUsed <span class="op">=</span> fName</span>
<span id="cb2-284"><a href="#cb2-284"></a>            <span class="cf">else</span>:</span>
<span id="cb2-285"><a href="#cb2-285"></a>                filesUsed <span class="op">=</span> filesUsed <span class="op">+</span> <span class="st">', '</span> <span class="op">+</span> fName</span>
<span id="cb2-286"><a href="#cb2-286"></a></span>
<span id="cb2-287"><a href="#cb2-287"></a>            <span class="co"># Read the NetCDF, variable 'MBchla' and squeeze to make 2D array (lat x lon)</span></span>
<span id="cb2-288"><a href="#cb2-288"></a>            chlaFile <span class="op">=</span> Dataset(fName)</span>
<span id="cb2-289"><a href="#cb2-289"></a>            chla <span class="op">=</span> chlaFile.variables[<span class="st">"MBchla"</span>][:, :, :, :]</span>
<span id="cb2-290"><a href="#cb2-290"></a>            chlaFile.close()</span>
<span id="cb2-291"><a href="#cb2-291"></a>            chla <span class="op">=</span> np.squeeze(chla)</span>
<span id="cb2-292"><a href="#cb2-292"></a></span>
<span id="cb2-293"><a href="#cb2-293"></a>            <span class="co"># Update running sum and count arrays</span></span>
<span id="cb2-294"><a href="#cb2-294"></a>            mean, num <span class="op">=</span> meanVar(mean, num, chla)</span>
<span id="cb2-295"><a href="#cb2-295"></a></span>
<span id="cb2-296"><a href="#cb2-296"></a>    <span class="co"># Mask out any grid cells with zero observations, setting them to the fill value</span></span>
<span id="cb2-297"><a href="#cb2-297"></a>    mean <span class="op">=</span> ma.array(mean, mask<span class="op">=</span>(num<span class="op">==</span><span class="dv">0</span>), fill_value<span class="op">=-</span><span class="fl">9999999.</span>)</span>
<span id="cb2-298"><a href="#cb2-298"></a></span>
<span id="cb2-299"><a href="#cb2-299"></a>    <span class="co"># Switch to the working directory for output operations</span></span>
<span id="cb2-300"><a href="#cb2-300"></a>    os.chdir(workDir)</span>
<span id="cb2-301"><a href="#cb2-301"></a></span>
<span id="cb2-302"><a href="#cb2-302"></a>    <span class="co"># Construct the output filename with start and end dates plus data types</span></span>
<span id="cb2-303"><a href="#cb2-303"></a>    outFile <span class="op">=</span> <span class="st">'MB'</span> <span class="op">+</span> startYearC <span class="op">+</span> startDoyC <span class="op">+</span> <span class="st">'_'</span> <span class="op">+</span> endyearC <span class="op">+</span> endDoyC <span class="op">+</span> <span class="st">'_'</span> <span class="op">+</span> dtype <span class="op">+</span> <span class="st">'.nc'</span></span>
<span id="cb2-304"><a href="#cb2-304"></a></span>
<span id="cb2-305"><a href="#cb2-305"></a>    <span class="co"># Create multi-day NetCDF file using the mean and count arrays</span></span>
<span id="cb2-306"><a href="#cb2-306"></a>    ncFile <span class="op">=</span> makeNetcdf(mean, num, interval, outFile, filesUsed, workDir)</span>
<span id="cb2-307"><a href="#cb2-307"></a></span>
<span id="cb2-308"><a href="#cb2-308"></a>    <span class="co"># Upload composite NetCDF to remote MB chla directory, labeling it with the interval</span></span>
<span id="cb2-309"><a href="#cb2-309"></a>    send_to_servers(ncFile, <span class="st">'/MB/chla/'</span>, <span class="bu">str</span>(interval))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="compmbchlamday" class="level3">
<h3 class="anchored" data-anchor-id="compmbchlamday">CompMBChlamday</h3>
<p><code>CompMBChlamday.py</code> ingests 1-day composite Chla NetCDF files over user-defined date range and maps them onto a 0.025° × 0.025° regular grid spanning longitude 120°–320° and latitude –45°–65°, accumulating sums and counts to compute the monthly mean. It then masks out points with no observations, writes the result as a CF-compliant NetCDF, and uploads it to a directory on a remote server. Find the monthly product on ERDDAP <a href="./modisa_scripts.html#modisa-products-on-swfsc-erddap-server">here</a>.</p>
<p>The following chart summarizes the script’s workflow:</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">%%{init: { "flowchart": { "htmlLabels": true } }}%%
flowchart LR
  I("&lt;b&gt;Inputs&lt;/b&gt;&lt;br/&gt;• 1-day Chla NetCDFs (dataDir)&lt;br/&gt;• workDir&lt;br/&gt;• endYear &amp; endDoy&lt;br/&gt;• startDoy")
    --&gt; P("&lt;b&gt;Processing&lt;/b&gt;&lt;br/&gt;• Parse args &amp; compute interval&lt;br/&gt;• Compute start/end dates&lt;br/&gt;• Clear workDir&lt;br/&gt;• Initialize mean &amp; count arrays&lt;br/&gt;• Gather files over date range&lt;br/&gt;• Loop: read each file &amp; update mean/num&lt;br/&gt;• Mask pixels with no observations")
    --&gt; O("&lt;b&gt;Output&lt;/b&gt;&lt;br/&gt;• Monthly composite Chla NetCDF&lt;br/&gt;• Deployed to /MB/chla/")
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<div id="bfcca6cb" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>View CompMBChlamday.py</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1"></a><span class="co">"""</span></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="co">Overview</span></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="co">--------</span></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="co">Compute monthly composites of chlorophyll-a (Chla) for the MODIS “MB” (Pacific Ocean)</span></span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="co">dataset by averaging daily 1-day NetCDF files over a specified interval of days.</span></span>
<span id="cb3-6"><a href="#cb3-6"></a></span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="co">Usage</span></span>
<span id="cb3-8"><a href="#cb3-8"></a><span class="co">-----</span></span>
<span id="cb3-9"><a href="#cb3-9"></a><span class="co">::</span></span>
<span id="cb3-10"><a href="#cb3-10"></a><span class="co">  </span></span>
<span id="cb3-11"><a href="#cb3-11"></a><span class="co">    python CompMBChlamday.py &lt;dataDir&gt; &lt;workDir&gt; &lt;endYear&gt; &lt;endDoy&gt; &lt;startDoy&gt;</span></span>
<span id="cb3-12"><a href="#cb3-12"></a></span>
<span id="cb3-13"><a href="#cb3-13"></a><span class="co">Where:</span></span>
<span id="cb3-14"><a href="#cb3-14"></a></span>
<span id="cb3-15"><a href="#cb3-15"></a><span class="co">- ``dataDir``</span></span>
<span id="cb3-16"><a href="#cb3-16"></a></span>
<span id="cb3-17"><a href="#cb3-17"></a><span class="co">  Directory containing daily 1-day NetCDF files named ``MB&lt;YYYY&gt;&lt;DDD&gt;*chla.nc``.</span></span>
<span id="cb3-18"><a href="#cb3-18"></a></span>
<span id="cb3-19"><a href="#cb3-19"></a><span class="co">- ``workDir``</span></span>
<span id="cb3-20"><a href="#cb3-20"></a></span>
<span id="cb3-21"><a href="#cb3-21"></a><span class="co">  Temporary working directory for intermediate files</span></span>
<span id="cb3-22"><a href="#cb3-22"></a></span>
<span id="cb3-23"><a href="#cb3-23"></a><span class="co">- ``endYear`` </span></span>
<span id="cb3-24"><a href="#cb3-24"></a></span>
<span id="cb3-25"><a href="#cb3-25"></a><span class="co">  Four-digit year of the last day in the composite (e.g., ``2025``).</span></span>
<span id="cb3-26"><a href="#cb3-26"></a></span>
<span id="cb3-27"><a href="#cb3-27"></a><span class="co">- ``endDoy``</span></span>
<span id="cb3-28"><a href="#cb3-28"></a></span>
<span id="cb3-29"><a href="#cb3-29"></a><span class="co">  Three-digit day-of-year of the last composite day (e.g., ``031``).</span></span>
<span id="cb3-30"><a href="#cb3-30"></a></span>
<span id="cb3-31"><a href="#cb3-31"></a><span class="co">- ``startDoy``</span></span>
<span id="cb3-32"><a href="#cb3-32"></a></span>
<span id="cb3-33"><a href="#cb3-33"></a><span class="co">  Three-digit day-of-year of the first composite day (e.g., ``001``).</span></span>
<span id="cb3-34"><a href="#cb3-34"></a></span>
<span id="cb3-35"><a href="#cb3-35"></a><span class="co">Description</span></span>
<span id="cb3-36"><a href="#cb3-36"></a><span class="co">-----------</span></span>
<span id="cb3-37"><a href="#cb3-37"></a><span class="co">1. **Parse arguments &amp; compute interval**</span></span>
<span id="cb3-38"><a href="#cb3-38"></a></span>
<span id="cb3-39"><a href="#cb3-39"></a><span class="co">  - Read ``dataDir``, ``workDir``, ``endYear``, ``endDoy``, and ``startDoy``.</span></span>
<span id="cb3-40"><a href="#cb3-40"></a></span>
<span id="cb3-41"><a href="#cb3-41"></a><span class="co">  - Compute ``interval = endDoy - startDoy + 1``.</span></span>
<span id="cb3-42"><a href="#cb3-42"></a></span>
<span id="cb3-43"><a href="#cb3-43"></a><span class="co">2. **Compute calendar dates**</span></span>
<span id="cb3-44"><a href="#cb3-44"></a></span>
<span id="cb3-45"><a href="#cb3-45"></a><span class="co">  - Convert ``endYear`` + ``endDoy`` to a ``datetime`` (``myDateEnd``).</span></span>
<span id="cb3-46"><a href="#cb3-46"></a></span>
<span id="cb3-47"><a href="#cb3-47"></a><span class="co">  - Derive ``myDateStart = myDateEnd - (interval - 1) days``.</span></span>
<span id="cb3-48"><a href="#cb3-48"></a></span>
<span id="cb3-49"><a href="#cb3-49"></a><span class="co">3. **Initialize accumulators**</span></span>
<span id="cb3-50"><a href="#cb3-50"></a></span>
<span id="cb3-51"><a href="#cb3-51"></a><span class="co">  - Clear ``workDir``.</span></span>
<span id="cb3-52"><a href="#cb3-52"></a></span>
<span id="cb3-53"><a href="#cb3-53"></a><span class="co">  - Preallocate two arrays of shape (4401x8001):</span></span>
<span id="cb3-54"><a href="#cb3-54"></a></span>
<span id="cb3-55"><a href="#cb3-55"></a><span class="co">     - ``mean`` (float32) for the running sum of Chla.</span></span>
<span id="cb3-56"><a href="#cb3-56"></a></span>
<span id="cb3-57"><a href="#cb3-57"></a><span class="co">     - ``num``  (int32) for the count of observations.</span></span>
<span id="cb3-58"><a href="#cb3-58"></a></span>
<span id="cb3-59"><a href="#cb3-59"></a><span class="co">4. **Gather daily files**</span></span>
<span id="cb3-60"><a href="#cb3-60"></a></span>
<span id="cb3-61"><a href="#cb3-61"></a><span class="co">  - Build a list of all ``MB&lt;YYYY&gt;&lt;DDD&gt;*chla.nc`` files from ``startDoy`` to ``endDoy``.</span></span>
<span id="cb3-62"><a href="#cb3-62"></a></span>
<span id="cb3-63"><a href="#cb3-63"></a><span class="co">  - Handle year-boundary spans by splitting into two date ranges if necessary.</span></span>
<span id="cb3-64"><a href="#cb3-64"></a></span>
<span id="cb3-65"><a href="#cb3-65"></a><span class="co">5. **Accumulate daily Chla**</span></span>
<span id="cb3-66"><a href="#cb3-66"></a></span>
<span id="cb3-67"><a href="#cb3-67"></a><span class="co">  - For each file:</span></span>
<span id="cb3-68"><a href="#cb3-68"></a></span>
<span id="cb3-69"><a href="#cb3-69"></a><span class="co">     - Open via ``Dataset()``.</span></span>
<span id="cb3-70"><a href="#cb3-70"></a></span>
<span id="cb3-71"><a href="#cb3-71"></a><span class="co">     - Read the 4-D variable ``MBchla``, squeeze to 2-D.</span></span>
<span id="cb3-72"><a href="#cb3-72"></a></span>
<span id="cb3-73"><a href="#cb3-73"></a><span class="co">     - Update ``mean`` and ``num`` via ``meanVar(mean, num, data2d)``.</span></span>
<span id="cb3-74"><a href="#cb3-74"></a></span>
<span id="cb3-75"><a href="#cb3-75"></a><span class="co">6. **Mask &amp; finalize**</span></span>
<span id="cb3-76"><a href="#cb3-76"></a></span>
<span id="cb3-77"><a href="#cb3-77"></a><span class="co">  - Create a masked array: mask pixels where ``num == 0`` (no observations) and set fill value ``-9999999.``.</span></span>
<span id="cb3-78"><a href="#cb3-78"></a></span>
<span id="cb3-79"><a href="#cb3-79"></a><span class="co">7. **Write &amp; deploy**</span></span>
<span id="cb3-80"><a href="#cb3-80"></a></span>
<span id="cb3-81"><a href="#cb3-81"></a><span class="co">  - Change to ``workDir``.</span></span>
<span id="cb3-82"><a href="#cb3-82"></a></span>
<span id="cb3-83"><a href="#cb3-83"></a><span class="co">  - Construct output filename ``MB&lt;startYear&gt;&lt;startDoy&gt;_&lt;endYear&gt;&lt;endDoy&gt;_chla.nc``.</span></span>
<span id="cb3-84"><a href="#cb3-84"></a></span>
<span id="cb3-85"><a href="#cb3-85"></a><span class="co">  - Call ``makeNetcdfmDay(mean, num, interval, outFile, filesUsed, workDir)`` to produce a CF-compliant NetCDF.</span></span>
<span id="cb3-86"><a href="#cb3-86"></a></span>
<span id="cb3-87"><a href="#cb3-87"></a><span class="co">  - Transfer it to ``/MB/chla/`` on the remote server via ``send_to_servers()``.</span></span>
<span id="cb3-88"><a href="#cb3-88"></a></span>
<span id="cb3-89"><a href="#cb3-89"></a><span class="co">Dependencies</span></span>
<span id="cb3-90"><a href="#cb3-90"></a><span class="co">------------</span></span>
<span id="cb3-91"><a href="#cb3-91"></a><span class="co">- Python 3.x</span></span>
<span id="cb3-92"><a href="#cb3-92"></a></span>
<span id="cb3-93"><a href="#cb3-93"></a><span class="co">- Standard library: ``os``, ``sys``, ``glob``, ``itertools.chain``, ``datetime``, ``timedelta``</span></span>
<span id="cb3-94"><a href="#cb3-94"></a></span>
<span id="cb3-95"><a href="#cb3-95"></a><span class="co">- Third-party: ``numpy``, ``numpy.ma``, ``netCDF4.Dataset``</span></span>
<span id="cb3-96"><a href="#cb3-96"></a></span>
<span id="cb3-97"><a href="#cb3-97"></a><span class="co">- Custom roylib functions:</span></span>
<span id="cb3-98"><a href="#cb3-98"></a></span>
<span id="cb3-99"><a href="#cb3-99"></a><span class="co">  - ``isleap(year)``</span></span>
<span id="cb3-100"><a href="#cb3-100"></a></span>
<span id="cb3-101"><a href="#cb3-101"></a><span class="co">  - ``meanVar(mean, num, data)``</span></span>
<span id="cb3-102"><a href="#cb3-102"></a></span>
<span id="cb3-103"><a href="#cb3-103"></a><span class="co">  - ``makeNetcdfmDay(mean, num, interval, outFile, filesUsed, workDir)``</span></span>
<span id="cb3-104"><a href="#cb3-104"></a></span>
<span id="cb3-105"><a href="#cb3-105"></a><span class="co">  - ``send_to_servers(ncFile, remote_dir, interval_flag)``</span></span>
<span id="cb3-106"><a href="#cb3-106"></a></span>
<span id="cb3-107"><a href="#cb3-107"></a></span>
<span id="cb3-108"><a href="#cb3-108"></a><span class="co">Directory Structure</span></span>
<span id="cb3-109"><a href="#cb3-109"></a><span class="co">-------------------</span></span>
<span id="cb3-110"><a href="#cb3-110"></a><span class="co">- **Input Directory** (dataDir):</span></span>
<span id="cb3-111"><a href="#cb3-111"></a></span>
<span id="cb3-112"><a href="#cb3-112"></a><span class="co">  Contains daily files ``MB&lt;YYYY&gt;&lt;DDD&gt;*chla.nc``.</span></span>
<span id="cb3-113"><a href="#cb3-113"></a></span>
<span id="cb3-114"><a href="#cb3-114"></a><span class="co">- **Working Directory** (workDir):</span></span>
<span id="cb3-115"><a href="#cb3-115"></a></span>
<span id="cb3-116"><a href="#cb3-116"></a><span class="co">  Temporary space cleared and reused each run.</span></span>
<span id="cb3-117"><a href="#cb3-117"></a></span>
<span id="cb3-118"><a href="#cb3-118"></a><span class="co">- **Output Location**:</span></span>
<span id="cb3-119"><a href="#cb3-119"></a></span>
<span id="cb3-120"><a href="#cb3-120"></a><span class="co">  Final monthly composite sent to ``/MB/chla/``.</span></span>
<span id="cb3-121"><a href="#cb3-121"></a></span>
<span id="cb3-122"><a href="#cb3-122"></a><span class="co">Usage Example</span></span>
<span id="cb3-123"><a href="#cb3-123"></a><span class="co">-------------</span></span>
<span id="cb3-124"><a href="#cb3-124"></a><span class="co">Generate a January 2025 composite (DOY 001-031):</span></span>
<span id="cb3-125"><a href="#cb3-125"></a></span>
<span id="cb3-126"><a href="#cb3-126"></a><span class="co">::</span></span>
<span id="cb3-127"><a href="#cb3-127"></a><span class="co"> </span></span>
<span id="cb3-128"><a href="#cb3-128"></a><span class="co">   python CompMBChlamday.py /data/modisgf/1day/ /tmp/mw_work/ 2025 031 001</span></span>
<span id="cb3-129"><a href="#cb3-129"></a></span>
<span id="cb3-130"><a href="#cb3-130"></a><span class="co">This will average daily Chla for DOY 001…031 of 2025, write ``MB2025001_2025031_chla.nc`` in ``/tmp/mw_work/``, and upload to ``/MB/chla/``.</span></span>
<span id="cb3-131"><a href="#cb3-131"></a><span class="co">"""</span></span>
<span id="cb3-132"><a href="#cb3-132"></a><span class="im">from</span> __future__ <span class="im">import</span> print_function</span>
<span id="cb3-133"><a href="#cb3-133"></a><span class="im">from</span> builtins <span class="im">import</span> <span class="bu">str</span></span>
<span id="cb3-134"><a href="#cb3-134"></a><span class="im">from</span> builtins <span class="im">import</span> <span class="bu">range</span></span>
<span id="cb3-135"><a href="#cb3-135"></a></span>
<span id="cb3-136"><a href="#cb3-136"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb3-137"><a href="#cb3-137"></a>    <span class="im">from</span> datetime <span class="im">import</span> datetime, timedelta</span>
<span id="cb3-138"><a href="#cb3-138"></a>    <span class="im">import</span> glob</span>
<span id="cb3-139"><a href="#cb3-139"></a>    <span class="im">from</span> itertools <span class="im">import</span> chain</span>
<span id="cb3-140"><a href="#cb3-140"></a>    <span class="im">from</span> netCDF4 <span class="im">import</span> Dataset</span>
<span id="cb3-141"><a href="#cb3-141"></a>    <span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb3-142"><a href="#cb3-142"></a>    <span class="im">import</span> numpy.ma <span class="im">as</span> ma</span>
<span id="cb3-143"><a href="#cb3-143"></a>    <span class="im">import</span> os</span>
<span id="cb3-144"><a href="#cb3-144"></a>    <span class="im">import</span> sys</span>
<span id="cb3-145"><a href="#cb3-145"></a></span>
<span id="cb3-146"><a href="#cb3-146"></a>    <span class="co"># Ensure 'roylib' is on the import path</span></span>
<span id="cb3-147"><a href="#cb3-147"></a>    sys.path.append(<span class="st">'/home/cwatch/pythonLibs'</span>)</span>
<span id="cb3-148"><a href="#cb3-148"></a>    <span class="im">from</span> roylib <span class="im">import</span> <span class="op">*</span></span>
<span id="cb3-149"><a href="#cb3-149"></a></span>
<span id="cb3-150"><a href="#cb3-150"></a>    <span class="co"># Directory with 1-day MB chl files</span></span>
<span id="cb3-151"><a href="#cb3-151"></a>    dataDir <span class="op">=</span> sys.argv[<span class="dv">1</span>]</span>
<span id="cb3-152"><a href="#cb3-152"></a></span>
<span id="cb3-153"><a href="#cb3-153"></a>    <span class="co"># Temporary working directory</span></span>
<span id="cb3-154"><a href="#cb3-154"></a>    workDir <span class="op">=</span> sys.argv[<span class="dv">2</span>]</span>
<span id="cb3-155"><a href="#cb3-155"></a></span>
<span id="cb3-156"><a href="#cb3-156"></a>    <span class="co"># Composite end year</span></span>
<span id="cb3-157"><a href="#cb3-157"></a>    endyearC <span class="op">=</span> sys.argv[<span class="dv">3</span>]</span>
<span id="cb3-158"><a href="#cb3-158"></a></span>
<span id="cb3-159"><a href="#cb3-159"></a>    <span class="co"># Same year for start</span></span>
<span id="cb3-160"><a href="#cb3-160"></a>    startYearC <span class="op">=</span> endyearC</span>
<span id="cb3-161"><a href="#cb3-161"></a></span>
<span id="cb3-162"><a href="#cb3-162"></a>    <span class="co"># Zero-padded end DOY</span></span>
<span id="cb3-163"><a href="#cb3-163"></a>    endDoyC <span class="op">=</span> sys.argv[<span class="dv">4</span>]</span>
<span id="cb3-164"><a href="#cb3-164"></a>    endDoyC <span class="op">=</span> endDoyC.rjust(<span class="dv">3</span>, <span class="st">'0'</span>)</span>
<span id="cb3-165"><a href="#cb3-165"></a>    endDoy <span class="op">=</span> <span class="bu">int</span>(endDoyC)</span>
<span id="cb3-166"><a href="#cb3-166"></a></span>
<span id="cb3-167"><a href="#cb3-167"></a>    <span class="co"># Zero-padded start DOY</span></span>
<span id="cb3-168"><a href="#cb3-168"></a>    startDoyC <span class="op">=</span> sys.argv[<span class="dv">5</span>]</span>
<span id="cb3-169"><a href="#cb3-169"></a>    startDoyC <span class="op">=</span> startDoyC.rjust(<span class="dv">3</span>, <span class="st">'0'</span>)</span>
<span id="cb3-170"><a href="#cb3-170"></a>    startDoy <span class="op">=</span> <span class="bu">int</span>(startDoyC )</span>
<span id="cb3-171"><a href="#cb3-171"></a></span>
<span id="cb3-172"><a href="#cb3-172"></a>    <span class="co"># Number of days in the composite</span></span>
<span id="cb3-173"><a href="#cb3-173"></a>    interval <span class="op">=</span> endDoy <span class="op">-</span> startDoy <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb3-174"><a href="#cb3-174"></a></span>
<span id="cb3-175"><a href="#cb3-175"></a>    <span class="co"># Convert end date to calendar dates</span></span>
<span id="cb3-176"><a href="#cb3-176"></a>    myDateEnd <span class="op">=</span> datetime(<span class="bu">int</span>(endyearC), <span class="dv">1</span>, <span class="dv">1</span>) <span class="op">+</span> timedelta(endDoy <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb3-177"><a href="#cb3-177"></a>    myDateStart <span class="op">=</span> myDateEnd <span class="op">+</span> timedelta(days<span class="op">=-</span>(interval <span class="op">-</span> <span class="dv">1</span>))</span>
<span id="cb3-178"><a href="#cb3-178"></a></span>
<span id="cb3-179"><a href="#cb3-179"></a>    <span class="co"># Prepare output directory</span></span>
<span id="cb3-180"><a href="#cb3-180"></a>    outDir <span class="op">=</span> <span class="st">'/ERDData1/modisa/data/modisgf/'</span> <span class="op">+</span> endyearC <span class="op">+</span> <span class="st">'/mday'</span></span>
<span id="cb3-181"><a href="#cb3-181"></a></span>
<span id="cb3-182"><a href="#cb3-182"></a>    <span class="bu">print</span>(dataDir)</span>
<span id="cb3-183"><a href="#cb3-183"></a>    <span class="bu">print</span>(workDir)</span>
<span id="cb3-184"><a href="#cb3-184"></a>    <span class="bu">print</span>(endyearC)</span>
<span id="cb3-185"><a href="#cb3-185"></a>    <span class="bu">print</span>(endDoyC)</span>
<span id="cb3-186"><a href="#cb3-186"></a>    <span class="bu">print</span>(interval)</span>
<span id="cb3-187"><a href="#cb3-187"></a></span>
<span id="cb3-188"><a href="#cb3-188"></a>    <span class="co">###</span></span>
<span id="cb3-189"><a href="#cb3-189"></a>    <span class="co"># dtypeList = ['chla']</span></span>
<span id="cb3-190"><a href="#cb3-190"></a>    <span class="co"># for dtype in dtypeList:</span></span>
<span id="cb3-191"><a href="#cb3-191"></a></span>
<span id="cb3-192"><a href="#cb3-192"></a>    <span class="co"># Data type for this composite run</span></span>
<span id="cb3-193"><a href="#cb3-193"></a>    dtype <span class="op">=</span> <span class="st">'chla'</span></span>
<span id="cb3-194"><a href="#cb3-194"></a></span>
<span id="cb3-195"><a href="#cb3-195"></a>    <span class="co"># Clear the working directory</span></span>
<span id="cb3-196"><a href="#cb3-196"></a>    os.chdir(workDir)</span>
<span id="cb3-197"><a href="#cb3-197"></a>    os.system(<span class="st">'rm -f *'</span>)</span>
<span id="cb3-198"><a href="#cb3-198"></a></span>
<span id="cb3-199"><a href="#cb3-199"></a>    <span class="co"># Move to data directory</span></span>
<span id="cb3-200"><a href="#cb3-200"></a>    os.chdir(dataDir)</span>
<span id="cb3-201"><a href="#cb3-201"></a></span>
<span id="cb3-202"><a href="#cb3-202"></a>    <span class="co"># Preallocate sum (mean) and count arrays matching grid dims</span></span>
<span id="cb3-203"><a href="#cb3-203"></a>    mean <span class="op">=</span> np.zeros((<span class="dv">4401</span>, <span class="dv">8001</span>), np.single)</span>
<span id="cb3-204"><a href="#cb3-204"></a>    num <span class="op">=</span> np.zeros((<span class="dv">4401</span>, <span class="dv">8001</span>), dtype<span class="op">=</span>np.int32)</span>
<span id="cb3-205"><a href="#cb3-205"></a></span>
<span id="cb3-206"><a href="#cb3-206"></a>    <span class="co"># Composite entirely within the same year</span></span>
<span id="cb3-207"><a href="#cb3-207"></a>    <span class="cf">if</span> (endDoy <span class="op">&gt;</span> startDoy):</span>
<span id="cb3-208"><a href="#cb3-208"></a>        doyRange <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(startDoy, endDoy <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb3-209"><a href="#cb3-209"></a>        fileList <span class="op">=</span> []</span>
<span id="cb3-210"><a href="#cb3-210"></a>        <span class="co"># Collect all matching files for each DOY</span></span>
<span id="cb3-211"><a href="#cb3-211"></a>        <span class="cf">for</span> doy <span class="kw">in</span> doyRange:</span>
<span id="cb3-212"><a href="#cb3-212"></a>            doyC <span class="op">=</span> <span class="bu">str</span>(doy)</span>
<span id="cb3-213"><a href="#cb3-213"></a>            doyC <span class="op">=</span> doyC.rjust(<span class="dv">3</span>, <span class="st">'0'</span>)</span>
<span id="cb3-214"><a href="#cb3-214"></a>            myString <span class="op">=</span> <span class="st">'MB'</span> <span class="op">+</span> endyearC <span class="op">+</span> doyC <span class="op">+</span> <span class="st">'*'</span> <span class="op">+</span> dtype <span class="op">+</span> <span class="st">'.nc'</span></span>
<span id="cb3-215"><a href="#cb3-215"></a>            fileList.append(glob.glob(myString))</span>
<span id="cb3-216"><a href="#cb3-216"></a></span>
<span id="cb3-217"><a href="#cb3-217"></a>        <span class="co"># Flatten and sort the list of lists</span></span>
<span id="cb3-218"><a href="#cb3-218"></a>        fileList <span class="op">=</span> <span class="bu">list</span>(chain.from_iterable(fileList))</span>
<span id="cb3-219"><a href="#cb3-219"></a>        fileList.sort()</span>
<span id="cb3-220"><a href="#cb3-220"></a>        filesUsed <span class="op">=</span> <span class="st">""</span></span>
<span id="cb3-221"><a href="#cb3-221"></a>        <span class="bu">print</span>(fileList)</span>
<span id="cb3-222"><a href="#cb3-222"></a></span>
<span id="cb3-223"><a href="#cb3-223"></a>        <span class="co"># Loop through each file</span></span>
<span id="cb3-224"><a href="#cb3-224"></a>        <span class="cf">for</span> fName <span class="kw">in</span> fileList:</span>
<span id="cb3-225"><a href="#cb3-225"></a>            <span class="cf">if</span> (<span class="bu">len</span>(filesUsed) <span class="op">==</span> <span class="dv">0</span>):</span>
<span id="cb3-226"><a href="#cb3-226"></a>                filesUsed <span class="op">=</span> fName</span>
<span id="cb3-227"><a href="#cb3-227"></a>            <span class="cf">else</span>:</span>
<span id="cb3-228"><a href="#cb3-228"></a>                filesUsed <span class="op">=</span> filesUsed <span class="op">+</span> <span class="st">', '</span> <span class="op">+</span> fName</span>
<span id="cb3-229"><a href="#cb3-229"></a></span>
<span id="cb3-230"><a href="#cb3-230"></a>            chlaFile <span class="op">=</span> Dataset(fName)</span>
<span id="cb3-231"><a href="#cb3-231"></a>            chla <span class="op">=</span> chlaFile.variables[<span class="st">"MBchla"</span>][:, :, :, :]</span>
<span id="cb3-232"><a href="#cb3-232"></a>            chlaFile.close()</span>
<span id="cb3-233"><a href="#cb3-233"></a>            chla <span class="op">=</span> np.squeeze(chla)</span>
<span id="cb3-234"><a href="#cb3-234"></a></span>
<span id="cb3-235"><a href="#cb3-235"></a>            <span class="co"># Update running mean and count arrays</span></span>
<span id="cb3-236"><a href="#cb3-236"></a>            mean, num <span class="op">=</span> meanVar(mean, num, chla)</span>
<span id="cb3-237"><a href="#cb3-237"></a>    <span class="cf">else</span>:</span>
<span id="cb3-238"><a href="#cb3-238"></a>        <span class="co"># Composite wraps across year boundary</span></span>
<span id="cb3-239"><a href="#cb3-239"></a>        dataDir1 <span class="op">=</span> dataDir</span>
<span id="cb3-240"><a href="#cb3-240"></a>        dataDir1 <span class="op">=</span> dataDir1.replace(endyearC, startYearC)</span>
<span id="cb3-241"><a href="#cb3-241"></a>        <span class="co"># Determine last DOY of start year based on leap year</span></span>
<span id="cb3-242"><a href="#cb3-242"></a>        <span class="cf">if</span>(isleap):</span>
<span id="cb3-243"><a href="#cb3-243"></a>            endday <span class="op">=</span> <span class="dv">366</span></span>
<span id="cb3-244"><a href="#cb3-244"></a>        <span class="cf">else</span>:</span>
<span id="cb3-245"><a href="#cb3-245"></a>            endday <span class="op">=</span> <span class="dv">365</span></span>
<span id="cb3-246"><a href="#cb3-246"></a></span>
<span id="cb3-247"><a href="#cb3-247"></a>        <span class="co"># From startDoy through end of start year  </span></span>
<span id="cb3-248"><a href="#cb3-248"></a>        fileList <span class="op">=</span> []</span>
<span id="cb3-249"><a href="#cb3-249"></a>        os.chdir(dataDir1)</span>
<span id="cb3-250"><a href="#cb3-250"></a>        doyRange <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(startDoy, endday <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb3-251"><a href="#cb3-251"></a>        <span class="cf">for</span> doy <span class="kw">in</span> doyRange:</span>
<span id="cb3-252"><a href="#cb3-252"></a>            doyC <span class="op">=</span> <span class="bu">str</span>(doy)</span>
<span id="cb3-253"><a href="#cb3-253"></a>            doyC <span class="op">=</span> doyC.rjust(<span class="dv">3</span>, <span class="st">'0'</span>)</span>
<span id="cb3-254"><a href="#cb3-254"></a>            myString <span class="op">=</span> <span class="st">'MB'</span> <span class="op">+</span> startYearC <span class="op">+</span> doyC <span class="op">+</span> <span class="st">'*'</span> <span class="op">+</span> dtype <span class="op">+</span> <span class="st">'.nc'</span></span>
<span id="cb3-255"><a href="#cb3-255"></a>            fileList.append(glob.glob(myString))</span>
<span id="cb3-256"><a href="#cb3-256"></a></span>
<span id="cb3-257"><a href="#cb3-257"></a>        fileList <span class="op">=</span> <span class="bu">list</span>(chain.from_iterable(fileList))</span>
<span id="cb3-258"><a href="#cb3-258"></a>        fileList.sort()</span>
<span id="cb3-259"><a href="#cb3-259"></a></span>
<span id="cb3-260"><a href="#cb3-260"></a>        filesUsed <span class="op">=</span> <span class="st">""</span></span>
<span id="cb3-261"><a href="#cb3-261"></a>        <span class="bu">print</span>(fileList)</span>
<span id="cb3-262"><a href="#cb3-262"></a>        <span class="cf">for</span> fName <span class="kw">in</span> fileList:</span>
<span id="cb3-263"><a href="#cb3-263"></a>            <span class="cf">if</span> (<span class="bu">len</span>(filesUsed) <span class="op">==</span> <span class="dv">0</span>):</span>
<span id="cb3-264"><a href="#cb3-264"></a>                filesUsed <span class="op">=</span> fName</span>
<span id="cb3-265"><a href="#cb3-265"></a>            <span class="cf">else</span>:</span>
<span id="cb3-266"><a href="#cb3-266"></a>                filesUsed <span class="op">=</span> filesUsed <span class="op">+</span> <span class="st">', '</span> <span class="op">+</span> fName</span>
<span id="cb3-267"><a href="#cb3-267"></a></span>
<span id="cb3-268"><a href="#cb3-268"></a>            chlaFile <span class="op">=</span> Dataset(fName)</span>
<span id="cb3-269"><a href="#cb3-269"></a>            chla <span class="op">=</span> chlaFile.variables[<span class="st">"MBchla"</span>][:, :, :, :]</span>
<span id="cb3-270"><a href="#cb3-270"></a>            chlaFile.close()</span>
<span id="cb3-271"><a href="#cb3-271"></a>            chla <span class="op">=</span> np.squeeze(chla)</span>
<span id="cb3-272"><a href="#cb3-272"></a>            mean, num <span class="op">=</span> meanVar(mean, num, chla)</span>
<span id="cb3-273"><a href="#cb3-273"></a></span>
<span id="cb3-274"><a href="#cb3-274"></a>        <span class="co"># From DOY 1 of end year through endDoy</span></span>
<span id="cb3-275"><a href="#cb3-275"></a>        os.chdir(dataDir)</span>
<span id="cb3-276"><a href="#cb3-276"></a>        fileList <span class="op">=</span> []</span>
<span id="cb3-277"><a href="#cb3-277"></a>        doyRange<span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="dv">1</span>, endDoy <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb3-278"><a href="#cb3-278"></a>        <span class="cf">for</span> doy <span class="kw">in</span> doyRange:</span>
<span id="cb3-279"><a href="#cb3-279"></a>            doyC <span class="op">=</span> <span class="bu">str</span>(doy)</span>
<span id="cb3-280"><a href="#cb3-280"></a>            doyC <span class="op">=</span> doyC.rjust(<span class="dv">3</span>, <span class="st">'0'</span>)</span>
<span id="cb3-281"><a href="#cb3-281"></a>            myString <span class="op">=</span> <span class="st">'MB'</span> <span class="op">+</span> endyearC <span class="op">+</span> doyC <span class="op">+</span> <span class="st">'*'</span> <span class="op">+</span> dtype <span class="op">+</span> <span class="st">'.nc'</span></span>
<span id="cb3-282"><a href="#cb3-282"></a>            fileList.append(glob.glob(myString))</span>
<span id="cb3-283"><a href="#cb3-283"></a></span>
<span id="cb3-284"><a href="#cb3-284"></a>        fileList <span class="op">=</span> <span class="bu">list</span>(chain.from_iterable(fileList))</span>
<span id="cb3-285"><a href="#cb3-285"></a>        fileList.sort()</span>
<span id="cb3-286"><a href="#cb3-286"></a>        <span class="bu">print</span>(fileList)</span>
<span id="cb3-287"><a href="#cb3-287"></a>        <span class="cf">for</span> fName <span class="kw">in</span> fileList:</span>
<span id="cb3-288"><a href="#cb3-288"></a>            <span class="cf">if</span> (<span class="bu">len</span>(filesUsed) <span class="op">==</span> <span class="dv">0</span>):</span>
<span id="cb3-289"><a href="#cb3-289"></a>                filesUsed <span class="op">=</span> fName</span>
<span id="cb3-290"><a href="#cb3-290"></a>            <span class="cf">else</span>:</span>
<span id="cb3-291"><a href="#cb3-291"></a>                filesUsed <span class="op">=</span> filesUsed <span class="op">+</span> <span class="st">', '</span> <span class="op">+</span> fName</span>
<span id="cb3-292"><a href="#cb3-292"></a></span>
<span id="cb3-293"><a href="#cb3-293"></a>            chlaFile <span class="op">=</span> Dataset(fName)</span>
<span id="cb3-294"><a href="#cb3-294"></a>            chla <span class="op">=</span> chlaFile.variables[<span class="st">"MBchla"</span>][:, :, :, :]</span>
<span id="cb3-295"><a href="#cb3-295"></a>            chlaFile.close()</span>
<span id="cb3-296"><a href="#cb3-296"></a>            chla <span class="op">=</span> np.squeeze(chla)</span>
<span id="cb3-297"><a href="#cb3-297"></a>            mean, num <span class="op">=</span> meanVar(mean, num, chla)</span>
<span id="cb3-298"><a href="#cb3-298"></a></span>
<span id="cb3-299"><a href="#cb3-299"></a>    <span class="co"># Mask out pixels with zero observations and set fill value for missing data</span></span>
<span id="cb3-300"><a href="#cb3-300"></a>    mean <span class="op">=</span> ma.array(mean, mask<span class="op">=</span>(num <span class="op">==</span> <span class="dv">0</span>), fill_value<span class="op">=-</span><span class="fl">9999999.</span>)</span>
<span id="cb3-301"><a href="#cb3-301"></a></span>
<span id="cb3-302"><a href="#cb3-302"></a>    <span class="co"># Switch to the working directory</span></span>
<span id="cb3-303"><a href="#cb3-303"></a>    os.chdir(workDir)</span>
<span id="cb3-304"><a href="#cb3-304"></a></span>
<span id="cb3-305"><a href="#cb3-305"></a>    <span class="co"># Construct output filename</span></span>
<span id="cb3-306"><a href="#cb3-306"></a>    outFile <span class="op">=</span> <span class="st">'MB'</span> <span class="op">+</span> startYearC <span class="op">+</span> startDoyC <span class="op">+</span> <span class="st">'_'</span> <span class="op">+</span> endyearC <span class="op">+</span> endDoyC <span class="op">+</span> <span class="st">'_'</span> <span class="op">+</span> dtype <span class="op">+</span> <span class="st">'.nc'</span></span>
<span id="cb3-307"><a href="#cb3-307"></a></span>
<span id="cb3-308"><a href="#cb3-308"></a>    <span class="co"># Generate the monthly NetCDF file</span></span>
<span id="cb3-309"><a href="#cb3-309"></a>    ncFile <span class="op">=</span> makeNetcdfmDay(mean, num, interval, outFile, filesUsed, workDir)</span>
<span id="cb3-310"><a href="#cb3-310"></a></span>
<span id="cb3-311"><a href="#cb3-311"></a>    <span class="co"># Upload the composite to remote MB chla directory</span></span>
<span id="cb3-312"><a href="#cb3-312"></a>    send_to_servers(ncFile, <span class="st">'/MB/chla/'</span>, <span class="st">'m'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="sst" class="level2">
<h2 class="anchored" data-anchor-id="sst">SST</h2>
<section id="makesst1daynewmb" class="level3">
<h3 class="anchored" data-anchor-id="makesst1daynewmb">makeSST1daynewMB</h3>
<p><code>makeSST1daynewMB</code> makes a 1-day SST composite for the MB dataset by aggregating valid Level-2 swaths from the target day (HOD &gt; 10) and early hours of the following day (HOD ≤ 10), then interpolating onto a 0.025° × 0.025° regular grid spanning longitude 120–320° and latitude –45–65° via PyGMT. It writes out a CF-compliant NetCDF, masks land using a static grid, computes coverage statistics, and uploads the resulting file to a directory on the remote server. Find the 1-day product on ERDDAP <a href="./modisa_scripts.html#modisa-products-on-swfsc-erddap-server">here</a>.</p>
<p>The following chart summarizes the script’s workflow:</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">%%{init: {"flowchart":{"htmlLabels":true}}}%%
flowchart LR
  I("&lt;b&gt;Inputs&lt;/b&gt;&lt;br/&gt;• Raw L2 SST swaths (dataDir)&lt;br/&gt;• workDir&lt;br/&gt;• Year &amp; DOY")
    --&gt; P("&lt;b&gt;Processing&lt;/b&gt;&lt;br/&gt;• Compute dates &amp; directories&lt;br/&gt;• Load land mask&lt;br/&gt;• Discover swaths for day &amp; next-day&lt;br/&gt;• Stage &amp; filter swaths (day-only, region overlap)&lt;br/&gt;• Extract, reshape &amp; filter variables&lt;br/&gt;• Interpolate onto regular grid&lt;br/&gt;• Apply mask")
    --&gt; O("&lt;b&gt;Output&lt;/b&gt;&lt;br/&gt;• CF-compliant 1-day composite SST NetCDF&lt;br/&gt;• Deployed to /MB/sstd/1day/")
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<div id="7727d026" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>View makeSST1daynewMB.py</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1"></a><span class="co">"""</span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="co">Overview</span></span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="co">--------</span></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="co">Generate a one-day SST grid for the MODIS “MB” (Pacific Ocean) dataset by combining swaths</span></span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="co">from Level-2 SST NetCDF files over a two-day interval (current day and early hours of the</span></span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="co">next day). The output is a CF-compliant NetCDF file containing daily SST on a regular grid</span></span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="co">(lon 120-320°, lat -45-65°).</span></span>
<span id="cb4-8"><a href="#cb4-8"></a></span>
<span id="cb4-9"><a href="#cb4-9"></a><span class="co">Usage</span></span>
<span id="cb4-10"><a href="#cb4-10"></a><span class="co">-----</span></span>
<span id="cb4-11"><a href="#cb4-11"></a><span class="co">::</span></span>
<span id="cb4-12"><a href="#cb4-12"></a></span>
<span id="cb4-13"><a href="#cb4-13"></a><span class="co">    python makeSST1daynewMB.py &lt;dataDir&gt; &lt;workDir&gt; &lt;year&gt; &lt;doy&gt;</span></span>
<span id="cb4-14"><a href="#cb4-14"></a></span>
<span id="cb4-15"><a href="#cb4-15"></a><span class="co">Where:</span></span>
<span id="cb4-16"><a href="#cb4-16"></a></span>
<span id="cb4-17"><a href="#cb4-17"></a><span class="co">- ``dataDir``</span></span>
<span id="cb4-18"><a href="#cb4-18"></a></span>
<span id="cb4-19"><a href="#cb4-19"></a><span class="co">  Base directory containing raw Level-2 SST NetCDF swaths, organized as ``&lt;dataDirBase&gt;/&lt;YYYY&gt;&lt;MM&gt;/``. Each file must match ``AQUA_MODIS.&lt;YYYY&gt;&lt;MM&gt;&lt;DD&gt;T*.L2.SST.NRT.nc``.</span></span>
<span id="cb4-20"><a href="#cb4-20"></a></span>
<span id="cb4-21"><a href="#cb4-21"></a><span class="co">- ``workDir``</span></span>
<span id="cb4-22"><a href="#cb4-22"></a></span>
<span id="cb4-23"><a href="#cb4-23"></a><span class="co">  Temporary working directory. Swaths are copied here, intermediate files are created, and then cleaned up.</span></span>
<span id="cb4-24"><a href="#cb4-24"></a></span>
<span id="cb4-25"><a href="#cb4-25"></a><span class="co">- ``year``</span></span>
<span id="cb4-26"><a href="#cb4-26"></a></span>
<span id="cb4-27"><a href="#cb4-27"></a><span class="co">  Four-digit year string (e.g., ``"2025"``).</span></span>
<span id="cb4-28"><a href="#cb4-28"></a></span>
<span id="cb4-29"><a href="#cb4-29"></a><span class="co">- ``doy``</span></span>
<span id="cb4-30"><a href="#cb4-30"></a></span>
<span id="cb4-31"><a href="#cb4-31"></a><span class="co">  Three-digit day-of-year string (zero-padded, e.g., ``"082"`` for March 23).</span></span>
<span id="cb4-32"><a href="#cb4-32"></a></span>
<span id="cb4-33"><a href="#cb4-33"></a><span class="co">Description</span></span>
<span id="cb4-34"><a href="#cb4-34"></a><span class="co">-----------</span></span>
<span id="cb4-35"><a href="#cb4-35"></a><span class="co">1. **Date and Directory Setup**</span></span>
<span id="cb4-36"><a href="#cb4-36"></a></span>
<span id="cb4-37"><a href="#cb4-37"></a><span class="co">     - Convert ``year`` + ``doy`` to a calendar date (``myDate``), then extract zero-padded month (``myMon``) and day (``myDay``).</span></span>
<span id="cb4-38"><a href="#cb4-38"></a><span class="co">     </span></span>
<span id="cb4-39"><a href="#cb4-39"></a><span class="co">     - Compute next-day date (``myDate1``) and its year/month/day-of-year (``year1``, ``myMon1``, ``doy1``).</span></span>
<span id="cb4-40"><a href="#cb4-40"></a><span class="co">     </span></span>
<span id="cb4-41"><a href="#cb4-41"></a><span class="co">     Define:</span></span>
<span id="cb4-42"><a href="#cb4-42"></a></span>
<span id="cb4-43"><a href="#cb4-43"></a><span class="co">         - ``datadir = dataDirBase + year + myMon + "/"``  </span></span>
<span id="cb4-44"><a href="#cb4-44"></a><span class="co">         - ``datadir1 = dataDirBase + year1 + myMon1 + "/"``</span></span>
<span id="cb4-45"><a href="#cb4-45"></a></span>
<span id="cb4-46"><a href="#cb4-46"></a><span class="co">     These folders must contain the SST swath files for the current day and next day, respectively.</span></span>
<span id="cb4-47"><a href="#cb4-47"></a><span class="co">     </span></span>
<span id="cb4-48"><a href="#cb4-48"></a><span class="co">     - Load a static land-mask grid from ``/u00/ref/landmasks/LM_120_320_0.025_-45_65_0.025_gridline.grd`` into ``my_mask``.</span></span>
<span id="cb4-49"><a href="#cb4-49"></a></span>
<span id="cb4-50"><a href="#cb4-50"></a><span class="co">2. **Swath Discovery (Day N, HOD &gt; 10)**  </span></span>
<span id="cb4-51"><a href="#cb4-51"></a></span>
<span id="cb4-52"><a href="#cb4-52"></a><span class="co">     - Change directory to ``datadir``.</span></span>
<span id="cb4-53"><a href="#cb4-53"></a><span class="co">     </span></span>
<span id="cb4-54"><a href="#cb4-54"></a><span class="co">     - Build glob pattern: ``AQUA_MODIS.&lt;year&gt;&lt;myMon&gt;&lt;myDay&gt;*.L2.SST.NRT.nc``</span></span>
<span id="cb4-55"><a href="#cb4-55"></a><span class="co">     </span></span>
<span id="cb4-56"><a href="#cb4-56"></a><span class="co">     - Sort matching files into ``fileList``.</span></span>
<span id="cb4-57"><a href="#cb4-57"></a><span class="co">     </span></span>
<span id="cb4-58"><a href="#cb4-58"></a><span class="co">     - Change into ``workDir``, then remove any stale files matching ``AQUA_MODIS.*L2.SST*`` or ``MB20*``.</span></span>
<span id="cb4-59"><a href="#cb4-59"></a></span>
<span id="cb4-60"><a href="#cb4-60"></a><span class="co">3. **Loop Over Each Swath for Day N (HOD &gt; 10)**  </span></span>
<span id="cb4-61"><a href="#cb4-61"></a></span>
<span id="cb4-62"><a href="#cb4-62"></a><span class="co">     For each ``fName`` in ``fileList``:</span></span>
<span id="cb4-63"><a href="#cb4-63"></a></span>
<span id="cb4-64"><a href="#cb4-64"></a><span class="co">     a. Extract hour-of-day (HOD) from the filename.</span></span>
<span id="cb4-65"><a href="#cb4-65"></a><span class="co">     </span></span>
<span id="cb4-66"><a href="#cb4-66"></a><span class="co">     b. If ``HOD &gt; 10``, copy the swath from ``datadir`` to ``workDir`` and open with ``netCDF4.Dataset`` (skip if unreadable).</span></span>
<span id="cb4-67"><a href="#cb4-67"></a><span class="co">      </span></span>
<span id="cb4-68"><a href="#cb4-68"></a><span class="co">     c. Read ``navigation_data`` (``latitude``, ``longitude``), convert negative longitudes to 0-360°. Compute swath extents and test geographic overlap:  </span></span>
<span id="cb4-69"><a href="#cb4-69"></a></span>
<span id="cb4-70"><a href="#cb4-70"></a><span class="co">         - Longitude overlaps [120°, 320°]</span></span>
<span id="cb4-71"><a href="#cb4-71"></a><span class="co">         </span></span>
<span id="cb4-72"><a href="#cb4-72"></a><span class="co">         - Latitude overlaps [-45°, 65°]</span></span>
<span id="cb4-73"><a href="#cb4-73"></a><span class="co">         </span></span>
<span id="cb4-74"><a href="#cb4-74"></a><span class="co">         - ``day_night_flag == "Day"``</span></span>
<span id="cb4-75"><a href="#cb4-75"></a><span class="co">         </span></span>
<span id="cb4-76"><a href="#cb4-76"></a><span class="co">         If all true, append the filename to ``filesUsed``.</span></span>
<span id="cb4-77"><a href="#cb4-77"></a></span>
<span id="cb4-78"><a href="#cb4-78"></a><span class="co">      d. Reshape variables using ``myReshape`` and read from ``geophysical_data``:</span></span>
<span id="cb4-79"><a href="#cb4-79"></a></span>
<span id="cb4-80"><a href="#cb4-80"></a><span class="co">         - ``sst`` (sea surface temperature)</span></span>
<span id="cb4-81"><a href="#cb4-81"></a><span class="co">         </span></span>
<span id="cb4-82"><a href="#cb4-82"></a><span class="co">         - ``qual_sst`` (quality flag)</span></span>
<span id="cb4-83"><a href="#cb4-83"></a><span class="co">        </span></span>
<span id="cb4-84"><a href="#cb4-84"></a><span class="co">         Flatten quality flags, stack ``longitude``, ``latitude``, ``sst`` into ``dataOut``, and filter:</span></span>
<span id="cb4-85"><a href="#cb4-85"></a><span class="co">         </span></span>
<span id="cb4-86"><a href="#cb4-86"></a><span class="co">           - ``qual_sst &lt; 3``</span></span>
<span id="cb4-87"><a href="#cb4-87"></a><span class="co">         </span></span>
<span id="cb4-88"><a href="#cb4-88"></a><span class="co">           - SST &gt; -2 °C</span></span>
<span id="cb4-89"><a href="#cb4-89"></a><span class="co">         </span></span>
<span id="cb4-90"><a href="#cb4-90"></a><span class="co">           - Longitude between 120° and 320°</span></span>
<span id="cb4-91"><a href="#cb4-91"></a><span class="co">         </span></span>
<span id="cb4-92"><a href="#cb4-92"></a><span class="co">           - Latitude ≤ 65°</span></span>
<span id="cb4-93"><a href="#cb4-93"></a><span class="co">         </span></span>
<span id="cb4-94"><a href="#cb4-94"></a><span class="co">         Accumulate valid points into ``temp_data``.</span></span>
<span id="cb4-95"><a href="#cb4-95"></a></span>
<span id="cb4-96"><a href="#cb4-96"></a><span class="co">   e. Close the NetCDF and remove the copied swath from ``workDir`` using ``safe_remove``.</span></span>
<span id="cb4-97"><a href="#cb4-97"></a></span>
<span id="cb4-98"><a href="#cb4-98"></a><span class="co">4. **Swath Discovery (Day N+1, HOD ≤ 10)**</span></span>
<span id="cb4-99"><a href="#cb4-99"></a></span>
<span id="cb4-100"><a href="#cb4-100"></a><span class="co">     - Change directory to ``datadir1``.</span></span>
<span id="cb4-101"><a href="#cb4-101"></a><span class="co">     </span></span>
<span id="cb4-102"><a href="#cb4-102"></a><span class="co">     - Build glob pattern: ``AQUA_MODIS.&lt;year1&gt;&lt;myMon1&gt;&lt;myDay1&gt;*.L2.SST.NRT.nc``</span></span>
<span id="cb4-103"><a href="#cb4-103"></a><span class="co">     </span></span>
<span id="cb4-104"><a href="#cb4-104"></a><span class="co">     - Sort into ``fileList``.</span></span>
<span id="cb4-105"><a href="#cb4-105"></a><span class="co">     </span></span>
<span id="cb4-106"><a href="#cb4-106"></a><span class="co">     - Change back into ``workDir``.</span></span>
<span id="cb4-107"><a href="#cb4-107"></a></span>
<span id="cb4-108"><a href="#cb4-108"></a><span class="co">5. **Loop Over Each Swath for Day N+1 (HOD ≤ 10)**</span></span>
<span id="cb4-109"><a href="#cb4-109"></a></span>
<span id="cb4-110"><a href="#cb4-110"></a><span class="co">     For each ``fName`` in ``fileList``:</span></span>
<span id="cb4-111"><a href="#cb4-111"></a><span class="co">     </span></span>
<span id="cb4-112"><a href="#cb4-112"></a><span class="co">       - Extract HOD; if ``HOD ≤ 10``, copy swath from ``datadir1`` to ``workDir`` and repeat steps 3b-3e (navigation, quality/filter, accumulate into ``temp_data``).</span></span>
<span id="cb4-113"><a href="#cb4-113"></a></span>
<span id="cb4-114"><a href="#cb4-114"></a><span class="co">6. **Gridding Swath Point Cloud**</span></span>
<span id="cb4-115"><a href="#cb4-115"></a></span>
<span id="cb4-116"><a href="#cb4-116"></a><span class="co">     - After processing both sets of swaths, define output grid filename: ``MB&lt;year&gt;&lt;doy&gt;_&lt;year&gt;&lt;doy&gt;_sstd.grd``</span></span>
<span id="cb4-117"><a href="#cb4-117"></a></span>
<span id="cb4-118"><a href="#cb4-118"></a><span class="co">     - Set PyGMT region and spacing:</span></span>
<span id="cb4-119"><a href="#cb4-119"></a></span>
<span id="cb4-120"><a href="#cb4-120"></a><span class="co">         - ``region = "120/320/-45/65"``</span></span>
<span id="cb4-121"><a href="#cb4-121"></a></span>
<span id="cb4-122"><a href="#cb4-122"></a><span class="co">         - ``spacing = "0.025/0.025"``</span></span>
<span id="cb4-123"><a href="#cb4-123"></a></span>
<span id="cb4-124"><a href="#cb4-124"></a><span class="co">     - Call:</span></span>
<span id="cb4-125"><a href="#cb4-125"></a></span>
<span id="cb4-126"><a href="#cb4-126"></a><span class="co">     ::</span></span>
<span id="cb4-127"><a href="#cb4-127"></a></span>
<span id="cb4-128"><a href="#cb4-128"></a><span class="co">         pygmt.xyz2grd(</span></span>
<span id="cb4-129"><a href="#cb4-129"></a><span class="co">             data=temp_data,</span></span>
<span id="cb4-130"><a href="#cb4-130"></a><span class="co">             region=region,</span></span>
<span id="cb4-131"><a href="#cb4-131"></a><span class="co">             spacing=spacing</span></span>
<span id="cb4-132"><a href="#cb4-132"></a><span class="co">         )</span></span>
<span id="cb4-133"><a href="#cb4-133"></a></span>
<span id="cb4-134"><a href="#cb4-134"></a><span class="co">     to produce a gridded ``xarray.DataArray`` (``temp_data1``).</span></span>
<span id="cb4-135"><a href="#cb4-135"></a></span>
<span id="cb4-136"><a href="#cb4-136"></a><span class="co">7. **Convert to NetCDF and Send to Server**</span></span>
<span id="cb4-137"><a href="#cb4-137"></a></span>
<span id="cb4-138"><a href="#cb4-138"></a><span class="co">     - Invoke: ``ncFile = grd2netcdf1(temp_data1, fileOut, filesUsed, my_mask, "MB")`` from ``roylib``: </span></span>
<span id="cb4-139"><a href="#cb4-139"></a></span>
<span id="cb4-140"><a href="#cb4-140"></a><span class="co">     - Masks out land using ``my_mask`` (set land to NaN).</span></span>
<span id="cb4-141"><a href="#cb4-141"></a></span>
<span id="cb4-142"><a href="#cb4-142"></a><span class="co">     - Computes coverage metrics (# observations, % coverage).</span></span>
<span id="cb4-143"><a href="#cb4-143"></a></span>
<span id="cb4-144"><a href="#cb4-144"></a><span class="co">     - Uses a CDL template to generate an empty CF-compliant NetCDF via ``ncgen``.</span></span>
<span id="cb4-145"><a href="#cb4-145"></a></span>
<span id="cb4-146"><a href="#cb4-146"></a><span class="co">     - Populates coordinates, SST values, metadata, and a center-time stamp.</span></span>
<span id="cb4-147"><a href="#cb4-147"></a></span>
<span id="cb4-148"><a href="#cb4-148"></a><span class="co">     - Returns the final NetCDF filename (``MB&lt;year&gt;&lt;doy&gt;_&lt;year&gt;&lt;doy&gt;_sstd.nc``).</span></span>
<span id="cb4-149"><a href="#cb4-149"></a></span>
<span id="cb4-150"><a href="#cb4-150"></a><span class="co">   - Call:</span></span>
<span id="cb4-151"><a href="#cb4-151"></a></span>
<span id="cb4-152"><a href="#cb4-152"></a><span class="co">     ::</span></span>
<span id="cb4-153"><a href="#cb4-153"></a></span>
<span id="cb4-154"><a href="#cb4-154"></a><span class="co">          send_to_servers(ncFile, "/MB/sstd/", "1")</span></span>
<span id="cb4-155"><a href="#cb4-155"></a></span>
<span id="cb4-156"><a href="#cb4-156"></a><span class="co">     to copy the NetCDF into ``/MB/sstd/1day/``.</span></span>
<span id="cb4-157"><a href="#cb4-157"></a></span>
<span id="cb4-158"><a href="#cb4-158"></a><span class="co">     Finally, remove the local NetCDF copy.</span></span>
<span id="cb4-159"><a href="#cb4-159"></a></span>
<span id="cb4-160"><a href="#cb4-160"></a><span class="co">Dependencies</span></span>
<span id="cb4-161"><a href="#cb4-161"></a><span class="co">------------</span></span>
<span id="cb4-162"><a href="#cb4-162"></a><span class="co">- **Python 3.x**</span></span>
<span id="cb4-163"><a href="#cb4-163"></a></span>
<span id="cb4-164"><a href="#cb4-164"></a><span class="co">- **Standard library:** ``os``, ``glob``, ``re``, ``shutil``, ``sys``, ``datetime``, ``timedelta``, ``chain``</span></span>
<span id="cb4-165"><a href="#cb4-165"></a></span>
<span id="cb4-166"><a href="#cb4-166"></a><span class="co">- **Third-party**: ``netCDF4.Dataset``, ``numpy``, ``numpy.ma``, ``pygmt``  </span></span>
<span id="cb4-167"><a href="#cb4-167"></a></span>
<span id="cb4-168"><a href="#cb4-168"></a><span class="co">- **Custom roylib functions:**</span></span>
<span id="cb4-169"><a href="#cb4-169"></a></span>
<span id="cb4-170"><a href="#cb4-170"></a><span class="co">   - ``myReshape(array)``</span></span>
<span id="cb4-171"><a href="#cb4-171"></a><span class="co">  </span></span>
<span id="cb4-172"><a href="#cb4-172"></a><span class="co">   - ``grd2netcdf1(grd, outName, filesUsed, mask, fType)``</span></span>
<span id="cb4-173"><a href="#cb4-173"></a></span>
<span id="cb4-174"><a href="#cb4-174"></a><span class="co">   - ``safe_remove(filePath)``  </span></span>
<span id="cb4-175"><a href="#cb4-175"></a></span>
<span id="cb4-176"><a href="#cb4-176"></a><span class="co">   - ``send_to_servers(ncFile, destDir, interval)``</span></span>
<span id="cb4-177"><a href="#cb4-177"></a></span>
<span id="cb4-178"><a href="#cb4-178"></a><span class="co">   - ``isleap(year)``</span></span>
<span id="cb4-179"><a href="#cb4-179"></a></span>
<span id="cb4-180"><a href="#cb4-180"></a><span class="co">   - ``makeNetcdf(mean, nobs, interval, outFile, filesUsed, workDir)``</span></span>
<span id="cb4-181"><a href="#cb4-181"></a></span>
<span id="cb4-182"><a href="#cb4-182"></a><span class="co">   - ``meanVar(mean, num, obs)``</span></span>
<span id="cb4-183"><a href="#cb4-183"></a></span>
<span id="cb4-184"><a href="#cb4-184"></a><span class="co">Land Mask</span></span>
<span id="cb4-185"><a href="#cb4-185"></a><span class="co">---------</span></span>
<span id="cb4-186"><a href="#cb4-186"></a><span class="co">- A static GRD file is required at:</span></span>
<span id="cb4-187"><a href="#cb4-187"></a></span>
<span id="cb4-188"><a href="#cb4-188"></a><span class="co">  ``/u00/ref/landmasks/LM_120_320_0.025_-45_65_0.025_gridline.grd``</span></span>
<span id="cb4-189"><a href="#cb4-189"></a></span>
<span id="cb4-190"><a href="#cb4-190"></a><span class="co">Directory Structure</span></span>
<span id="cb4-191"><a href="#cb4-191"></a><span class="co">-------------------</span></span>
<span id="cb4-192"><a href="#cb4-192"></a><span class="co">- **Input swaths directory (Day N)**:</span></span>
<span id="cb4-193"><a href="#cb4-193"></a></span>
<span id="cb4-194"><a href="#cb4-194"></a><span class="co">  ``&lt;dataDirBase&gt;/&lt;YYYY&gt;&lt;MM&gt;/`` containing files named ``AQUA_MODIS.&lt;YYYY&gt;&lt;MM&gt;&lt;DD&gt;T*.L2.SST.NRT.nc``.</span></span>
<span id="cb4-195"><a href="#cb4-195"></a></span>
<span id="cb4-196"><a href="#cb4-196"></a><span class="co">- **Input swaths directory (Day N+1)**:</span></span>
<span id="cb4-197"><a href="#cb4-197"></a><span class="co">  </span></span>
<span id="cb4-198"><a href="#cb4-198"></a><span class="co">  ``&lt;dataDirBase&gt;/&lt;YYYY1&gt;&lt;MM1&gt;/`` containing the early-hour swaths.</span></span>
<span id="cb4-199"><a href="#cb4-199"></a></span>
<span id="cb4-200"><a href="#cb4-200"></a><span class="co">- **Working directory** (workDir): </span></span>
<span id="cb4-201"><a href="#cb4-201"></a><span class="co">  </span></span>
<span id="cb4-202"><a href="#cb4-202"></a><span class="co">  Temporary location where swaths are copied, processed, and removed.</span></span>
<span id="cb4-203"><a href="#cb4-203"></a></span>
<span id="cb4-204"><a href="#cb4-204"></a><span class="co">- **Output grid** (fileOut):  </span></span>
<span id="cb4-205"><a href="#cb4-205"></a><span class="co">  </span></span>
<span id="cb4-206"><a href="#cb4-206"></a><span class="co">  A GMT “.grd” file named ``MB&lt;year&gt;&lt;doy&gt;_&lt;year&gt;&lt;doy&gt;_sstd.grd``.</span></span>
<span id="cb4-207"><a href="#cb4-207"></a></span>
<span id="cb4-208"><a href="#cb4-208"></a><span class="co">- **Final NetCDF** (returned by ``grd2netcdf1``): </span></span>
<span id="cb4-209"><a href="#cb4-209"></a><span class="co">  </span></span>
<span id="cb4-210"><a href="#cb4-210"></a><span class="co">  Named ``MB&lt;year&gt;&lt;doy&gt;_&lt;year&gt;&lt;doy&gt;_sstd.nc``, then copied to ``/MB/sstd/1day/``.</span></span>
<span id="cb4-211"><a href="#cb4-211"></a></span>
<span id="cb4-212"><a href="#cb4-212"></a><span class="co">Usage Example</span></span>
<span id="cb4-213"><a href="#cb4-213"></a><span class="co">-------------</span></span>
<span id="cb4-214"><a href="#cb4-214"></a><span class="co">Assume your raw SST swaths are in ``/Users/you/modis_data/netcdf/202503/`` and your working directory is ``/Users/you/modis_work/``</span></span>
<span id="cb4-215"><a href="#cb4-215"></a></span>
<span id="cb4-216"><a href="#cb4-216"></a><span class="co">::</span></span>
<span id="cb4-217"><a href="#cb4-217"></a></span>
<span id="cb4-218"><a href="#cb4-218"></a><span class="co">    python makeSST1daynewMB.py /Users/you/modis_data/netcdf/ </span><span class="op">\</span></span>
<span id="cb4-219"><a href="#cb4-219"></a><span class="co">                              /Users/you/modis_work/ </span><span class="op">\</span></span>
<span id="cb4-220"><a href="#cb4-220"></a><span class="co">                              2025 082</span></span>
<span id="cb4-221"><a href="#cb4-221"></a></span>
<span id="cb4-222"><a href="#cb4-222"></a><span class="co">This will:</span></span>
<span id="cb4-223"><a href="#cb4-223"></a></span>
<span id="cb4-224"><a href="#cb4-224"></a><span class="co">  - Copy all swaths from March 23 with HOD &gt; 10 into “/Users/you/modis_work/”.</span></span>
<span id="cb4-225"><a href="#cb4-225"></a></span>
<span id="cb4-226"><a href="#cb4-226"></a><span class="co">  - Copy early swaths from March 24 with HOD ≤ 10 into “/Users/you/modis_work/”.</span></span>
<span id="cb4-227"><a href="#cb4-227"></a></span>
<span id="cb4-228"><a href="#cb4-228"></a><span class="co">  - Build a combined point cloud from valid “Day” pixels for 120-320°, lat -45-65°).</span></span>
<span id="cb4-229"><a href="#cb4-229"></a></span>
<span id="cb4-230"><a href="#cb4-230"></a><span class="co">  - Create “MB2025082_2025082_sstd.grd” via PyGMT ``xyz2grd``.</span></span>
<span id="cb4-231"><a href="#cb4-231"></a></span>
<span id="cb4-232"><a href="#cb4-232"></a><span class="co">  - Convert the grid to “MB2025082_2025082_sstd.nc” using ``grd2netcdf1``.</span></span>
<span id="cb4-233"><a href="#cb4-233"></a></span>
<span id="cb4-234"><a href="#cb4-234"></a><span class="co">  - Copy the NetCDF to “/MB/sstd/1day/” and remove local copies.</span></span>
<span id="cb4-235"><a href="#cb4-235"></a><span class="co">"""</span></span>
<span id="cb4-236"><a href="#cb4-236"></a><span class="im">from</span> __future__ <span class="im">import</span> print_function</span>
<span id="cb4-237"><a href="#cb4-237"></a><span class="im">from</span> builtins <span class="im">import</span> <span class="bu">str</span></span>
<span id="cb4-238"><a href="#cb4-238"></a></span>
<span id="cb4-239"><a href="#cb4-239"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb4-240"><a href="#cb4-240"></a>    <span class="im">from</span> datetime <span class="im">import</span> datetime, timedelta</span>
<span id="cb4-241"><a href="#cb4-241"></a>    <span class="im">import</span> glob</span>
<span id="cb4-242"><a href="#cb4-242"></a>    <span class="im">from</span> itertools <span class="im">import</span> chain</span>
<span id="cb4-243"><a href="#cb4-243"></a>    <span class="im">from</span> netCDF4 <span class="im">import</span> Dataset</span>
<span id="cb4-244"><a href="#cb4-244"></a>    <span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb4-245"><a href="#cb4-245"></a>    <span class="im">import</span> numpy.ma <span class="im">as</span> ma</span>
<span id="cb4-246"><a href="#cb4-246"></a>    <span class="im">import</span> pygmt</span>
<span id="cb4-247"><a href="#cb4-247"></a>    <span class="im">import</span> os</span>
<span id="cb4-248"><a href="#cb4-248"></a>    <span class="im">import</span> re</span>
<span id="cb4-249"><a href="#cb4-249"></a>    <span class="im">import</span> shutil</span>
<span id="cb4-250"><a href="#cb4-250"></a>    <span class="im">import</span> sys</span>
<span id="cb4-251"><a href="#cb4-251"></a></span>
<span id="cb4-252"><a href="#cb4-252"></a>    <span class="co"># Ensure 'roylib' is on the import path</span></span>
<span id="cb4-253"><a href="#cb4-253"></a>    sys.path.append(<span class="st">'/home/cwatch/pythonLibs'</span>)</span>
<span id="cb4-254"><a href="#cb4-254"></a>    <span class="im">from</span> roylib <span class="im">import</span> <span class="op">*</span></span>
<span id="cb4-255"><a href="#cb4-255"></a></span>
<span id="cb4-256"><a href="#cb4-256"></a>    <span class="co"># Geographic bounds for MW region</span></span>
<span id="cb4-257"><a href="#cb4-257"></a>    latmax <span class="op">=</span> <span class="fl">65.</span></span>
<span id="cb4-258"><a href="#cb4-258"></a>    latmin <span class="op">=</span> <span class="op">-</span><span class="fl">45.</span></span>
<span id="cb4-259"><a href="#cb4-259"></a>    lonmax <span class="op">=</span> <span class="fl">320.</span></span>
<span id="cb4-260"><a href="#cb4-260"></a>    lonmin <span class="op">=</span> <span class="fl">120.</span></span>
<span id="cb4-261"><a href="#cb4-261"></a></span>
<span id="cb4-262"><a href="#cb4-262"></a>    outFile <span class="op">=</span> <span class="st">'modisgfSSTtemp'</span></span>
<span id="cb4-263"><a href="#cb4-263"></a></span>
<span id="cb4-264"><a href="#cb4-264"></a>    <span class="co"># Set data directory</span></span>
<span id="cb4-265"><a href="#cb4-265"></a>    datadirBase <span class="op">=</span> sys.argv[<span class="dv">1</span>]</span>
<span id="cb4-266"><a href="#cb4-266"></a></span>
<span id="cb4-267"><a href="#cb4-267"></a>    <span class="co"># Set work directory</span></span>
<span id="cb4-268"><a href="#cb4-268"></a>    workdir <span class="op">=</span> sys.argv[<span class="dv">2</span>]</span>
<span id="cb4-269"><a href="#cb4-269"></a></span>
<span id="cb4-270"><a href="#cb4-270"></a>    <span class="co"># Get the year and doy from the command line</span></span>
<span id="cb4-271"><a href="#cb4-271"></a>    year <span class="op">=</span> sys.argv[<span class="dv">3</span>]</span>
<span id="cb4-272"><a href="#cb4-272"></a>    doy <span class="op">=</span> sys.argv[<span class="dv">4</span>]</span>
<span id="cb4-273"><a href="#cb4-273"></a>    <span class="bu">print</span>(year)</span>
<span id="cb4-274"><a href="#cb4-274"></a>    <span class="bu">print</span>(doy)</span>
<span id="cb4-275"><a href="#cb4-275"></a></span>
<span id="cb4-276"><a href="#cb4-276"></a>    <span class="co"># Convert year/doy to a calendar date and zero-pad month/day</span></span>
<span id="cb4-277"><a href="#cb4-277"></a>    myDate <span class="op">=</span> datetime(<span class="bu">int</span>(year), <span class="dv">1</span>, <span class="dv">1</span>) <span class="op">+</span> timedelta(<span class="bu">int</span>(doy) <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb4-278"><a href="#cb4-278"></a>    myMon <span class="op">=</span> <span class="bu">str</span>(myDate.month)</span>
<span id="cb4-279"><a href="#cb4-279"></a>    myMon <span class="op">=</span> myMon.rjust(<span class="dv">2</span>, <span class="st">'0'</span>)</span>
<span id="cb4-280"><a href="#cb4-280"></a>    myDay <span class="op">=</span> <span class="bu">str</span>(myDate.day).rjust(<span class="dv">2</span>, <span class="st">'0'</span>)</span>
<span id="cb4-281"><a href="#cb4-281"></a></span>
<span id="cb4-282"><a href="#cb4-282"></a>    <span class="co"># Directory for day N's raw swaths: &lt;datadirBase&gt;/&lt;year&gt;/&lt;myMon&gt;/</span></span>
<span id="cb4-283"><a href="#cb4-283"></a>    datadir <span class="op">=</span> datadirBase <span class="op">+</span> year <span class="op">+</span> myMon <span class="op">+</span> <span class="st">'/'</span></span>
<span id="cb4-284"><a href="#cb4-284"></a></span>
<span id="cb4-285"><a href="#cb4-285"></a>    <span class="co"># Compute actual calendar date from year + day</span></span>
<span id="cb4-286"><a href="#cb4-286"></a>    myDate1 <span class="op">=</span> myDate <span class="op">+</span> timedelta(days<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb4-287"><a href="#cb4-287"></a>    year1 <span class="op">=</span> <span class="bu">str</span>(myDate1.year)</span>
<span id="cb4-288"><a href="#cb4-288"></a>    doy1 <span class="op">=</span> myDate1.strftime(<span class="st">"%j"</span>).zfill(<span class="dv">3</span>)</span>
<span id="cb4-289"><a href="#cb4-289"></a>    myMon1 <span class="op">=</span> <span class="bu">str</span>(myDate1.month)</span>
<span id="cb4-290"><a href="#cb4-290"></a>    myMon1 <span class="op">=</span> myMon1.rjust(<span class="dv">2</span>, <span class="st">'0'</span>)</span>
<span id="cb4-291"><a href="#cb4-291"></a>    myDay1 <span class="op">=</span> <span class="bu">str</span>(myDate1.day).rjust(<span class="dv">2</span>, <span class="st">'0'</span>)</span>
<span id="cb4-292"><a href="#cb4-292"></a>    <span class="bu">print</span>(myDate)</span>
<span id="cb4-293"><a href="#cb4-293"></a>    <span class="bu">print</span>(myDate1)</span>
<span id="cb4-294"><a href="#cb4-294"></a>    <span class="bu">print</span>(year1)</span>
<span id="cb4-295"><a href="#cb4-295"></a>    <span class="bu">print</span>(myMon1)</span>
<span id="cb4-296"><a href="#cb4-296"></a></span>
<span id="cb4-297"><a href="#cb4-297"></a>    <span class="co"># Directory for day N + 1's raw swaths: &lt;datadirBase&gt;/&lt;year1&gt;/&lt;myMon1&gt;/</span></span>
<span id="cb4-298"><a href="#cb4-298"></a>    datadir1 <span class="op">=</span> datadirBase <span class="op">+</span> year1 <span class="op">+</span> myMon1 <span class="op">+</span> <span class="st">'/'</span></span>
<span id="cb4-299"><a href="#cb4-299"></a></span>
<span id="cb4-300"><a href="#cb4-300"></a>    <span class="co"># Load static land mask grid from GRD</span></span>
<span id="cb4-301"><a href="#cb4-301"></a>    mask_root <span class="op">=</span> Dataset(<span class="st">'/u00/ref/landmasks/LM_120_320_0.025_-45_65_0.025_gridline.grd'</span>)</span>
<span id="cb4-302"><a href="#cb4-302"></a>    my_mask <span class="op">=</span> mask_root.variables[<span class="st">'z'</span>][:, :]</span>
<span id="cb4-303"><a href="#cb4-303"></a>    mask_root.close()</span>
<span id="cb4-304"><a href="#cb4-304"></a></span>
<span id="cb4-305"><a href="#cb4-305"></a>    <span class="co"># Now move to the data directory</span></span>
<span id="cb4-306"><a href="#cb4-306"></a>    os.chdir(datadir)</span>
<span id="cb4-307"><a href="#cb4-307"></a></span>
<span id="cb4-308"><a href="#cb4-308"></a>    <span class="co"># Set up the string for the file search in the data directory</span></span>
<span id="cb4-309"><a href="#cb4-309"></a>    myString <span class="op">=</span> <span class="st">'AQUA_MODIS.'</span> <span class="op">+</span> year <span class="op">+</span> myMon <span class="op">+</span> myDay <span class="op">+</span> <span class="st">'*.L2.SST.NRT.nc'</span></span>
<span id="cb4-310"><a href="#cb4-310"></a>    <span class="bu">print</span>(myString)</span>
<span id="cb4-311"><a href="#cb4-311"></a></span>
<span id="cb4-312"><a href="#cb4-312"></a>    <span class="co"># Get list of files in the data directory that match with full path</span></span>
<span id="cb4-313"><a href="#cb4-313"></a>    fileList <span class="op">=</span> glob.glob(myString)</span>
<span id="cb4-314"><a href="#cb4-314"></a>    <span class="co"># print(fileList)</span></span>
<span id="cb4-315"><a href="#cb4-315"></a>    fileList.sort()</span>
<span id="cb4-316"><a href="#cb4-316"></a></span>
<span id="cb4-317"><a href="#cb4-317"></a>    <span class="co"># Now move to the work directory and clear old files</span></span>
<span id="cb4-318"><a href="#cb4-318"></a>    os.chdir(workdir)</span>
<span id="cb4-319"><a href="#cb4-319"></a>    os.system(<span class="st">'rm -f AQUA_MODIS.*L2.SST*'</span>)</span>
<span id="cb4-320"><a href="#cb4-320"></a>    os.system(<span class="st">'rm -f MB20*'</span>)</span>
<span id="cb4-321"><a href="#cb4-321"></a></span>
<span id="cb4-322"><a href="#cb4-322"></a>    <span class="co"># Prepare variables to accumulate point-cloud data and track provenance</span></span>
<span id="cb4-323"><a href="#cb4-323"></a>    temp_data <span class="op">=</span> <span class="va">None</span></span>
<span id="cb4-324"><a href="#cb4-324"></a>    filesUsed <span class="op">=</span> <span class="st">""</span></span>
<span id="cb4-325"><a href="#cb4-325"></a></span>
<span id="cb4-326"><a href="#cb4-326"></a>    <span class="co"># Loop through each swath filename for Day N</span></span>
<span id="cb4-327"><a href="#cb4-327"></a>    <span class="cf">for</span> fName <span class="kw">in</span> fileList:</span>
<span id="cb4-328"><a href="#cb4-328"></a>        fileName <span class="op">=</span> fName</span>
<span id="cb4-329"><a href="#cb4-329"></a></span>
<span id="cb4-330"><a href="#cb4-330"></a>        <span class="co"># Extract Hour-Of-Day (hod) from filename via</span></span>
<span id="cb4-331"><a href="#cb4-331"></a>        datetime <span class="op">=</span> re.search(<span class="st">'AQUA_MODIS.(.+?).L2.SST.NRT.nc'</span>, fileName)</span>
<span id="cb4-332"><a href="#cb4-332"></a>        hodstr <span class="op">=</span> datetime.group(<span class="dv">1</span>)[<span class="dv">9</span>:<span class="dv">11</span>]</span>
<span id="cb4-333"><a href="#cb4-333"></a>        hod <span class="op">=</span> <span class="bu">int</span>(hodstr)</span>
<span id="cb4-334"><a href="#cb4-334"></a></span>
<span id="cb4-335"><a href="#cb4-335"></a>        <span class="co"># Only process swaths acquired after hod &gt; 10 </span></span>
<span id="cb4-336"><a href="#cb4-336"></a>        <span class="cf">if</span> (hod <span class="op">&gt;</span> <span class="dv">10</span>):</span>
<span id="cb4-337"><a href="#cb4-337"></a>            <span class="bu">print</span>(hod)</span>
<span id="cb4-338"><a href="#cb4-338"></a>            <span class="bu">print</span>(fileName)</span>
<span id="cb4-339"><a href="#cb4-339"></a></span>
<span id="cb4-340"><a href="#cb4-340"></a>            <span class="co"># Copy swath from datadir into workdir for processing</span></span>
<span id="cb4-341"><a href="#cb4-341"></a>            shutil.copyfile(datadir <span class="op">+</span> fName, workdir <span class="op">+</span> fName)</span>
<span id="cb4-342"><a href="#cb4-342"></a></span>
<span id="cb4-343"><a href="#cb4-343"></a>            <span class="co"># Attempt to open the NetCDF; skip if unreadable</span></span>
<span id="cb4-344"><a href="#cb4-344"></a>            <span class="cf">try</span>:</span>
<span id="cb4-345"><a href="#cb4-345"></a>                rootgrp <span class="op">=</span> Dataset(fileName, <span class="st">'r'</span>)</span>
<span id="cb4-346"><a href="#cb4-346"></a>            <span class="cf">except</span> <span class="pp">IOError</span>:</span>
<span id="cb4-347"><a href="#cb4-347"></a>                <span class="bu">print</span>(<span class="st">"bad file "</span> <span class="op">+</span> fileName)</span>
<span id="cb4-348"><a href="#cb4-348"></a>                <span class="cf">continue</span></span>
<span id="cb4-349"><a href="#cb4-349"></a></span>
<span id="cb4-350"><a href="#cb4-350"></a>            <span class="co"># Extract navigation-group data</span></span>
<span id="cb4-351"><a href="#cb4-351"></a>            navDataGroup <span class="op">=</span> rootgrp.groups[<span class="st">'navigation_data'</span>]</span>
<span id="cb4-352"><a href="#cb4-352"></a>            latitude <span class="op">=</span> navDataGroup.variables[<span class="st">'latitude'</span>][:, :]</span>
<span id="cb4-353"><a href="#cb4-353"></a>            longitude <span class="op">=</span> navDataGroup.variables[<span class="st">'longitude'</span>][:, :]</span>
<span id="cb4-354"><a href="#cb4-354"></a></span>
<span id="cb4-355"><a href="#cb4-355"></a>            <span class="co"># Convert any negative longitudes to the 0-360° domain</span></span>
<span id="cb4-356"><a href="#cb4-356"></a>            longitude[longitude <span class="op">&lt;</span> <span class="dv">0</span>] <span class="op">=</span> longitude[longitude <span class="op">&lt;</span> <span class="dv">0</span>] <span class="op">+</span> <span class="dv">360</span></span>
<span id="cb4-357"><a href="#cb4-357"></a></span>
<span id="cb4-358"><a href="#cb4-358"></a>            <span class="co"># Compute swath extents (min/max) for geographic filtering</span></span>
<span id="cb4-359"><a href="#cb4-359"></a>            dataLonMin <span class="op">=</span> np.nanmin(longitude[longitude <span class="op">&gt;=</span> <span class="dv">0</span>])</span>
<span id="cb4-360"><a href="#cb4-360"></a>            dataLonMax <span class="op">=</span> np.nanmax(longitude[longitude <span class="op">&lt;=</span> <span class="dv">360</span>])</span>
<span id="cb4-361"><a href="#cb4-361"></a>            dataLatMin <span class="op">=</span> np.nanmin(latitude[latitude <span class="op">&gt;=</span> <span class="op">-</span><span class="dv">90</span>])</span>
<span id="cb4-362"><a href="#cb4-362"></a>            dataLatMax <span class="op">=</span> np.nanmax(latitude[latitude <span class="op">&lt;=</span> <span class="dv">90</span>])</span>
<span id="cb4-363"><a href="#cb4-363"></a></span>
<span id="cb4-364"><a href="#cb4-364"></a>            <span class="co"># Determine if swath overlaps our MB region (lon 120-320, lat -45-65)</span></span>
<span id="cb4-365"><a href="#cb4-365"></a>            goodLon1 <span class="op">=</span> (dataLonMin <span class="op">&lt;</span> lonmin) <span class="kw">and</span> (dataLonMax <span class="op">&gt;=</span> lonmin)</span>
<span id="cb4-366"><a href="#cb4-366"></a>            goodLon2 <span class="op">=</span> (dataLonMin <span class="op">&gt;=</span> lonmin) <span class="kw">and</span> (dataLonMin <span class="op">&lt;=</span> lonmax)</span>
<span id="cb4-367"><a href="#cb4-367"></a>            goodLon <span class="op">=</span> goodLon1 <span class="kw">or</span> goodLon2</span>
<span id="cb4-368"><a href="#cb4-368"></a></span>
<span id="cb4-369"><a href="#cb4-369"></a>            goodLat1 <span class="op">=</span> (dataLatMin <span class="op">&lt;</span> latmin) <span class="kw">and</span> (dataLatMax <span class="op">&gt;=</span> latmin)</span>
<span id="cb4-370"><a href="#cb4-370"></a>            goodLat2 <span class="op">=</span> (dataLatMin <span class="op">&gt;=</span> latmin) <span class="kw">and</span> (dataLatMin <span class="op">&lt;=</span> latmax)</span>
<span id="cb4-371"><a href="#cb4-371"></a>            goodLat <span class="op">=</span> goodLat1 <span class="kw">or</span> goodLat2</span>
<span id="cb4-372"><a href="#cb4-372"></a></span>
<span id="cb4-373"><a href="#cb4-373"></a>            <span class="co"># Check if swath is daytime (only keep "Day" pixels)</span></span>
<span id="cb4-374"><a href="#cb4-374"></a>            dayNightTest <span class="op">=</span> (rootgrp.day_night_flag <span class="op">==</span> <span class="st">'Day'</span>)</span>
<span id="cb4-375"><a href="#cb4-375"></a></span>
<span id="cb4-376"><a href="#cb4-376"></a>            <span class="co"># Only proceed if geography and day-night tests pass</span></span>
<span id="cb4-377"><a href="#cb4-377"></a>            <span class="cf">if</span> (goodLon <span class="kw">and</span> goodLat <span class="kw">and</span> dayNightTest):</span>
<span id="cb4-378"><a href="#cb4-378"></a>                <span class="co"># Add filename to provenance list</span></span>
<span id="cb4-379"><a href="#cb4-379"></a>                <span class="cf">if</span> (<span class="bu">len</span>(filesUsed) <span class="op">==</span> <span class="dv">0</span>):</span>
<span id="cb4-380"><a href="#cb4-380"></a>                    filesUsed <span class="op">=</span> fileName</span>
<span id="cb4-381"><a href="#cb4-381"></a>                <span class="cf">else</span>:</span>
<span id="cb4-382"><a href="#cb4-382"></a>                    filesUsed <span class="op">=</span> filesUsed <span class="op">+</span> <span class="st">', '</span> <span class="op">+</span> fileName</span>
<span id="cb4-383"><a href="#cb4-383"></a></span>
<span id="cb4-384"><a href="#cb4-384"></a>                <span class="co"># Extract geophysical data and reshape</span></span>
<span id="cb4-385"><a href="#cb4-385"></a>                longitude <span class="op">=</span> myReshape(longitude)</span>
<span id="cb4-386"><a href="#cb4-386"></a>                latitude <span class="op">=</span> myReshape(latitude)</span>
<span id="cb4-387"><a href="#cb4-387"></a>                geoDataGroup <span class="op">=</span> rootgrp.groups[<span class="st">'geophysical_data'</span>]</span>
<span id="cb4-388"><a href="#cb4-388"></a>                sst <span class="op">=</span> geoDataGroup.variables[<span class="st">'sst'</span>][:, :]</span>
<span id="cb4-389"><a href="#cb4-389"></a>                sst <span class="op">=</span> myReshape(sst)</span>
<span id="cb4-390"><a href="#cb4-390"></a>                qual_sst <span class="op">=</span> geoDataGroup.variables[<span class="st">'qual_sst'</span>][:, :]</span>
<span id="cb4-391"><a href="#cb4-391"></a>                qual_sst <span class="op">=</span> myReshape(qual_sst)</span>
<span id="cb4-392"><a href="#cb4-392"></a></span>
<span id="cb4-393"><a href="#cb4-393"></a>                <span class="co"># Filter out low-quality pixels (qual_sst &lt; 3)</span></span>
<span id="cb4-394"><a href="#cb4-394"></a>                qualTest <span class="op">=</span> qual_sst <span class="op">&lt;</span> <span class="dv">3</span></span>
<span id="cb4-395"><a href="#cb4-395"></a>                qualTest <span class="op">=</span> qual_sst <span class="op">&lt;</span> <span class="dv">3</span></span>
<span id="cb4-396"><a href="#cb4-396"></a>                qualTest <span class="op">=</span> qualTest.flatten()</span>
<span id="cb4-397"><a href="#cb4-397"></a></span>
<span id="cb4-398"><a href="#cb4-398"></a>                <span class="co"># Stack (lon, lat, sst) into a single 2D array with shape (N, 3)</span></span>
<span id="cb4-399"><a href="#cb4-399"></a>                dataOut <span class="op">=</span> np.hstack((longitude, latitude, sst))</span>
<span id="cb4-400"><a href="#cb4-400"></a></span>
<span id="cb4-401"><a href="#cb4-401"></a>                <span class="co"># Apply quality mask, valid SST &gt; -2°C and geographic bounds</span></span>
<span id="cb4-402"><a href="#cb4-402"></a>                dataOut <span class="op">=</span> dataOut[qualTest]</span>
<span id="cb4-403"><a href="#cb4-403"></a>                dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">2</span>] <span class="op">&gt;</span> <span class="op">-</span><span class="dv">2</span>]</span>
<span id="cb4-404"><a href="#cb4-404"></a>                dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">0</span>] <span class="op">&gt;</span> <span class="op">-</span><span class="dv">400</span>]</span>
<span id="cb4-405"><a href="#cb4-405"></a>                dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">0</span>] <span class="op">&gt;=</span> lonmin]</span>
<span id="cb4-406"><a href="#cb4-406"></a>                dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">0</span>] <span class="op">&lt;=</span> lonmax]</span>
<span id="cb4-407"><a href="#cb4-407"></a>                dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">1</span>] <span class="op">&lt;=</span> latmax]</span>
<span id="cb4-408"><a href="#cb4-408"></a></span>
<span id="cb4-409"><a href="#cb4-409"></a>                <span class="co"># Accumulate into temp_data array</span></span>
<span id="cb4-410"><a href="#cb4-410"></a>                <span class="cf">if</span> (dataOut.shape[<span class="dv">0</span>] <span class="op">&gt;</span> <span class="dv">0</span>):</span>
<span id="cb4-411"><a href="#cb4-411"></a>                    <span class="cf">if</span> (temp_data <span class="kw">is</span> <span class="va">None</span>):</span>
<span id="cb4-412"><a href="#cb4-412"></a>                        temp_data <span class="op">=</span> dataOut</span>
<span id="cb4-413"><a href="#cb4-413"></a>                    <span class="cf">else</span>:</span>
<span id="cb4-414"><a href="#cb4-414"></a>                        temp_data <span class="op">=</span> np.concatenate((temp_data, dataOut), axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb4-415"><a href="#cb4-415"></a></span>
<span id="cb4-416"><a href="#cb4-416"></a>            <span class="co"># Close the NetCDF and remove swath from workdir</span></span>
<span id="cb4-417"><a href="#cb4-417"></a>            rootgrp.close()</span>
<span id="cb4-418"><a href="#cb4-418"></a>            safe_remove(fileName)</span>
<span id="cb4-419"><a href="#cb4-419"></a></span>
<span id="cb4-420"><a href="#cb4-420"></a>    <span class="co"># Process swaths for Day N+1 (hod ≤ 10)</span></span>
<span id="cb4-421"><a href="#cb4-421"></a>    <span class="co"># Move back to data dir</span></span>
<span id="cb4-422"><a href="#cb4-422"></a>    <span class="bu">print</span>(datadir1)</span>
<span id="cb4-423"><a href="#cb4-423"></a>    os.chdir(datadir1)</span>
<span id="cb4-424"><a href="#cb4-424"></a></span>
<span id="cb4-425"><a href="#cb4-425"></a>    <span class="co"># Set up the string for file matching of doy+1</span></span>
<span id="cb4-426"><a href="#cb4-426"></a>    myString <span class="op">=</span> <span class="st">'AQUA_MODIS.'</span> <span class="op">+</span> year1 <span class="op">+</span> myMon1 <span class="op">+</span> myDay1  <span class="op">+</span> <span class="st">'*.L2.SST.NRT.nc'</span></span>
<span id="cb4-427"><a href="#cb4-427"></a>    fileList <span class="op">=</span> glob.glob(myString)</span>
<span id="cb4-428"><a href="#cb4-428"></a>    fileList.sort()</span>
<span id="cb4-429"><a href="#cb4-429"></a></span>
<span id="cb4-430"><a href="#cb4-430"></a>    <span class="co"># Switch back to workdir for processing</span></span>
<span id="cb4-431"><a href="#cb4-431"></a>    os.chdir(workdir)</span>
<span id="cb4-432"><a href="#cb4-432"></a>    <span class="cf">for</span> fName <span class="kw">in</span> fileList:</span>
<span id="cb4-433"><a href="#cb4-433"></a>        fileName <span class="op">=</span> fName</span>
<span id="cb4-434"><a href="#cb4-434"></a></span>
<span id="cb4-435"><a href="#cb4-435"></a>        <span class="co"># Extract hod again</span></span>
<span id="cb4-436"><a href="#cb4-436"></a>        datetime <span class="op">=</span> re.search(<span class="st">'AQUA_MODIS.(.+?).L2.SST.NRT.nc'</span>, fileName)</span>
<span id="cb4-437"><a href="#cb4-437"></a>        hodstr <span class="op">=</span> datetime.group(<span class="dv">1</span>)[<span class="dv">9</span>:<span class="dv">11</span>]</span>
<span id="cb4-438"><a href="#cb4-438"></a>        hod <span class="op">=</span> <span class="bu">int</span>(hodstr)</span>
<span id="cb4-439"><a href="#cb4-439"></a></span>
<span id="cb4-440"><a href="#cb4-440"></a>        <span class="co"># Only process early swaths (hod ≤ 10) from Day N+1</span></span>
<span id="cb4-441"><a href="#cb4-441"></a>        <span class="cf">if</span> (hod <span class="op">&lt;=</span> <span class="dv">10</span>):</span>
<span id="cb4-442"><a href="#cb4-442"></a>            <span class="bu">print</span>(hod)</span>
<span id="cb4-443"><a href="#cb4-443"></a>            <span class="bu">print</span>(fileName)</span>
<span id="cb4-444"><a href="#cb4-444"></a></span>
<span id="cb4-445"><a href="#cb4-445"></a>            <span class="co"># cp file from work directory to</span></span>
<span id="cb4-446"><a href="#cb4-446"></a>            shutil.copyfile(datadir1 <span class="op">+</span> fName, workdir <span class="op">+</span> fName)</span>
<span id="cb4-447"><a href="#cb4-447"></a>            <span class="cf">try</span>:</span>
<span id="cb4-448"><a href="#cb4-448"></a>                rootgrp <span class="op">=</span> Dataset(fileName, <span class="st">'r'</span>)</span>
<span id="cb4-449"><a href="#cb4-449"></a>            <span class="cf">except</span> <span class="pp">IOError</span>:</span>
<span id="cb4-450"><a href="#cb4-450"></a>                <span class="bu">print</span>(<span class="st">"bad file "</span> <span class="op">+</span> fileName)</span>
<span id="cb4-451"><a href="#cb4-451"></a>                <span class="cf">continue</span></span>
<span id="cb4-452"><a href="#cb4-452"></a></span>
<span id="cb4-453"><a href="#cb4-453"></a>            navDataGroup <span class="op">=</span> rootgrp.groups[<span class="st">'navigation_data'</span>]</span>
<span id="cb4-454"><a href="#cb4-454"></a>            latitude <span class="op">=</span> navDataGroup.variables[<span class="st">'latitude'</span>][:, :]</span>
<span id="cb4-455"><a href="#cb4-455"></a>            longitude <span class="op">=</span> navDataGroup.variables[<span class="st">'longitude'</span>][:, :]</span>
<span id="cb4-456"><a href="#cb4-456"></a>            longitude[longitude <span class="op">&lt;</span> <span class="dv">0</span>] <span class="op">=</span> longitude[longitude <span class="op">&lt;</span> <span class="dv">0</span>] <span class="op">+</span> <span class="dv">360</span></span>
<span id="cb4-457"><a href="#cb4-457"></a>            dataLonMin <span class="op">=</span> np.nanmin(longitude[longitude <span class="op">&gt;=</span> <span class="dv">0</span>])</span>
<span id="cb4-458"><a href="#cb4-458"></a>            dataLonMax <span class="op">=</span> np.nanmax(longitude[longitude <span class="op">&lt;=</span> <span class="dv">360</span>])</span>
<span id="cb4-459"><a href="#cb4-459"></a>            dataLatMin <span class="op">=</span> np.nanmin(latitude[latitude <span class="op">&gt;=</span> <span class="op">-</span><span class="dv">90</span>] )</span>
<span id="cb4-460"><a href="#cb4-460"></a>            dataLatMax <span class="op">=</span> np.nanmax(latitude[latitude <span class="op">&lt;=</span> <span class="dv">90</span>] )</span>
<span id="cb4-461"><a href="#cb4-461"></a></span>
<span id="cb4-462"><a href="#cb4-462"></a>            goodLon1 <span class="op">=</span> (dataLonMin <span class="op">&lt;</span> lonmin) <span class="kw">and</span> ( dataLonMax <span class="op">&gt;=</span> lonmin)</span>
<span id="cb4-463"><a href="#cb4-463"></a>            goodLon2 <span class="op">=</span> (dataLonMin <span class="op">&gt;=</span> lonmin) <span class="kw">and</span> (dataLonMin <span class="op">&lt;=</span> lonmax)</span>
<span id="cb4-464"><a href="#cb4-464"></a>            goodLon <span class="op">=</span> goodLon1 <span class="kw">or</span> goodLon2</span>
<span id="cb4-465"><a href="#cb4-465"></a>            goodLat1 <span class="op">=</span> (dataLatMin <span class="op">&lt;</span> latmin) <span class="kw">and</span> (dataLatMax <span class="op">&gt;=</span> latmin)</span>
<span id="cb4-466"><a href="#cb4-466"></a>            goodLat2 <span class="op">=</span> (dataLatMin <span class="op">&gt;=</span> latmin) <span class="kw">and</span> (dataLatMin <span class="op">&lt;=</span> latmax)</span>
<span id="cb4-467"><a href="#cb4-467"></a>            goodLat <span class="op">=</span> goodLat1 <span class="kw">or</span> goodLat2</span>
<span id="cb4-468"><a href="#cb4-468"></a></span>
<span id="cb4-469"><a href="#cb4-469"></a>            dayNightTest <span class="op">=</span> (rootgrp.day_night_flag <span class="op">==</span> <span class="st">'Day'</span>)</span>
<span id="cb4-470"><a href="#cb4-470"></a></span>
<span id="cb4-471"><a href="#cb4-471"></a>            <span class="cf">if</span> (goodLon <span class="kw">and</span> goodLat <span class="kw">and</span> dayNightTest):</span>
<span id="cb4-472"><a href="#cb4-472"></a>                <span class="cf">if</span> (<span class="bu">len</span>(filesUsed) <span class="op">==</span> <span class="dv">0</span>):</span>
<span id="cb4-473"><a href="#cb4-473"></a>                    filesUsed <span class="op">=</span> fileName</span>
<span id="cb4-474"><a href="#cb4-474"></a>                <span class="cf">else</span>:</span>
<span id="cb4-475"><a href="#cb4-475"></a>                    filesUsed <span class="op">=</span> filesUsed <span class="op">+</span> <span class="st">', '</span> <span class="op">+</span> fileName</span>
<span id="cb4-476"><a href="#cb4-476"></a></span>
<span id="cb4-477"><a href="#cb4-477"></a>                longitude <span class="op">=</span> myReshape(longitude)</span>
<span id="cb4-478"><a href="#cb4-478"></a>                latitude <span class="op">=</span> myReshape(latitude)</span>
<span id="cb4-479"><a href="#cb4-479"></a>                geoDataGroup <span class="op">=</span> rootgrp.groups[<span class="st">'geophysical_data'</span>]</span>
<span id="cb4-480"><a href="#cb4-480"></a>                sst <span class="op">=</span> geoDataGroup.variables[<span class="st">'sst'</span>][:, :]</span>
<span id="cb4-481"><a href="#cb4-481"></a>                sst <span class="op">=</span> myReshape(sst)</span>
<span id="cb4-482"><a href="#cb4-482"></a>                qual_sst <span class="op">=</span> geoDataGroup.variables[<span class="st">'qual_sst'</span>][:, :]</span>
<span id="cb4-483"><a href="#cb4-483"></a>                qual_sst <span class="op">=</span> myReshape(qual_sst)</span>
<span id="cb4-484"><a href="#cb4-484"></a>                qualTest <span class="op">=</span> qual_sst <span class="op">&lt;</span> <span class="dv">3</span></span>
<span id="cb4-485"><a href="#cb4-485"></a>                qualTest <span class="op">=</span> qualTest.flatten()</span>
<span id="cb4-486"><a href="#cb4-486"></a></span>
<span id="cb4-487"><a href="#cb4-487"></a>                dataOut <span class="op">=</span> np.hstack((longitude, latitude, sst))</span>
<span id="cb4-488"><a href="#cb4-488"></a>                dataOut <span class="op">=</span> dataOut[qualTest]</span>
<span id="cb4-489"><a href="#cb4-489"></a>                dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">2</span>] <span class="op">&gt;</span> <span class="op">-</span><span class="dv">2</span>]</span>
<span id="cb4-490"><a href="#cb4-490"></a>                dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">0</span>] <span class="op">&gt;</span> <span class="op">-</span><span class="dv">400</span>]</span>
<span id="cb4-491"><a href="#cb4-491"></a>                dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">0</span>] <span class="op">&gt;=</span> lonmin]</span>
<span id="cb4-492"><a href="#cb4-492"></a>                dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">0</span>] <span class="op">&lt;=</span> lonmax]</span>
<span id="cb4-493"><a href="#cb4-493"></a>                dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">1</span>] <span class="op">&gt;=</span> latmin]</span>
<span id="cb4-494"><a href="#cb4-494"></a>                dataOut <span class="op">=</span> dataOut[dataOut[:, <span class="dv">1</span>] <span class="op">&lt;=</span> latmax]</span>
<span id="cb4-495"><a href="#cb4-495"></a>    </span>
<span id="cb4-496"><a href="#cb4-496"></a>                <span class="cf">if</span> (dataOut.shape[<span class="dv">0</span>] <span class="op">&gt;</span> <span class="dv">0</span>):</span>
<span id="cb4-497"><a href="#cb4-497"></a>                    <span class="cf">if</span> (temp_data <span class="kw">is</span> <span class="va">None</span>):</span>
<span id="cb4-498"><a href="#cb4-498"></a>                        temp_data <span class="op">=</span> dataOut</span>
<span id="cb4-499"><a href="#cb4-499"></a>                    <span class="cf">else</span>:</span>
<span id="cb4-500"><a href="#cb4-500"></a>                        temp_data <span class="op">=</span> np.concatenate((temp_data, dataOut), axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb4-501"><a href="#cb4-501"></a></span>
<span id="cb4-502"><a href="#cb4-502"></a>            <span class="co"># Close the NetCDF and remove swath from workdir</span></span>
<span id="cb4-503"><a href="#cb4-503"></a>            rootgrp.close()</span>
<span id="cb4-504"><a href="#cb4-504"></a>            safe_remove(fileName)</span>
<span id="cb4-505"><a href="#cb4-505"></a></span>
<span id="cb4-506"><a href="#cb4-506"></a>    <span class="co"># Build GMT grid from accumulated point cloud</span></span>
<span id="cb4-507"><a href="#cb4-507"></a>    <span class="co"># Define output grid filename for PyGMT</span></span>
<span id="cb4-508"><a href="#cb4-508"></a>    fileOut <span class="op">=</span> <span class="st">'MB'</span> <span class="op">+</span> year <span class="op">+</span> doy <span class="op">+</span> <span class="st">'_'</span> <span class="op">+</span> year <span class="op">+</span> doy <span class="op">+</span> <span class="st">'_sstd.grd'</span></span>
<span id="cb4-509"><a href="#cb4-509"></a>    <span class="bu">range</span> <span class="op">=</span> <span class="st">'120/320/-45/65'</span></span>
<span id="cb4-510"><a href="#cb4-510"></a>    increment <span class="op">=</span> <span class="st">'0.025/0.025'</span></span>
<span id="cb4-511"><a href="#cb4-511"></a></span>
<span id="cb4-512"><a href="#cb4-512"></a>    <span class="co"># Use PyGMT xyz2grd to interpolate scattered (lon, lat, sst) into a regular grid</span></span>
<span id="cb4-513"><a href="#cb4-513"></a>    temp_data1 <span class="op">=</span> pygmt.xyz2grd(</span>
<span id="cb4-514"><a href="#cb4-514"></a>        data<span class="op">=</span>temp_data,</span>
<span id="cb4-515"><a href="#cb4-515"></a>        region<span class="op">=</span><span class="bu">range</span>,</span>
<span id="cb4-516"><a href="#cb4-516"></a>        spacing<span class="op">=</span>increment,</span>
<span id="cb4-517"><a href="#cb4-517"></a>    )</span>
<span id="cb4-518"><a href="#cb4-518"></a></span>
<span id="cb4-519"><a href="#cb4-519"></a>    <span class="co"># Convert GMT grid to CF-compliant NetCDF and send to server</span></span>
<span id="cb4-520"><a href="#cb4-520"></a>    ncFile <span class="op">=</span> grd2netcdf1(temp_data1, fileOut, filesUsed, my_mask, <span class="st">'MB'</span>)</span>
<span id="cb4-521"><a href="#cb4-521"></a></span>
<span id="cb4-522"><a href="#cb4-522"></a>    <span class="co">#myCmd = "mv " + ncFile + " /home/cwatch/pygmt_test/outfiles"</span></span>
<span id="cb4-523"><a href="#cb4-523"></a>    <span class="co">#os.system(myCmd)</span></span>
<span id="cb4-524"><a href="#cb4-524"></a></span>
<span id="cb4-525"><a href="#cb4-525"></a>    <span class="co"># Copy the resulting NetCDF to the "MB" server folder for 1-day products</span></span>
<span id="cb4-526"><a href="#cb4-526"></a>    send_to_servers(ncFile, <span class="st">'/MB/sstd/'</span>, <span class="st">'1'</span>)</span>
<span id="cb4-527"><a href="#cb4-527"></a></span>
<span id="cb4-528"><a href="#cb4-528"></a>    <span class="co"># Remove local NetCDF copy from working directory</span></span>
<span id="cb4-529"><a href="#cb4-529"></a>    os.remove(ncFile)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="compmbsst" class="level3">
<h3 class="anchored" data-anchor-id="compmbsst">CompMBSST</h3>
<p><code>CompMBSST.py</code> makes the 3, 5, 8, 14-day SST composites by averaging 1-day MB SST NetCDF files over user-specified interval of days, accumulates running sum and count arrays on a 0.025° × 0.025° regular grid spanning longitude 120°–320° and latitude –45°–65°. It accumulates running sums and counts, masks out unobserved pixels, writes a CF-compliant NetCDF, and uploads the result to a directory on the remote server. Find the multi-day products on ERDDAP <a href="./modisa_scripts.html#modisa-products-on-swfsc-erddap-server">here</a>.</p>
<p>The following chart summarizes the script’s workflow:</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">%%{init: {"flowchart":{"htmlLabels":true}}}%%
flowchart LR
  I("&lt;b&gt;Inputs&lt;/b&gt;&lt;br/&gt;• 1-day SST NetCDFs (dataDir)&lt;br/&gt;• workDir&lt;br/&gt;• endYear &amp; endDoy&lt;br/&gt;• interval (days)")
    --&gt; P("&lt;b&gt;Processing&lt;/b&gt;&lt;br/&gt;• Compute start/end dates&lt;br/&gt;• Initialize mean/num arrays&lt;br/&gt;• Gather daily files&lt;br/&gt;• Loop: open each file, extract &amp; squeeze variable&lt;br/&gt;• Update running mean &amp; count&lt;br/&gt;• Mask pixels with zero observations")
    --&gt; O("&lt;b&gt;Output&lt;/b&gt;&lt;br/&gt;• CF-compliant multi-day composite SST NetCDF&lt;br/&gt;• Deployed to /MB/sstd/")
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<div id="60db6fb5" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>View CompMBSST.py</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1"></a><span class="co">"""</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="co">Overview</span></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="co">--------</span></span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="co">Compute multi-day SST composites for the MODIS “MB” (Pacific Ocean) dataset by averaging</span></span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="co">daily 1-day NetCDF SST files over a specified interval of days (e.g., 3, 5, 8, or 14).</span></span>
<span id="cb5-6"><a href="#cb5-6"></a></span>
<span id="cb5-7"><a href="#cb5-7"></a><span class="co">Usage</span></span>
<span id="cb5-8"><a href="#cb5-8"></a><span class="co">-----</span></span>
<span id="cb5-9"><a href="#cb5-9"></a><span class="co">::</span></span>
<span id="cb5-10"><a href="#cb5-10"></a><span class="co">  </span></span>
<span id="cb5-11"><a href="#cb5-11"></a><span class="co">    python CompMBSST.py &lt;dataDir&gt; &lt;workDir&gt; &lt;endYear&gt; &lt;endDoy&gt; &lt;interval&gt;</span></span>
<span id="cb5-12"><a href="#cb5-12"></a></span>
<span id="cb5-13"><a href="#cb5-13"></a><span class="co">Where:</span></span>
<span id="cb5-14"><a href="#cb5-14"></a></span>
<span id="cb5-15"><a href="#cb5-15"></a><span class="co">- ``dataDir``</span></span>
<span id="cb5-16"><a href="#cb5-16"></a></span>
<span id="cb5-17"><a href="#cb5-17"></a><span class="co">  Directory containing daily 1-day SST NetCDF files named ``MB&lt;YYYY&gt;&lt;DDD&gt;*sstd.nc``.</span></span>
<span id="cb5-18"><a href="#cb5-18"></a></span>
<span id="cb5-19"><a href="#cb5-19"></a><span class="co">- ``workDir``</span></span>
<span id="cb5-20"><a href="#cb5-20"></a></span>
<span id="cb5-21"><a href="#cb5-21"></a><span class="co">  Temporary working directory for intermediate files.</span></span>
<span id="cb5-22"><a href="#cb5-22"></a></span>
<span id="cb5-23"><a href="#cb5-23"></a><span class="co">- ``endYear``</span></span>
<span id="cb5-24"><a href="#cb5-24"></a></span>
<span id="cb5-25"><a href="#cb5-25"></a><span class="co">  Four-digit year of the last day in the composite (e.g., ``2025``).</span></span>
<span id="cb5-26"><a href="#cb5-26"></a></span>
<span id="cb5-27"><a href="#cb5-27"></a><span class="co">- ``endDoy``</span></span>
<span id="cb5-28"><a href="#cb5-28"></a></span>
<span id="cb5-29"><a href="#cb5-29"></a><span class="co">  Three-digit day-of-year of the last day (e.g., ``082``).</span></span>
<span id="cb5-30"><a href="#cb5-30"></a></span>
<span id="cb5-31"><a href="#cb5-31"></a><span class="co">- ``interval``</span></span>
<span id="cb5-32"><a href="#cb5-32"></a></span>
<span id="cb5-33"><a href="#cb5-33"></a><span class="co">  Number of days to include (e.g., `3`, `5`, `8`, `14`).</span></span>
<span id="cb5-34"><a href="#cb5-34"></a></span>
<span id="cb5-35"><a href="#cb5-35"></a><span class="co">Description</span></span>
<span id="cb5-36"><a href="#cb5-36"></a><span class="co">-----------</span></span>
<span id="cb5-37"><a href="#cb5-37"></a><span class="co">1. **Parse arguments &amp; compute interval**</span></span>
<span id="cb5-38"><a href="#cb5-38"></a></span>
<span id="cb5-39"><a href="#cb5-39"></a><span class="co">  - Read ``dataDir``, ``workDir``, ``endYear``, ``endDoy``, and ``interval`` from ``sys.argv``.</span></span>
<span id="cb5-40"><a href="#cb5-40"></a></span>
<span id="cb5-41"><a href="#cb5-41"></a><span class="co">  - Compute ``startDoy = endDoy - interval + 1`` and zero-pad DOY strings.</span></span>
<span id="cb5-42"><a href="#cb5-42"></a></span>
<span id="cb5-43"><a href="#cb5-43"></a><span class="co">2. **Compute calendar dates**</span></span>
<span id="cb5-44"><a href="#cb5-44"></a></span>
<span id="cb5-45"><a href="#cb5-45"></a><span class="co">  - Convert ``endYear`` + ``endDoy`` to a ``datetime`` (``myDateEnd``).</span></span>
<span id="cb5-46"><a href="#cb5-46"></a><span class="co">  </span></span>
<span id="cb5-47"><a href="#cb5-47"></a><span class="co">  - Compute ``myDateStart = myDateEnd - (interval - 1)`` days.</span></span>
<span id="cb5-48"><a href="#cb5-48"></a></span>
<span id="cb5-49"><a href="#cb5-49"></a><span class="co">3. **Initialize accumulators**</span></span>
<span id="cb5-50"><a href="#cb5-50"></a></span>
<span id="cb5-51"><a href="#cb5-51"></a><span class="co">  - Clear ``workDir`` of old files.</span></span>
<span id="cb5-52"><a href="#cb5-52"></a></span>
<span id="cb5-53"><a href="#cb5-53"></a><span class="co">  - Preallocate ``mean`` and ``num`` arrays of shape (4401, 8001) for running sum and counts.</span></span>
<span id="cb5-54"><a href="#cb5-54"></a></span>
<span id="cb5-55"><a href="#cb5-55"></a><span class="co">4. **Gather daily files**</span></span>
<span id="cb5-56"><a href="#cb5-56"></a></span>
<span id="cb5-57"><a href="#cb5-57"></a><span class="co">  - If ``startDoy ≤ endDoy``, collect files for DOYs ``startDoy…endDoy``; else handle wrap-around at year end by collecting ``startDoy…yearEnd`` and ``1…endDoy``.</span></span>
<span id="cb5-58"><a href="#cb5-58"></a></span>
<span id="cb5-59"><a href="#cb5-59"></a><span class="co">5. **Accumulate SST**</span></span>
<span id="cb5-60"><a href="#cb5-60"></a></span>
<span id="cb5-61"><a href="#cb5-61"></a><span class="co">  - For each NetCDF:</span></span>
<span id="cb5-62"><a href="#cb5-62"></a></span>
<span id="cb5-63"><a href="#cb5-63"></a><span class="co">     - Open via ``Dataset()``.</span></span>
<span id="cb5-64"><a href="#cb5-64"></a></span>
<span id="cb5-65"><a href="#cb5-65"></a><span class="co">     - Read 4-D variable ``MBsstd``, squeeze to 2-D array.</span></span>
<span id="cb5-66"><a href="#cb5-66"></a></span>
<span id="cb5-67"><a href="#cb5-67"></a><span class="co">     - Update ``mean, num`` with ``meanVar(mean, num, sst)``.</span></span>
<span id="cb5-68"><a href="#cb5-68"></a></span>
<span id="cb5-69"><a href="#cb5-69"></a><span class="co">6. **Mask and finalize**</span></span>
<span id="cb5-70"><a href="#cb5-70"></a></span>
<span id="cb5-71"><a href="#cb5-71"></a><span class="co">  - Mask pixels with zero observations (``num == 0``), fill with ``-9999999.``.</span></span>
<span id="cb5-72"><a href="#cb5-72"></a></span>
<span id="cb5-73"><a href="#cb5-73"></a><span class="co">7. **Write &amp; deploy**</span></span>
<span id="cb5-74"><a href="#cb5-74"></a></span>
<span id="cb5-75"><a href="#cb5-75"></a><span class="co">  - Change back to ``workDir``.</span></span>
<span id="cb5-76"><a href="#cb5-76"></a></span>
<span id="cb5-77"><a href="#cb5-77"></a><span class="co">  - Build ``outFile = MB&lt;startYear&gt;&lt;startDoy&gt;_&lt;endYear&gt;&lt;endDoy&gt;_sstd.nc``.</span></span>
<span id="cb5-78"><a href="#cb5-78"></a></span>
<span id="cb5-79"><a href="#cb5-79"></a><span class="co">  - Call ``makeNetcdf(mean, num, interval, outFile, filesUsed, workDir)`` to write CF-compliant NetCDF.</span></span>
<span id="cb5-80"><a href="#cb5-80"></a></span>
<span id="cb5-81"><a href="#cb5-81"></a><span class="co">  - Upload via ``send_to_servers(ncFile, '/MB/sstd/', str(interval))``.</span></span>
<span id="cb5-82"><a href="#cb5-82"></a></span>
<span id="cb5-83"><a href="#cb5-83"></a><span class="co">Dependencies</span></span>
<span id="cb5-84"><a href="#cb5-84"></a><span class="co">------------</span></span>
<span id="cb5-85"><a href="#cb5-85"></a><span class="co">- **Python 3.x**</span></span>
<span id="cb5-86"><a href="#cb5-86"></a></span>
<span id="cb5-87"><a href="#cb5-87"></a><span class="co">- **Standard library:** ``os``, ``sys``, ``glob``, ``itertools.chain``, ``datetime``, ``timedelta``</span></span>
<span id="cb5-88"><a href="#cb5-88"></a></span>
<span id="cb5-89"><a href="#cb5-89"></a><span class="co">- **Third-party:** ``numpy``, ``numpy.ma``, ``netCDF4.Dataset``</span></span>
<span id="cb5-90"><a href="#cb5-90"></a></span>
<span id="cb5-91"><a href="#cb5-91"></a><span class="co">- **Custom roylib functions:**</span></span>
<span id="cb5-92"><a href="#cb5-92"></a></span>
<span id="cb5-93"><a href="#cb5-93"></a><span class="co">  - ``isleap(year)``</span></span>
<span id="cb5-94"><a href="#cb5-94"></a></span>
<span id="cb5-95"><a href="#cb5-95"></a><span class="co">  - ``meanVar(mean, num, array)``</span></span>
<span id="cb5-96"><a href="#cb5-96"></a></span>
<span id="cb5-97"><a href="#cb5-97"></a><span class="co">  - ``makeNetcdf(mean, num, interval, outFile, filesUsed, workDir)``</span></span>
<span id="cb5-98"><a href="#cb5-98"></a></span>
<span id="cb5-99"><a href="#cb5-99"></a><span class="co">  - ``send_to_servers(ncFile, remote_dir, interval_flag)``</span></span>
<span id="cb5-100"><a href="#cb5-100"></a></span>
<span id="cb5-101"><a href="#cb5-101"></a><span class="co">Directory Structure</span></span>
<span id="cb5-102"><a href="#cb5-102"></a><span class="co">-------------------</span></span>
<span id="cb5-103"><a href="#cb5-103"></a><span class="co">- **Input Directory** (``dataDir``):</span></span>
<span id="cb5-104"><a href="#cb5-104"></a></span>
<span id="cb5-105"><a href="#cb5-105"></a><span class="co">  Contains daily files ``MB&lt;YYYY&gt;&lt;DDD&gt;*sstd.nc``.</span></span>
<span id="cb5-106"><a href="#cb5-106"></a></span>
<span id="cb5-107"><a href="#cb5-107"></a><span class="co">- **Working Directory** (``workDir``):</span></span>
<span id="cb5-108"><a href="#cb5-108"></a></span>
<span id="cb5-109"><a href="#cb5-109"></a><span class="co">  Temporary staging and output location.</span></span>
<span id="cb5-110"><a href="#cb5-110"></a></span>
<span id="cb5-111"><a href="#cb5-111"></a><span class="co">- **Output location** (remote):</span></span>
<span id="cb5-112"><a href="#cb5-112"></a></span>
<span id="cb5-113"><a href="#cb5-113"></a><span class="co">  Copied to ``/MB/sstd/`` with the interval flag.</span></span>
<span id="cb5-114"><a href="#cb5-114"></a></span>
<span id="cb5-115"><a href="#cb5-115"></a><span class="co">Usage Example</span></span>
<span id="cb5-116"><a href="#cb5-116"></a><span class="co">-------------</span></span>
<span id="cb5-117"><a href="#cb5-117"></a><span class="co">Create a 5-day SST composite from DOY 001 to 005 of 2025:</span></span>
<span id="cb5-118"><a href="#cb5-118"></a></span>
<span id="cb5-119"><a href="#cb5-119"></a><span class="co">::</span></span>
<span id="cb5-120"><a href="#cb5-120"></a><span class="co"> </span></span>
<span id="cb5-121"><a href="#cb5-121"></a><span class="co">   python CompMBSST.py /data/modisgf/1day/ /tmp/mw_work/ 2025 005 5</span></span>
<span id="cb5-122"><a href="#cb5-122"></a></span>
<span id="cb5-123"><a href="#cb5-123"></a><span class="co">This will average files MB2025001*… through MB2025005*, write ``MB2025001_2025005_sstd.nc`` in ``/tmp/mw_work/``, and upload to ``/MB/sstd/``.</span></span>
<span id="cb5-124"><a href="#cb5-124"></a><span class="co">"""</span></span>
<span id="cb5-125"><a href="#cb5-125"></a><span class="im">from</span> __future__ <span class="im">import</span> print_function</span>
<span id="cb5-126"><a href="#cb5-126"></a><span class="im">from</span> builtins <span class="im">import</span> <span class="bu">str</span></span>
<span id="cb5-127"><a href="#cb5-127"></a><span class="im">from</span> builtins <span class="im">import</span> <span class="bu">range</span></span>
<span id="cb5-128"><a href="#cb5-128"></a></span>
<span id="cb5-129"><a href="#cb5-129"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb5-130"><a href="#cb5-130"></a>    <span class="im">from</span> datetime <span class="im">import</span> datetime, timedelta</span>
<span id="cb5-131"><a href="#cb5-131"></a>    <span class="im">import</span> glob</span>
<span id="cb5-132"><a href="#cb5-132"></a>    <span class="im">from</span> itertools <span class="im">import</span> chain</span>
<span id="cb5-133"><a href="#cb5-133"></a>    <span class="im">from</span> netCDF4 <span class="im">import</span> Dataset</span>
<span id="cb5-134"><a href="#cb5-134"></a>    <span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb5-135"><a href="#cb5-135"></a>    <span class="im">import</span> numpy.ma <span class="im">as</span> ma</span>
<span id="cb5-136"><a href="#cb5-136"></a>    <span class="im">import</span> os</span>
<span id="cb5-137"><a href="#cb5-137"></a>    <span class="im">import</span> sys</span>
<span id="cb5-138"><a href="#cb5-138"></a></span>
<span id="cb5-139"><a href="#cb5-139"></a>    <span class="co"># Ensure 'roylib' is on the import path</span></span>
<span id="cb5-140"><a href="#cb5-140"></a>    sys.path.append(<span class="st">'/home/cwatch/pythonLibs'</span>)</span>
<span id="cb5-141"><a href="#cb5-141"></a>    <span class="im">from</span> roylib <span class="im">import</span> <span class="op">*</span></span>
<span id="cb5-142"><a href="#cb5-142"></a></span>
<span id="cb5-143"><a href="#cb5-143"></a>    <span class="co"># Directory with 1-day SST NetCDFs</span></span>
<span id="cb5-144"><a href="#cb5-144"></a>    dataDir <span class="op">=</span> sys.argv[<span class="dv">1</span>]</span>
<span id="cb5-145"><a href="#cb5-145"></a></span>
<span id="cb5-146"><a href="#cb5-146"></a>    <span class="co"># Temporary working directory</span></span>
<span id="cb5-147"><a href="#cb5-147"></a>    workDir <span class="op">=</span> sys.argv[<span class="dv">2</span>]</span>
<span id="cb5-148"><a href="#cb5-148"></a></span>
<span id="cb5-149"><a href="#cb5-149"></a>    <span class="co"># Composite end year (YYYY)</span></span>
<span id="cb5-150"><a href="#cb5-150"></a>    endyearC <span class="op">=</span> sys.argv[<span class="dv">3</span>]</span>
<span id="cb5-151"><a href="#cb5-151"></a></span>
<span id="cb5-152"><a href="#cb5-152"></a>    <span class="co"># Composite end day-of-year (DDD)</span></span>
<span id="cb5-153"><a href="#cb5-153"></a>    endDoyC <span class="op">=</span> sys.argv[<span class="dv">4</span>]</span>
<span id="cb5-154"><a href="#cb5-154"></a>    endDoyC <span class="op">=</span> endDoyC.rjust(<span class="dv">3</span>, <span class="st">'0'</span>)</span>
<span id="cb5-155"><a href="#cb5-155"></a></span>
<span id="cb5-156"><a href="#cb5-156"></a>    <span class="co"># Integer form of end day-of-year</span></span>
<span id="cb5-157"><a href="#cb5-157"></a>    endDoy <span class="op">=</span> <span class="bu">int</span>(endDoyC)</span>
<span id="cb5-158"><a href="#cb5-158"></a></span>
<span id="cb5-159"><a href="#cb5-159"></a>    <span class="co"># Composite length as string</span></span>
<span id="cb5-160"><a href="#cb5-160"></a>    intervalC <span class="op">=</span> sys.argv[<span class="dv">5</span>]</span>
<span id="cb5-161"><a href="#cb5-161"></a>    interval <span class="op">=</span> <span class="bu">int</span>(intervalC)</span>
<span id="cb5-162"><a href="#cb5-162"></a></span>
<span id="cb5-163"><a href="#cb5-163"></a>    <span class="co"># Convert end Doy to calendar date</span></span>
<span id="cb5-164"><a href="#cb5-164"></a>    myDateEnd <span class="op">=</span> datetime(<span class="bu">int</span>(endyearC), <span class="dv">1</span>, <span class="dv">1</span>) <span class="op">+</span> timedelta(<span class="bu">int</span>(endDoyC) <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb5-165"><a href="#cb5-165"></a></span>
<span id="cb5-166"><a href="#cb5-166"></a>    <span class="co"># Start date = end date minus (interval-1) days</span></span>
<span id="cb5-167"><a href="#cb5-167"></a>    myDateStart <span class="op">=</span> myDateEnd <span class="op">+</span> timedelta(days<span class="op">=-</span>(interval <span class="op">-</span> <span class="dv">1</span>))</span>
<span id="cb5-168"><a href="#cb5-168"></a></span>
<span id="cb5-169"><a href="#cb5-169"></a>    <span class="co"># Zero-padded start Doy and year</span></span>
<span id="cb5-170"><a href="#cb5-170"></a>    startDoyC <span class="op">=</span> myDateStart.strftime(<span class="st">"%j"</span>).zfill(<span class="dv">3</span>)</span>
<span id="cb5-171"><a href="#cb5-171"></a>    startDoy <span class="op">=</span> <span class="bu">int</span>(startDoyC)</span>
<span id="cb5-172"><a href="#cb5-172"></a>    startYearC <span class="op">=</span> <span class="bu">str</span>(myDateStart.year)</span>
<span id="cb5-173"><a href="#cb5-173"></a></span>
<span id="cb5-174"><a href="#cb5-174"></a>    <span class="co"># Prepare output directory</span></span>
<span id="cb5-175"><a href="#cb5-175"></a>    outDir <span class="op">=</span> <span class="st">'/ERDData1/modisa/data/modisgf/'</span> <span class="op">+</span> endyearC <span class="op">+</span> <span class="st">'/'</span> <span class="op">+</span> intervalC <span class="op">+</span> <span class="st">'day'</span></span>
<span id="cb5-176"><a href="#cb5-176"></a></span>
<span id="cb5-177"><a href="#cb5-177"></a>    <span class="bu">print</span>(dataDir)</span>
<span id="cb5-178"><a href="#cb5-178"></a>    <span class="bu">print</span>(workDir)</span>
<span id="cb5-179"><a href="#cb5-179"></a>    <span class="bu">print</span>(endyearC)</span>
<span id="cb5-180"><a href="#cb5-180"></a>    <span class="bu">print</span>(endDoyC)</span>
<span id="cb5-181"><a href="#cb5-181"></a>    <span class="bu">print</span>(intervalC)</span>
<span id="cb5-182"><a href="#cb5-182"></a>    <span class="bu">print</span>(startYearC)</span>
<span id="cb5-183"><a href="#cb5-183"></a>    <span class="bu">print</span>(startDoyC)</span>
<span id="cb5-184"><a href="#cb5-184"></a></span>
<span id="cb5-185"><a href="#cb5-185"></a>    <span class="co">###</span></span>
<span id="cb5-186"><a href="#cb5-186"></a>    <span class="co">#cdtypeList = ['sstd']</span></span>
<span id="cb5-187"><a href="#cb5-187"></a>    <span class="co"># for dtype in dtypeList:</span></span>
<span id="cb5-188"><a href="#cb5-188"></a></span>
<span id="cb5-189"><a href="#cb5-189"></a>    <span class="co"># Data type for SST composites</span></span>
<span id="cb5-190"><a href="#cb5-190"></a>    dtype <span class="op">=</span> <span class="st">'sstd'</span></span>
<span id="cb5-191"><a href="#cb5-191"></a></span>
<span id="cb5-192"><a href="#cb5-192"></a>    <span class="co"># Clean working directory</span></span>
<span id="cb5-193"><a href="#cb5-193"></a>    os.chdir(workDir)</span>
<span id="cb5-194"><a href="#cb5-194"></a>    os.system(<span class="st">'rm -f *'</span>)</span>
<span id="cb5-195"><a href="#cb5-195"></a></span>
<span id="cb5-196"><a href="#cb5-196"></a>    <span class="co"># Change to data directory</span></span>
<span id="cb5-197"><a href="#cb5-197"></a>    os.chdir(dataDir)</span>
<span id="cb5-198"><a href="#cb5-198"></a></span>
<span id="cb5-199"><a href="#cb5-199"></a>    <span class="co"># Preallocate sum (mean) and count arrays matching grid dims</span></span>
<span id="cb5-200"><a href="#cb5-200"></a>    mean <span class="op">=</span>np.zeros((<span class="dv">4401</span>, <span class="dv">8001</span>), np.single)</span>
<span id="cb5-201"><a href="#cb5-201"></a>    num <span class="op">=</span> np.zeros((<span class="dv">4401</span>, <span class="dv">8001</span>), dtype<span class="op">=</span>np.int32)</span>
<span id="cb5-202"><a href="#cb5-202"></a></span>
<span id="cb5-203"><a href="#cb5-203"></a>    <span class="co"># Composite within the same calendar year</span></span>
<span id="cb5-204"><a href="#cb5-204"></a>    <span class="cf">if</span> (endDoy <span class="op">&gt;</span> startDoy):</span>
<span id="cb5-205"><a href="#cb5-205"></a>        <span class="co"># Build range of Doys</span></span>
<span id="cb5-206"><a href="#cb5-206"></a>        doyRange <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(startDoy, endDoy <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb5-207"><a href="#cb5-207"></a>        fileList <span class="op">=</span> []</span>
<span id="cb5-208"><a href="#cb5-208"></a>        <span class="co"># Gather filenames for each DOY</span></span>
<span id="cb5-209"><a href="#cb5-209"></a>        <span class="cf">for</span> doy <span class="kw">in</span> doyRange:</span>
<span id="cb5-210"><a href="#cb5-210"></a>            doyC <span class="op">=</span> <span class="bu">str</span>(doy)</span>
<span id="cb5-211"><a href="#cb5-211"></a>            doyC <span class="op">=</span> doyC.rjust(<span class="dv">3</span>, <span class="st">'0'</span>)</span>
<span id="cb5-212"><a href="#cb5-212"></a>            myString <span class="op">=</span> <span class="st">'MB'</span> <span class="op">+</span> endyearC <span class="op">+</span> doyC <span class="op">+</span> <span class="st">'*'</span> <span class="op">+</span> dtype <span class="op">+</span> <span class="st">'.nc'</span></span>
<span id="cb5-213"><a href="#cb5-213"></a>            fileList.append(glob.glob(myString))</span>
<span id="cb5-214"><a href="#cb5-214"></a></span>
<span id="cb5-215"><a href="#cb5-215"></a>        <span class="co"># Flatten and sort file list</span></span>
<span id="cb5-216"><a href="#cb5-216"></a>        fileList <span class="op">=</span> <span class="bu">list</span>(chain.from_iterable(fileList))</span>
<span id="cb5-217"><a href="#cb5-217"></a>        fileList.sort()</span>
<span id="cb5-218"><a href="#cb5-218"></a>        filesUsed <span class="op">=</span> <span class="st">""</span></span>
<span id="cb5-219"><a href="#cb5-219"></a>        <span class="bu">print</span>(fileList)</span>
<span id="cb5-220"><a href="#cb5-220"></a></span>
<span id="cb5-221"><a href="#cb5-221"></a>        <span class="co"># Loop through files and accumulate SST</span></span>
<span id="cb5-222"><a href="#cb5-222"></a>        <span class="cf">for</span> fName <span class="kw">in</span> fileList:</span>
<span id="cb5-223"><a href="#cb5-223"></a>            <span class="cf">if</span> (<span class="bu">len</span>(filesUsed) <span class="op">==</span> <span class="dv">0</span>):</span>
<span id="cb5-224"><a href="#cb5-224"></a>                filesUsed <span class="op">=</span> fName</span>
<span id="cb5-225"><a href="#cb5-225"></a>            <span class="cf">else</span>:</span>
<span id="cb5-226"><a href="#cb5-226"></a>                filesUsed <span class="op">=</span> filesUsed <span class="op">+</span> <span class="st">', '</span> <span class="op">+</span> fName</span>
<span id="cb5-227"><a href="#cb5-227"></a></span>
<span id="cb5-228"><a href="#cb5-228"></a>            sstFile <span class="op">=</span> Dataset(fName)</span>
<span id="cb5-229"><a href="#cb5-229"></a>            sst <span class="op">=</span> sstFile.variables[<span class="st">"MBsstd"</span>][:, :, :, :]</span>
<span id="cb5-230"><a href="#cb5-230"></a>            sstFile.close()</span>
<span id="cb5-231"><a href="#cb5-231"></a>            sst <span class="op">=</span> np.squeeze(sst)</span>
<span id="cb5-232"><a href="#cb5-232"></a>            mean, num <span class="op">=</span> meanVar(mean, num, sst)</span>
<span id="cb5-233"><a href="#cb5-233"></a>    <span class="cf">else</span>:</span>
<span id="cb5-234"><a href="#cb5-234"></a>        <span class="co"># Composite spans year boundary</span></span>
<span id="cb5-235"><a href="#cb5-235"></a>        <span class="co"># Determine directory for the start year</span></span>
<span id="cb5-236"><a href="#cb5-236"></a>        dataDir1 <span class="op">=</span> dataDir</span>
<span id="cb5-237"><a href="#cb5-237"></a>        dataDir1 <span class="op">=</span> dataDir1.replace(endyearC, startYearC)</span>
<span id="cb5-238"><a href="#cb5-238"></a>        <span class="co"># Determine end of start year based on start year</span></span>
<span id="cb5-239"><a href="#cb5-239"></a>        <span class="cf">if</span> (isleap):</span>
<span id="cb5-240"><a href="#cb5-240"></a>            endday <span class="op">=</span> <span class="dv">366</span></span>
<span id="cb5-241"><a href="#cb5-241"></a>        <span class="cf">else</span>:</span>
<span id="cb5-242"><a href="#cb5-242"></a>            endday <span class="op">=</span> <span class="dv">365</span></span>
<span id="cb5-243"><a href="#cb5-243"></a></span>
<span id="cb5-244"><a href="#cb5-244"></a>        <span class="co"># A DOY from startDoy to end of start year</span></span>
<span id="cb5-245"><a href="#cb5-245"></a>        fileList <span class="op">=</span> []</span>
<span id="cb5-246"><a href="#cb5-246"></a>        <span class="bu">print</span>(dataDir1)</span>
<span id="cb5-247"><a href="#cb5-247"></a>        os.chdir(dataDir1)</span>
<span id="cb5-248"><a href="#cb5-248"></a>        doyRange <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(startDoy, endday <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb5-249"><a href="#cb5-249"></a>        <span class="cf">for</span> doy <span class="kw">in</span> doyRange:</span>
<span id="cb5-250"><a href="#cb5-250"></a>            doyC <span class="op">=</span> <span class="bu">str</span>(doy)</span>
<span id="cb5-251"><a href="#cb5-251"></a>            doyC <span class="op">=</span> doyC.rjust(<span class="dv">3</span>, <span class="st">'0'</span>)</span>
<span id="cb5-252"><a href="#cb5-252"></a>            myString <span class="op">=</span> <span class="st">'MB'</span> <span class="op">+</span> startYearC <span class="op">+</span> doyC <span class="op">+</span> <span class="st">'*'</span> <span class="op">+</span> dtype <span class="op">+</span> <span class="st">'.nc'</span></span>
<span id="cb5-253"><a href="#cb5-253"></a>            fileList.append(glob.glob(myString))</span>
<span id="cb5-254"><a href="#cb5-254"></a></span>
<span id="cb5-255"><a href="#cb5-255"></a>        fileList <span class="op">=</span> <span class="bu">list</span>(chain.from_iterable(fileList))</span>
<span id="cb5-256"><a href="#cb5-256"></a>        fileList.sort()</span>
<span id="cb5-257"><a href="#cb5-257"></a>        filesUsed <span class="op">=</span> <span class="st">""</span></span>
<span id="cb5-258"><a href="#cb5-258"></a>        <span class="bu">print</span>(fileList)</span>
<span id="cb5-259"><a href="#cb5-259"></a>        <span class="cf">for</span> fName <span class="kw">in</span> fileList:</span>
<span id="cb5-260"><a href="#cb5-260"></a>            <span class="cf">if</span> (<span class="bu">len</span>(filesUsed) <span class="op">==</span> <span class="dv">0</span>):</span>
<span id="cb5-261"><a href="#cb5-261"></a>                filesUsed <span class="op">=</span> fName</span>
<span id="cb5-262"><a href="#cb5-262"></a>            <span class="cf">else</span>:</span>
<span id="cb5-263"><a href="#cb5-263"></a>                filesUsed <span class="op">=</span> filesUsed <span class="op">+</span> <span class="st">', '</span> <span class="op">+</span> fName</span>
<span id="cb5-264"><a href="#cb5-264"></a></span>
<span id="cb5-265"><a href="#cb5-265"></a>            sstFile <span class="op">=</span> Dataset(fName)</span>
<span id="cb5-266"><a href="#cb5-266"></a>            sst <span class="op">=</span> sstFile.variables[<span class="st">"MBsstd"</span>][:, :, :, :]</span>
<span id="cb5-267"><a href="#cb5-267"></a>            sstFile.close()</span>
<span id="cb5-268"><a href="#cb5-268"></a>            sst <span class="op">=</span> np.squeeze(sst)</span>
<span id="cb5-269"><a href="#cb5-269"></a>            mean, num <span class="op">=</span> meanVar(mean, num, sst)</span>
<span id="cb5-270"><a href="#cb5-270"></a></span>
<span id="cb5-271"><a href="#cb5-271"></a>        <span class="co"># DOY from 1 to endDoy of end year</span></span>
<span id="cb5-272"><a href="#cb5-272"></a>        os.chdir(dataDir)</span>
<span id="cb5-273"><a href="#cb5-273"></a>        fileList <span class="op">=</span> []</span>
<span id="cb5-274"><a href="#cb5-274"></a>        doyRange <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="dv">1</span>, endDoy <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb5-275"><a href="#cb5-275"></a>        <span class="bu">print</span>(doyRange)</span>
<span id="cb5-276"><a href="#cb5-276"></a>        <span class="cf">for</span> doy <span class="kw">in</span> doyRange:</span>
<span id="cb5-277"><a href="#cb5-277"></a>            doyC <span class="op">=</span> <span class="bu">str</span>(doy)</span>
<span id="cb5-278"><a href="#cb5-278"></a>            doyC <span class="op">=</span> doyC.rjust(<span class="dv">3</span>, <span class="st">'0'</span>)</span>
<span id="cb5-279"><a href="#cb5-279"></a>            myString <span class="op">=</span> <span class="st">'MB'</span> <span class="op">+</span> endyearC <span class="op">+</span> doyC <span class="op">+</span> <span class="st">'*'</span> <span class="op">+</span> dtype <span class="op">+</span> <span class="st">'.nc'</span></span>
<span id="cb5-280"><a href="#cb5-280"></a>            fileList.append(glob.glob(myString))</span>
<span id="cb5-281"><a href="#cb5-281"></a></span>
<span id="cb5-282"><a href="#cb5-282"></a>        fileList <span class="op">=</span> <span class="bu">list</span>(chain.from_iterable(fileList))</span>
<span id="cb5-283"><a href="#cb5-283"></a>        fileList.sort()</span>
<span id="cb5-284"><a href="#cb5-284"></a>        <span class="bu">print</span>(fileList)</span>
<span id="cb5-285"><a href="#cb5-285"></a>        <span class="cf">for</span> fName <span class="kw">in</span> fileList:</span>
<span id="cb5-286"><a href="#cb5-286"></a>            <span class="cf">if</span> (<span class="bu">len</span>(filesUsed) <span class="op">==</span> <span class="dv">0</span>):</span>
<span id="cb5-287"><a href="#cb5-287"></a>                filesUsed <span class="op">=</span> fName</span>
<span id="cb5-288"><a href="#cb5-288"></a>            <span class="cf">else</span>:</span>
<span id="cb5-289"><a href="#cb5-289"></a>                filesUsed <span class="op">=</span> filesUsed <span class="op">+</span> <span class="st">', '</span> <span class="op">+</span> fName</span>
<span id="cb5-290"><a href="#cb5-290"></a></span>
<span id="cb5-291"><a href="#cb5-291"></a>            sstFile <span class="op">=</span> Dataset(fName)</span>
<span id="cb5-292"><a href="#cb5-292"></a>            sst <span class="op">=</span> sstFile.variables[<span class="st">"MBsstd"</span>][:, :, :, :]</span>
<span id="cb5-293"><a href="#cb5-293"></a>            sstFile.close()</span>
<span id="cb5-294"><a href="#cb5-294"></a>            sst <span class="op">=</span> np.squeeze(sst)</span>
<span id="cb5-295"><a href="#cb5-295"></a>            mean, num <span class="op">=</span> meanVar(mean, num, sst)</span>
<span id="cb5-296"><a href="#cb5-296"></a></span>
<span id="cb5-297"><a href="#cb5-297"></a>    <span class="co"># Mask out any grid cells with zero observations, setting them to the fill value</span></span>
<span id="cb5-298"><a href="#cb5-298"></a>    mean <span class="op">=</span> ma.array(mean, mask<span class="op">=</span>(num <span class="op">==</span> <span class="dv">0</span>), fill_value<span class="op">=-</span><span class="fl">9999999.</span>)</span>
<span id="cb5-299"><a href="#cb5-299"></a></span>
<span id="cb5-300"><a href="#cb5-300"></a>    <span class="co"># Switch to the working directory for output operations</span></span>
<span id="cb5-301"><a href="#cb5-301"></a>    os.chdir(workDir)</span>
<span id="cb5-302"><a href="#cb5-302"></a></span>
<span id="cb5-303"><a href="#cb5-303"></a>    <span class="co"># Construct the output filename with start and end dates plus data types</span></span>
<span id="cb5-304"><a href="#cb5-304"></a>    outFile <span class="op">=</span> <span class="st">'MB'</span> <span class="op">+</span> startYearC <span class="op">+</span> startDoyC <span class="op">+</span> <span class="st">'_'</span> <span class="op">+</span> endyearC <span class="op">+</span> endDoyC <span class="op">+</span> <span class="st">'_'</span> <span class="op">+</span> dtype <span class="op">+</span> <span class="st">'.nc'</span></span>
<span id="cb5-305"><a href="#cb5-305"></a>    <span class="bu">print</span>(interval)</span>
<span id="cb5-306"><a href="#cb5-306"></a></span>
<span id="cb5-307"><a href="#cb5-307"></a>    <span class="co"># Create multi-day NetCDF file using the mean and count arrays</span></span>
<span id="cb5-308"><a href="#cb5-308"></a>    ncFile <span class="op">=</span> makeNetcdf(mean, num, interval, outFile, filesUsed, workDir)</span>
<span id="cb5-309"><a href="#cb5-309"></a></span>
<span id="cb5-310"><a href="#cb5-310"></a>    <span class="co"># Upload composite NetCDF to remote MB SST directory, labeling it with the interval</span></span>
<span id="cb5-311"><a href="#cb5-311"></a>    send_to_servers(ncFile, <span class="st">'/MB/sstd/'</span>, <span class="bu">str</span>(interval))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="compmbsstmday" class="level3">
<h3 class="anchored" data-anchor-id="compmbsstmday">CompMBSSTmday</h3>
<p><code>CompMBSSTmday.py</code> reads daily 1-day SST NetCDF files for a user-specified date range and accumulates running sum and count arrays on a 0.025° × 0.025° regular grid spanning longitude 120°–320° and latitude –45°–65°. It then masks out any grid cells with zero observations and writes the averaged monthly composite as a CF-compliant NetCDF, which is automatically uploaded to a directory on the remote server. Find the monthly product on ERDDAP <a href="./modisa_scripts.html#modisa-products-on-swfsc-erddap-server">here</a>.</p>
<p>The following chart summarizes the script’s workflow:</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">%%{init: { "flowchart": { "htmlLabels": true } }}%%
flowchart LR
  I("&lt;b&gt;Inputs&lt;/b&gt;&lt;br/&gt;• 1-day SST NetCDFs (dataDir)&lt;br/&gt;• workDir&lt;br/&gt;• endYear &amp; endDoy&lt;br/&gt;• startDoy")
    --&gt; P("&lt;b&gt;Processing&lt;/b&gt;&lt;br/&gt;• Parse args &amp; compute interval&lt;br/&gt;• Compute start/end dates&lt;br/&gt;• Clear workDir&lt;br/&gt;• Initialize mean &amp; count arrays&lt;br/&gt;• Gather files&lt;br/&gt;• Loop: read each file &amp; update mean/num&lt;br/&gt;• Mask pixels with no observations")
    --&gt; O("&lt;b&gt;Output&lt;/b&gt;&lt;br/&gt;• Monthly composite SST NetCDF&lt;br/&gt;• Deployed to /MB/sstd/")
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<div id="6ce76b1b" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>View CompMBSSTmday.py</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1"></a><span class="co">"""</span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="co">Overview</span></span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="co">--------</span></span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="co">Generate **monthly** SST composites for the MODIS “MB” (Pacific Ocean) dataset by averaging</span></span>
<span id="cb6-5"><a href="#cb6-5"></a><span class="co">daily 1-day NetCDF files over a user-defined range of days (typically a calendar month).</span></span>
<span id="cb6-6"><a href="#cb6-6"></a></span>
<span id="cb6-7"><a href="#cb6-7"></a><span class="co">Usage</span></span>
<span id="cb6-8"><a href="#cb6-8"></a><span class="co">-----</span></span>
<span id="cb6-9"><a href="#cb6-9"></a><span class="co">::</span></span>
<span id="cb6-10"><a href="#cb6-10"></a></span>
<span id="cb6-11"><a href="#cb6-11"></a><span class="co">    python CompMBSSTmday.py &lt;dataDir&gt; &lt;workDir&gt; &lt;endYear&gt; &lt;endDoy&gt; &lt;startDoy&gt;</span></span>
<span id="cb6-12"><a href="#cb6-12"></a></span>
<span id="cb6-13"><a href="#cb6-13"></a><span class="co">Where:</span></span>
<span id="cb6-14"><a href="#cb6-14"></a></span>
<span id="cb6-15"><a href="#cb6-15"></a><span class="co">- ``dataDir``</span></span>
<span id="cb6-16"><a href="#cb6-16"></a></span>
<span id="cb6-17"><a href="#cb6-17"></a><span class="co">  Directory containing the daily 1-day SST NetCDFs named ``MB&lt;YYYY&gt;&lt;DDD&gt;*sstd.nc``.</span></span>
<span id="cb6-18"><a href="#cb6-18"></a></span>
<span id="cb6-19"><a href="#cb6-19"></a><span class="co">- ``workDir``</span></span>
<span id="cb6-20"><a href="#cb6-20"></a></span>
<span id="cb6-21"><a href="#cb6-21"></a><span class="co">  Temporary working directory for intermediate files</span></span>
<span id="cb6-22"><a href="#cb6-22"></a></span>
<span id="cb6-23"><a href="#cb6-23"></a><span class="co">- ``endYear``</span></span>
<span id="cb6-24"><a href="#cb6-24"></a></span>
<span id="cb6-25"><a href="#cb6-25"></a><span class="co">  Four-digit year of the last day in the composite (e.g., ``2025``).</span></span>
<span id="cb6-26"><a href="#cb6-26"></a></span>
<span id="cb6-27"><a href="#cb6-27"></a><span class="co">- ``endDoy``</span></span>
<span id="cb6-28"><a href="#cb6-28"></a></span>
<span id="cb6-29"><a href="#cb6-29"></a><span class="co">  Three-digit day-of-year of the last composite day (e.g., ``031``).</span></span>
<span id="cb6-30"><a href="#cb6-30"></a></span>
<span id="cb6-31"><a href="#cb6-31"></a><span class="co">- ``startDoy``</span></span>
<span id="cb6-32"><a href="#cb6-32"></a></span>
<span id="cb6-33"><a href="#cb6-33"></a><span class="co">  Three-digit day-of-year of the first composite day (e.g., ``001``).</span></span>
<span id="cb6-34"><a href="#cb6-34"></a></span>
<span id="cb6-35"><a href="#cb6-35"></a><span class="co">Description</span></span>
<span id="cb6-36"><a href="#cb6-36"></a><span class="co">-----------</span></span>
<span id="cb6-37"><a href="#cb6-37"></a><span class="co">1. **Parse arguments &amp; compute interval**</span></span>
<span id="cb6-38"><a href="#cb6-38"></a></span>
<span id="cb6-39"><a href="#cb6-39"></a><span class="co">  - Read ``dataDir``, ``workDir``, ``endYear``, ``endDoy``, and ``startDoy`` from ``sys.argv``.</span></span>
<span id="cb6-40"><a href="#cb6-40"></a></span>
<span id="cb6-41"><a href="#cb6-41"></a><span class="co">  - Compute ``interval = endDoy - startDoy + 1``, the number of days in the composite.</span></span>
<span id="cb6-42"><a href="#cb6-42"></a></span>
<span id="cb6-43"><a href="#cb6-43"></a><span class="co">2. **Compute start/end dates**</span></span>
<span id="cb6-44"><a href="#cb6-44"></a></span>
<span id="cb6-45"><a href="#cb6-45"></a><span class="co">  - Convert ``endYear`+`endDoy`` to a ``datetime`` for logging.</span></span>
<span id="cb6-46"><a href="#cb6-46"></a></span>
<span id="cb6-47"><a href="#cb6-47"></a><span class="co">  - Derive ``startDoy`` date by subtracting ``interval - 1`` days.</span></span>
<span id="cb6-48"><a href="#cb6-48"></a></span>
<span id="cb6-49"><a href="#cb6-49"></a><span class="co">3. **Initialize accumulators**</span></span>
<span id="cb6-50"><a href="#cb6-50"></a></span>
<span id="cb6-51"><a href="#cb6-51"></a><span class="co">  - Change to ``workDir`` and clear any old files.</span></span>
<span id="cb6-52"><a href="#cb6-52"></a></span>
<span id="cb6-53"><a href="#cb6-53"></a><span class="co">  - Preallocate two arrays of shape 4401x8001:</span></span>
<span id="cb6-54"><a href="#cb6-54"></a></span>
<span id="cb6-55"><a href="#cb6-55"></a><span class="co">     - ``mean`` (float32) for the running sum of SST.</span></span>
<span id="cb6-56"><a href="#cb6-56"></a></span>
<span id="cb6-57"><a href="#cb6-57"></a><span class="co">     - ``num``  (int32) for the count of observations.</span></span>
<span id="cb6-58"><a href="#cb6-58"></a></span>
<span id="cb6-59"><a href="#cb6-59"></a><span class="co">4. **Gather daily files**</span></span>
<span id="cb6-60"><a href="#cb6-60"></a></span>
<span id="cb6-61"><a href="#cb6-61"></a><span class="co">  - Build a sorted list of all ``MB&lt;YYYY&gt;&lt;DDD&gt;*sstd.nc`` files from ``startDoy`` to ``endDoy``, handling wrap-around at year boundaries if needed.</span></span>
<span id="cb6-62"><a href="#cb6-62"></a></span>
<span id="cb6-63"><a href="#cb6-63"></a><span class="co">5. **Accumulate daily SST**</span></span>
<span id="cb6-64"><a href="#cb6-64"></a></span>
<span id="cb6-65"><a href="#cb6-65"></a><span class="co">  - For each file:</span></span>
<span id="cb6-66"><a href="#cb6-66"></a></span>
<span id="cb6-67"><a href="#cb6-67"></a><span class="co">     - Open via ``Dataset()``, read the 4-D variable ``MBsstd``, squeeze to 2-D.</span></span>
<span id="cb6-68"><a href="#cb6-68"></a></span>
<span id="cb6-69"><a href="#cb6-69"></a><span class="co">     - Update ``mean`` and ``num`` via ``meanVar(mean, num, sst2d)``.</span></span>
<span id="cb6-70"><a href="#cb6-70"></a></span>
<span id="cb6-71"><a href="#cb6-71"></a><span class="co">6. **Mask and finalize**</span></span>
<span id="cb6-72"><a href="#cb6-72"></a></span>
<span id="cb6-73"><a href="#cb6-73"></a><span class="co">  - Create a masked array: mask pixels where ``num==0`` (no observations) and set fill value ``-9999999.``.</span></span>
<span id="cb6-74"><a href="#cb6-74"></a></span>
<span id="cb6-75"><a href="#cb6-75"></a><span class="co">7. **Write &amp; deploy**</span></span>
<span id="cb6-76"><a href="#cb6-76"></a></span>
<span id="cb6-77"><a href="#cb6-77"></a><span class="co">  - Change to ``workDir``.</span></span>
<span id="cb6-78"><a href="#cb6-78"></a></span>
<span id="cb6-79"><a href="#cb6-79"></a><span class="co">  - Construct an output filename ``MB&lt;YYYY&gt;&lt;startDDD&gt;_&lt;YYYY&gt;&lt;endDDD&gt;_sstd_mday.nc``.</span></span>
<span id="cb6-80"><a href="#cb6-80"></a></span>
<span id="cb6-81"><a href="#cb6-81"></a><span class="co">  - Call ``makeNetcdfmDay(mean, num, interval, outFile, filesUsed, workDir)`` to produce a CF-compliant NetCDF.</span></span>
<span id="cb6-82"><a href="#cb6-82"></a><span class="co">  </span></span>
<span id="cb6-83"><a href="#cb6-83"></a><span class="co">  - Transfer the file to ``/MB/sstd/`` on the remote server via ``send_to_servers()``.</span></span>
<span id="cb6-84"><a href="#cb6-84"></a></span>
<span id="cb6-85"><a href="#cb6-85"></a><span class="co">Dependencies</span></span>
<span id="cb6-86"><a href="#cb6-86"></a><span class="co">------------</span></span>
<span id="cb6-87"><a href="#cb6-87"></a><span class="co">- **Python 3.x**</span></span>
<span id="cb6-88"><a href="#cb6-88"></a></span>
<span id="cb6-89"><a href="#cb6-89"></a><span class="co">- **Standard library:** ``os``, ``sys``, ``glob``, ``itertools.chain``, ``datetime``, ``timedelta``</span></span>
<span id="cb6-90"><a href="#cb6-90"></a></span>
<span id="cb6-91"><a href="#cb6-91"></a><span class="co">- **Third-party:** ``numpy``, ``numpy.ma``, ``netCDF4.Dataset``</span></span>
<span id="cb6-92"><a href="#cb6-92"></a></span>
<span id="cb6-93"><a href="#cb6-93"></a><span class="co">- **Custom roylib functions:**</span></span>
<span id="cb6-94"><a href="#cb6-94"></a></span>
<span id="cb6-95"><a href="#cb6-95"></a><span class="co">  - ``isleap(year)``</span></span>
<span id="cb6-96"><a href="#cb6-96"></a></span>
<span id="cb6-97"><a href="#cb6-97"></a><span class="co">  - ``meanVar(mean, num, data)``</span></span>
<span id="cb6-98"><a href="#cb6-98"></a></span>
<span id="cb6-99"><a href="#cb6-99"></a><span class="co">  - ``makeNetcdfmDay(mean, num, interval, outFile, filesUsed, workDir)``</span></span>
<span id="cb6-100"><a href="#cb6-100"></a></span>
<span id="cb6-101"><a href="#cb6-101"></a><span class="co">  - ``send_to_servers(ncFile, remote_dir, interval_flag)``</span></span>
<span id="cb6-102"><a href="#cb6-102"></a></span>
<span id="cb6-103"><a href="#cb6-103"></a><span class="co">Directory Structure</span></span>
<span id="cb6-104"><a href="#cb6-104"></a><span class="co">-------------------</span></span>
<span id="cb6-105"><a href="#cb6-105"></a><span class="co">- **Input Directory** (``dataDir``):</span></span>
<span id="cb6-106"><a href="#cb6-106"></a></span>
<span id="cb6-107"><a href="#cb6-107"></a><span class="co">  ``MB&lt;YYYY&gt;&lt;DDD&gt;*sstd.nc`` daily SST files for the year.</span></span>
<span id="cb6-108"><a href="#cb6-108"></a></span>
<span id="cb6-109"><a href="#cb6-109"></a><span class="co">- **Working Directory**  (``workDir``):</span></span>
<span id="cb6-110"><a href="#cb6-110"></a></span>
<span id="cb6-111"><a href="#cb6-111"></a><span class="co">  Temporary staging for intermediate and final files.</span></span>
<span id="cb6-112"><a href="#cb6-112"></a></span>
<span id="cb6-113"><a href="#cb6-113"></a><span class="co">- **Output Location**:</span></span>
<span id="cb6-114"><a href="#cb6-114"></a></span>
<span id="cb6-115"><a href="#cb6-115"></a><span class="co">  Monthly composite written to ``workDir`` then copied to ``/MB/sstd/``.</span></span>
<span id="cb6-116"><a href="#cb6-116"></a></span>
<span id="cb6-117"><a href="#cb6-117"></a><span class="co">Usage Example</span></span>
<span id="cb6-118"><a href="#cb6-118"></a><span class="co">-------------</span></span>
<span id="cb6-119"><a href="#cb6-119"></a><span class="co">Create a January 2025 composite (DOY 001-031):</span></span>
<span id="cb6-120"><a href="#cb6-120"></a><span class="co">::</span></span>
<span id="cb6-121"><a href="#cb6-121"></a><span class="co"> </span></span>
<span id="cb6-122"><a href="#cb6-122"></a><span class="co">   python CompMBSSTmday.py /data/modisgf/1day/ /tmp/mb_work/ 2025 031 001</span></span>
<span id="cb6-123"><a href="#cb6-123"></a></span>
<span id="cb6-124"><a href="#cb6-124"></a><span class="co">This averages daily SST files DOY 001…031 of 2025, writes ``MB2025001_2025031_sstd_mday.nc`` in ``/tmp/mb_work/``, and uploads to ``/MB/sstd/``.</span></span>
<span id="cb6-125"><a href="#cb6-125"></a><span class="co">"""</span></span>
<span id="cb6-126"><a href="#cb6-126"></a><span class="im">from</span> __future__ <span class="im">import</span> print_function</span>
<span id="cb6-127"><a href="#cb6-127"></a><span class="im">from</span> builtins <span class="im">import</span> <span class="bu">str</span></span>
<span id="cb6-128"><a href="#cb6-128"></a><span class="im">from</span> builtins <span class="im">import</span> <span class="bu">range</span></span>
<span id="cb6-129"><a href="#cb6-129"></a></span>
<span id="cb6-130"><a href="#cb6-130"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb6-131"><a href="#cb6-131"></a>    <span class="im">from</span> datetime <span class="im">import</span> datetime, timedelta</span>
<span id="cb6-132"><a href="#cb6-132"></a>    <span class="im">import</span> glob</span>
<span id="cb6-133"><a href="#cb6-133"></a>    <span class="im">from</span> itertools <span class="im">import</span> chain</span>
<span id="cb6-134"><a href="#cb6-134"></a>    <span class="im">from</span> netCDF4 <span class="im">import</span> Dataset</span>
<span id="cb6-135"><a href="#cb6-135"></a>    <span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb6-136"><a href="#cb6-136"></a>    <span class="im">import</span> numpy.ma <span class="im">as</span> ma</span>
<span id="cb6-137"><a href="#cb6-137"></a>    <span class="im">import</span> os</span>
<span id="cb6-138"><a href="#cb6-138"></a>    <span class="im">import</span> sys</span>
<span id="cb6-139"><a href="#cb6-139"></a></span>
<span id="cb6-140"><a href="#cb6-140"></a>    <span class="co"># Ensure 'roylib' is on the import path</span></span>
<span id="cb6-141"><a href="#cb6-141"></a>    sys.path.append(<span class="st">'/home/cwatch/pythonLibs'</span>)</span>
<span id="cb6-142"><a href="#cb6-142"></a>    <span class="im">from</span> roylib <span class="im">import</span> <span class="op">*</span></span>
<span id="cb6-143"><a href="#cb6-143"></a></span>
<span id="cb6-144"><a href="#cb6-144"></a>    <span class="co"># Directory of daily 1-day NetCDFs</span></span>
<span id="cb6-145"><a href="#cb6-145"></a>    dataDir <span class="op">=</span> sys.argv[<span class="dv">1</span>]</span>
<span id="cb6-146"><a href="#cb6-146"></a></span>
<span id="cb6-147"><a href="#cb6-147"></a>    <span class="co"># Temporary working directory</span></span>
<span id="cb6-148"><a href="#cb6-148"></a>    workDir <span class="op">=</span> sys.argv[<span class="dv">2</span>]</span>
<span id="cb6-149"><a href="#cb6-149"></a></span>
<span id="cb6-150"><a href="#cb6-150"></a>    <span class="co"># End date (year, day-of-year)</span></span>
<span id="cb6-151"><a href="#cb6-151"></a>    endyearC <span class="op">=</span> sys.argv[<span class="dv">3</span>]</span>
<span id="cb6-152"><a href="#cb6-152"></a>    endDoyC <span class="op">=</span> sys.argv[<span class="dv">4</span>]</span>
<span id="cb6-153"><a href="#cb6-153"></a>    endDoyC <span class="op">=</span> endDoyC.rjust(<span class="dv">3</span>, <span class="st">'0'</span>)</span>
<span id="cb6-154"><a href="#cb6-154"></a></span>
<span id="cb6-155"><a href="#cb6-155"></a>    <span class="co"># Start day-of-year (same year)</span></span>
<span id="cb6-156"><a href="#cb6-156"></a>    startYearC <span class="op">=</span> endyearC</span>
<span id="cb6-157"><a href="#cb6-157"></a>    endDoy <span class="op">=</span> <span class="bu">int</span>(endDoyC)</span>
<span id="cb6-158"><a href="#cb6-158"></a>    startDoyC <span class="op">=</span> sys.argv[<span class="dv">5</span>]</span>
<span id="cb6-159"><a href="#cb6-159"></a>    startDoyC <span class="op">=</span> startDoyC.rjust(<span class="dv">3</span>, <span class="st">'0'</span>)</span>
<span id="cb6-160"><a href="#cb6-160"></a>    startDoy <span class="op">=</span> <span class="bu">int</span>(startDoyC )</span>
<span id="cb6-161"><a href="#cb6-161"></a></span>
<span id="cb6-162"><a href="#cb6-162"></a>    <span class="co"># Number of days in the composite</span></span>
<span id="cb6-163"><a href="#cb6-163"></a>    interval <span class="op">=</span> endDoy <span class="op">-</span> startDoy <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb6-164"><a href="#cb6-164"></a></span>
<span id="cb6-165"><a href="#cb6-165"></a>    <span class="co"># Convert end date to calendar dates</span></span>
<span id="cb6-166"><a href="#cb6-166"></a>    myDateEnd <span class="op">=</span> datetime(<span class="bu">int</span>(endyearC), <span class="dv">1</span>, <span class="dv">1</span>) <span class="op">+</span> timedelta(endDoy <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb6-167"><a href="#cb6-167"></a>    myDateStart <span class="op">=</span> myDateEnd <span class="op">+</span> timedelta(days<span class="op">=-</span>(interval <span class="op">-</span> <span class="dv">1</span>))</span>
<span id="cb6-168"><a href="#cb6-168"></a></span>
<span id="cb6-169"><a href="#cb6-169"></a>    <span class="co"># Prepare output directory</span></span>
<span id="cb6-170"><a href="#cb6-170"></a>    outDir <span class="op">=</span> <span class="st">'/ERDData1/modisa/data/modisgf/'</span> <span class="op">+</span> endyearC <span class="op">+</span> <span class="st">'/mday'</span></span>
<span id="cb6-171"><a href="#cb6-171"></a></span>
<span id="cb6-172"><a href="#cb6-172"></a>    <span class="bu">print</span>(dataDir)</span>
<span id="cb6-173"><a href="#cb6-173"></a>    <span class="bu">print</span>(workDir)</span>
<span id="cb6-174"><a href="#cb6-174"></a>    <span class="bu">print</span>(endyearC)</span>
<span id="cb6-175"><a href="#cb6-175"></a>    <span class="bu">print</span>(endDoyC)</span>
<span id="cb6-176"><a href="#cb6-176"></a>    <span class="bu">print</span>(interval)</span>
<span id="cb6-177"><a href="#cb6-177"></a></span>
<span id="cb6-178"><a href="#cb6-178"></a>    <span class="co">###</span></span>
<span id="cb6-179"><a href="#cb6-179"></a>    <span class="co">#cdtypeList = ['sstd']</span></span>
<span id="cb6-180"><a href="#cb6-180"></a>    <span class="co"># for dtype in dtypeList:</span></span>
<span id="cb6-181"><a href="#cb6-181"></a></span>
<span id="cb6-182"><a href="#cb6-182"></a>    <span class="co"># Only SST variable for MB composites</span></span>
<span id="cb6-183"><a href="#cb6-183"></a>    dtype <span class="op">=</span> <span class="st">'sstd'</span></span>
<span id="cb6-184"><a href="#cb6-184"></a></span>
<span id="cb6-185"><a href="#cb6-185"></a>    <span class="co"># Clean working directory</span></span>
<span id="cb6-186"><a href="#cb6-186"></a>    os.chdir(workDir)</span>
<span id="cb6-187"><a href="#cb6-187"></a>    os.system(<span class="st">'rm -f *'</span>)</span>
<span id="cb6-188"><a href="#cb6-188"></a></span>
<span id="cb6-189"><a href="#cb6-189"></a>    <span class="co"># Move to data directory</span></span>
<span id="cb6-190"><a href="#cb6-190"></a>    os.chdir(dataDir)</span>
<span id="cb6-191"><a href="#cb6-191"></a></span>
<span id="cb6-192"><a href="#cb6-192"></a>    <span class="co"># Preallocate sum (mean) and count arrays matching grid dims</span></span>
<span id="cb6-193"><a href="#cb6-193"></a>    mean <span class="op">=</span> np.zeros((<span class="dv">4401</span>, <span class="dv">8001</span>), np.single)</span>
<span id="cb6-194"><a href="#cb6-194"></a>    num <span class="op">=</span> np.zeros((<span class="dv">4401</span>, <span class="dv">8001</span>), dtype<span class="op">=</span>np.int32)</span>
<span id="cb6-195"><a href="#cb6-195"></a></span>
<span id="cb6-196"><a href="#cb6-196"></a>    <span class="co"># Build list of NetCDF files spanning startDoy..endDoy</span></span>
<span id="cb6-197"><a href="#cb6-197"></a>    <span class="cf">if</span> (endDoy <span class="op">&gt;</span> startDoy):</span>
<span id="cb6-198"><a href="#cb6-198"></a>        <span class="co"># Composite entirely within the same year</span></span>
<span id="cb6-199"><a href="#cb6-199"></a>        doyRange <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(startDoy, endDoy <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb6-200"><a href="#cb6-200"></a>        <span class="bu">print</span>(doyRange)</span>
<span id="cb6-201"><a href="#cb6-201"></a></span>
<span id="cb6-202"><a href="#cb6-202"></a>        <span class="co"># Build list matching files for each DOY</span></span>
<span id="cb6-203"><a href="#cb6-203"></a>        fileList <span class="op">=</span> []</span>
<span id="cb6-204"><a href="#cb6-204"></a>        <span class="cf">for</span> doy <span class="kw">in</span> doyRange:</span>
<span id="cb6-205"><a href="#cb6-205"></a>            doyC <span class="op">=</span> <span class="bu">str</span>(doy)</span>
<span id="cb6-206"><a href="#cb6-206"></a>            doyC <span class="op">=</span> doyC.rjust(<span class="dv">3</span>, <span class="st">'0'</span>)</span>
<span id="cb6-207"><a href="#cb6-207"></a>            myString <span class="op">=</span> <span class="st">'MB'</span> <span class="op">+</span> endyearC <span class="op">+</span> doyC <span class="op">+</span> <span class="st">'*'</span> <span class="op">+</span> dtype <span class="op">+</span> <span class="st">'.nc'</span></span>
<span id="cb6-208"><a href="#cb6-208"></a>            fileList.append(glob.glob(myString))</span>
<span id="cb6-209"><a href="#cb6-209"></a></span>
<span id="cb6-210"><a href="#cb6-210"></a>        <span class="co"># Flatten and sort</span></span>
<span id="cb6-211"><a href="#cb6-211"></a>        fileList <span class="op">=</span> <span class="bu">list</span>(chain.from_iterable(fileList))</span>
<span id="cb6-212"><a href="#cb6-212"></a>        fileList.sort()</span>
<span id="cb6-213"><a href="#cb6-213"></a>        filesUsed <span class="op">=</span> <span class="st">""</span></span>
<span id="cb6-214"><a href="#cb6-214"></a>        <span class="bu">print</span>(fileList)</span>
<span id="cb6-215"><a href="#cb6-215"></a></span>
<span id="cb6-216"><a href="#cb6-216"></a>        <span class="co"># Loop through each file</span></span>
<span id="cb6-217"><a href="#cb6-217"></a>        <span class="cf">for</span> fName <span class="kw">in</span> fileList:</span>
<span id="cb6-218"><a href="#cb6-218"></a>            <span class="co"># Build provenance string</span></span>
<span id="cb6-219"><a href="#cb6-219"></a>            <span class="cf">if</span> (<span class="bu">len</span>(filesUsed) <span class="op">==</span> <span class="dv">0</span>):</span>
<span id="cb6-220"><a href="#cb6-220"></a>                filesUsed <span class="op">=</span> fName</span>
<span id="cb6-221"><a href="#cb6-221"></a>            <span class="cf">else</span>:</span>
<span id="cb6-222"><a href="#cb6-222"></a>                filesUsed <span class="op">=</span> filesUsed <span class="op">+</span> <span class="st">', '</span> <span class="op">+</span> fName</span>
<span id="cb6-223"><a href="#cb6-223"></a></span>
<span id="cb6-224"><a href="#cb6-224"></a>            <span class="co"># Read SST variable and accumulate</span></span>
<span id="cb6-225"><a href="#cb6-225"></a>            sstFile <span class="op">=</span> Dataset(fName)</span>
<span id="cb6-226"><a href="#cb6-226"></a>            sst <span class="op">=</span> sstFile.variables[<span class="st">"MBsstd"</span>][:, :, :, :]</span>
<span id="cb6-227"><a href="#cb6-227"></a>            sstFile.close()</span>
<span id="cb6-228"><a href="#cb6-228"></a>            sst <span class="op">=</span> np.squeeze(sst)</span>
<span id="cb6-229"><a href="#cb6-229"></a></span>
<span id="cb6-230"><a href="#cb6-230"></a>            <span class="co"># Update running mean and count arrays</span></span>
<span id="cb6-231"><a href="#cb6-231"></a>            mean, num <span class="op">=</span> meanVar(mean, num, sst)</span>
<span id="cb6-232"><a href="#cb6-232"></a>    <span class="cf">else</span>:</span>
<span id="cb6-233"><a href="#cb6-233"></a>        <span class="co"># Composite spans year boundary</span></span>
<span id="cb6-234"><a href="#cb6-234"></a>        dataDir1 <span class="op">=</span> dataDir</span>
<span id="cb6-235"><a href="#cb6-235"></a>        dataDir1 <span class="op">=</span> dataDir1.replace(endyearC, startYearC)</span>
<span id="cb6-236"><a href="#cb6-236"></a></span>
<span id="cb6-237"><a href="#cb6-237"></a>        <span class="co"># Determine last day of start year</span></span>
<span id="cb6-238"><a href="#cb6-238"></a>        <span class="cf">if</span> (isleap):</span>
<span id="cb6-239"><a href="#cb6-239"></a>            endday <span class="op">=</span> <span class="dv">366</span></span>
<span id="cb6-240"><a href="#cb6-240"></a>        <span class="cf">else</span>:</span>
<span id="cb6-241"><a href="#cb6-241"></a>            endday <span class="op">=</span> <span class="dv">365</span></span>
<span id="cb6-242"><a href="#cb6-242"></a></span>
<span id="cb6-243"><a href="#cb6-243"></a>        <span class="co"># From startDoy through end of start year  </span></span>
<span id="cb6-244"><a href="#cb6-244"></a>        fileList <span class="op">=</span> []</span>
<span id="cb6-245"><a href="#cb6-245"></a>        os.chdir(dataDir1)</span>
<span id="cb6-246"><a href="#cb6-246"></a>        doyRange <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(startDoy, endday <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb6-247"><a href="#cb6-247"></a>        <span class="cf">for</span> doy <span class="kw">in</span> doyRange:</span>
<span id="cb6-248"><a href="#cb6-248"></a>            doyC <span class="op">=</span> <span class="bu">str</span>(doy)</span>
<span id="cb6-249"><a href="#cb6-249"></a>            doyC <span class="op">=</span> doyC.rjust(<span class="dv">3</span>, <span class="st">'0'</span>)</span>
<span id="cb6-250"><a href="#cb6-250"></a>            myString <span class="op">=</span> <span class="st">'MB'</span> <span class="op">+</span> startYearC <span class="op">+</span> doyC <span class="op">+</span> <span class="st">'*'</span> <span class="op">+</span> dtype <span class="op">+</span> <span class="st">'.nc'</span></span>
<span id="cb6-251"><a href="#cb6-251"></a>            fileList.append(glob.glob(myString))</span>
<span id="cb6-252"><a href="#cb6-252"></a></span>
<span id="cb6-253"><a href="#cb6-253"></a>        fileList <span class="op">=</span> <span class="bu">list</span>(chain.from_iterable(fileList))</span>
<span id="cb6-254"><a href="#cb6-254"></a>        fileList.sort()</span>
<span id="cb6-255"><a href="#cb6-255"></a>        fileUsed <span class="op">=</span> <span class="st">""</span></span>
<span id="cb6-256"><a href="#cb6-256"></a>        <span class="bu">print</span>(fileList)</span>
<span id="cb6-257"><a href="#cb6-257"></a>        <span class="cf">for</span> fName <span class="kw">in</span> fileList:</span>
<span id="cb6-258"><a href="#cb6-258"></a>            <span class="cf">if</span> (<span class="bu">len</span>(filesUsed) <span class="op">==</span> <span class="dv">0</span>):</span>
<span id="cb6-259"><a href="#cb6-259"></a>                filesUsed <span class="op">=</span> fName</span>
<span id="cb6-260"><a href="#cb6-260"></a>            <span class="cf">else</span>:</span>
<span id="cb6-261"><a href="#cb6-261"></a>                filesUsed <span class="op">=</span> filesUsed <span class="op">+</span> <span class="st">', '</span> <span class="op">+</span> fName</span>
<span id="cb6-262"><a href="#cb6-262"></a></span>
<span id="cb6-263"><a href="#cb6-263"></a>            sstFile <span class="op">=</span> Dataset(fName)</span>
<span id="cb6-264"><a href="#cb6-264"></a>            sst <span class="op">=</span> sstFile.variables[<span class="st">"MBsstd"</span>][:, :, :, :]</span>
<span id="cb6-265"><a href="#cb6-265"></a>            sstFile.close()</span>
<span id="cb6-266"><a href="#cb6-266"></a>            sst <span class="op">=</span> np.squeeze(sst)</span>
<span id="cb6-267"><a href="#cb6-267"></a>            mean, num <span class="op">=</span> meanVar(mean, num, sst)</span>
<span id="cb6-268"><a href="#cb6-268"></a></span>
<span id="cb6-269"><a href="#cb6-269"></a>        <span class="co"># From DOY 1 of end year through endDoy</span></span>
<span id="cb6-270"><a href="#cb6-270"></a>        os.chdir(dataDir)</span>
<span id="cb6-271"><a href="#cb6-271"></a>        fileList <span class="op">=</span> []</span>
<span id="cb6-272"><a href="#cb6-272"></a>        doyRange <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="dv">1</span>, endDoy <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb6-273"><a href="#cb6-273"></a>        <span class="cf">for</span> doy <span class="kw">in</span> doyRange:</span>
<span id="cb6-274"><a href="#cb6-274"></a>            doyC <span class="op">=</span> <span class="bu">str</span>(doy)</span>
<span id="cb6-275"><a href="#cb6-275"></a>            doyC <span class="op">=</span> doyC.rjust(<span class="dv">3</span>, <span class="st">'0'</span>)</span>
<span id="cb6-276"><a href="#cb6-276"></a>            myString <span class="op">=</span> <span class="st">'MB'</span> <span class="op">+</span> endyearC <span class="op">+</span> doyC <span class="op">+</span> <span class="st">'*'</span> <span class="op">+</span> dtype <span class="op">+</span> <span class="st">'.nc'</span></span>
<span id="cb6-277"><a href="#cb6-277"></a>            fileList.append(glob.glob(myString))</span>
<span id="cb6-278"><a href="#cb6-278"></a></span>
<span id="cb6-279"><a href="#cb6-279"></a>        fileList <span class="op">=</span> <span class="bu">list</span>(chain.from_iterable(fileList))</span>
<span id="cb6-280"><a href="#cb6-280"></a>        fileList.sort()</span>
<span id="cb6-281"><a href="#cb6-281"></a>        <span class="bu">print</span>(fileList)</span>
<span id="cb6-282"><a href="#cb6-282"></a>        <span class="cf">for</span> fName <span class="kw">in</span> fileList:</span>
<span id="cb6-283"><a href="#cb6-283"></a>            <span class="cf">if</span> (<span class="bu">len</span>(filesUsed) <span class="op">==</span> <span class="dv">0</span>):</span>
<span id="cb6-284"><a href="#cb6-284"></a>                filesUsed <span class="op">=</span> fName</span>
<span id="cb6-285"><a href="#cb6-285"></a>            <span class="cf">else</span>:</span>
<span id="cb6-286"><a href="#cb6-286"></a>                filesUsed <span class="op">=</span> filesUsed <span class="op">+</span> <span class="st">', '</span> <span class="op">+</span> fName</span>
<span id="cb6-287"><a href="#cb6-287"></a></span>
<span id="cb6-288"><a href="#cb6-288"></a>            sstFile <span class="op">=</span> Dataset(fName)</span>
<span id="cb6-289"><a href="#cb6-289"></a>            sst <span class="op">=</span> sstFile.variables[<span class="st">"MBsstd"</span>][:, :, :, :]</span>
<span id="cb6-290"><a href="#cb6-290"></a>            sstFile.close()</span>
<span id="cb6-291"><a href="#cb6-291"></a>            sst <span class="op">=</span> np.squeeze(sst)</span>
<span id="cb6-292"><a href="#cb6-292"></a>            mean, num <span class="op">=</span> meanVar(mean,num,sst)</span>
<span id="cb6-293"><a href="#cb6-293"></a></span>
<span id="cb6-294"><a href="#cb6-294"></a>    <span class="co"># Mask out pixels with zero observations and set fill value for missing data</span></span>
<span id="cb6-295"><a href="#cb6-295"></a>    mean <span class="op">=</span> ma.array(mean, mask<span class="op">=</span>(num <span class="op">==</span> <span class="dv">0</span>), fill_value<span class="op">=-</span><span class="fl">9999999.</span>)</span>
<span id="cb6-296"><a href="#cb6-296"></a></span>
<span id="cb6-297"><a href="#cb6-297"></a>    <span class="co"># Switch to the working directory</span></span>
<span id="cb6-298"><a href="#cb6-298"></a>    os.chdir(workDir)</span>
<span id="cb6-299"><a href="#cb6-299"></a></span>
<span id="cb6-300"><a href="#cb6-300"></a>    <span class="co"># Construct output filename</span></span>
<span id="cb6-301"><a href="#cb6-301"></a>    outFile <span class="op">=</span> <span class="st">'MB'</span> <span class="op">+</span> startYearC <span class="op">+</span> startDoyC <span class="op">+</span> <span class="st">'_'</span> <span class="op">+</span> endyearC <span class="op">+</span> endDoyC <span class="op">+</span> <span class="st">'_'</span> <span class="op">+</span> dtype <span class="op">+</span> <span class="st">'.nc'</span></span>
<span id="cb6-302"><a href="#cb6-302"></a></span>
<span id="cb6-303"><a href="#cb6-303"></a>    <span class="co"># Generate the multi-day NetCDF file</span></span>
<span id="cb6-304"><a href="#cb6-304"></a>    ncFile <span class="op">=</span> makeNetcdfmDay(mean, num, interval, outFile, filesUsed, workDir)</span>
<span id="cb6-305"><a href="#cb6-305"></a></span>
<span id="cb6-306"><a href="#cb6-306"></a>    <span class="co"># Send the NetCDF to the remote server directory</span></span>
<span id="cb6-307"><a href="#cb6-307"></a>    send_to_servers(ncFile, <span class="st">'/MB/sstd/'</span> , <span class="st">'m'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>