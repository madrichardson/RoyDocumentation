

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>roylib &mdash; Roy Scripts API 0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=412b7542" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=2709fde1"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Roy Scripts API
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../roylib.html">roylib Script</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../roylib.html#roylib.get_netcdfFile"><code class="docutils literal notranslate"><span class="pre">get_netcdfFile()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../roylib.html#roylib.grd2netcdf"><code class="docutils literal notranslate"><span class="pre">grd2netcdf()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../roylib.html#roylib.grd2netcdf1"><code class="docutils literal notranslate"><span class="pre">grd2netcdf1()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../roylib.html#roylib.isleap"><code class="docutils literal notranslate"><span class="pre">isleap()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../roylib.html#roylib.makeNetcdf"><code class="docutils literal notranslate"><span class="pre">makeNetcdf()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../roylib.html#roylib.makeNetcdfmDay"><code class="docutils literal notranslate"><span class="pre">makeNetcdfmDay()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../roylib.html#roylib.meanVar"><code class="docutils literal notranslate"><span class="pre">meanVar()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../roylib.html#roylib.mean_sumsq"><code class="docutils literal notranslate"><span class="pre">mean_sumsq()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../roylib.html#roylib.myReshape"><code class="docutils literal notranslate"><span class="pre">myReshape()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../roylib.html#roylib.retrieve_new_files"><code class="docutils literal notranslate"><span class="pre">retrieve_new_files()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../roylib.html#roylib.retrieve_new_files1"><code class="docutils literal notranslate"><span class="pre">retrieve_new_files1()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../roylib.html#roylib.safe_remove"><code class="docutils literal notranslate"><span class="pre">safe_remove()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../roylib.html#roylib.send_ncml_to_servers"><code class="docutils literal notranslate"><span class="pre">send_ncml_to_servers()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../roylib.html#roylib.send_to_servers"><code class="docutils literal notranslate"><span class="pre">send_to_servers()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../roylib.html#roylib.update_modis_1day"><code class="docutils literal notranslate"><span class="pre">update_modis_1day()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../roylib.html#roylib.update_modis_composite"><code class="docutils literal notranslate"><span class="pre">update_modis_composite()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../roylib.html#roylib.url_lines"><code class="docutils literal notranslate"><span class="pre">url_lines()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../roylib.html#roylib.url_lines1"><code class="docutils literal notranslate"><span class="pre">url_lines1()</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../newGetModis.html">newGetModis Script</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../newGetModis.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../newGetModis.html#usage">Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../newGetModis.html#description">Description</a></li>
<li class="toctree-l2"><a class="reference internal" href="../newGetModis.html#dependencies">Dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../newGetModis.html#directory-structure">Directory Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../newGetModis.html#usage-example">Usage Example</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../makeChla1daynewMB.html">makeChla1daynewMB Script</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../makeChla1daynewMB.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../makeChla1daynewMB.html#usage">Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../makeChla1daynewMB.html#description">Description</a></li>
<li class="toctree-l2"><a class="reference internal" href="../makeChla1daynewMB.html#dependencies">Dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../makeChla1daynewMB.html#land-mask">Land Mask</a></li>
<li class="toctree-l2"><a class="reference internal" href="../makeChla1daynewMB.html#directory-structure">Directory Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../makeChla1daynewMB.html#usage-example">Usage Example</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../CompMBChla.html">CompMBChla Script</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../CompMBChla.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CompMBChla.html#usage">Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CompMBChla.html#description">Description</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CompMBChla.html#dependencies">Dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CompMBChla.html#directory-structure">Directory Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CompMBChla.html#usage-example">Usage Example</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../CompMBChlamday.html">CompMBChlamday Script</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../CompMBChlamday.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CompMBChlamday.html#usage">Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CompMBChlamday.html#description">Description</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CompMBChlamday.html#dependencies">Dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CompMBChlamday.html#directory-structure">Directory Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CompMBChlamday.html#usage-example">Usage Example</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../makeSST1daynewMB.html">makeSST1daynewMB Script</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../makeSST1daynewMB.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../makeSST1daynewMB.html#usage">Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../makeSST1daynewMB.html#description">Description</a></li>
<li class="toctree-l2"><a class="reference internal" href="../makeSST1daynewMB.html#dependencies">Dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../makeSST1daynewMB.html#land-mask">Land Mask</a></li>
<li class="toctree-l2"><a class="reference internal" href="../makeSST1daynewMB.html#directory-structure">Directory Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../makeSST1daynewMB.html#usage-example">Usage Example</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../CompMBSST.html">CompMBSST Script</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../CompMBSST.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CompMBSST.html#usage">Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CompMBSST.html#description">Description</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CompMBSST.html#dependencies">Dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CompMBSST.html#directory-structure">Directory Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CompMBSST.html#usage-example">Usage Example</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../CompMBSSTmday.html">CompMBSSTmday Script</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../CompMBSSTmday.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CompMBSSTmday.html#usage">Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CompMBSSTmday.html#description">Description</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CompMBSSTmday.html#dependencies">Dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CompMBSSTmday.html#directory-structure">Directory Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CompMBSSTmday.html#usage-example">Usage Example</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../makeChla1daynewMW.html">makeChla1daynewMW Script</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../makeChla1daynewMW.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../makeChla1daynewMW.html#usage">Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../makeChla1daynewMW.html#description">Description</a></li>
<li class="toctree-l2"><a class="reference internal" href="../makeChla1daynewMW.html#dependencies">Dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../makeChla1daynewMW.html#land-mask">Land Mask</a></li>
<li class="toctree-l2"><a class="reference internal" href="../makeChla1daynewMW.html#directory-structure">Directory Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../makeChla1daynewMW.html#usage-example">Usage Example</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../CompMWChla.html">CompMWChla Script</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../CompMWChla.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CompMWChla.html#usage">Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CompMWChla.html#description">Description</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CompMWChla.html#dependencies">Dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CompMWChla.html#directory-structure">Directory Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CompMWChla.html#usage-example">Usage Example</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../CompMWChlamday.html">CompMWChlamday Script</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../CompMWChlamday.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CompMWChlamday.html#usage">Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CompMWChlamday.html#description">Description</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CompMWChlamday.html#dependencies">Dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CompMWChlamday.html#directory-structure">Directory Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CompMWChlamday.html#usage-example">Usage Example</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../makeSST1daynewMW.html">makeSST1daynewMW Script</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../makeSST1daynewMW.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../makeSST1daynewMW.html#usage">Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../makeSST1daynewMW.html#description">Description</a></li>
<li class="toctree-l2"><a class="reference internal" href="../makeSST1daynewMW.html#dependencies">Dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../makeSST1daynewMW.html#land-mask">Land Mask</a></li>
<li class="toctree-l2"><a class="reference internal" href="../makeSST1daynewMW.html#directory-structure">Directory Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../makeSST1daynewMW.html#usage-example">Usage Example</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../CompMWSST.html">CompMWSST Script</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../CompMWSST.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CompMWSST.html#usage">Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CompMWSST.html#description">Description</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CompMWSST.html#dependencies">Dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CompMWSST.html#directory-structure">Directory Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CompMWSST.html#usage-example">Usage Example</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../CompMWSSTmday.html">CompMWSSTmday Script</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../CompMWSSTmday.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CompMWSSTmday.html#usage">Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CompMWSSTmday.html#description">Description</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CompMWSSTmday.html#dependencies">Dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CompMWSSTmday.html#directory-structure">Directory Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CompMWSSTmday.html#usage-example">Usage Example</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Roy Scripts API</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">roylib</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for roylib</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">future</span> <span class="kn">import</span> <span class="n">standard_library</span>

<span class="n">standard_library</span><span class="o">.</span><span class="n">install_aliases</span><span class="p">()</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="kn">import</span> <span class="nb">str</span>
<span class="kn">from</span> <span class="nn">past.utils</span> <span class="kn">import</span> <span class="n">old_div</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">netCDF4</span> <span class="kn">import</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">num2date</span><span class="p">,</span> <span class="n">date2num</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numpy.ma</span> <span class="k">as</span> <span class="nn">ma</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">urllib.request</span><span class="o">,</span> <span class="nn">urllib.parse</span><span class="o">,</span> <span class="nn">urllib.error</span>
<span class="kn">import</span> <span class="nn">urllib.request</span><span class="o">,</span> <span class="nn">urllib.error</span><span class="o">,</span> <span class="nn">urllib.parse</span>


<div class="viewcode-block" id="myReshape">
<a class="viewcode-back" href="../roylib.html#roylib.myReshape">[docs]</a>
<span class="k">def</span> <span class="nf">myReshape</span><span class="p">(</span><span class="n">dataArray</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flatten an N-dimensional array into a 2D column vector of type float32.</span>

<span class="sd">    This helper is used before gridding routines that expect a single column of</span>
<span class="sd">    values (shape: `(n_pixels, 1)`). If `dataArray` is a `numpy.ma.MaskedArray`,</span>
<span class="sd">    masked entries are preserved in the output.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dataArray : numpy.ndarray or numpy.ma.MaskedArray</span>
<span class="sd">        Any N-dimensional array (e.g., `(n, m)`, `(n,)`, or higher rank).</span>
<span class="sd">        If a masked array is provided, masks are preserved in the result.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    numpy.ma.MaskedArray or numpy.ndarray</span>
<span class="sd">        A 2D array of shape `(dataArray.size, 1)` with dtype `float32`.</span>
<span class="sd">        - If `dataArray` was a masked array, the result is a masked array.</span>
<span class="sd">        - Otherwise, the result is a regular `ndarray` of `float32`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dataArray</span> <span class="o">=</span> <span class="n">dataArray</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">dataArray</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">dataArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dataArray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dataArray</span></div>



<div class="viewcode-block" id="get_netcdfFile">
<a class="viewcode-back" href="../roylib.html#roylib.get_netcdfFile">[docs]</a>
<span class="k">def</span> <span class="nf">get_netcdfFile</span><span class="p">(</span><span class="n">fileName</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download a NetCDF file from the NASA OceanColor server using wget.</span>

<span class="sd">    This function builds and executes a wget command that uses stored URS cookies</span>
<span class="sd">    for authentication. The target file is fetched from the NASA OceanColor `getfile`</span>
<span class="sd">    endpoint, which requires a valid URS session. The downloaded file is saved to</span>
<span class="sd">    the current working directory under its original name.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fileName : str</span>
<span class="sd">        The name of the remote NetCDF file to download (e.g.,</span>
<span class="sd">        `&#39;A2023123006000.L2_LAC_SST.nc&#39;`). This is appended to the base URL</span>
<span class="sd">        `https://oceandata.sci.gsfc.nasa.gov/ob/getfile/` to form the full download URL.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">        This function does not return a value. On success, the file appears in the</span>
<span class="sd">        current directory. Existing files with the same name are overwritten.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    RuntimeError</span>
<span class="sd">        If the wget command returns a non-zero exit status, indicating a download failure.</span>
<span class="sd">    OSError</span>
<span class="sd">        If the operating system command cannot be executed or if required tools are missing.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">baseURL</span> <span class="o">=</span> <span class="s1">&#39;&quot;https://oceandata.sci.gsfc.nasa.gov/ob/getfile/&#39;</span>
    <span class="n">wgetCommand</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;/usr/bin/wget -4 --load-cookies ~/.urs_cookies --save-cookies ~/.urs_cookies --auth-no-challenge=on --keep-session-cookies --content-disposition --no-check-certificate &quot;</span>
        <span class="o">+</span> <span class="n">baseURL</span>
        <span class="o">+</span> <span class="n">fileName</span>
        <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">wgetCommand</span><span class="p">)</span>
    <span class="c1">#    urllib.urlretrieve(baseURL+fileName,fileName)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">wgetCommand</span><span class="p">)</span></div>



<div class="viewcode-block" id="safe_remove">
<a class="viewcode-back" href="../roylib.html#roylib.safe_remove">[docs]</a>
<span class="k">def</span> <span class="nf">safe_remove</span><span class="p">(</span><span class="n">fileName</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Delete a file if it exists, handling errors gracefully.</span>

<span class="sd">    This function checks whether the specified path refers to an existing file.</span>
<span class="sd">    If so, it attempts to delete it. On Windows, it waits one second after</span>
<span class="sd">    deletion to ensure the file handle is released. Any error during removal</span>
<span class="sd">    (permission denied, file in use, etc.) is caught, and the function returns</span>
<span class="sd">    False. Non-file paths also return False without raising.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fileName : str</span>
<span class="sd">        The path to the file to be removed. Can be absolute or relative.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        True if the file existed and was removed successfully; False otherwise.</span>
<span class="sd">        - Returns False if the path does not point to a regular file.</span>
<span class="sd">        - Returns False if an exception occurs during deletion.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    None</span>
<span class="sd">        All exceptions during file removal are caught; the function never raises.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fileName</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;nt&quot;</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># seconds</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="send_to_servers">
<a class="viewcode-back" href="../roylib.html#roylib.send_to_servers">[docs]</a>
<span class="k">def</span> <span class="nf">send_to_servers</span><span class="p">(</span><span class="n">ncFile</span><span class="p">,</span> <span class="n">dataDir</span><span class="p">,</span> <span class="n">interval</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Transfer a NetCDF file to multiple remote servers via rsync and optionally copy locally.</span>

<span class="sd">    This function constructs an rsync command to push the specified file (`ncFile`) from</span>
<span class="sd">    the current working directory to two remote hosts under `/u00/satellite&lt;remote_path&gt;`.</span>
<span class="sd">    The `&lt;remote_path&gt;` depends on `dataDir` and `interval`. If `interval` is `&quot;0&quot;`, the</span>
<span class="sd">    remote path is `&lt;dataDir&gt;/&lt;ncFile&gt;`; otherwise it is `&lt;dataDir&gt;&lt;interval&gt;day/&lt;ncFile&gt;`.</span>
<span class="sd">    After rsyncing to both servers, if `interval` equals `&quot;1&quot;` and `dataDir` starts with</span>
<span class="sd">    either `&quot;MB&quot;` or `&quot;MW&quot;`, the function also copies the file locally into the</span>
<span class="sd">    corresponding `/ERDData1/modisa/data/modisgf/1day/` or</span>
<span class="sd">    `/ERDData1/modisa/data/modiswc/1day/` directory.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ncFile : str</span>
<span class="sd">        The filename (with extension) of the NetCDF file to be transferred (e.g., `&quot;A2023123006000.L2.nc&quot;`).</span>
<span class="sd">    dataDir : str</span>
<span class="sd">        The base directory path on the remote server where the file should be placed.</span>
<span class="sd">        This string is used both to build the remote path and to determine local copy logic</span>
<span class="sd">        when `interval` is `&quot;1&quot;`. For example, `&quot;/MB2023123&quot;` or `&quot;/MW2023123&quot;`.</span>
<span class="sd">    interval : str</span>
<span class="sd">        The day interval specifier, typically `&quot;0&quot;`, `&quot;1&quot;`, `&quot;3&quot;`, etc. If `&quot;0&quot;`, no</span>
<span class="sd">        subdirectory is appended; otherwise, `&lt;interval&gt;day` is appended to `dataDir`</span>
<span class="sd">        (e.g., `&quot;3&quot;` → `&quot;3day&quot;`).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">        This function does not return a value. On success, the file is transferred to</span>
<span class="sd">        both remote servers and possibly copied locally under `/ERDData1/modisa/...`.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    RuntimeError</span>
<span class="sd">        If any rsync command returns a non-zero exit code, indicating a failure in transfer.</span>
<span class="sd">    OSError</span>
<span class="sd">        If the local file cannot be read, written, or copied (e.g., permission denied,</span>
<span class="sd">        path does not exist, or `shutil.copyfile` fails).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">intervalDay</span> <span class="o">=</span> <span class="n">interval</span> <span class="o">+</span> <span class="s2">&quot;day&quot;</span>
    <span class="k">if</span> <span class="n">interval</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">:</span>
        <span class="n">remote_file</span> <span class="o">=</span> <span class="n">dataDir</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">ncFile</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">remote_file</span> <span class="o">=</span> <span class="n">dataDir</span> <span class="o">+</span> <span class="n">intervalDay</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">ncFile</span>
    <span class="n">myCmd</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;rsync -tvh &quot;</span>
        <span class="o">+</span> <span class="n">ncFile</span>
        <span class="o">+</span> <span class="s2">&quot; cwatch@192.168.31.15:/u00/satellite&quot;</span>
        <span class="o">+</span> <span class="n">remote_file</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">myCmd</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">myCmd</span><span class="p">)</span>

    <span class="n">myCmd</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;rsync -tvh &quot;</span>
        <span class="o">+</span> <span class="n">ncFile</span>
        <span class="o">+</span> <span class="s2">&quot; cwatch@000.00.00.00:/u00/satellite&quot;</span>
        <span class="o">+</span> <span class="n">remote_file</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">myCmd</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">myCmd</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">intervalDay</span> <span class="o">==</span> <span class="s2">&quot;1day&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">dataDir</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;MB&quot;</span><span class="p">):</span>
        <span class="c1"># mvFile = &#39;/ERDData1/modisa/data/modisgf/1day/&#39; + ncFile</span>
        <span class="n">mvFile</span> <span class="o">=</span> <span class="s2">&quot;/ERDData1/modisa/data/modisgf/1day/&quot;</span> <span class="o">+</span> <span class="n">ncFile</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">ncFile</span><span class="p">,</span> <span class="n">mvFile</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">intervalDay</span> <span class="o">==</span> <span class="s2">&quot;1day&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">dataDir</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;MW&quot;</span><span class="p">):</span>
        <span class="c1"># mvFile = &#39;/ERDData1/modisa/data/modiswc/1day/&#39; + ncFile</span>
        <span class="n">mvFile</span> <span class="o">=</span> <span class="s2">&quot;/ERDData1/modisa/data/modiswc/1day/&quot;</span> <span class="o">+</span> <span class="n">ncFile</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">ncFile</span><span class="p">,</span> <span class="n">mvFile</span><span class="p">)</span></div>



<div class="viewcode-block" id="send_ncml_to_servers">
<a class="viewcode-back" href="../roylib.html#roylib.send_ncml_to_servers">[docs]</a>
<span class="k">def</span> <span class="nf">send_ncml_to_servers</span><span class="p">(</span><span class="n">ncmlFile</span><span class="p">,</span> <span class="n">ncmlDir</span><span class="p">,</span> <span class="n">dataDir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Transfer a NetCDF Markup Language (NCML) file to three specified remote servers via rsync.</span>

<span class="sd">    This function constructs and executes three rsync commands to copy the NCML file from</span>
<span class="sd">    the local directory (`ncmlDir`) to each remote host under `/u00/satellite/&lt;dataDir&gt;`.</span>
<span class="sd">    The target hosts are located in a private document.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ncmlFile : str</span>
<span class="sd">        The filename of the NCML file to transfer (e.g., &quot;example.ncml&quot;). This file is assumed</span>
<span class="sd">        to reside in `ncmlDir`.</span>
<span class="sd">    ncmlDir : str</span>
<span class="sd">        Local directory path where `ncmlFile` is located.</span>
<span class="sd">    dataDir : str</span>
<span class="sd">        The target directory path (relative to `/u00/satellite/`) on each remote server.</span>
<span class="sd">        The full remote path becomes `/u00/satellite/&lt;dataDir&gt;&lt;ncmlFile&gt;`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    RuntimeError</span>
<span class="sd">        If any rsync command returns a non-zero exit code, indicating a transfer failure.</span>
<span class="sd">    OSError</span>
<span class="sd">        If the local NCML file cannot be found or accessed, or if rsync is not available.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">send_file</span> <span class="o">=</span> <span class="n">ncmlDir</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">ncmlFile</span>
    <span class="n">myCmd</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;rsync -tvh &quot;</span>
        <span class="o">+</span> <span class="n">send_file</span>
        <span class="o">+</span> <span class="s2">&quot; cwatch000.000.00.00:/u00/satellite&quot;</span>
        <span class="o">+</span> <span class="n">dataDir</span>
        <span class="o">+</span> <span class="n">ncmlFile</span>
    <span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">myCmd</span><span class="p">)</span>
    <span class="n">myCmd</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;rsync -tvh &quot;</span>
        <span class="o">+</span> <span class="n">send_file</span>
        <span class="o">+</span> <span class="s2">&quot; cwatch@000.000.00.00:/u00/satellite&quot;</span>
        <span class="o">+</span> <span class="n">dataDir</span>
        <span class="o">+</span> <span class="n">ncmlFile</span>
    <span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">myCmd</span><span class="p">)</span>
    <span class="n">myCmd</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;rsync -tvh &quot;</span>
        <span class="o">+</span> <span class="n">send_file</span>
        <span class="o">+</span> <span class="s2">&quot; cwatch@000.00.00.00:/u00/satellite&quot;</span>
        <span class="o">+</span> <span class="n">dataDir</span>
        <span class="o">+</span> <span class="n">ncmlFile</span>
    <span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">myCmd</span><span class="p">)</span></div>



<div class="viewcode-block" id="retrieve_new_files">
<a class="viewcode-back" href="../roylib.html#roylib.retrieve_new_files">[docs]</a>
<span class="k">def</span> <span class="nf">retrieve_new_files</span><span class="p">(</span><span class="n">dataDir</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">myYear</span><span class="p">,</span> <span class="n">doy</span><span class="p">,</span> <span class="n">param_update_flag</span><span class="p">,</span> <span class="n">lag</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check for and download new MODIS files for a given parameter and date.</span>

<span class="sd">    This function constructs a search query for the NASA OceanColor file_search API</span>
<span class="sd">    based on the provided parameter (`&quot;OC&quot;` or other). It computes the calendar date</span>
<span class="sd">    from `myYear` and `doy`, then builds a query string of the form:</span>
<span class="sd">    `search=AQUA_MODIS.&lt;YYYY&gt;&lt;MM&gt;&lt;DD&gt;*L2.&lt;param&gt;.NRT.nc&amp;dtype=L2&amp;sensor=aqua&amp;results_as_file=1`.</span>
<span class="sd">    It calls `url_lines1` to fetch the list of matching filenames. For each filename,</span>
<span class="sd">    it checks whether the file already exists in `dataDir`; if not, it sets the</span>
<span class="sd">    corresponding index in `param_update_flag` to True and invokes `get_netcdfFile`</span>
<span class="sd">    to download the missing file, pausing 20 seconds between downloads.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dataDir : str</span>
<span class="sd">        The directory where downloaded files should be saved (e.g., `/ERDData1/modisa/data/netcdf/`).</span>
<span class="sd">    param : str</span>
<span class="sd">        The MODIS data parameter to retrieve, typically `&quot;OC&quot;` (ocean color) or another dataset code.</span>
<span class="sd">    myYear : str</span>
<span class="sd">        The four-digit year (e.g., `&quot;2023&quot;`).</span>
<span class="sd">    doy : str</span>
<span class="sd">        The day of year as a zero-padded string (e.g., `&quot;005&quot;` for January 5).</span>
<span class="sd">    param_update_flag : list of bool</span>
<span class="sd">        A list of length at least 4, where `param_update_flag[lag + 3]` is set to True</span>
<span class="sd">        if a new file for that lag index needs to be downloaded.</span>
<span class="sd">    lag : int</span>
<span class="sd">        The offset relative to the current date, ranging from -3 to 0. This determines</span>
<span class="sd">        which index in `param_update_flag` to update (`lag + 3`).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">        The function does not return a value. It updates `param_update_flag` in place</span>
<span class="sd">        and downloads any missing NetCDF files to `dataDir`.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    urllib.error.URLError</span>
<span class="sd">        If the HTTP request inside `url_lines1` fails (e.g., network error).</span>
<span class="sd">    OSError</span>
<span class="sd">        If file operations (checking existence or writing) fail, or if `get_netcdfFile`</span>
<span class="sd">        cannot write the downloaded file.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">param</span> <span class="o">==</span> <span class="s2">&quot;OC&quot;</span><span class="p">:</span>
        <span class="c1"># modis_search_URL = &#39;search=A&#39; + myYear + doy + &#39;*L2_LAC_&#39; + param + &#39;.nc&amp;dtype=L2&amp;sensor=aqua&amp;results_as_file=1&#39;</span>
        <span class="n">myDate</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">myYear</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">doy</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">myMonth</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">myDate</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">)</span>
        <span class="n">myDay</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">myDate</span><span class="o">.</span><span class="n">day</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">)</span>
        <span class="n">modis_search_URL</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;search=AQUA_MODIS.&quot;</span>
            <span class="o">+</span> <span class="n">myYear</span>
            <span class="o">+</span> <span class="n">myMonth</span>
            <span class="o">+</span> <span class="n">myDay</span>
            <span class="o">+</span> <span class="s2">&quot;*L2.&quot;</span>
            <span class="o">+</span> <span class="n">param</span>
            <span class="o">+</span> <span class="s2">&quot;.NRT.nc&amp;dtype=L2&amp;sensor=aqua&amp;results_as_file=1&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">doy</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">lag</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">modis_search_URL</span><span class="p">)</span>
        <span class="c1"># fileList = url_lines(modis_search_URL)</span>
        <span class="n">fileList</span> <span class="o">=</span> <span class="n">url_lines1</span><span class="p">(</span><span class="n">modis_search_URL</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fName</span> <span class="ow">in</span> <span class="n">fileList</span><span class="p">:</span>
            <span class="n">fileTest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">dataDir</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">fName</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">fileTest</span><span class="p">):</span>
                <span class="n">param_update_flag</span><span class="p">[</span><span class="n">lag</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">fName</span><span class="p">)</span>
                <span class="n">get_netcdfFile</span><span class="p">(</span><span class="n">fName</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">myDate</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">myYear</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">doy</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">myMonth</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">myDate</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">)</span>
        <span class="n">myDay</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">myDate</span><span class="o">.</span><span class="n">day</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">)</span>
        <span class="n">modis_search_URL</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;search=AQUA_MODIS.&quot;</span>
            <span class="o">+</span> <span class="n">myYear</span>
            <span class="o">+</span> <span class="n">myMonth</span>
            <span class="o">+</span> <span class="n">myDay</span>
            <span class="o">+</span> <span class="s2">&quot;*L2.&quot;</span>
            <span class="o">+</span> <span class="n">param</span>
            <span class="o">+</span> <span class="s2">&quot;.NRT.nc&amp;dtype=L2&amp;sensor=aqua&amp;results_as_file=1&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">doy</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">lag</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">modis_search_URL</span><span class="p">)</span>
        <span class="c1"># fileList = url_lines(modis_search_URL)</span>
        <span class="n">fileList</span> <span class="o">=</span> <span class="n">url_lines1</span><span class="p">(</span><span class="n">modis_search_URL</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fName</span> <span class="ow">in</span> <span class="n">fileList</span><span class="p">:</span>
            <span class="n">fileTest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">dataDir</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">fName</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">fileTest</span><span class="p">):</span>
                <span class="n">param_update_flag</span><span class="p">[</span><span class="n">lag</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">fName</span><span class="p">)</span>
                <span class="n">get_netcdfFile</span><span class="p">(</span><span class="n">fName</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span></div>



<div class="viewcode-block" id="retrieve_new_files1">
<a class="viewcode-back" href="../roylib.html#roylib.retrieve_new_files1">[docs]</a>
<span class="k">def</span> <span class="nf">retrieve_new_files1</span><span class="p">(</span><span class="n">dataDir</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">myYear</span><span class="p">,</span> <span class="n">doy</span><span class="p">,</span> <span class="n">param_update_flag</span><span class="p">,</span> <span class="n">lag</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check for and download new MODIS files, handling OC and non-OC parameters differently.</span>

<span class="sd">    This function constructs a search query for the NASA OceanColor file_search API based on</span>
<span class="sd">    the given parameter. For `param == &quot;OC&quot;`, it uses a legacy L2_LAC endpoint; otherwise it uses</span>
<span class="sd">    the NRT endpoint. It computes the calendar date from `myYear` and `doy`, builds the query</span>
<span class="sd">    string, and retrieves the list of matching filenames via `url_lines1`. The filenames are sorted,</span>
<span class="sd">    and for each filename not already present in `dataDir`, it sets the corresponding index in</span>
<span class="sd">    `param_update_flag` to True and calls `get_netcdfFile` to download the file, pausing 20 seconds</span>
<span class="sd">    between downloads.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dataDir : str</span>
<span class="sd">        The directory where downloaded files should be saved (e.g., `/ERDData1/modisa/data/netcdf/`).</span>
<span class="sd">    param : str</span>
<span class="sd">        The MODIS data parameter to retrieve. If `&quot;OC&quot;`, the search endpoint uses L2_LAC_OC; otherwise</span>
<span class="sd">        it uses the NRT endpoint (e.g., `&quot;SST&quot;` or other parameter codes).</span>
<span class="sd">    myYear : str</span>
<span class="sd">        The four-digit year (e.g., `&quot;2023&quot;`). Used to construct the search URL.</span>
<span class="sd">    doy : str</span>
<span class="sd">        The day of year as a zero-padded string (e.g., `&quot;005&quot;` for January 5). Used to construct the search URL.</span>
<span class="sd">    param_update_flag : list of bool</span>
<span class="sd">        A list of length at least 4, where `param_update_flag[lag + 3]` is set to True if a new file</span>
<span class="sd">        needs to be downloaded for the given lag index.</span>
<span class="sd">    lag : int</span>
<span class="sd">        The offset relative to the current date, ranging from -3 to 0. Determines which index in</span>
<span class="sd">        `param_update_flag` to update (`lag + 3`).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">        Updates `param_update_flag` in place and downloads any missing NetCDF files to `dataDir`.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    urllib.error.URLError</span>
<span class="sd">        If the HTTP request inside `url_lines1` encounters a network error on all retry attempts.</span>
<span class="sd">    OSError</span>
<span class="sd">        If file operations fail (e.g., checking existence, writing to `dataDir`), or if `get_netcdfFile`</span>
<span class="sd">        cannot write the downloaded file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Rest of the code...</span>

    <span class="k">if</span> <span class="n">param</span> <span class="o">==</span> <span class="s2">&quot;OC&quot;</span><span class="p">:</span>
        <span class="c1"># modis_search_URL = &#39;search=A&#39; + myYear + doy + &#39;*L2_LAC_&#39; + param + &#39;.nc&amp;dtype=L2&amp;sensor=aqua&amp;results_as_file=1&#39;</span>
        <span class="n">myDate</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">myYear</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">doy</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">myMonth</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">myDate</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">)</span>
        <span class="n">myDay</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">myDate</span><span class="o">.</span><span class="n">day</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">)</span>
        <span class="n">modis_search_URL</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;search=A&quot;</span>
            <span class="o">+</span> <span class="n">myYear</span>
            <span class="o">+</span> <span class="n">doy</span>
            <span class="o">+</span> <span class="s2">&quot;*L2_LAC_&quot;</span>
            <span class="o">+</span> <span class="n">param</span>
            <span class="o">+</span> <span class="s2">&quot;.nc&amp;dtype=L2&amp;sensor=aqua&amp;results_as_file=1&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">doy</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">lag</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">modis_search_URL</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">doy</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">lag</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">modis_search_URL</span><span class="p">)</span>
        <span class="c1"># fileList = url_lines(modis_search_URL)</span>
        <span class="n">fileList</span> <span class="o">=</span> <span class="n">url_lines1</span><span class="p">(</span><span class="n">modis_search_URL</span><span class="p">)</span>
        <span class="n">fileList</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">fName</span> <span class="ow">in</span> <span class="n">fileList</span><span class="p">:</span>
            <span class="n">fileTest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">dataDir</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">fName</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">fileTest</span><span class="p">):</span>
                <span class="n">param_update_flag</span><span class="p">[</span><span class="n">lag</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">fName</span><span class="p">)</span>
                <span class="n">get_netcdfFile</span><span class="p">(</span><span class="n">fName</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">myDate</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">myYear</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">doy</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">myMonth</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">myDate</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">)</span>
        <span class="n">myDay</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">myDate</span><span class="o">.</span><span class="n">day</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">)</span>
        <span class="n">modis_search_URL</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;search=AQUA_MODIS.&quot;</span>
            <span class="o">+</span> <span class="n">myYear</span>
            <span class="o">+</span> <span class="n">myMonth</span>
            <span class="o">+</span> <span class="n">myDay</span>
            <span class="o">+</span> <span class="s2">&quot;*L2.&quot;</span>
            <span class="o">+</span> <span class="n">param</span>
            <span class="o">+</span> <span class="s2">&quot;.NRT.nc&amp;dtype=L2&amp;sensor=aqua&amp;results_as_file=1&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">doy</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">lag</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">modis_search_URL</span><span class="p">)</span>
        <span class="c1"># fileList = url_lines(modis_search_URL)</span>
        <span class="n">fileList</span> <span class="o">=</span> <span class="n">url_lines1</span><span class="p">(</span><span class="n">modis_search_URL</span><span class="p">)</span>
        <span class="n">fileList</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">fName</span> <span class="ow">in</span> <span class="n">fileList</span><span class="p">:</span>
            <span class="n">fileTest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">dataDir</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">fName</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">fileTest</span><span class="p">):</span>
                <span class="n">param_update_flag</span><span class="p">[</span><span class="n">lag</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">fName</span><span class="p">)</span>
                <span class="n">get_netcdfFile</span><span class="p">(</span><span class="n">fName</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span></div>



<div class="viewcode-block" id="isleap">
<a class="viewcode-back" href="../roylib.html#roylib.isleap">[docs]</a>
<span class="k">def</span> <span class="nf">isleap</span><span class="p">(</span><span class="n">year</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine whether the specified year is a leap year.</span>

<span class="sd">    This function attempts to construct a date object for February 29 of the given year.</span>
<span class="sd">    If the date is valid, the year is a leap year; otherwise, a ValueError is raised</span>
<span class="sd">    and the function returns False.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    year : int</span>
<span class="sd">        The year to check (e.g., 2024).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        True if `year` is a leap year (i.e., February 29 exists in that year);</span>
<span class="sd">        False otherwise.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    None</span>
<span class="sd">        Any ValueError raised by `datetime.date(year, 2, 29)` is caught internally;</span>
<span class="sd">        the function never propagates exceptions.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">date</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">29</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="meanVar">
<a class="viewcode-back" href="../roylib.html#roylib.meanVar">[docs]</a>
<span class="k">def</span> <span class="nf">meanVar</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">obs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update the running mean and count of observations with new data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mean : numpy.ma.MaskedArray or numpy.ndarray</span>
<span class="sd">        The current running mean values for each element.</span>
<span class="sd">    num : numpy.ndarray</span>
<span class="sd">        The current count of valid observations for each element (integer array).</span>
<span class="sd">    obs : numpy.ma.MaskedArray</span>
<span class="sd">        The new observations with the same shape as `mean`. Masked entries are not used.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        A 2-tuple `(updated_mean, updated_count)` where:</span>
<span class="sd">        - `updated_mean` is a masked or regular array of new mean values (dtype float32).</span>
<span class="sd">        - `updated_count` is an integer array of updated counts (dtype int32).</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    None</span>
<span class="sd">        Shape mismatches or invalid operations will propagate NumPy errors.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">numpy.ma</span> <span class="k">as</span> <span class="nn">ma</span>

    <span class="n">numShape</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">)</span>
    <span class="n">numAdd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">numShape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">numAdd</span><span class="p">[</span><span class="n">obs</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">numAdd</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">tempNum</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="p">(</span><span class="n">num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">tempNum</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">)</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">temp</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span></div>



<div class="viewcode-block" id="mean_sumsq">
<a class="viewcode-back" href="../roylib.html#roylib.mean_sumsq">[docs]</a>
<span class="k">def</span> <span class="nf">mean_sumsq</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">ss</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">obs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cumulative calculation of mean and sum of squares for masked arrays.</span>

<span class="sd">    This function updates the running mean, sum of squares, and count of observations</span>
<span class="sd">    given a new set of observations. All input arrays (`mean`, `ss`, and `obs`) must be</span>
<span class="sd">    NumPy masked arrays of identical shape. If any input is not a masked array, the</span>
<span class="sd">    function exits with an error message.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mean : numpy.ma.MaskedArray</span>
<span class="sd">        The current running mean array. Masked entries indicate missing data and</span>
<span class="sd">        are not included in the update.</span>
<span class="sd">    ss : numpy.ma.MaskedArray</span>
<span class="sd">        The current running sum of squares array. Masked entries are not included</span>
<span class="sd">        in the update.</span>
<span class="sd">    num : numpy.ndarray</span>
<span class="sd">        The current count of valid observations for each element, as an integer array</span>
<span class="sd">        of the same shape as `mean`. This array is incremented for each unmasked entry</span>
<span class="sd">        in `obs`.</span>
<span class="sd">    obs : numpy.ma.MaskedArray</span>
<span class="sd">        The new observations to incorporate. Masked entries indicate missing data and</span>
<span class="sd">        are not used in updating `mean`, `ss`, or `num`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        A 3-tuple `(updated_mean, updated_ss, updated_num)` where:</span>
<span class="sd">        - `updated_mean` (numpy.ma.MaskedArray): The updated running mean array.</span>
<span class="sd">        - `updated_ss` (numpy.ma.MaskedArray): The updated running sum of squares array.</span>
<span class="sd">        - `updated_num` (numpy.ndarray): The updated count of observations as an integer array.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    SystemExit</span>
<span class="sd">        If any of `mean`, `ss`, or `obs` is not a `numpy.ma.MaskedArray`, the function</span>
<span class="sd">        prints an error message and exits.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">numpy.ma</span> <span class="k">as</span> <span class="nn">ma</span>
    <span class="kn">import</span> <span class="nn">sys</span>

    <span class="k">if</span> <span class="p">(</span>
        <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">)</span>
        <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">)</span>
        <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">)</span>
    <span class="p">):</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Input arguments mean, ss, and obs are not numpy masked arrays&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Try converting mean, ss, and obs to masked arrays&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;before using them in the function, e.g. ma.array(arg)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">mean_sumsq</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>

    <span class="n">numShape</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">mean</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">)</span>
    <span class="n">numAdd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">numShape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">numAdd</span><span class="p">[</span><span class="n">obs</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">numAdd</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">tempNum</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="p">(</span><span class="n">num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;tempNum&quot;</span><span class="p">,</span> <span class="n">tempNum</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">tempNum</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="n">tNfloat</span> <span class="o">=</span> <span class="n">tempNum</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">)</span>

    <span class="n">temp</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">tNfloat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">)</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">mean</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span> <span class="n">temp</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">)</span>
    <span class="c1"># mean = ma.masked_where(mean == 0., mean)</span>

    <span class="n">num1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
    <span class="n">num2</span> <span class="o">=</span> <span class="n">num1</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;num2&quot;</span><span class="p">,</span> <span class="n">num2</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">num2</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">num1</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">num1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">num1</span><span class="p">,</span> <span class="n">num2</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="n">num1</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;num1&quot;</span><span class="p">,</span> <span class="n">num1</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">num1</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;num&quot;</span><span class="p">,</span> <span class="n">num</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">num</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="n">temp1</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">)</span>
    <span class="n">temp2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">temp1</span><span class="p">,</span> <span class="n">temp1</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="s2">&quot;ss parts&quot;</span><span class="p">,</span>
        <span class="n">ss</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
        <span class="n">ma</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">num1</span><span class="p">,</span> <span class="n">temp2</span><span class="p">)</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
    <span class="p">)</span>
    <span class="n">ss</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span> <span class="o">+</span> <span class="n">ma</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">num1</span><span class="p">,</span> <span class="n">temp2</span><span class="p">)</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

    <span class="n">mean</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mean</span><span class="p">)</span>
    <span class="n">ss</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ss</span><span class="p">)</span>
    <span class="n">vr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
    <span class="n">sdev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">vr</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;stDev&quot;</span><span class="p">,</span> <span class="n">sdev</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">sdev</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">sdev</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
    <span class="c1"># print(stdev.min(), stdev.max(), stdev.mean())</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">ss</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span></div>



<div class="viewcode-block" id="makeNetcdf">
<a class="viewcode-back" href="../roylib.html#roylib.makeNetcdf">[docs]</a>
<span class="k">def</span> <span class="nf">makeNetcdf</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">nobs</span><span class="p">,</span> <span class="n">interval</span><span class="p">,</span> <span class="n">outFile</span><span class="p">,</span> <span class="n">filesUsed</span><span class="p">,</span> <span class="n">workDir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a NetCDF file from aggregated data arrays and assign metadata.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mean : numpy.ma.MaskedArray or numpy.ndarray</span>
<span class="sd">        A 2D array of mean values (masked or regular). Masked entries are treated as missing.</span>
<span class="sd">    nobs : int</span>
<span class="sd">        The number of observations used to compute `mean`. This value is recalculated from `mean`.</span>
<span class="sd">    interval : int</span>
<span class="sd">        Time interval in days (e.g., 1, 3, 5, 8, 14). Determines which CDL template to use.</span>
<span class="sd">    outFile : str</span>
<span class="sd">        Desired output filename (e.g., &#39;/path/to/output/MB2023123001.nc&#39;). The function infers:</span>
<span class="sd">        - `dataset`: first two characters.</span>
<span class="sd">        - `param`: substring after the first underscore past index 10.</span>
<span class="sd">        - `time1` and `time2`: substrings indicating start and end DOY.</span>
<span class="sd">    filesUsed : list of str</span>
<span class="sd">        List of source filenames that contributed to `mean`. Stored in the NetCDF’s `files` attribute.</span>
<span class="sd">    workDir : str</span>
<span class="sd">        Directory in which to execute `ncgen` and write the new NetCDF file.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        The path of the generated NetCDF file (with “.nc” extension).</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    OSError</span>
<span class="sd">        If changing directory to `workDir` fails or if `ncgen` cannot be executed.</span>
<span class="sd">    RuntimeError</span>
<span class="sd">        If the `ncgen` command returns a non-zero exit code.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">workDir</span><span class="p">)</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">now1</span> <span class="o">=</span> <span class="n">date</span><span class="p">(</span><span class="n">now</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">now</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">now</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
    <span class="n">nobs</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">mean</span><span class="p">)</span>
    <span class="n">noMiss</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">count_masked</span><span class="p">(</span><span class="n">mean</span><span class="p">)</span>
    <span class="n">percentCoverage</span> <span class="o">=</span> <span class="n">old_div</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">nobs</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">nobs</span> <span class="o">+</span> <span class="n">noMiss</span><span class="p">))</span>
    <span class="c1"># get netcdf file name and correct cdl file</span>
    <span class="n">ncFile</span> <span class="o">=</span> <span class="n">outFile</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">outFile</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">ncFile</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">param</span> <span class="o">=</span> <span class="n">ncFile</span><span class="p">[(</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">ncFile</span><span class="p">)]</span>
    <span class="n">time1</span> <span class="o">=</span> <span class="n">outFile</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span>
    <span class="n">time2</span> <span class="o">=</span> <span class="n">outFile</span><span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="mi">17</span><span class="p">]</span>
    <span class="n">ncFile</span> <span class="o">=</span> <span class="n">ncFile</span> <span class="o">+</span> <span class="s2">&quot;.nc&quot;</span>
    <span class="n">interval1</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ncFile</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">interval1</span><span class="p">)</span>
    <span class="c1"># cdlFile = &#39;/ERDData1/modisa/python/&#39; + dataset + param + interval1 + &#39;Day.cdl&#39;</span>
    <span class="n">cdlFile</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;/ERDData1/modisa/python/&quot;</span> <span class="o">+</span> <span class="n">dataset</span> <span class="o">+</span> <span class="n">param</span> <span class="o">+</span> <span class="n">interval1</span> <span class="o">+</span> <span class="s2">&quot;Day.cdl&quot;</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">cdlFile</span><span class="p">)</span>
    <span class="c1"># os.system(&#39;/usr/bin/ncgen -o &#39; + ncFile + &#39; &#39; + cdlFile)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;/usr/bin/ncgen -o &quot;</span> <span class="o">+</span> <span class="n">ncFile</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">cdlFile</span><span class="p">)</span>
    <span class="c1"># shutil.copyfile(cdlFile, ncFile)</span>
    <span class="n">ncPointer</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">ncFile</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span>
    <span class="n">mytime</span> <span class="o">=</span> <span class="n">ncPointer</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>
    <span class="n">ncPointer</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="n">filesUsed</span>
    <span class="n">ncPointer</span><span class="o">.</span><span class="n">date_created</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">now1</span><span class="p">)</span>
    <span class="n">ncPointer</span><span class="o">.</span><span class="n">date_issued</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">now1</span><span class="p">)</span>
    <span class="n">paramName</span> <span class="o">=</span> <span class="n">dataset</span> <span class="o">+</span> <span class="n">param</span>
    <span class="n">myparam</span> <span class="o">=</span> <span class="n">ncPointer</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">paramName</span><span class="p">]</span>
    <span class="n">tempName</span> <span class="o">=</span> <span class="n">myparam</span><span class="o">.</span><span class="n">long_name</span>
    <span class="n">composite</span> <span class="o">=</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="n">interval1</span> <span class="o">+</span> <span class="s2">&quot; Day Composite)&quot;</span>
    <span class="n">tempName</span> <span class="o">=</span> <span class="n">tempName</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;(3 Day Composite)&quot;</span><span class="p">,</span> <span class="n">composite</span><span class="p">)</span>
    <span class="n">myparam</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="n">tempName</span>
    <span class="n">myparam</span><span class="o">.</span><span class="n">numberOfObservations</span> <span class="o">=</span> <span class="n">nobs</span>
    <span class="n">myparam</span><span class="o">.</span><span class="n">percentCoverage</span> <span class="o">=</span> <span class="n">percentCoverage</span>
    <span class="n">myparam</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mean</span><span class="p">[:,</span> <span class="p">:]</span>
    <span class="n">myparam</span><span class="o">.</span><span class="n">actual_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(([</span><span class="n">mean</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">mean</span><span class="o">.</span><span class="n">max</span><span class="p">()]))</span>
    <span class="n">startTimeYear</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span>
    <span class="n">startTimeDoy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time1</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">7</span><span class="p">])</span>
    <span class="n">startDate</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">startTimeYear</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">startTimeDoy</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">interval1</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span>
        <span class="n">centerDate</span> <span class="o">=</span> <span class="n">startDate</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">interval1</span> <span class="o">==</span> <span class="s2">&quot;3&quot;</span><span class="p">:</span>
        <span class="n">centerDate</span> <span class="o">=</span> <span class="n">startDate</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">36</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">interval1</span> <span class="o">==</span> <span class="s2">&quot;5&quot;</span><span class="p">:</span>
        <span class="n">centerDate</span> <span class="o">=</span> <span class="n">startDate</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">interval1</span> <span class="o">==</span> <span class="s2">&quot;8&quot;</span><span class="p">:</span>
        <span class="n">centerDate</span> <span class="o">=</span> <span class="n">startDate</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">interval1</span> <span class="o">==</span> <span class="s2">&quot;14&quot;</span><span class="p">:</span>
        <span class="n">centerDate</span> <span class="o">=</span> <span class="n">startDate</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>

    <span class="n">udtime</span> <span class="o">=</span> <span class="n">date2num</span><span class="p">(</span><span class="n">centerDate</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;seconds since 1970-01-01&quot;</span><span class="p">)</span>
    <span class="n">mytime</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">udtime</span>
    <span class="n">mytime</span><span class="o">.</span><span class="n">actual_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(([</span><span class="n">udtime</span><span class="p">,</span> <span class="n">udtime</span><span class="p">]))</span>
    <span class="n">ncPointer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ncFile</span></div>



<div class="viewcode-block" id="makeNetcdfmDay">
<a class="viewcode-back" href="../roylib.html#roylib.makeNetcdfmDay">[docs]</a>
<span class="k">def</span> <span class="nf">makeNetcdfmDay</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">nobs</span><span class="p">,</span> <span class="n">interval</span><span class="p">,</span> <span class="n">outFile</span><span class="p">,</span> <span class="n">filesUsed</span><span class="p">,</span> <span class="n">workDir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a NetCDF file for multi-day composite data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mean : numpy.ma.MaskedArray or numpy.ndarray</span>
<span class="sd">        A 2D array of mean values for the composite period. Masked entries are treated as missing.</span>
<span class="sd">    nobs : int</span>
<span class="sd">        The number of observations used to compute `mean`. Recomputed internally from `mean`.</span>
<span class="sd">    interval : float</span>
<span class="sd">        The length of the composite period (in days). Used to select the “mDay” CDL template.</span>
<span class="sd">    outFile : str</span>
<span class="sd">        Desired output filename (ending in “.nc”). The function derives:</span>
<span class="sd">        - `dataset`: first two characters of `outFile`.</span>
<span class="sd">        - `param`: substring after the first underscore past index 10.</span>
<span class="sd">        - `time1` and `time2`: substrings for start/end DOY.</span>
<span class="sd">    filesUsed : list of str</span>
<span class="sd">        A list of source filenames that contributed to `mean`. Stored in NetCDF’s `files` attribute.</span>
<span class="sd">    workDir : str</span>
<span class="sd">        Directory in which to execute `ncgen` and write the new NetCDF file.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        The path of the generated NetCDF file (with “.nc” extension).</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    OSError</span>
<span class="sd">        If changing directory to `workDir` fails or if `ncgen` cannot be executed.</span>
<span class="sd">    RuntimeError</span>
<span class="sd">        If the `ncgen` command returns a non-zero exit code.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">workDir</span><span class="p">)</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">now1</span> <span class="o">=</span> <span class="n">date</span><span class="p">(</span><span class="n">now</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">now</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">now</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
    <span class="n">nobs</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">mean</span><span class="p">)</span>
    <span class="n">noMiss</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">count_masked</span><span class="p">(</span><span class="n">mean</span><span class="p">)</span>
    <span class="n">percentCoverage</span> <span class="o">=</span> <span class="n">old_div</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">nobs</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">nobs</span> <span class="o">+</span> <span class="n">noMiss</span><span class="p">))</span>
    <span class="c1"># get netcdf file name and correct cdl file</span>
    <span class="n">ncFile</span> <span class="o">=</span> <span class="n">outFile</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">outFile</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">ncFile</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">param</span> <span class="o">=</span> <span class="n">ncFile</span><span class="p">[(</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">ncFile</span><span class="p">)]</span>
    <span class="n">time1</span> <span class="o">=</span> <span class="n">outFile</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span>
    <span class="n">time2</span> <span class="o">=</span> <span class="n">outFile</span><span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="mi">17</span><span class="p">]</span>
    <span class="n">ncFile</span> <span class="o">=</span> <span class="n">ncFile</span> <span class="o">+</span> <span class="s2">&quot;.nc&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ncFile</span><span class="p">)</span>
    <span class="c1"># cdlFile = &#39;/ERDData1/modisa/python/&#39; + dataset + param + &#39;mDay.cdl&#39;</span>
    <span class="n">cdlFile</span> <span class="o">=</span> <span class="s2">&quot;/ERDData1/modisa/python/&quot;</span> <span class="o">+</span> <span class="n">dataset</span> <span class="o">+</span> <span class="n">param</span> <span class="o">+</span> <span class="s2">&quot;mDay.cdl&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">cdlFile</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;/usr/bin/ncgen -o &quot;</span> <span class="o">+</span> <span class="n">ncFile</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">cdlFile</span><span class="p">)</span>
    <span class="c1"># shutil.copyfile(cdlFile, ncFile)</span>
    <span class="n">ncPointer</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">ncFile</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span>
    <span class="n">mytime</span> <span class="o">=</span> <span class="n">ncPointer</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>
    <span class="n">ncPointer</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="n">filesUsed</span>
    <span class="n">ncPointer</span><span class="o">.</span><span class="n">date_created</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">now1</span><span class="p">)</span>
    <span class="n">ncPointer</span><span class="o">.</span><span class="n">date_issued</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">now1</span><span class="p">)</span>
    <span class="n">paramName</span> <span class="o">=</span> <span class="n">dataset</span> <span class="o">+</span> <span class="n">param</span>
    <span class="n">myparam</span> <span class="o">=</span> <span class="n">ncPointer</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">paramName</span><span class="p">]</span>
    <span class="n">myparam</span><span class="o">.</span><span class="n">numberOfObservations</span> <span class="o">=</span> <span class="n">nobs</span>
    <span class="n">myparam</span><span class="o">.</span><span class="n">percentCoverage</span> <span class="o">=</span> <span class="n">percentCoverage</span>
    <span class="n">myparam</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mean</span><span class="p">[:,</span> <span class="p">:]</span>
    <span class="n">myparam</span><span class="o">.</span><span class="n">actual_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(([</span><span class="n">mean</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">mean</span><span class="o">.</span><span class="n">max</span><span class="p">()]))</span>
    <span class="n">startTimeYear</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span>
    <span class="n">startTimeDoy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time1</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">7</span><span class="p">])</span>
    <span class="n">startDate</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">startTimeYear</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">startTimeDoy</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">endTimeYear</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time2</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span>
    <span class="n">endTimeDoy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time2</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">7</span><span class="p">])</span>
    <span class="n">endDate</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">endTimeYear</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">endTimeDoy</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">centerDoy</span> <span class="o">=</span> <span class="n">old_div</span><span class="p">((</span><span class="n">startTimeDoy</span> <span class="o">+</span> <span class="n">endTimeDoy</span><span class="p">),</span> <span class="mf">2.0</span><span class="p">)</span>
    <span class="n">centerDate</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">startTimeYear</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">centerDoy</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">centerDate</span><span class="p">)</span>
    <span class="n">udtime</span> <span class="o">=</span> <span class="n">date2num</span><span class="p">(</span><span class="n">centerDate</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;seconds since 1970-01-01&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">endTimeDoy</span> <span class="o">-</span> <span class="n">startTimeDoy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">31</span><span class="p">:</span>
        <span class="n">udtime</span> <span class="o">=</span> <span class="n">udtime</span> <span class="o">+</span> <span class="mi">43200</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">udtime</span><span class="p">)</span>
    <span class="n">mytime</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">udtime</span>
    <span class="n">mytime</span><span class="o">.</span><span class="n">actual_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(([</span><span class="n">udtime</span><span class="p">,</span> <span class="n">udtime</span><span class="p">]))</span>
    <span class="n">ncPointer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ncFile</span></div>



<div class="viewcode-block" id="grd2netcdf">
<a class="viewcode-back" href="../roylib.html#roylib.grd2netcdf">[docs]</a>
<span class="k">def</span> <span class="nf">grd2netcdf</span><span class="p">(</span><span class="n">grdFile</span><span class="p">,</span> <span class="n">filesUsed</span><span class="p">,</span> <span class="n">fType</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a GRD file to a NetCDF file, copying spatial data and metadata.</span>

<span class="sd">    This function reads a GRD file containing gridded data (with variables named</span>
<span class="sd">    either &quot;lon&quot;/&quot;lat&quot;/&quot;z&quot; or &quot;x&quot;/&quot;y&quot;/&quot;z&quot; depending on `fType`), computes coverage statistics,</span>
<span class="sd">    generates a NetCDF file via an `ncgen` command on a corresponding CDL template, and</span>
<span class="sd">    writes spatial coordinates, data values, and metadata (file list, creation date,</span>
<span class="sd">    observation count, coverage, and actual range) into the new NetCDF. The time variable</span>
<span class="sd">    is centered based on the date stamps in the original filename.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    grdFile : str</span>
<span class="sd">        Path to the input GRD file (e.g., &quot;/path/to/MB2023123001000.grd&quot;).</span>
<span class="sd">        The filename must encode the dataset, parameter, and date information:</span>
<span class="sd">        - The first two characters are the dataset code.</span>
<span class="sd">        - Characters 2-9 represent the start date (YYYYDDD).</span>
<span class="sd">        - Characters 10-17 represent the end date (YYYYDDD).</span>
<span class="sd">    filesUsed : list of str</span>
<span class="sd">        A list of source filenames that contributed to the GRD data. This list is stored</span>
<span class="sd">        in the NetCDF file&#39;s `files` attribute.</span>
<span class="sd">    fType : str</span>
<span class="sd">        File type indicator:</span>
<span class="sd">        - `&quot;MW&quot;` uses variables `&quot;lon&quot;`, `&quot;lat&quot;`, and `&quot;z&quot;`.</span>
<span class="sd">        - Any other value uses variables `&quot;x&quot;`, `&quot;y&quot;`, and `&quot;z&quot;`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        The path of the generated NetCDF file (same as `grdFile` with a “.nc” extension).</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    OSError</span>
<span class="sd">        If reading the GRD file or executing the `ncgen` command fails (e.g., file not found,</span>
<span class="sd">        permission denied).</span>
<span class="sd">    RuntimeError</span>
<span class="sd">        If the `ncgen` command returns a non-zero exit code, indicating failure to generate</span>
<span class="sd">        the NetCDF file.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">now1</span> <span class="o">=</span> <span class="n">date</span><span class="p">(</span><span class="n">now</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">now</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">now</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
    <span class="n">grdPointer</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">grdFile</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fType</span> <span class="o">==</span> <span class="s2">&quot;MW&quot;</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">grdPointer</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">][:]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">grdPointer</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">][:]</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">grdPointer</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">][:,</span> <span class="p">:]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">grdPointer</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][:]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">grdPointer</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">][:]</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">grdPointer</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">][:,</span> <span class="p">:]</span>
    <span class="n">grdPointer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">nobs</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="n">noMiss</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">count_masked</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="n">percentCoverage</span> <span class="o">=</span> <span class="n">old_div</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">nobs</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">nobs</span> <span class="o">+</span> <span class="n">noMiss</span><span class="p">))</span>
    <span class="c1"># get netcdf file name and correct cdl file</span>
    <span class="n">ncFile</span> <span class="o">=</span> <span class="n">grdFile</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">grdFile</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">ncFile</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">param</span> <span class="o">=</span> <span class="n">ncFile</span><span class="p">[(</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">ncFile</span><span class="p">)]</span>
    <span class="n">time1</span> <span class="o">=</span> <span class="n">grdFile</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span>
    <span class="n">time2</span> <span class="o">=</span> <span class="n">grdFile</span><span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="mi">17</span><span class="p">]</span>
    <span class="n">interval</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time2</span><span class="p">)</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">time1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ncFile</span> <span class="o">=</span> <span class="n">ncFile</span> <span class="o">+</span> <span class="s2">&quot;.nc&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ncFile</span><span class="p">)</span>
    <span class="c1"># cdlFile = &#39;/ERDData1/modisa/python/&#39; + dataset + param + interval + &#39;Day.cdl&#39;</span>
    <span class="n">cdlFile</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;/ERDData1/modisa/python/&quot;</span> <span class="o">+</span> <span class="n">dataset</span> <span class="o">+</span> <span class="n">param</span> <span class="o">+</span> <span class="n">interval</span> <span class="o">+</span> <span class="s2">&quot;Day.cdl&quot;</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">cdlFile</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;/usr/bin/ncgen -o &quot;</span> <span class="o">+</span> <span class="n">ncFile</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">cdlFile</span><span class="p">)</span>
    <span class="c1"># shutil.copyfile(cdlFile, ncFile)</span>
    <span class="n">ncPointer</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">ncFile</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span>
    <span class="n">lat</span> <span class="o">=</span> <span class="n">ncPointer</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span>
    <span class="n">lon</span> <span class="o">=</span> <span class="n">ncPointer</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">]</span>
    <span class="n">mytime</span> <span class="o">=</span> <span class="n">ncPointer</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>
    <span class="n">ncPointer</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="n">filesUsed</span>
    <span class="n">ncPointer</span><span class="o">.</span><span class="n">date_created</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">now1</span><span class="p">)</span>
    <span class="n">ncPointer</span><span class="o">.</span><span class="n">date_issued</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">now1</span><span class="p">)</span>
    <span class="n">paramName</span> <span class="o">=</span> <span class="n">dataset</span> <span class="o">+</span> <span class="n">param</span>
    <span class="n">myparam</span> <span class="o">=</span> <span class="n">ncPointer</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">paramName</span><span class="p">]</span>
    <span class="n">lat</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:]</span>
    <span class="n">lon</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:]</span>
    <span class="n">myparam</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">z</span><span class="p">[:,</span> <span class="p">:]</span>
    <span class="n">myparam</span><span class="o">.</span><span class="n">numberOfObservations</span> <span class="o">=</span> <span class="n">nobs</span>
    <span class="n">myparam</span><span class="o">.</span><span class="n">percentCoverage</span> <span class="o">=</span> <span class="n">percentCoverage</span>
    <span class="n">myparam</span><span class="o">.</span><span class="n">actual_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(([</span><span class="n">z</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">z</span><span class="o">.</span><span class="n">max</span><span class="p">()]))</span>
    <span class="n">startTimeYear</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span>
    <span class="n">startTimeDoy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time1</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">7</span><span class="p">])</span>
    <span class="n">startDate</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">startTimeYear</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">startTimeDoy</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">interval</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span>
        <span class="n">centerDate</span> <span class="o">=</span> <span class="n">startDate</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">interval</span> <span class="o">==</span> <span class="s2">&quot;3&quot;</span><span class="p">:</span>
        <span class="n">centerDate</span> <span class="o">=</span> <span class="n">startDate</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">36</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">interval</span> <span class="o">==</span> <span class="s2">&quot;5&quot;</span><span class="p">:</span>
        <span class="n">centerDate</span> <span class="o">=</span> <span class="n">startDate</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">interval</span> <span class="o">==</span> <span class="s2">&quot;8&quot;</span><span class="p">:</span>
        <span class="n">centerDate</span> <span class="o">=</span> <span class="n">startDate</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">interval</span> <span class="o">==</span> <span class="s2">&quot;14&quot;</span><span class="p">:</span>
        <span class="n">centerDate</span> <span class="o">=</span> <span class="n">startDate</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>

    <span class="n">udtime</span> <span class="o">=</span> <span class="n">date2num</span><span class="p">(</span><span class="n">centerDate</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;seconds since 1970-01-01&quot;</span><span class="p">)</span>
    <span class="n">mytime</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">udtime</span>
    <span class="n">mytime</span><span class="o">.</span><span class="n">actual_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(([</span><span class="n">udtime</span><span class="p">,</span> <span class="n">udtime</span><span class="p">]))</span>
    <span class="n">ncPointer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ncFile</span></div>



<div class="viewcode-block" id="grd2netcdf1">
<a class="viewcode-back" href="../roylib.html#roylib.grd2netcdf1">[docs]</a>
<span class="k">def</span> <span class="nf">grd2netcdf1</span><span class="p">(</span><span class="n">grdFile</span><span class="p">,</span> <span class="n">fileOut</span><span class="p">,</span> <span class="n">filesUsed</span><span class="p">,</span> <span class="n">my_mask</span><span class="p">,</span> <span class="n">fType</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert an Xarray grid file to a NetCDF file, applying a land mask and writing metadata.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    grdFile : xarray.Dataset</span>
<span class="sd">        The input grid dataset. If `fType == &quot;MW&quot;`, it must have `.lon`, `.lat`, and `.values`.</span>
<span class="sd">        Otherwise, it must have `.x`, `.y`, and `.values`.</span>
<span class="sd">    fileOut : str</span>
<span class="sd">        The target output filename (e.g., &#39;/path/to/output/MB2023123001.nc&#39;). The function</span>
<span class="sd">        derives dataset, parameter, start/end DOY from this name.</span>
<span class="sd">    filesUsed : list of str</span>
<span class="sd">        A list of source filenames that contributed to the grid; stored in the NetCDF&#39;s `files`.</span>
<span class="sd">    my_mask : numpy.ndarray</span>
<span class="sd">        A boolean or integer mask array of the same shape as `grdFile.values`. Points where</span>
<span class="sd">        `my_mask != 1` are set to NaN and then masked.</span>
<span class="sd">    fType : str</span>
<span class="sd">        File type indicator:</span>
<span class="sd">        - `&quot;MW&quot;` → use `grdFile.lon.values`, `grdFile.lat.values`, and `grdFile.values`.</span>
<span class="sd">        - Any other string → use `grdFile.x.values`, `grdFile.y.values`, and `grdFile.values`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        The path of the generated NetCDF file (same as `fileOut` with “.nc” extension).</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    OSError</span>
<span class="sd">        If the GRD file cannot be read or if the `ncgen` command fails to run.</span>
<span class="sd">    RuntimeError</span>
<span class="sd">        If `ncgen` returns a non-zero exit code.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
    <span class="kn">from</span> <span class="nn">netCDF4</span> <span class="kn">import</span> <span class="n">Dataset</span>
    <span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>

    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">now1</span> <span class="o">=</span> <span class="n">date</span><span class="p">(</span><span class="n">now</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">now</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">now</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fType</span> <span class="o">==</span> <span class="s2">&quot;MW&quot;</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">grdFile</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">grdFile</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">values</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">grdFile</span><span class="o">.</span><span class="n">values</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">grdFile</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">grdFile</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">values</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">grdFile</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># set areas in land mask not land to NaN</span>
    <span class="n">z</span><span class="p">[</span><span class="n">my_mask</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NAN</span>
    <span class="c1"># convert z to ma.array with NaNs masked</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">z</span><span class="p">),</span> <span class="n">fill_value</span><span class="o">=-</span><span class="mf">9999999.0</span><span class="p">)</span>
    <span class="n">nobs</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="n">noMiss</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">count_masked</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="n">percentCoverage</span> <span class="o">=</span> <span class="n">old_div</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">nobs</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">nobs</span> <span class="o">+</span> <span class="n">noMiss</span><span class="p">))</span>
    <span class="c1"># get netcdf file name and correct cdl file</span>
    <span class="n">ncFile</span> <span class="o">=</span> <span class="n">fileOut</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">fileOut</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">ncFile</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">param</span> <span class="o">=</span> <span class="n">ncFile</span><span class="p">[(</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">ncFile</span><span class="p">)]</span>
    <span class="n">time1</span> <span class="o">=</span> <span class="n">fileOut</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span>
    <span class="n">time2</span> <span class="o">=</span> <span class="n">fileOut</span><span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="mi">17</span><span class="p">]</span>
    <span class="n">interval</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time2</span><span class="p">)</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">time1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ncFile</span> <span class="o">=</span> <span class="n">ncFile</span> <span class="o">+</span> <span class="s2">&quot;.nc&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ncFile</span><span class="p">)</span>
    <span class="c1"># cdlFile = &#39;/ERDData1/modisa/python/&#39; + dataset + param + interval + &#39;Day.cdl&#39;</span>
    <span class="n">cdlFile</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;/ERDData1/modisa/python/&quot;</span> <span class="o">+</span> <span class="n">dataset</span> <span class="o">+</span> <span class="n">param</span> <span class="o">+</span> <span class="n">interval</span> <span class="o">+</span> <span class="s2">&quot;Day.cdl&quot;</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">cdlFile</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;/usr/bin/ncgen -o &quot;</span> <span class="o">+</span> <span class="n">ncFile</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">cdlFile</span><span class="p">)</span>
    <span class="c1"># shutil.copyfile(cdlFile, ncFile)</span>
    <span class="n">ncPointer</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">ncFile</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span>
    <span class="n">lat</span> <span class="o">=</span> <span class="n">ncPointer</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span>
    <span class="n">lon</span> <span class="o">=</span> <span class="n">ncPointer</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">]</span>
    <span class="n">mytime</span> <span class="o">=</span> <span class="n">ncPointer</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>
    <span class="n">ncPointer</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="n">filesUsed</span>
    <span class="n">ncPointer</span><span class="o">.</span><span class="n">date_created</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">now1</span><span class="p">)</span>
    <span class="n">ncPointer</span><span class="o">.</span><span class="n">date_issued</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">now1</span><span class="p">)</span>
    <span class="n">paramName</span> <span class="o">=</span> <span class="n">dataset</span> <span class="o">+</span> <span class="n">param</span>
    <span class="n">myparam</span> <span class="o">=</span> <span class="n">ncPointer</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">paramName</span><span class="p">]</span>
    <span class="n">lat</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:]</span>
    <span class="n">lon</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:]</span>
    <span class="n">myparam</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">z</span><span class="p">[:,</span> <span class="p">:]</span>
    <span class="n">myparam</span><span class="o">.</span><span class="n">numberOfObservations</span> <span class="o">=</span> <span class="n">nobs</span>
    <span class="n">myparam</span><span class="o">.</span><span class="n">percentCoverage</span> <span class="o">=</span> <span class="n">percentCoverage</span>
    <span class="n">myparam</span><span class="o">.</span><span class="n">actual_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(([</span><span class="n">z</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">z</span><span class="o">.</span><span class="n">max</span><span class="p">()]))</span>
    <span class="n">startTimeYear</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span>
    <span class="n">startTimeDoy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time1</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">7</span><span class="p">])</span>
    <span class="n">startDate</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">startTimeYear</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">startTimeDoy</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">interval</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span>
        <span class="n">centerDate</span> <span class="o">=</span> <span class="n">startDate</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">interval</span> <span class="o">==</span> <span class="s2">&quot;3&quot;</span><span class="p">:</span>
        <span class="n">centerDate</span> <span class="o">=</span> <span class="n">startDate</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">36</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">interval</span> <span class="o">==</span> <span class="s2">&quot;5&quot;</span><span class="p">:</span>
        <span class="n">centerDate</span> <span class="o">=</span> <span class="n">startDate</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">interval</span> <span class="o">==</span> <span class="s2">&quot;8&quot;</span><span class="p">:</span>
        <span class="n">centerDate</span> <span class="o">=</span> <span class="n">startDate</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">interval</span> <span class="o">==</span> <span class="s2">&quot;14&quot;</span><span class="p">:</span>
        <span class="n">centerDate</span> <span class="o">=</span> <span class="n">startDate</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>

    <span class="n">udtime</span> <span class="o">=</span> <span class="n">date2num</span><span class="p">(</span><span class="n">centerDate</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;seconds since 1970-01-01&quot;</span><span class="p">)</span>
    <span class="n">mytime</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">udtime</span>
    <span class="n">mytime</span><span class="o">.</span><span class="n">actual_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(([</span><span class="n">udtime</span><span class="p">,</span> <span class="n">udtime</span><span class="p">]))</span>
    <span class="n">ncPointer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ncFile</span></div>



<div class="viewcode-block" id="update_modis_1day">
<a class="viewcode-back" href="../roylib.html#roylib.update_modis_1day">[docs]</a>
<span class="k">def</span> <span class="nf">update_modis_1day</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">basedataDir</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">param_update_flag</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Execute daily MODIS processing scripts for SST or Chla based on update flags.</span>

<span class="sd">    This function iterates over the three most recent lags (-3, -2, -1 days relative to `now`).</span>
<span class="sd">    For each lag where `param_update_flag[lag + 3]` is True, it computes the corresponding date,</span>
<span class="sd">    constructs the directory path under `basedataDir`, and invokes the appropriate daily processing</span>
<span class="sd">    scripts via `os.system`. For `&quot;SST&quot;`, it runs both `makeSST1daynewMW.py` and `makeSST1daynewMB.py`;</span>
<span class="sd">    for `&quot;Chla&quot;`, it runs both `makeChla1daynewMW.py` and `makeChla1daynewMB.py`. Each script is</span>
<span class="sd">    passed the year and day-of-year strings as arguments.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    now : datetime.datetime</span>
<span class="sd">        The reference datetime (typically the current date and time). Used to compute the target date</span>
<span class="sd">        for each lag.</span>
<span class="sd">    basedataDir : str</span>
<span class="sd">        The base path for data directories (e.g., &quot;/ERDData1/modisa/data/netcdf/&quot;). For each lag,</span>
<span class="sd">        the function will append `&lt;YYYY&gt;&lt;MM&gt;` to this path to form `dataDir`.</span>
<span class="sd">    param : str</span>
<span class="sd">        The parameter to process: either `&quot;SST&quot;` or `&quot;Chla&quot;`. Determines which pair of scripts to invoke.</span>
<span class="sd">    param_update_flag : list of bool</span>
<span class="sd">        A list of length at least 4. For each `lag` in `[-3, -2, -1]`, if `param_update_flag[lag + 3]`</span>
<span class="sd">        is True, the function will trigger processing for that lag index.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">        This function does not return a value. It updates no in-memory state beyond side effects</span>
<span class="sd">        of calling external scripts.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    OSError</span>
<span class="sd">        If the working directory or the external processing scripts cannot be invoked (e.g., path not found,</span>
<span class="sd">        permission denied). Any non-zero exit code from `os.system` is not captured but may indicate failure.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">lag</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">param_update_flag</span><span class="p">[</span><span class="n">lag</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]:</span>
            <span class="n">myDate1</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">lag</span><span class="p">)</span>
            <span class="n">myYear</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">myDate1</span><span class="o">.</span><span class="n">year</span><span class="p">)</span>
            <span class="n">myMon</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">myDate1</span><span class="o">.</span><span class="n">month</span><span class="p">)</span>
            <span class="n">myMon</span> <span class="o">=</span> <span class="n">myMon</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">)</span>
            <span class="n">doy</span> <span class="o">=</span> <span class="n">myDate1</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%j&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">dataDir</span> <span class="o">=</span> <span class="n">basedataDir</span> <span class="o">+</span> <span class="n">myYear</span> <span class="o">+</span> <span class="n">myMon</span>
            <span class="k">if</span> <span class="n">param</span> <span class="o">==</span> <span class="s2">&quot;SST&quot;</span><span class="p">:</span>
                <span class="c1"># myCmd = &#39;/home/cwatch/anaconda3/bin/python /home/cwatch/newPython/modisa/makeSST1daynewMW.py  /ERDData1/modisa/data/netcdf/ /ERDData1/modisa/work/ &#39; + myYear + &#39; &#39; + doy</span>
                <span class="n">myCmd</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;/home/cwatch/mambaforge/bin/python /home/cwatch/newPython/modisa/makeSST1daynewMW.py  /ERDData1/modisa/data/netcdf/ /ERDData1/modisa/work/ &quot;</span>
                    <span class="o">+</span> <span class="n">myYear</span>
                    <span class="o">+</span> <span class="s2">&quot; &quot;</span>
                    <span class="o">+</span> <span class="n">doy</span>
                <span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">myCmd</span><span class="p">)</span>
                <span class="c1"># myCmd = &#39;/home/cwatch/anaconda3/bin/python /home/cwatch/newPython/modisa/makeSST1daynewMB.py  /ERDData1/modisa/data/netcdf/ /ERDData1/modisa/work1/ &#39; + myYear + &#39; &#39; + doy</span>
                <span class="n">myCmd</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;/home/cwatch/mambaforge/bin/python /home/cwatch/newPython/modisa/makeSST1daynewMB.py  /ERDData1/modisa/data/netcdf/ /ERDData1/modisa/work1/ &quot;</span>
                    <span class="o">+</span> <span class="n">myYear</span>
                    <span class="o">+</span> <span class="s2">&quot; &quot;</span>
                    <span class="o">+</span> <span class="n">doy</span>
                <span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">myCmd</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># myCmd = &#39;/home/cwatch/anaconda3/bin/python /home/cwatch/newPython/modisa/makeChla1daynewMW.py /ERDData1/modisa/data/netcdf/ /ERDData1/modisa/work/ &#39; + myYear + &#39; &#39; + doy</span>
                <span class="n">myCmd</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;/home/cwatch/mambaforge/bin/python /home/cwatch/newPython/modisa/makeChla1daynewMW.py /ERDData1/modisa/data/netcdf/ /ERDData1/modisa/work/ &quot;</span>
                    <span class="o">+</span> <span class="n">myYear</span>
                    <span class="o">+</span> <span class="s2">&quot; &quot;</span>
                    <span class="o">+</span> <span class="n">doy</span>
                <span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">myCmd</span><span class="p">)</span>
                <span class="c1"># myCmd = &#39;/home/cwatch/anaconda3/bin/python /home/cwatch/newPython/modisa/makeChla1daynewMB.py  /ERDData1/modisa/data/netcdf/ /ERDData1/modisa/work1/ &#39; + myYear + &#39; &#39; + doy</span>
                <span class="n">myCmd</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;/home/cwatch/mambaforge/bin/python /home/cwatch/newPython/modisa/makeChla1daynewMB.py  /ERDData1/modisa/data/netcdf/ /ERDData1/modisa/work1/ &quot;</span>
                    <span class="o">+</span> <span class="n">myYear</span>
                    <span class="o">+</span> <span class="s2">&quot; &quot;</span>
                    <span class="o">+</span> <span class="n">doy</span>
                <span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">myCmd</span><span class="p">)</span></div>



<div class="viewcode-block" id="update_modis_composite">
<a class="viewcode-back" href="../roylib.html#roylib.update_modis_composite">[docs]</a>
<span class="k">def</span> <span class="nf">update_modis_composite</span><span class="p">(</span>
    <span class="n">now</span><span class="p">,</span> <span class="n">basedataDir</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">param_update_flag</span><span class="p">,</span> <span class="n">composite</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update MODIS composite products for specified date lags and parameter.</span>

<span class="sd">    This function iterates over the three days immediately preceding `now` (lags -3, -2, -1).</span>
<span class="sd">    For each lag, it computes the corresponding date, builds the data directory path from</span>
<span class="sd">    `basedataDir`, and checks if any daily updates occurred in that range by summing the</span>
<span class="sd">    boolean flags in `param_update_flag` up to the current lag index. If an update is needed,</span>
<span class="sd">    it invokes the appropriate composite scripts via `os.system`. When `param` is `&#39;SST&#39;`,</span>
<span class="sd">    it runs `CompMBSST.py` and `CompMWSST.py`; when `param` is `&#39;Chla&#39;`, it runs</span>
<span class="sd">    `CompMBChla.py` and `CompMWChla.py`. Each script is passed the year, day-of-year, and</span>
<span class="sd">    the `composite` interval as command-line arguments.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    now : datetime.datetime</span>
<span class="sd">        The reference datetime used to calculate the target dates for each lag.</span>
<span class="sd">    basedataDir : str</span>
<span class="sd">        The base path where daily composite input data resides (e.g.,</span>
<span class="sd">        &#39;/ERDData1/modisa/data/modisgf/1day/&#39;).</span>
<span class="sd">    param : str</span>
<span class="sd">        The parameter type to process: either `&#39;SST&#39;` or `&#39;Chla&#39;`.</span>
<span class="sd">    param_update_flag : list of bool</span>
<span class="sd">        A list of length at least 4. For each lag in [-3, -2, -1], if the sum of</span>
<span class="sd">        `param_update_flag[0]` through `param_update_flag[lag + 3]` is greater than zero,</span>
<span class="sd">        the composite update scripts will be invoked for that lag.</span>
<span class="sd">    composite : str</span>
<span class="sd">        The composite interval identifier (e.g., `&#39;3&#39;`, `&#39;5&#39;`, `&#39;8&#39;`, `&#39;14&#39;`). Passed to</span>
<span class="sd">        external scripts to control the composite period.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">        This function does not return a value. It performs side effects by calling</span>
<span class="sd">        external composite scripts.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    OSError</span>
<span class="sd">        If any of the external composite scripts cannot be executed (e.g., the script</span>
<span class="sd">        file is missing or not executable).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">lag</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">)):</span>
        <span class="n">myDate1</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">lag</span><span class="p">)</span>
        <span class="n">myYear</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">myDate1</span><span class="o">.</span><span class="n">year</span><span class="p">)</span>
        <span class="n">myMon</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">myDate1</span><span class="o">.</span><span class="n">month</span><span class="p">)</span>
        <span class="n">myMon</span> <span class="o">=</span> <span class="n">myMon</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">)</span>
        <span class="n">doy</span> <span class="o">=</span> <span class="n">myDate1</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%j&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">dataDir</span> <span class="o">=</span> <span class="n">basedataDir</span> <span class="o">+</span> <span class="n">myYear</span> <span class="o">+</span> <span class="n">myMon</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">param_update_flag</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="p">(</span><span class="n">lag</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">param</span> <span class="o">==</span> <span class="s2">&quot;SST&quot;</span><span class="p">:</span>
                <span class="c1"># myCmd = &#39;/home/cwatch/anaconda3/bin/python /home/cwatch/newPython/modisa/CompMBSST.py /ERDData1/modisa/data/modisgf/1day/ /ERDData1/modisa/work1/ &#39; + myYear + &#39; &#39; + doy + &#39; &#39; + composite</span>
                <span class="n">myCmd</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;/home/cwatch/anaconda3/bin/python /home/cwatch/newPython/modisa/CompMBSST.py /ERDData1/modisa/data/modisgf/1day/ /ERDData1/modisa/work1/ &quot;</span>
                    <span class="o">+</span> <span class="n">myYear</span>
                    <span class="o">+</span> <span class="s2">&quot; &quot;</span>
                    <span class="o">+</span> <span class="n">doy</span>
                    <span class="o">+</span> <span class="s2">&quot; &quot;</span>
                    <span class="o">+</span> <span class="n">composite</span>
                <span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">myCmd</span><span class="p">)</span>
                <span class="c1"># myCmd = &#39;/home/cwatch/anaconda3/bin/python /home/cwatch/newPython/modisa/CompMWSST.py /ERDData1/modisa/data/modiswc/1day/ /ERDData1/modisa/work/ &#39; + myYear + &#39; &#39; + doy + &#39; &#39; + composite</span>
                <span class="n">myCmd</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;/home/cwatch/anaconda3/bin/python /home/cwatch/newPython/modisa/CompMWSST.py /ERDData1/modisa/data/modiswc/1day/ /ERDData1/modisa/work/ &quot;</span>
                    <span class="o">+</span> <span class="n">myYear</span>
                    <span class="o">+</span> <span class="s2">&quot; &quot;</span>
                    <span class="o">+</span> <span class="n">doy</span>
                    <span class="o">+</span> <span class="s2">&quot; &quot;</span>
                    <span class="o">+</span> <span class="n">composite</span>
                <span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">myCmd</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># myCmd = &#39;/home/cwatch/anaconda3/bin/python /home/cwatch/newPython/modisa/CompMBChla.py /ERDData1/modisa/data/modisgf/1day/ /ERDData1/modisa/work1/ &#39; + myYear + &#39; &#39; + doy + &#39; &#39; + composite</span>
                <span class="n">myCmd</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;/home/cwatch/anaconda3/bin/python /home/cwatch/newPython/modisa/CompMBChla.py /ERDData1/modisa/data/modisgf/1day/ /ERDData1/modisa/work1/ &quot;</span>
                    <span class="o">+</span> <span class="n">myYear</span>
                    <span class="o">+</span> <span class="s2">&quot; &quot;</span>
                    <span class="o">+</span> <span class="n">doy</span>
                    <span class="o">+</span> <span class="s2">&quot; &quot;</span>
                    <span class="o">+</span> <span class="n">composite</span>
                <span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">myCmd</span><span class="p">)</span>
                <span class="c1"># myCmd = &#39;/home/cwatch/anaconda3/bin/python /home/cwatch/newPython/modisa/CompMWChla.py /ERDData1/modisa/data/modiswc/1day/ /ERDData1/modisa/work/ &#39; + myYear + &#39; &#39; + doy + &#39; &#39; + composite</span>
                <span class="n">myCmd</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;/home/cwatch/anaconda3/bin/python /home/cwatch/newPython/modisa/CompMWChla.py /ERDData1/modisa/data/modiswc/1day/ /ERDData1/modisa/work/ &quot;</span>
                    <span class="o">+</span> <span class="n">myYear</span>
                    <span class="o">+</span> <span class="s2">&quot; &quot;</span>
                    <span class="o">+</span> <span class="n">doy</span>
                    <span class="o">+</span> <span class="s2">&quot; &quot;</span>
                    <span class="o">+</span> <span class="n">composite</span>
                <span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">myCmd</span><span class="p">)</span></div>



<div class="viewcode-block" id="url_lines">
<a class="viewcode-back" href="../roylib.html#roylib.url_lines">[docs]</a>
<span class="k">def</span> <span class="nf">url_lines</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download a file from a URL via `wget` and return its lines.</span>

<span class="sd">    This function constructs a `wget` command to fetch the content at the</span>
<span class="sd">    specified URL, saves it to a temporary files, retries up to 24 times</span>
<span class="sd">    if the download yields an empty file, and then returns the file&#39;s lines</span>
<span class="sd">    as a list of strings (with trailing newline characters stripped).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    url: str</span>
<span class="sd">        The query string or full URL to pass to the NASA OceanData</span>
<span class="sd">        file_search API via `wget`. This should include any necessary</span>
<span class="sd">        parameters (e.g. `?dataset=...&amp;time_min=...`).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        A list of lines (`str`) read from the downloaded file. Each</span>
<span class="sd">        element has had its trailing newline removed.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    RuntimeError</span>
<span class="sd">        If the file remains empty after the maximum number of retries.</span>
<span class="sd">    FileNotFoundError</span>
<span class="sd">        If the downloaded file cannot be opened.</span>
<span class="sd">    OSError</span>
<span class="sd">        If an underlying OS call fails (e.g., `wget` not found, permission</span>
<span class="sd">        issues, etc.).</span>
<span class="sd">    subprocess.CalledProcessError</span>
<span class="sd">        If `wget` exits with a non-zero status (when called with</span>
<span class="sd">        `check=True`).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Initialize an empty list to store the lines read from the downloaded file</span>
    <span class="n">myList</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

    <span class="c1"># Initialize retry counter</span>
    <span class="n">no_tries</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># Attempt up to 24 additional downloads (total 24 tries) until the file in non-empty</span>
    <span class="k">while</span> <span class="n">no_tries</span> <span class="o">&lt;</span> <span class="mi">25</span><span class="p">:</span>

        <span class="c1"># Build the wget command to fetch data from the NASA OceanData API,</span>
        <span class="c1"># saving output to a temporary file</span>
        <span class="n">wgetCmd</span> <span class="o">=</span> <span class="s2">&quot;/usr/bin/wget -O /home/cwatch/newPython/modisa/fileNames.txt --no-check-certificate &#39;https://oceandata.sci.gsfc.nasa.gov/api/file_search?&quot;</span> <span class="o">+</span> <span class="n">url</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
        <span class="c1"># Print the command for debugging purposes</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">wgetCmd</span><span class="p">)</span>

        <span class="c1"># Execute the command in a subshell; capture the return code</span>
        <span class="n">returnCode</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">wgetCmd</span><span class="p">,</span> <span class="n">shell</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;return code: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">returnCode</span><span class="p">))</span>
        
        <span class="c1"># Check size of the downloaded file</span>
        <span class="n">file_size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="s1">&#39;/home/cwatch/newPython/modisa/fileNames.txt&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;search file size: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">file_size</span><span class="p">))</span>

        <span class="c1"># If the file has content, break out of the retry loop</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">file_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Otherwise, increment retry counter and wait before trying</span>
            <span class="n">no_tries</span> <span class="o">=</span> <span class="n">no_tries</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

    <span class="c1"># Open the downloaded file for reading       </span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/home/cwatch/newPython/modisa/fileNames.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>

    <span class="c1"># iterate over each line in the file</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
        <span class="c1"># Strip trailing newline/carriage-return and append to our list</span>
        <span class="n">myList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>

    <span class="c1"># Close the file to free up resources</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Print the first two entries for a quick preview</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;myList: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">myList</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]))</span>

    <span class="c1"># Return the full list of lines</span>
    <span class="k">return</span> <span class="n">myList</span></div>



<div class="viewcode-block" id="url_lines1">
<a class="viewcode-back" href="../roylib.html#roylib.url_lines1">[docs]</a>
<span class="k">def</span> <span class="nf">url_lines1</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fetch a list of file names from the NASA OceanData API.</span>

<span class="sd">    This function constructs a full API request URL by appending the</span>
<span class="sd">    provided query string to the OceanData file_search endpoint, then</span>
<span class="sd">    attempts up to 24 retries (with a 5-second delay) to fetch the</span>
<span class="sd">    response. Once a non-empty response is received, it decodes each</span>
<span class="sd">    line as UTF-8, strips trailing whitespace, and returns the lines</span>
<span class="sd">    as a list of strings.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    url: str</span>
<span class="sd">        A query string containing one or more URL-encoded parameters</span>
<span class="sd">        (e.g. `&quot;dataset=MODISA_L2&amp;time_min=2025-06-01&amp;time_max=2025-06-10&quot;`).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        A list of decoded, stripped lines from the API response.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    urllib.error.URLError</span>
<span class="sd">        If there is a network problem or the URL cannot be reached.</span>
<span class="sd">    urllib.error.HTTPError</span>
<span class="sd">        If the server returns an HTTP error status (e.g., 404 or 500).</span>
<span class="sd">    RuntimeError</span>
<span class="sd">        If no data is returned after 24 retries.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Initialize empty list to collect decoded lines from the response</span>
    <span class="n">myList</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

    <span class="c1"># Construct the full API endpoint URL by prefixing the base endpoint</span>
    <span class="n">url_new</span> <span class="o">=</span> <span class="s1">&#39;https://oceandata.sci.gsfc.nasa.gov/api/file_search?&#39;</span> <span class="o">+</span>  <span class="n">url</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">url_new</span><span class="p">)</span>

    <span class="c1"># Initialize a retry counter; we will attempt up to 24 additional tries</span>
    <span class="n">no_tries</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># Loop until we either get data or exceed the retry limit</span>
    <span class="k">while</span> <span class="n">no_tries</span> <span class="o">&lt;</span> <span class="mi">25</span><span class="p">:</span>
        <span class="c1"># Open the URL and read all lines from the HTTP response</span>
        <span class="k">with</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url_new</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
            <span class="n">flist</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

        <span class="c1"># Log how many lines were returned in the attempt</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;filelist length: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">flist</span><span class="p">)))</span>

        <span class="c1"># If we recieved at least one line, break out of the retry loop</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">flist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Otherwise, increment retry counter and pause before retrying</span>
            <span class="n">no_tries</span> <span class="o">=</span> <span class="n">no_tries</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

    <span class="c1"># Iterate over each raw byte line in the response list</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">flist</span><span class="p">:</span>
        <span class="c1"># Decode bytes to a UTF-8 string</span>
        <span class="n">junk</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">)</span>
        <span class="c1"># Strip any trailing whitespace or newline characters and append to our list</span>
        <span class="n">myList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">junk</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
    
    <span class="c1"># Return the list of cleaned, decoded lines</span>
    <span class="k">return</span> <span class="n">myList</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Roy Mendelssohn &amp; Madison Richardson.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>